---
title: "Power analysis Helmut's Nature Ecol Evol paper"
author: "Yefeng"
date: "2020/9/21"
output: html_document
subtitle: "check for Shinichi"
---


## Setup

```{r setup, echo = FALSE}
# Tidy
 # rm(list=ls())
 # graphics.off()

# Preparing workspace
knitr::opts_chunk$set(echo = TRUE, include = TRUE)

# Loading packages
pacman::p_load(knitr, # knit markdown
               readxl, 
               readr, 
               metafor, 
               dplyr, 
               tidyverse, 
               janitor, # generate 1-, 2-way table
               patchwork, # layout of plots
               cowplot, 
               ggpubr,
               gridExtra,
               orchaRd, # forest-like plot
               gridGraphics # Redraw Base Graphics Using 'grid' Graphics. `gridGraphics` is required to handle base-R plots.
               )
```



## My understanding 

I have a good understanding of Stanley's paper. But I am a bit confused about what we are goding to do.

(a) Stanley's paper focused on statistical power for meta-analytic cases (he had 200 cases). He used 3 method to estimate average effect size (i.e. assumped true effect). Then use true effect size and corresponding variance to calculate power for each of 200 meta-analyses. However, Stanley may do this improperly. He neglected between-study heterogeneity when calculating power for meta-analysis. In other word, he used sampling variance as SE to calculate power for meta-analysis. Actually, SE of estimated effect size (i.e. meta-analysis SE) should include both sampling variance and between-study variance (tau2).

(b) I am not very much sure whether we should use the same thing as Stanley or not. If yes, statistical power has nothing to do with effect size type (e.g., hedge's d, response ratio, CVR). We just use the following formula 1-pnorm(1.96-mu/SE) to calculate power, where mu is the meta-analytic estimate and SE is corrsponding standatd error (i.e. sqrt(variance)). 

But my understanding is that we want to calculate statistical power for each empirical data point rather than meta-analytic cases (i.e. 12 MA for lnCVR and 36 for lnRR). In other word, power analysis for individual studies included by meta-analyses. This is different from Stanley's paper, which focuses on power analysis for meta-analysis. 

(c) If my understanding of (b) is correct. Check the following approach . To compute power for each empirical data point, we need true effect size and standard error of true effect size. The ture effect size is unknown, so we gonna use meta-analytic estimates (i.e. intercept from meta-analytic model) as (estimated) true effect. But we still use standard error of empirical effect size, rather than standard error of meta-analytic estimate. 

(d) Anyway, I provided both type power analysis (i.e. meta-analysis and empirical study). I am not sure whether my approach is correct.





## Pilot for one case (case ma1.1)

### Preprocessing data

```{r import raw data}
# Importing raw data
raw_m1_1 <- read.csv(file = "./dataset/raw_m1_1.csv", header = TRUE) #sep=";"
view(raw_m1_1)
raw_data <- m1_1_raw

# Renames the column names
  names(raw_data)[str_detect(names(raw_data), c("T.mean|T.sd|T.N|C.mean|C.sd|C.N"))] <- c("T_mean", "T_sd", "T_N", "C_mean", "C_sd", "C_N")


    
# Calculating 3 type of effect size statistics
  
## lnRR
  lnRR <- with(raw_data, escalc(measure = "ROM",
                                m1i = T_mean,
                                m2i = C_mean,
                                sd1i = T_sd,
                                sd2i = C_sd,
                                n1i = T_N,
                                n2i = C_N))

## lnCVR
  lnCVR <- with(raw_data, escalc(measure = "CVR",
                                 m1i = T_mean,
                                 m2i = C_mean,
                                 sd1i = T_sd,
                                 sd2i = C_sd,
                                 n1i = T_N,
                                 n2i = C_N))
## lnVR
  lnVR <- with(raw_data, escalc(measure = "VR",
                                sd1i = T_sd,
                                sd2i = C_sd,
                                n1i = T_N,
                                n2i = C_N))


## combination 
  metrics <- data.frame(RR = lnRR$yi, VRR = lnRR$vi, CVR = lnCVR$yi, VCVR = lnCVR$vi, VR = lnVR$yi, VVR = lnVR$vi)
  dat_m1_1 <- cbind(raw_data, metrics)


# clean NA
  dat_m1_1 <- dat_m1_1[!is.na(dat_m1_1$RR),] 
  dat_m1_1 <- dat_m1_1[!is.na(dat_m1_1$VRR),] 
  dat_m1_1 <- dat_m1_1[!is.na(dat_m1_1$CVR),]
  dat_m1_1 <- dat_m1_1[!is.na(dat_m1_1$VCVR),]
  
  dat_m1_1[dat_m1_1 == "-Inf"] <- NA
  dat_m1_1[dat_m1_1 == "Inf"] <- NA  
    
```






### Power analysis for meta-analytic case

```{r modeling}

# fit meta-analytic model
## RR
model_m1_1_RR <- with(dat_m1_1, rma.mv(yi = RR,
                                        V = VRR,
                                        random = list(~1|Study, ~1|Unit_ID),
                                        method = "REML",
                                        test = "z"))


## CVR
model_m1_1_CVR <- with(dat_m1_1, rma.mv(yi = CVR,
                                        V = VCVR,
                                        random = list(~1|Study, ~1|Unit_ID),
                                        method = "REML",
                                        test = "z"))

## VR
model_m1_1_VR <- with(dat_m1_1, rma.mv(yi = VR,
                                        V = VVR,
                                        random = list(~1|Study, ~1|Unit_ID),
                                        method = "REML",
                                        test = "z"))



# power calculating
## get estimate and corresponding error

model_m1_1 <- list(model_m1_1_RR,model_m1_1_CVR,model_m1_1_VR)

est <- data.frame(es.type=c("RR","CVR","VR"),
                  mu=sapply(model_m1_1, function(x) x$beta),
                  SE=sapply(model_m1_1, function(x) x$se),
                  p_value=sapply(model_m1_1, function(x) x$pval)
                  )

## Stanley's formula to creat function to calculate power for meta-analytic estimate
power.ma_Stanley <- function(mu, SE) {
  if_else(mu>0, (1-pnorm(qnorm(0.975)-mu/SE)), pnorm(qnorm(0.975)-mu/SE))
  }


est$power.Stanley_formula <- power.ma_Stanley(mu=est$mu,SE=est$SE)


## Shinichi's function to creat function to calculate power for meta-analytic estimate
### two-tailed power
power.ma_Shinichi_two.tail <- function(mu, SE) {
  if_else(mu>0, (2-pnorm(qnorm(0.975)-mu/SE)-pnorm(qnorm(0.975)+mu/SE)), (pnorm(qnorm(0.975)-mu/SE)+pnorm(qnorm(0.975)+mu/SE)))}

### get two-tailed power
est$power.Shinichi_two.tail <- power.ma_Shinichi_two.tail(mu=est$mu,SE=est$SE)


### one-tailed power
power.ma_Shinichi_one.tail <- function(mu, SE) {
  if_else(mu>0, (1-pnorm(qnorm(0.95)-mu/SE)), (pnorm(qnorm(0.95)-mu/SE)))}

### get one-tailed power
est$power.Shinichi_one.tail <- power.ma_Shinichi_one.tail(mu=est$mu,SE=est$SE)


write.csv(est, file = "./power_results.csv")

```








The following is my previous approach. I have not fixed them according your approach

### Power analysis for individual study within meta-analytic case

```{r modeling}

# creating function for calculating variance for effect size
## RR
V.RR<-function(CMean, CSD, CN, EMean, ESD, EN){
	EVar<-ESD^2
	CVar<-CSD^2
	V<- (CVar / (CN * (CMean^2))) + (EVar / (EN * (EMean^2)))
	return(V)
} ## or we can directly use variance of lnRR from escalc() function

## calculating variance for RR

dat_m1_1$V.RR <- V.RR(CMean=dat_m1_1$C_mean, CSD=dat_m1_1$C_sd, CN=dat_m1_1$C_N, EMean=dat_m1_1$T_mean, ESD=dat_m1_1$T_sd, EN=dat_m1_1$T_N)


## CVR
V.CVR<-function(CMean, CSD, CN, EMean, ESD, EN){
		mvcorr<-cor.test(log(c(CMean, EMean)), log(c(CSD, ESD)))$estimate
		V<- CSD^2 / (CN * (CMean^2)) + 1 / (2 * (CN - 1)) - 2 * mvcorr * sqrt((CSD^2 / (CN * (CMean^2))) * (1 / (2 * (CN - 1)))) + ESD^2 / (EN * (EMean^2)) + 1 / (2 * (EN - 1)) - 2 * mvcorr * sqrt((ESD^2 / (EN * (EMean^2))) * (1 / (2 * (EN - 1))))
	return(V)
}  ## or we can directly use variance of lnCVR from escalc() function

		
dat_m1_1$V.CVR <- V.CVR(CMean=dat_m1_1$C_mean, CSD=dat_m1_1$C_sd, CN=dat_m1_1$C_N, EMean=dat_m1_1$T_mean, ESD=dat_m1_1$T_sd, EN=dat_m1_1$T_N)		



# power calculating
## creating function for power analysis for empirical study
power.empirical <- function(mu, se) {
  if_else(mu>0, 1-pnorm(1.96-mu/se), pnorm(1.96-mu/se))
  }

## power based on observed effect size
dat_m1_1$observed_power_RR <- power.empirical(mu=dat_m1_1$RR, se=sqrt(dat_m1_1$V.RR))

dat_m1_1$observed_power_CVR <- power.empirical(mu=dat_m1_1$CVR, se=sqrt(dat_m1_1$V.CVR))


## power based on meta-analytic estimate as true effect size
dat_m1_1$true_power_RR <- power.empirical(mu=rep(est$mu[1], length(dat_m1_1$V.RR)), se=sqrt(dat_m1_1$V.RR))

dat_m1_1$true_power_CVR <- power.empirical(mu=rep(est$mu[1], length(dat_m1_1$V.CVR)), se=sqrt(dat_m1_1$V.CVR))





```


