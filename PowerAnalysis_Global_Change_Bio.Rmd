---
title: "Power analysis Helmut's Nature Ecol Evol paper"
author: "Yefeng"
date: "2020/9/21"
output: html_document
subtitle: "check for Shinichi"
---


## Setup

```{r setup, echo = FALSE}
# Tidy
 # rm(list=ls())
 # graphics.off()

# Preparing workspace
knitr::opts_chunk$set(echo = TRUE, include = TRUE)

# Loading packages
pacman::p_load(knitr, # knit markdown
               readxl, 
               readr, 
               metafor, 
               dplyr, 
               tidyverse, 
               janitor, # generate 1-, 2-way table
               patchwork, # layout of plots
               cowplot, 
               ggpubr,
               gridExtra,
               orchaRd, # forest-like plot
               gridGraphics, # Redraw Base Graphics Using 'grid' Graphics. `gridGraphics` is required to handle base-R plots.
               dabestr,
               here,
               retrodesign,
               lme4,
               car, # logit transformation, car::logit()
               boot, # Bootstrap Resampling
               lmerTest, # get p-valus from lme4 model, but need to re-fit the model lmerTest::lme4
               ggthemes
               )

#library(dabestr)

#library(here)

# install.packages("D:/Program Files (x86)/R packages source/retrodesign_0.1.0.zip", repos = NULL, type="source") 



#simulated_plot <- retrodesign::sim_plot(0.5,1)

#png(filename = "./Figures/simulated_plot.png", width = 8, height = 8, units = "in", type = "windows", res = 400)
#simulated_plot
#dev.off()

# Function to calculate power (two-tail) for meta-analysis
power.ma_Shinichi <- function(mu, SE, alpha = 0.05) {
  2-pnorm(qnorm(1-alpha/2)-abs(mu)/SE)-pnorm(qnorm(1-alpha/2)+abs(mu)/SE)
  } # or power.ma_Shinichi1 <- function(mu,SE){1 - pnorm(qnorm(1-0.05/2)-abs(mu)/SE) + pnorm(-qnorm(1-0.05/2)-abs(mu)/SE)}



# Function for power analysis for empirical data point
power.individual_Shinichi <- function(mu, se, alpha = 0.05) {
  2-pnorm(qnorm(1-alpha/2)-abs(mu)/se)-pnorm(qnorm(1-alpha/2)+abs(mu)/se)} # two-tailed power


# Function for Type S error for empirical data point

error_S <- function(mu, se, alpha = 0.05){
  #z <- qnorm(1 - alpha/2) # Z-score or quantile
  p.u <- 1 - pnorm(qnorm(1 - alpha/2) - abs(mu)/se) # upper-tail probability
  p.l <- pnorm(-qnorm(1 - alpha/2) - abs(mu)/se) # lower-tail probability
  power <- p.u + p.l # upper + lower
  errorS <- p.l/power # percentage of the opposite direction
  return(errorS)
} 




# We also can use t-distribution to estimate error
# type.S <- function(mu, se, alpha = 0.05){
#  z <- qt(1 - alpha/2, df=Inf) # Z-score or quantile
#  p.u <- 1 - pt(z - abs(mu)/se, df=Inf) # upper-tail probability
#  p.l <- pt(-z - abs(mu)/se, df=Inf) # lower-tail probability
#  power <- p.u + p.l # upper + lower
#  typeS <- p.l/power # percentage of the opposite direction
#  return(data.frame(power=power,
#                    type_S=typeS))}


# Function for Type M error for empirical data point
error_M <- function(mu, se, alpha = 0.05, N = 10000) {
    est.random <- rnorm(n=N, mean = mu, sd = se)
    # est.random <- mu + se*rnorm(n=N, mean=0, sd=1)
    sig.index <- abs(est.random) > se*qnorm(1 - alpha/2)
    overestimate <- mean(abs(est.random)[sig.index])/abs(mu) # ratio is regardnesss of sign, so we need absolute value
    absolute_error <- overestimate*abs(mu) - abs(mu)
    relative_error <- absolute_error/(overestimate*abs(mu))
  return(abs(overestimate) %>% round(3))
}


error_M2 <- function(mu, se, alpha = 0.05, N = 10000) {
    est.random <- rnorm(n=N, mean = mu, sd = se)
    # est.random <- mu + se*rnorm(n=N, mean=0, sd=1)
    sig.index <- abs(est.random) > se*qnorm(1 - alpha/2)
    overestimate <- mean(abs(est.random)[sig.index])/abs(mu) # ratio is regardnesss of sign, so we need absolute value
    absolute_error <- overestimate*abs(mu) - abs(mu)
    relative_error <- absolute_error/(overestimate*abs(mu))
  return(abs(relative_error) %>% round(3))
} # relative error: (M - 1) / M



       
    
# the sampling variance of magnitude    
folded_error <-function(mean, variance){
  mu <- mean
  sigma <- sqrt(variance)
  fold_mu <- sigma*sqrt(2/pi)*exp((-mu^2)/(2*sigma^2)) + mu*(1 - 2*pnorm(-mu/sigma))
  fold_se <- sqrt(mu^2 + sigma^2 - fold_mu^2)
  # adding se to make bigger mean
  fold_v <-fold_se^2
  fold_v
}
    
    

#dat <- dat[!is.na(dat$yi) & dat$vi != 0, ]

```



<!-- **Contents** -->
<!-- We have three sections.  -->

<!-- Section 1: power analysis for 36 lnRR meta-analyses and corresponding  power analysis for individual data point within each meta-analysis -->

<!-- Section 2: power analysis for 12 lnCVR and lnVR meta-analyses and corresponding  power analysis for individual data point within each meta-analysis -->

<!-- Section3: using three three weighting schemes (i.e. WAAP, PET-PEESE, http://environmentalcomputing.net/meta-analysis/) to evaluate publication bias -->




### 1. lnRR*
Assuming different true effects based on meta-analytic estimate, we calculate two-tailed power for 30 lnRR meta-analytic cases and effect size included in each meta-analysis.

I temporarily kept it: In addition, we also calculate power using four hypothetical true effects (i.e. 1 - 100% mean differences) - 

#### 1.1 MA power calculation

```{r}
# load(here("data","model_est_RR.RData")) 

#***************************************************************#
#                  meta-analysis level power                    #
#***************************************************************#
# TODO - you can do this in one line - consdier using this function list.files() - by using this you can get all the names of files without typing in and loop or spply it through

# my try - list.files(path = "./36_lnRR_data")

#dat_m1_1 <- read.csv(here("data/36_lnRR_data", "m1_1.csv"), header = TRUE)


# Importing data
dat_m1_1 <- read.csv(file = "data/36_lnRR_data/m1_1.csv", header = TRUE)
dat_m1_2 <- read.csv(file = "data/36_lnRR_data/m1_2.csv", header = TRUE)
dat_m2_1 <- read.csv(file = "data/36_lnRR_data/m2_1.csv", header = TRUE)
dat_m2_2 <- read.csv(file = "data/36_lnRR_data/m2_2.csv", header = TRUE)
dat_m3_1 <- read.csv(file = "data/36_lnRR_data/m3_1.csv", header = TRUE)
dat_m4_1 <- read.csv(file = "data/36_lnRR_data/m4_1.csv", header = TRUE)
dat_m5_1 <- read.csv(file = "data/36_lnRR_data/m5_1.csv", header = TRUE)
dat_m6_1 <- read.csv(file = "data/36_lnRR_data/m6_1.csv", header = TRUE)
dat_m6_2 <- read.csv(file = "data/36_lnRR_data/m6_2.csv", header = TRUE)
dat_m6_3 <- read.csv(file = "data/36_lnRR_data/m6_3.csv", header = TRUE)
dat_m6_4 <- read.csv(file = "data/36_lnRR_data/m6_4.csv", header = TRUE)
dat_m6_5 <- read.csv(file = "data/36_lnRR_data/m6_5.csv", header = TRUE)
dat_m7_1 <- read.csv(file = "data/36_lnRR_data/m7_1.csv", header = TRUE)
dat_m7_2 <- read.csv(file = "data/36_lnRR_data/m7_2.csv", header = TRUE)
dat_m8_1 <- read.csv(file = "data/36_lnRR_data/m8_1.csv", header = TRUE)
dat_m9_1 <- read.csv(file = "data/36_lnRR_data/m9_1.csv", header = TRUE)
dat_m10_1 <- read.csv(file = "data/36_lnRR_data/m10_1.csv", header = TRUE)
dat_m11_1 <- read.csv(file = "data/36_lnRR_data/m11_1.csv", header = TRUE)
dat_m12_1 <- read.csv(file = "data/36_lnRR_data/m12_1.csv", header = TRUE)
dat_m13_1 <- read.csv(file = "data/36_lnRR_data/m13_1.csv", header = TRUE)
dat_m13_2 <- read.csv(file = "data/36_lnRR_data/m13_2.csv", header = TRUE)
dat_m14_1 <- read.csv(file = "data/36_lnRR_data/m14_1.csv", header = TRUE)
dat_m14_2 <- read.csv(file = "data/36_lnRR_data/m14_2.csv", header = TRUE)
dat_m14_3 <- read.csv(file = "data/36_lnRR_data/m14_3.csv", header = TRUE)
dat_m15_1 <- read.csv(file = "data/36_lnRR_data/m15_1.csv", header = TRUE)
dat_m16_1 <- read.csv(file = "data/36_lnRR_data/m16_1.csv", header = TRUE)
dat_m16_2 <- read.csv(file = "data/36_lnRR_data/m16_2.csv", header = TRUE)
dat_m20_1 <- read.csv(file = "data/36_lnRR_data/m20_1.csv", header = TRUE)
dat_m23_1 <- read.csv(file = "data/36_lnRR_data/m23_1.csv", header = TRUE)
dat_m24_1 <- read.csv(file = "data/36_lnRR_data/m24_1.csv", header = TRUE) #sep=";"



##Warning: There are some mising values of effect size corresponding variance (i.e. vi) in the following data set: dat_m17_1, dat_m17_2, dat_m18_1, dat_m19_1, dat_m21_1, dat_m22_1. These datasets can not be used to calculate power. Therefore, we deleted these six datasets. Finally, we have 36-6=30 datasets.


#***************************************************************#
#                    power for meta-analytic cases              #
#***************************************************************#

# make a list of data
dat_list <- list(dat_m1_1,
                 dat_m1_2,
                 dat_m2_1,
                 dat_m2_2,
                 dat_m3_1,
                 dat_m4_1,
                 dat_m5_1,
                 dat_m6_1,
                 dat_m6_2,
                 dat_m6_3,
                 dat_m6_4,
                 dat_m6_5,
                 dat_m7_1,
                 dat_m7_2,
                 dat_m8_1,
                 dat_m9_1,
                 dat_m10_1,
                 dat_m11_1,
                 dat_m12_1,
                 dat_m13_1,
                 dat_m13_2,
                 dat_m14_1,
                 dat_m14_2,
                 dat_m14_3,
                 dat_m15_1,
                 dat_m16_1,
                 dat_m16_2,
                 dat_m20_1,
                 dat_m23_1,
                 dat_m24_1)


# prepare "ture" effect of mean (i.e. lnRR) for power analysis - fit multi-level meta-analytic models
model_list_RR <- list() # rep(NA, length(dat_list))
for (i in 1:length(dat_list)) {
 model_list_RR[i] <- rma.mv(data = dat_list[[i]], yi = yi, V = vi, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

# calculate the number of total effect sizes - total sample size
ES_number <- NA
ES_number <- mapply(unique, sapply(dat_list, function(x) x$Unit_ID)) 
unlist(ES_number) %>% length() # 3850 this is to show how many global change experiments we use in our analysis 


# get the number of studies (N) and the number of effect sizes (k) from each meta-analysis
N_RR <- NA
N_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Study)))

k_RR <- NA
k_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Unit_ID)))


# As we assume meta-analytic mean as the ture effect, we need to get estimate (mu) and corresponding error (SE)
model_est_RR <- data.frame(MA_case=c("m1_1",
                                      "m1_2",
                                      "m2_1",
                                      "m2_2",
                                      "m3_1",
                                      "m4_1",
                                      "m5_1",
                                      "m6_1",
                                      "m6_2",
                                      "m6_3",
                                      "m6_4",
                                      "m6_5",
                                      "m7_1",
                                      "m7_2",
                                      "m8_1",
                                      "m9_1",
                                      "m10_1",
                                      "m11_1",
                                      "m12_1",
                                      "m13_1",
                                      "m13_2",
                                      "m14_1",
                                      "m14_2",
                                      "m14_3",
                                      "m15_1",
                                      "m16_1",
                                      "m16_2",
                                      "m20_1",
                                      "m23_1",
                                      "m24_1"),
                  mu_RR=sapply(model_list_RR, function(x) x$beta),
                  SE_RR=sapply(model_list_RR, function(x) x$se),
                  ll_NHST=sapply(model_list_RR, function(x) x$ci.lb),
                  ul_NHST=sapply(model_list_RR, function(x) x$ci.ub),
                  p_value=sapply(model_list_RR, function(x) x$pval))


#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_RR$MA.power <- power.ma_Shinichi(mu=model_est_RR$mu,SE=model_est_RR$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_RR$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_RR$mu[i],se=model_est_RR$SE[i],alpha=0.05) %>% unlist()
}

model_est_RR$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_RR$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_RR$mu[i],se=model_est_RR$SE[i],alpha=0.05) %>% unlist()
}

model_est_RR$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_RR$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_RR$mu[i],se=model_est_RR$SE[i],alpha=0.05) %>% unlist()
}

model_est_RR$MA.power.M2 <- MA.power.M2


# save
#write.csv(model_est_RR, file = "./meta-analysis power_RR.csv", row.names = FALSE)


# save(model_est_RR,file = here("data","model_est_RR.RData"))
#load(here("data","model_est_RR.RData"))
```


#### 1.2 Individual power calculation

##### 1.2.1 Calculation
```{r}
# load(here("data","dat_list.RData"))

#***************************************************************#
#                      individual level power                   #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_RR <- NA
for (i in 1:length(dat_list)) {
  power.F_RR[i] <- power.individual_Shinichi(mu=rep(model_list_RR[[i]]$beta, length(dat_list[[i]]$vi)), se=sqrt(dat_list[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_RR)) {
  dat_list[[i]]$power.F_RR <- power.F_RR[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_RR <- NA
for (i in 1:length(dat_list)) {
  power.F.S_RR[i] <- mapply(error_S, mu=rep(model_list_RR[[i]]$beta, length(dat_list[[i]]$vi)), se=sqrt(dat_list[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_RR)) {
  dat_list[[i]]$power.F.S_RR <- power.F.S_RR[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_RR <- NA
for (i in 1:length(dat_list)) {
  power.F.M_RR[i] <- mapply(error_M, mu=rep(model_list_RR[[i]]$beta, length(dat_list[[i]]$vi)), se=sqrt(dat_list[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_RR)) {
  dat_list[[i]]$power.F.M_RR <- power.F.M_RR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_RR <- NA
for (i in 1:length(dat_list)) {
  power.F.M2_RR[i] <- mapply(error_M2, mu=rep(model_list_RR[[i]]$beta, length(dat_list[[i]]$vi)), se=sqrt(dat_list[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_RR)) {
  dat_list[[i]]$power.F.M2_RR <- power.F.M2_RR[[i]]
}



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_RR <- NA
for (i in 1:length(model_list_RR)) {
  blups.list_RR[i] <- ranef(model_list_RR[[i]]) %>% list()
}

# get study index - match two components random effect
index.list_RR <- NA # list()
for (i in 1:length(model_list_RR)) {
  index.list_RR[i] <- match(as.character(dat_list[[i]]$Study),rownames(blups.list_RR[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_RR <-NA
for (i in 1:length(model_list_RR)) {
  effect.R_RR[i] <- mapply(sum, model_list_RR[[i]]$beta, blups.list_RR[[i]]$Study[index.list_RR[[i]],1], blups.list_RR[[i]]$Unit_ID[,1]) %>% list()
}

#--------------------- (1) two tailed power ---------------------#
power.R_RR <- NA
for (i in 1:length(dat_list)) {
  power.R_RR[i] <- power.individual_Shinichi(mu=effect.R_RR[[i]], se=sqrt(dat_list[[i]]$vi)) %>% list()}

# plot(power_RR[[1]]-power_RR2[[1]]) - check discrepancy
# allocate each set of power into corresponding dataset
for (i in 1:length(power.R_RR)) {
  dat_list[[i]]$power.R_RR <- power.R_RR[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect, which does not account for random effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_RR <- NA
for (i in 1:length(dat_list)) {
  power.R.S_RR[i] <- mapply(error_S, mu=effect.R_RR[[i]], se=sqrt(dat_list[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.R.S_RR)) {
  dat_list[[i]]$power.R.S_RR <- power.R.S_RR[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_RR <- NA
for (i in 1:length(dat_list)) {
  power.R.M_RR[i] <- mapply(error_M, mu=effect.R_RR[[i]], se=sqrt(dat_list[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.R.M_RR)) {
  dat_list[[i]]$power.R.M_RR <- power.R.M_RR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_RR <- NA
for (i in 1:length(dat_list)) {
  power.R.M2_RR[i] <- mapply(error_M2, mu=effect.R_RR[[i]], se=sqrt(dat_list[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.R.M2_RR)) {
  dat_list[[i]]$power.R.M2_RR <- power.R.M2_RR[[i]]
}


#save(dat_list,file = here("data","dat_list.RData"))

# load(here("data","dat_list.RData"))
```



##### 1.2.2 Summary of individual power

```{r}

#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.F_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.F_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.F_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.F_RR))[6,])  # early version, sapply(mapply(summary, sapply(dat_list, function(x) x$power_RR)), function(x) x[2])


#---------------------- (2) type S error -----------------------#
power.F.S_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.F.S_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F.S_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.F.S_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.F.S_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F.S_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.F.S_RR))[6,])


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.F.M_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F.M_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.F.M_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.F.M_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F.M_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.F.M_RR))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.F.M2_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F.M2_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.F.M2_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.F.M2_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.F.M2_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.F.M2_RR))[6,])




#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.R_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.R_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.R_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.R_RR))[6,])


#---------------------- (2) type S error -----------------------#
power.R.S_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.R.S_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R.S_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.R.S_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.R.S_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R.S_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.R.S_RR))[6,])



#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.R.M_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R.M_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.R.M_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.R.M_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R.M_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.R.M_RR))[6,])


#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_RR <- data.frame(MA_case=model_est_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list, function(x) x$power.R.M2_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R.M2_RR))[2,],
                   Median=mapply(summary, sapply(dat_list, function(x) x$power.R.M2_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list, function(x) x$power.R.M2_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list, function(x) x$power.R.M2_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list, function(x) x$power.R.M2_RR))[6,])

```


##### 1.2.3 SE of individual power

```{r}
Note: this section need to be ran in your computer

#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_RR
se.F_mean <- NA
for (i in 1:length(dat_list)) {
  se.F_mean[i] <- sd(dat_list[[i]]$power.F_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.F_RR[!is.na(dat_list[[i]]$power.F_RR)]))
}

power.F_summary_RR$se.F_mean <- se.F_mean

#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_RR
se.F.S_mean <- NA
for (i in 1:length(dat_list)) {
  se.F.S_mean[i] <- sd(dat_list[[i]]$power.F.S_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.F.S_RR[!is.na(dat_list[[i]]$power.F.S_RR)]))
}

power.F.S_summary_RR$se.F.S_mean <- se.F.S_mean


#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_RR
se.F.M_mean <- NA
for (i in 1:length(dat_list)) {
  se.F.M_mean[i] <- sd(dat_list[[i]]$power.F.M_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.F.M_RR[!is.na(dat_list[[i]]$power.F.M_RR)]))
}

power.F.M_summary_RR$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(dat_list)) {
  se.F.M2_mean[i] <- sd(dat_list[[i]]$power.F.M2_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.F.M2_RR[!is.na(dat_list[[i]]$power.F.M2_RR)]))
}

power.F.M2_summary_RR$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_RR
se.R_mean <- NA
for (i in 1:length(dat_list)) {
  se.R_mean[i] <- sd(dat_list[[i]]$power.R_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.R_RR[!is.na(dat_list[[i]]$power.R_RR)]))
}

power.R_summary_RR$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_RR
se.R.S_mean <- NA
for (i in 1:length(dat_list)) {
  se.R.S_mean[i] <- sd(dat_list[[i]]$power.R.S_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.R.S_RR[!is.na(dat_list[[i]]$power.R.S_RR)]))
}

power.R.S_summary_RR$se.R.S_mean <- se.R.S_mean


#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_RR
se.R.M_mean <- NA
for (i in 1:length(dat_list)) {
  se.R.M_mean[i] <- sd(dat_list[[i]]$power.R.M_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.R.M_RR[!is.na(dat_list[[i]]$power.R.M_RR)]))
}

power.R.M_summary_RR$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(dat_list)) {
  se.R.M2_mean[i] <- sd(dat_list[[i]]$power.R.M2_RR, na.rm=TRUE) / sqrt(length(dat_list[[i]]$power.R.M2_RR[!is.na(dat_list[[i]]$power.R.M2_RR)]))
}

power.R.M2_summary_RR$se.R.M2_mean <- se.R.M2_mean

```


#### 1.3 Regression

##### 1.3.1 MA power

```{r}
# Add k and N to the dataset
N_RR <- NA
N_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Study)))

k_RR <- NA
k_RR <- mapply(length, sapply(dat_list, function(x) x$Unit_ID))

model_est_RR$k <- k_RR
model_est_RR$N <- N_RR





# load meta-analysis level power
#load(here("data","model_est_RR.RData"))
#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#--------------------- (1) two tailed power ---------------------#
MMA_MA_RR <- lm(MA.power~1, weights = k, data = model_est_RR) 
MMA_MA_RR$coefficients
# log
MMA_MA_RR2 <- lm(log(MA.power)~1, weights = k, data = model_est_RR)
# this is median
MMA_MA_RR2$coefficients  %>% exp() %>%  round(3)
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)
#confidence interval of median
confint(MMA_MA_RR2) %>% exp() %>%  round(3)
# # logit
# MMA_MA_RR3 <- lm(car::logit(MA.power)~1, weights = k, data = model_est_RR)
# # I am not sure what this is - but this is not the mean
# MMA_MA_RR3$coefficients %>% inv.logit() # or plogis()
# compare residuals
png(filename = "./Figures/residual/MA.MAOM.power_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA_RR) %>% hist(main = paste("Orignal scale (meta-analysis power)"), xlab = "Residual")
residuals(MMA_MA_RR2) %>% hist(main = paste("Log scale (meta-analysis power)"), xlab = "Residual") 
dev.off()
#residuals(MMA_MA_RR3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 
#---------------------- (2) type S error -----------------------#
MMA_MA.S_RR <- lm(MA.power.S~1, weights = k, data = model_est_RR) 
MMA_MA.S_RR$coefficients
# log
MMA_MA.S_RR2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_RR) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_RR2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# # logit
# MMA_MA.S_RR3 <- lm(car::logit(MA.power.S)~1, weights = k, data = model_est_RR)
# MMA_MA.S_RR3$coefficients %>% inv.logit() # or plogis()
# make plot
png(filename = "./Figures/residual/MA.MAOM.S_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA.S_RR) %>% hist(main = paste("Orignal scale (meta-analysis Type S)"), xlab = "Residual")
residuals(MMA_MA.S_RR2) %>% hist(main = paste("Log scale (meta-analysis Type S)"), xlab = "Residual") 
dev.off() 
#residuals(MMA_MA.S_RR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#
# note that logit transformation is not suitable for Type M, because M error is not the probability. So I have not done logit transformation for M
MMA_MA.M_RR <- lm(MA.power.M~1, weights = k, data = model_est_RR) 
MMA_MA.M_RR$coefficients
# log
MMA_MA.M_RR2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_RR)
# this is median
MMA_MA.M_RR2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA.M_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_RR2) %>% exp()

# make plot
png(filename = "./Figures/residual/MA.MAOM.M_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA.M_RR) %>% hist(main = paste("Orignal scale (meta-analysis Type M)"), xlab = "Residual")
residuals(MMA_MA.M_RR2) %>% hist(main = paste("Log scale (meta-analysis Type M)"), xlab = "Residual") 
dev.off() 



#-------------- (3) type M2 error (overestimate ratio) -------------#
# note that logit transformation is not suitable for Type M, because M error is not the probability. So I have not done logit transformation for M
MMA_MA.M2_RR <- lm(MA.power.M2~1, weights = k, data = model_est_RR) 
MMA_MA.M2_RR$coefficients
# log
MMA_MA.M2_RR2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_RR)
# this is median
MMA_MA.M2_RR2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA.M2_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.M2+0.025))) %>% exp() - 0.025

#confidence interval of median
confint(MMA_MA.M2_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# # https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/confint
# 
# # rma(yi = Mean, sei = se.R_mean, test = “t”)) This will give you I2 etc - this may be good

# #--------------------- (1) two tailed power ---------------------#
# #MMA_MA_RR <- rma(data = model_est_RR, yi = MA.power, sei = 1/sqrt(k), method = "FE", test = "t")
# 
# MMA_MA_RR <- lm(MA.power~1, weights = k, data = model_est_RR) 
# summary(MMA_MA_RR)
# 
# MMA_MA_RR2 <- lm(log(MA.power)~1, weights = k, data = model_est_RR)
# 
# MMA_MA_RR3 <- lm(car::logit(MA.power)~1, weights = k, data = model_est_RR)
# 
# save(model_est_RR,file = here("data","model_est_RR.RData"))
# load(here("data","model_est_RR.RData"))
# 
# #---------------------- (2) type S error -----------------------#
# #MMA_MA.S_RR <- rma(data = model_est_RR, yi = MA.power.S, sei = 1/sqrt(k), method = "FE", test = "t")
# 
# MMA_MA.S_RR <- lm(model_est_RR$MA.power.S~1, weights = k, data = model_est_RR) 
# 
# MMA_MA.S_RR2 <- lm(log(model_est_RR$MA.power.S)~1, weights = k, data = model_est_RR)
# 
# MMA_MA.S_RR3 <- lm(car::logit(model_est_RR$MA.power.S)~1, weights = k, data = model_est_RR)
# 
# MMA_MA.S_RR3$coefficients %>% plogis() 
# 
# MMA_MA.S_RR3$coefficients %>% inv.logit()
# 
# summary(MMA_MA.S_RR)
# 
# #-------------- (3) type M error (overestimate ratio) -------------#
# # MMA_MA.M_RR <- rma(data = model_est_RR, yi = MA.power.M, sei = 1/sqrt(k), method = "FE", test = "t")
# 
# MMA_MA.M_RR <- lm(MA.power.M~1, weights = k, data = model_est_RR) 
# 
# MMA_MA.M_RR2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_RR) 
# 
# MMA_MA.M_RR3 <- lm(plogis(MA.power.M)~1, weights = k, data = model_est_RR) 
# 
# summary(MMA_MA.M_RR)
# 
```


##### 1.3.2 Individual power

```{r}

#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique incase some studies have same identities
#dat_m1_1$Study <- paste("m1_1_", dat_m1_1$Study, sep="")

# dat_list[[1]]$Study <- paste("m1_1_", dat_list[[1]]$Study, sep = "")
# dat_list[[2]]$Study <- paste("m1_2_", dat_list[[2]]$Study, sep = "")
# dat_list[[3]]$Study <- paste("m2_1_", dat_list[[3]]$Study, sep = "")
# dat_list[[4]]$Study <- paste("m2_2_", dat_list[[4]]$Study, sep = "")
# dat_list[[5]]$Study <- paste("m3_1_", dat_list[[5]]$Study, sep = "")
# dat_list[[6]]$Study <- paste("m4_1_", dat_list[[6]]$Study, sep = "")
# dat_list[[7]]$Study <- paste("m5_1_", dat_list[[7]]$Study, sep = "")
# dat_list[[8]]$Study <- paste("m6_1_", dat_list[[8]]$Study, sep = "")
# dat_list[[9]]$Study <- paste("m6_2_", dat_list[[9]]$Study, sep = "")
# dat_list[[10]]$Study <- paste("m6_3_", dat_list[[10]]$Study, sep = "")
# dat_list[[11]]$Study <- paste("m6_4_", dat_list[[11]]$Study, sep = "")
# dat_list[[12]]$Study <- paste("m6_5_", dat_list[[12]]$Study, sep = "")
# dat_list[[13]]$Study <- paste("m7_1_", dat_list[[13]]$Study, sep = "")
# dat_list[[14]]$Study <- paste("m7_2_", dat_list[[14]]$Study, sep = "")
# dat_list[[15]]$Study <- paste("m8_1_", dat_list[[15]]$Study, sep = "")
# dat_list[[16]]$Study <- paste("m9_1_", dat_list[[16]]$Study, sep = "")
# dat_list[[17]]$Study <- paste("m10_1_", dat_list[[17]]$Study, sep = "")
# dat_list[[18]]$Study <- paste("m11_1_", dat_list[[18]]$Study, sep = "")
# dat_list[[19]]$Study <- paste("m12_1_", dat_list[[19]]$Study, sep = "")
# dat_list[[20]]$Study <- paste("m13_1_", dat_list[[20]]$Study, sep = "")
# dat_list[[21]]$Study <- paste("m13_2_", dat_list[[21]]$Study, sep = "")
# dat_list[[22]]$Study <- paste("m14_1_", dat_list[[22]]$Study, sep = "")
# dat_list[[23]]$Study <- paste("m14_2_", dat_list[[23]]$Study, sep = "")
# dat_list[[24]]$Study <- paste("m14_3_", dat_list[[24]]$Study, sep = "")
# dat_list[[25]]$Study <- paste("m15_1_", dat_list[[25]]$Study, sep = "")
# dat_list[[26]]$Study <- paste("m16_1_", dat_list[[26]]$Study, sep = "")
# dat_list[[27]]$Study <- paste("m16_2_", dat_list[[27]]$Study, sep = "")
# dat_list[[28]]$Study <- paste("m20_1_", dat_list[[28]]$Study, sep = "")
# dat_list[[29]]$Study <- paste("m23_1_", dat_list[[29]]$Study, sep = "")
# dat_list[[30]]$Study <- paste("m24_1_", dat_list[[30]]$Study, sep = "")


studyID_RR <- NA
for (i in 1:length(dat_list)) {
  studyID_RR[i] <- dat_list[[i]]$Study %>% list()
}

MA_case_RR <- c(rep('m1_1',length(dat_list[[1]]$Study)),
                  rep('m1_2',length(dat_list[[2]]$Study)),
                  rep('m2_1',length(dat_list[[3]]$Study)),
                  rep('m2_2',length(dat_list[[4]]$Study)),
                  rep('m3_1',length(dat_list[[5]]$Study)),
                  rep('m4_1',length(dat_list[[6]]$Study)),
                  rep('m5_1',length(dat_list[[7]]$Study)),
                  rep('m6_1',length(dat_list[[8]]$Study)),
                  rep('m6_2',length(dat_list[[9]]$Study)),
                  rep('m6_3',length(dat_list[[10]]$Study)),
                  rep('m6_4',length(dat_list[[11]]$Study)),
                  rep('m6_5',length(dat_list[[12]]$Study)),
                  rep('m7_1',length(dat_list[[13]]$Study)),
                  rep('m7_2',length(dat_list[[14]]$Study)),
                  rep('m8_1',length(dat_list[[15]]$Study)),
                  rep('m9_1',length(dat_list[[16]]$Study)),
                  rep('m10_1',length(dat_list[[17]]$Study)),
                  rep('m11_1',length(dat_list[[18]]$Study)),
                  rep('m12_1',length(dat_list[[19]]$Study)),#m12_1
                  rep('m13_1',length(dat_list[[20]]$Study)),
                  rep('m13_2',length(dat_list[[21]]$Study)),
                  rep('m14_1',length(dat_list[[22]]$Study)),
                  rep('m14_2',length(dat_list[[23]]$Study)), 
                  rep('m14_3',length(dat_list[[24]]$Study)),
                  rep('m15_1',length(dat_list[[25]]$Study)),
                  rep('m16_1',length(dat_list[[26]]$Study)),
                  rep('m16_2',length(dat_list[[27]]$Study)),
                  rep('m20_1',length(dat_list[[28]]$Study)),
                  rep('m23_1',length(dat_list[[29]]$Study)), #m23_1
                  rep('m24_1',length(dat_list[[30]]$Study))
                  )

#MA_case_RR <- c("1m1_1", "2m1_2", "3m2_1", "4m2_2", "5m3_1", "6m4_1", "7m5_1", "8m6_1", "9m6_2", "10m6_3", "11m6_4",  "12m6_5",  "13m7_1",  "14m7_2",  "15m8_1",  "16m9_1",  "17m10_1", "18m11_1", "19m12_1", "20m13_1", "21m13_2" ,"22m14_1", "23m14_2", "24m14_3", "25m15_1", "26m16_1", "27m16_2", "28m20_1", "29m23_1", "30m24_1")

stressor_RR <-  c(rep('BD_loss',length(dat_list[[1]]$Study)),
                  rep('BD_loss',length(dat_list[[2]]$Study)),
                  rep('Fert',length(dat_list[[3]]$Study)),
                  rep('Fert',length(dat_list[[4]]$Study)),
                  rep('Warm',length(dat_list[[5]]$Study)),
                  rep('Fert',length(dat_list[[6]]$Study)),
                  rep('Fert',length(dat_list[[7]]$Study)),
                  rep('LUC',length(dat_list[[8]]$Study)),
                  rep('LUC',length(dat_list[[9]]$Study)),
                  rep('LUC',length(dat_list[[10]]$Study)),
                  rep('LUC',length(dat_list[[11]]$Study)),
                  rep('LUC',length(dat_list[[12]]$Study)),
                  rep('Fert',length(dat_list[[13]]$Study)),
                  rep('Fert',length(dat_list[[14]]$Study)),
                  rep('Precip',length(dat_list[[15]]$Study)),
                  rep('LUC',length(dat_list[[16]]$Study)),
                  rep('Warm',length(dat_list[[17]]$Study)),
                  rep('Inv',length(dat_list[[18]]$Study)),
                  rep('Fire',length(dat_list[[19]]$Study)),#m12_1
                  rep('Fire',length(dat_list[[20]]$Study)),
                  rep('Fire',length(dat_list[[21]]$Study)),
                  rep('Warm',length(dat_list[[22]]$Study)),
                  rep('Warm',length(dat_list[[23]]$Study)), 
                  rep('Warm',length(dat_list[[24]]$Study)),
                  rep('BD_loss',length(dat_list[[25]]$Study)),
                  rep('BD_loss',length(dat_list[[26]]$Study)),
                  rep('BD_loss',length(dat_list[[27]]$Study)),
                  rep('Acid',length(dat_list[[28]]$Study)),
                  rep('Inv',length(dat_list[[29]]$Study)), #m23_1
                  rep('Inv',length(dat_list[[30]]$Study))
                  )
#stressor_RR <- c("1BD_loss","2BD_loss","3Fert","4Fert","5Warm","6Fert","7Fert","8LUC","9LUC","10LUC","11LUC","12LUC","13Fert","14Fert","15Precip","16LUC","17Warm","18Inv","19Fire","20Fire","21Fire","22Warm","23Warm","24Warm","25BD_loss","26BD_loss","27BD_loss","28Acid","29Inv","30Inv")


approach_RR <-  c(rep('E',length(dat_list[[1]]$Study)),
                  rep('E',length(dat_list[[2]]$Study)),
                  rep('E',length(dat_list[[3]]$Study)),
                  rep('E',length(dat_list[[4]]$Study)),
                  rep('E',length(dat_list[[5]]$Study)),
                  rep('E',length(dat_list[[6]]$Study)),
                  rep('E',length(dat_list[[7]]$Study)),
                  rep('O',length(dat_list[[8]]$Study)),
                  rep('O',length(dat_list[[9]]$Study)),
                  rep('O',length(dat_list[[10]]$Study)),
                  rep('O',length(dat_list[[11]]$Study)),
                  rep('O',length(dat_list[[12]]$Study)),
                  rep('E',length(dat_list[[13]]$Study)),
                  rep('E',length(dat_list[[14]]$Study)),
                  rep('E',length(dat_list[[15]]$Study)),
                  rep('O',length(dat_list[[16]]$Study)),
                  rep('O',length(dat_list[[17]]$Study)),
                  rep('O',length(dat_list[[18]]$Study)),
                  dat_m12_1$approach,#m12_1
                  rep('O',length(dat_list[[20]]$Study)),
                  rep('O',length(dat_list[[21]]$Study)),
                  rep('E',length(dat_list[[22]]$Study)),
                  rep('E',length(dat_list[[23]]$Study)),
                  rep('E',length(dat_list[[24]]$Study)),
                  rep('E',length(dat_list[[25]]$Study)),
                  rep('E',length(dat_list[[26]]$Study)),
                  rep('E',length(dat_list[[27]]$Study)),
                  rep('E',length(dat_list[[28]]$Study)),
                  dat_m23_1$approach,#m23_1
                  rep('O',length(dat_list[[30]]$Study))
                  )
#approach_RR <- c("1E","2E","3E","4E","5E","6E","7E","8O","9O","10O","11O","12O","13E","14E","15E","16O","17O","18O","19B","20O","21O","22E","23E","24E","25E","26E","27E","28E","29B","30O")

studyID_RR <- unlist(studyID_RR)
power.F_RR <- unlist(power.F_RR)
power.F.S_RR <- unlist(power.F.S_RR)
power.F.M_RR <- unlist(power.F.M_RR)
power.F.M2_RR <- unlist(power.F.M2_RR)
power.R_RR <- unlist(power.R_RR)
power.R.S_RR <- unlist(power.R.S_RR)
power.R.M_RR <- unlist(power.R.M_RR)
power.R.M2_RR <- unlist(power.R.M2_RR)


individual_est_RR <- data.frame("MA_case_RR" = MA_case_RR,
                                "studyID_RR" = studyID_RR,
                                "stressor_RR" = stressor_RR,
                                "approach_RR" = approach_RR,
                                "power.F_RR" = power.F_RR,
                                "power.F.S_RR" = power.F.S_RR,
                                "power.F.M_RR" = power.F.M_RR,
                                "power.F.M2_RR" = power.F.M2_RR,
                                "power.R_RR" = power.R_RR,
                                "power.R.S_RR" = power.R.S_RR,
                                "power.R.M_RR" = power.R.M_RR,
                                "power.R.M2_RR" = power.R.M2_RR)

# save(individual_est_RR,file = here("data","individual_est_RR.RData"))
# save(power.F.M_RR,file = here("data","power.F.M_RR.RData"))
# save(power.R.M_RR,file = here("data","power.R.M_RR.RData"))


# load individual level power
#load(here("data","individual_est_RR.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_RR <- lmer(power.F_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
summary(MMA_power.F_RR)$coefficients[1]
# log
MMA_power.F_RR2 <- lmer(log(power.F_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# this is median 
summary(MMA_power.F_RR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_RR2) %>% exp()

# # logit
# MMA_power.F_RR3 <- lmer(car::logit(power.F_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# summary(MMA_power.F_RR3)$coefficients[1] %>% inv.logit()

# compare residual
png(filename = "./Figures/residual/MAOM.power_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F_RR) %>% hist(main = paste("Orignal scale (experiment power)"), xlab = "Residual")
residuals(MMA_power.F_RR2) %>% hist(main = paste("Log scale (experiment power)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.F_RR3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 

# include approach_RR as fixed effect and stressor as random effect
# non-contrast estimate
#TODO - this model does not really make sesne - comapred to what you said you did in the method
MMA_power.F_RR.approach <- lmer(power.F_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.F_RR.approach)$coefficients
# log
MMA_power.F_RR.approach2 <- lmer(log(power.F_RR) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.F_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR[individual_est_RR$approach_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.F_RR[individual_est_RR$approach_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_RR.approach2) %>% exp()



# contrast estimate
# log
MMA_power.F_RR.approach4 <- lmer(log(power.F_RR) ~ 1 + I(approach_RR) + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# check p value for contrasting results
summary(MMA_power.F_RR.approach4)


# # logit
# MMA_power.F_RR.approach3 <- lmer(car::logit(power.F_RR) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# summary(MMA_power.F_RR.approach3)$coefficients %>% inv.logit()
# make plot

par(mfrow = c(1, 2))
residuals(MMA_power.F_RR.approach) %>% hist(main = paste("Orignal scale (experiment power)"), xlab = "Residual")
residuals(MMA_power.F_RR.approach2) %>% hist(main = paste("Log scale (experiment power)"), xlab = "Residual") 

#residuals(MMA_power.F_RR.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_power.F.S_RR <- lmer(power.F.S_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
summary(MMA_power.F.S_RR)$coefficients[1]
# there is a issue in log transformation. some values of Type S are zero. Those can not be log-transformed
# TODO - we need to adjust S by adding a small value
# find the second smallest value and add
#min2 <- min(individual_est_RR$power.F.S_RR[individual_est_RR$power.F.S_RR != #min(individual_est_RR$power.F.S_RR)])
# better to just add 0.025 like invlogit
MMA_power.F.S_RR2 <- lmer(log(power.F.S_RR + 0.025) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# # logit
# # of course this has the same problem but they automatically add 0.02
# MMA_power.F.S_RR3 <- lmer(car::logit(power.F.S_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# summary(MMA_power.F.S_RR3)$coefficients[1] %>% inv.logit()
# make plot
png(filename = "./Figures/residual/residual_TypeS_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_RR) %>% hist(main = paste("Orignal scale Type S"), xlab = "Residual")
residuals(MMA_power.F.S_RR2) %>% hist(main = paste("Log scale experiment Type S"), xlab = "Residual")
dev.off()
#residuals(MMA_power.F.S_RR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_RR as fixed effect and stressor as random effect
MMA_power.F.S_RR.approach <- lmer(power.F.S_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.F.S_RR.approach)$coefficients
# log
MMA_power.F.S_RR.approach2 <- lmer(log(power.F.S_RR + 0.025) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.F.S_RR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_RR.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.F.S_RR.approach4 <- lmer(log(power.F.S_RR + 0.025) ~ 1 + I(approach_RR) + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# check p value
summary(MMA_power.F.S_RR.approach4)

#---------------------- (2) type M error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.F.M_RR <- lmer(power.F.M_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)

summary(MMA_power.F.M_RR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnRR are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.F.M_RR2 <- lmer(log(power.F.M_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)

# this is median
summary(MMA_power.F.M_RR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.F.M_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_RR2) %>% exp()

# make plot
png(filename = "./Figures/residual/MAOM.M_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_RR) %>% hist(main = paste("Orignal scale (experiment Type M)"), xlab = "Residual")
residuals(MMA_power.F.M_RR2) %>% hist(main = paste("Log scale (experiment Type M)"), xlab = "Residual") 
dev.off()


# include approach_RR as fixed effect and stressor as random effect
MMA_power.F.M_RR.approach <- lmer(power.F.M_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.F.M_RR.approach)$coefficients
# log
MMA_power.F.M_RR.approach2 <- lmer(log(power.F.M_RR) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.F.M_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR[individual_est_RR$approach_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.F.M_RR[individual_est_RR$approach_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_RR.approach2) %>% exp()




# contrasting model
MMA_power.F.M_RR.approach4 <- lmer(log(power.F.M_RR) ~ 1 + I(approach_RR) + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# check p value
summary(MMA_power.F.M_RR.approach4)

#---------------------- (2) type M2 error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.F.M2_RR <- lmer(power.F.M2_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)

summary(MMA_power.F.M2_RR)$coefficients[1] 

# log 
MMA_power.F.M2_RR2 <- lmer(log(power.F.M2_RR+0.025) ~ 1 + (1 | studyID_RR), data = individual_est_RR)

# this is median
summary(MMA_power.F.M2_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.F.M2_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M2_RR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_RR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_RR as fixed effect and stressor as random effect
MMA_power.F.M2_RR.approach <- lmer(power.F.M2_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.F.M2_RR.approach)$coefficients
# log
MMA_power.F.M2_RR.approach2 <- lmer(log(power.F.M2_RR + 0.025) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.F.M2_RR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M2_RR[individual_est_RR$approach_RR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.F.M2_RR[individual_est_RR$approach_RR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_RR.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_RR <- lmer(power.R_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
summary(MMA_power.R_RR)$coefficients[1]
# log
MMA_power.R_RR2 <- lmer(log(power.R_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# this is median 
summary(MMA_power.R_RR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_RR2) %>% exp()

# # logit
# MMA_power.R_RR3 <- lmer(car::logit(power.R_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# summary(MMA_power.R_RR3)$coefficients[1] %>% inv.logit()

# compare residual
png(filename = "./Figures/residual/residual_power_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R_RR) %>% hist(main = paste("Orignal scale power"), xlab = "Residual")
residuals(MMA_power.R_RR2) %>% hist(main = paste("Log scale power"), xlab = "Residual") 
dev.off()
#residuals(MMA_power.R_RR3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 

# include approach_RR as fixed effect and stressor as random effect
# your example code returned contrast estimates. I used -1 to get non-contrast estimate. -1 is general? It seems that it fits both rma and lmer  
#TODO - this model does not really make sesne - comapred to what you said you did in the method
MMA_power.R_RR.approach <- lmer(power.R_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.R_RR.approach)$coefficients
# log
MMA_power.R_RR.approach2 <- lmer(log(power.R_RR) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.R_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR[individual_est_RR$approach_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.R_RR[individual_est_RR$approach_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_RR.approach2) %>% exp()



# contrasting model
MMA_power.R_RR.approach4 <- lmer(log(power.R_RR) ~ 1 + I(approach_RR) + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# check p value
summary(MMA_power.R_RR.approach4)

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_RR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_RR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_power.R_RR.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_RR <- lmer(power.R.S_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
summary(MMA_power.R.S_RR)$coefficients[1]
# there is a issue in log transformation. some values of Type S are zero. Those can not be log-transformed
# TODO - we need to adjust S by adding a small value
# find the second smallest value and add
#min2 <- min(individual_est_RR$power.R.S_RR[individual_est_RR$power.R.S_RR != #min(individual_est_RR$power.R.S_RR)])
# better to just add 0.025 like invlogit
MMA_power.R.S_RR2 <- lmer(log(power.R.S_RR + 0.025) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# # logit
# # of course this has the same problem but they automatically add 0.02
# MMA_power.R.S_RR3 <- lmer(car::logit(power.R.S_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# summary(MMA_power.R.S_RR3)$coefficients[1] %>% inv.logit()
# make plot
png(filename = "./Figures/residual/TypeS_MA_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_RR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_RR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.R.S_RR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_RR as fixed effect and stressor as random effect
MMA_power.R.S_RR.approach <- lmer(power.R.S_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.R.S_RR.approach)$coefficients
# log
MMA_power.R.S_RR.approach2 <- lmer(log(power.R.S_RR + 0.025) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.R.S_RR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_RR.approach2) %>% exp()



# contrasting model
MMA_power.R.S_RR.approach4 <- lmer(log(power.R.S_RR + 0.025) ~ 1 + I(approach_RR) + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# check p value
summary(MMA_power.R.S_RR.approach4)


#---------------------- (2) type M error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.R.M_RR <- lmer(power.R.M_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)

summary(MMA_power.R.M_RR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnRR are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.R.M_RR2 <- lmer(log(power.R.M_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)

# this is median
summary(MMA_power.R.M_RR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.R.M_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_RR2) %>% exp()

# make plot
png(filename = "./Figures/residual/residual_TypeM_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_RR) %>% hist(main = paste("Orignal scale Type M"), xlab = "Residual")
residuals(MMA_power.R.M_RR2) %>% hist(main = paste("Log scale Type M"), xlab = "Residual")
dev.off()


# include approach_RR as fixed effect and stressor as random effect
MMA_power.R.M_RR.approach <- lmer(power.R.M_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.R.M_RR.approach)$coefficients
# log
MMA_power.R.M_RR.approach2 <- lmer(log(power.R.M_RR) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.R.M_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR[individual_est_RR$approach_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.R.M_RR[individual_est_RR$approach_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_RR.approach2) %>% exp()




# contrasting model
MMA_power.R.M_RR.approach4 <- lmer(log(power.R.M_RR) ~ 1 + I(approach_RR) + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# check p value
summary(MMA_power.R.M_RR.approach4)

#---------------------- (2) type M2 error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.R.M2_RR <- lmer(power.R.M2_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)

summary(MMA_power.R.M2_RR)$coefficients[1] 

# log 
MMA_power.R.M2_RR2 <- lmer(log(power.R.M2_RR+0.025) ~ 1 + (1 | studyID_RR), data = individual_est_RR)

# this is median
summary(MMA_power.R.M2_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.R.M2_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M2_RR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_RR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_RR as fixed effect and stressor as random effect
MMA_power.R.M2_RR.approach <- lmer(power.R.M2_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
summary(MMA_power.R.M2_RR.approach)$coefficients
# log
MMA_power.R.M2_RR.approach2 <- lmer(log(power.R.M2_RR + 0.025) ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# this is median
summary(MMA_power.R.M2_RR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M2_RR[individual_est_RR$approach_RR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.R.M2_RR[individual_est_RR$approach_RR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_RR.approach2) %>% exp() - 0.025






# # add study ID
# power.F_summary_RR$Study <- c(1,1,2,2,3,4,5,6,6,6,6,6,7,7,8,9,10,11,11,13,13,14,14,14,15,16,16,17,18,19)
# 
# # add N and k
# N_RR <- NA
# for (i in 1:length(dat_list)) {
#   n_RR[i] <- dat_list[[i]]$Unit_ID %>% length()
# }
# 
# k_RR <- NA
# for (i in 1:length(dat_list)) {
#   k_RR[i] <- dat_list[[i]]$Study %>% length()
# }
# 
# power.F_summary_RR$N <- N_RR
# power.F_summary_RR$k <- k_RR
# 
# # add labels for study type (experiment vs. observational)
# approach_RR <- c("E","E","E","E","E","E","E","O","O","O","O","O","E","E","E","O","O","O","B","O","O","E","E","E","E","E","E","E","B","O")
# 
# # add labels for treatment
# #treatment_RR <- c("Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pu","Pr","Pu","Pu","Pu","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr")
# 
# # add labels for stressor categories
# stressor_RR <- c("BD_loss","BD_loss","Fert","Fert","Warm","Fert","Fert","LUC","LUC","LUC","LUC","LUC","Fert","Fert","Precip","LUC","Warm","Inv","Fire","Fire","Fire","Warm","Warm","Warm","BD_loss","BD_loss","BD_loss","Acid","Inv","Inv")
# 
# stressor_RR %>% as.data.frame() # check the correctness
# 
# moderator_RR <- cbind(approach_RR, treatment_RR, stressor_RR)
# power.F_summary_RR <- cbind(power.F_summary_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F_summary_RR$approach_RR <- factor(power.F_summary_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# # # run rma model 
# # I guess you want to use add stressor as a new column for each data point within meta-analyses and use lmer to run the model - stressor as the fixed effect)
# 
# #--------------------- (1) two tailed power ---------------------#
# MMA_power.F_RR.approach <- with(power.F_summary_RR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F_RR.stressor <- with(power.F_summary_RR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F_RR <- with(power.F_summary_RR, rma(yi = Mean, sei = se.F_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# MMA_power.F_RR2 <- lmer(log(power.F_RR) ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# residuals(MMA_power.F_RR2) %>% hist()
# 
# MMA_power.F.S_RR2 <- lmer(power.F.S_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# residuals(MMA_power.F.S_RR2) %>% hist()
# 
# MMA_power.F.M_RR2 <- lmer(power.F.M_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# residuals(MMA_power.F.M_RR2) %>% hist()
# 
# 
# 
# MMA_power.R_RR2 <- lmer(power.R_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# residuals(MMA_power.R_RR2) %>% hist()
# 
# MMA_power.R.S_RR2 <- lmer(power.R.S_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# residuals(MMA_power.R.S_RR2) %>% hist()
# 
# MMA_power.R.M_RR2 <- lmer(power.R.M_RR ~ 1 + (1 | studyID_RR), data = individual_est_RR)
# residuals(MMA_power.R.M_RR2) %>% hist()
# 
# 
# 
# MMA_power.F_RR.approach2 <- lmer(power.F_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# residuals(MMA_power.F_RR2) %>% hist()
# 
# 
# MMA_power.F.M_RR.approach2 <- lmer(power.F.M_RR ~ 1 + I(approach_RR) -1 + (1 | studyID_RR) + (1 | stressor_RR), data = individual_est_RR)
# residuals(MMA_power.F_RR2) %>% hist()
# 
# 
# 
# # MMA_power.F_RR2 <- with(power.F_summary_RR, rma.mv (yi = Mean, V = se.F_mean, random = list(~1|Study/MA_case), method = "REML", test = "t"))
# 
# # MMA_power.F_RR3 <- with(power.F_summary_RR, rma.MV(yi = Mean, v = se.F_mean, random = list(~1|Study, ~1|MA_case), method = "REML", test = "t"))
# 
# 
# #---------------------- (2) type S error -----------------------#
# power.F.S_summary_RR <- cbind(power.F.S_summary_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.S_summary_RR$approach_RR <- factor(power.F.S_summary_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# MMA_power.F.S_RR.approach <- with(power.F.S_summary_RR, rma(yi = Mean, sei = se.F.S_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.S_RR.stressor <- with(power.F.S_summary_RR, rma(yi = Mean, sei = se.F.S_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F.S_RR <- with(power.F.S_summary_RR, rma(yi = Mean, sei = se.F.S_mean,   method = "REML", test = "t"))
# 
# 
# 
# #-------------- (3) type M error (overestimate ratio) -------------#
# power.F.M_summary_RR <- cbind(power.F.M_summary_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_RR$approach_RR <- factor(power.F.M_summary_RR$approach_RR, levels=c("O", "E", "B"))
# 
# MMA_power.F.M_RR.approach <- with(power.F.M_summary_RR, rma(yi = Mean, sei = se.F.M_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.M_RR.stressor <- with(power.F.M_summary_RR, rma(yi = Mean, sei = se.F.M_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F.M_RR <- with(power.F.M_summary_RR, rma(yi = Mean, sei = se.F.M_mean,   method = "REML", test = "t")) 
# 
# MMA_power.F.M2_RR <- with(power.F.M2_summary_RR, rma(yi = Mean, sei = se.F.M2_mean,   method = "REML", test = "t"))



# #----------------------------------------------------------------#
# #                 (ii) effect size specific effect as true effect
# #----------------------------------------------------------------#
# 
# 
# #--------------------- (1) two tailed power ---------------------#
# power.R_summary_RR <- cbind(power.R_summary_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.R_summary_RR$approach_RR <- factor(power.R_summary_RR$approach_RR, levels=c("O", "E", "B"))
# 
# MMA_power.R_RR.approach <- with(power.R_summary_RR, rma(yi = Mean, sei = se.R_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.R_RR.stressor <- with(power.R_summary_RR, rma(yi = Mean, sei = se.R_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# 
# MMA_power.R_RR <- with(power.R_summary_RR, rma(yi = Mean, sei = se.R_mean,   method = "REML", test = "t"))
# 
# 
# 
# #---------------------- (2) type S error -----------------------#
# power.R.S_summary_RR <- cbind(power.R.S_summary_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.R.S_summary_RR$approach_RR <- factor(power.R.S_summary_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# MMA_power.R.S_RR.approach <- with(power.R.S_summary_RR, rma(yi = Mean, sei = se.R.S_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.R.S_RR.stressor <- with(power.R.S_summary_RR, rma(yi = Mean, sei = se.R.S_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.R.S_RR <- with(power.R.S_summary_RR, rma(yi = Mean, sei = se.R.S_mean,   method = "REML", test = "t"))
# 
# 
# 
# #-------------- (3) type M error (overestimate ratio) -------------#
# power.R.M_summary_RR <- cbind(power.R.M_summary_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.R.M_summary_RR$approach_RR <- factor(power.R.M_summary_RR$approach_RR, levels=c("O", "E", "B"))
# 
# MMA_power.R.M_RR.approach <- with(power.R.M_summary_RR, rma(yi = Mean, sei = se.R.M_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.R.M_RR.stressor <- with(power.R.M_summary_RR, rma(yi = Mean, sei = se.R.M_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.R.M_RR <- with(power.R.M_summary_RR, rma(yi = Mean, sei = se.R.M_mean,   method = "REML", test = "t")) # median rather than mean
# 
# MMA_power.R.M2_RR <- with(power.R.M2_summary_RR, rma(yi = Mean, sei = se.R.M2_mean,   method = "REML", test = "t"))



```



### calculate replicates of E vs. O
```{r}

# replicates per group
n_experiment <- (individual_est_SMD[individual_est_SMD$approach_SMD == "E",]$n_total_SMD)/2
mean(n_experiment)


n_observation <- (individual_est_SMD[individual_est_SMD$approach_SMD == "O",]$n_total_SMD)/2
mean(n_observation)



# convert to dataframe
n_observation <- data.frame(n_observation)

ggplot(data=n_observation, aes(n_observation)) + geom_histogram(binwidth=1.5, color='black', fill='skyblue1') +
  geom_vline(aes(xintercept=25), color="red", linetype="dashed", size=1) +
  #scale_x_continuous(breaks=seq(0, 10, 1)) +
  labs(x = "Replicates (sample sizes) in non-manipulative observations", y = "Frequency") +
  theme_cowplot()+
  annotate("text", x = 55, y = 150, label = "mean = 25", size=3.5) -> n_observation.p
  
png(filename = "./Figures/n_observation.p.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
n_observation.p
dev.off()



# convert to dataframe
n_experiment <- data.frame(n_experiment)

ggplot(data=n_experiment, aes(n_experiment)) + geom_histogram(binwidth=0.25, color='black', fill='skyblue1') +
  geom_vline(aes(xintercept=10), color="red", linetype="dashed", size=1) +
  #scale_x_continuous(breaks=seq(0, 10, 1)) +
  labs(x = "Replicates (sample sizes) in manipulative experiments", y = "Frequency") +
  theme_cowplot()+
  annotate("text", x = 13, y = 200, label = "mean = 10", size=3.5) -> n_experiment.p

png(filename = "./Figures/n_experiment.p.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
n_experiment.p
dev.off()

            
```





### magnitude of lnRR*, lnRR, SMD, SMDH, lnVR and lnCVR
```{r}

# save(model_est_SMD,file = here("data","model_est_SMD.RData"))
# save(model_est_adjusted_SMD,file = here("data","model_est_adjusted_SMD.RData"))
# save(model_est_adjusted_SMD.esz,file = here("data","model_est_adjusted_SMD.esz.RData"))
# 
# 
# save(model_est_RR,file = here("data","model_est_RR.RData"))
# save(model_est_adjusted_RR,file = here("data","model_est_adjusted_RR.RData"))
# save(model_est_lnrr,file = here("data","model_est_lnrr.RData"))
# save(model_est_adjusted_lnrr,file = here("data","model_est_adjusted_lnrr.RData"))
# save(model_est_SMDH,file = here("data","model_est_SMDH.RData"))
# save(model_est_adjusted_SMDH,file = here("data","model_est_adjusted_SMDH.RData"))
# save(model_est_VR,file = here("data","model_est_VR.RData"))
# save(model_est_CVR,file = here("data","model_est_CVR.RData"))




# custom function for extracting mean and CI from each metafor model
estimates.CI <- function(model){
  db.mf <- data.frame(round(model$b,3),row.names = 1:nrow(model$b))
  db.mf <- cbind(db.mf,round(model$ci.lb,3),round(model$ci.ub,3),row.names(model$b))
  names(db.mf) <- c("mean","lower","upper","estimate")
  return(db.mf[,c("estimate","mean","lower","upper")])
}


# lnRR*
## absoulte value of mean
model_est_RR$abs_mean <- abs(model_est_RR$mu_RR)
## folded sampling variance
### get orignal sampling variance first
model_est_RR$variance <- (model_est_RR$SE_RR)^2
model_est_RR$folded_v <- folded_error(model_est_RR$mu_RR, model_est_RR$variance)

## meta-meta-analysis
MMA_magnitude_RR <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_RR) # or rma.uni(yi = abs_mean, sei = sqrt(folded_v), test = "t", method = "REML", data = model_est_RR)

## meta-regression
### label approach for each meta-analysis
model_est_RR$approach <- c("E","E","E","E","E","E","E","O","O","O","O","O","E","E","E","O","O","O","B","O","O","E","E","E","E","E","E","E","B","O")

model_est_RR$approach <- factor(model_est_RR$approach, levels = rev(c("E", "O", "B")))
### we only need to estimate effects for experiment and observation. So we excluded "both" when fitting models. We did the same things for other effect sizes
MMA_magnitude_regression_RR <- rma(yi = abs_mean, vi = folded_v, mods = ~relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_RR[model_est_RR$approach != "B",]) 




# adjusted_lnRR*
## absoulte value of mean
model_est_adjusted_RR$abs_mean <- abs(model_est_adjusted_RR$mu_RR)
## folded sampling variance
### get orignal sampling variance first
model_est_adjusted_RR$variance <- (model_est_adjusted_RR$SE_RR)^2
model_est_adjusted_RR$folded_v <- folded_error(model_est_adjusted_RR$mu_RR, model_est_adjusted_RR$variance)

## meta-meta-analysis
MMA_magnitude_adjusted_RR <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_adjusted_RR) 
## meta-regression
### label approach for each meta-analysis
model_est_adjusted_RR$approach <- c("E","E","E","E","E","E","E","O","O","O","O","O","E","E","E","O","O","O","B","O","O","E","E","E","E","E","E","E","B","O")
model_est_adjusted_RR$approach <- factor(model_est_adjusted_RR$approach, levels = rev(c("E", "O", "B")))

MMA_magnitude_regression_adjusted_RR <- rma(yi = abs_mean, vi = folded_v, mods = ~relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_adjusted_RR[model_est_adjusted_RR$approach != "B",])



# lnrr
## absoulte value of mean
model_est_lnrr$abs_mean <- abs(model_est_lnrr$mu_lnrr)
## folded sampling variance
### get orignal sampling variance first
model_est_lnrr$variance <- (model_est_lnrr$SE_lnrr)^2
model_est_lnrr$folded_v <- folded_error(model_est_lnrr$mu_lnrr, model_est_lnrr$variance)

## meta-meta-analysis
MMA_magnitude_lnrr <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_lnrr) 
## meta-regression
### label approach for each meta-analysis
model_est_lnrr$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")

model_est_lnrr$approach <- factor(model_est_lnrr$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_lnrr <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_lnrr) 



#decrease percentage of bias-corrected estimates
100*(estimates.CI(MMA_magnitude_adjusted_RR)[2] - estimates.CI(MMA_magnitude_RR)[2]) / estimates.CI(MMA_magnitude_adjusted_RR)[2]

100*(estimates.CI(MMA_magnitude_adjusted_lnrr)[2] - estimates.CI(MMA_magnitude_lnrr)[2]) / estimates.CI(MMA_magnitude_adjusted_lnrr)[2] 

100*(estimates.CI(MMA_magnitude_adjusted_SMD)[2] - estimates.CI(MMA_magnitude_SMD)[2]) / estimates.CI(MMA_magnitude_adjusted_SMD)[2] 

100*(estimates.CI(MMA_magnitude_adjusted_SMDH)[2] - estimates.CI(MMA_magnitude_SMDH)[2]) / estimates.CI(MMA_magnitude_adjusted_SMDH)[2] 

# adjusted_lnrr
## absoulte value of mean
model_est_adjusted_lnrr$abs_mean <- abs(model_est_adjusted_lnrr$mu_lnrr)
## folded sampling variance
### get orignal sampling variance first
model_est_adjusted_lnrr$variance <- (model_est_adjusted_lnrr$SE_lnrr)^2
model_est_adjusted_lnrr$folded_v <- folded_error(model_est_adjusted_lnrr$mu_lnrr, model_est_adjusted_lnrr$variance)

## meta-meta-analysis
MMA_magnitude_adjusted_lnrr <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_adjusted_lnrr) 
## meta-regression
### label approach for each meta-analysis
model_est_adjusted_lnrr$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")

model_est_adjusted_lnrr$approach <- factor(model_est_adjusted_lnrr$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_adjusted_lnrr <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_adjusted_lnrr) 




# SMD
## absoulte value of mean
model_est_SMD$abs_mean <- abs(model_est_SMD$mu_SMD)
## folded sampling variance
### get orignal sampling variance first
model_est_SMD$variance <- (model_est_SMD$SE_SMD)^2
model_est_SMD$folded_v <- folded_error(model_est_SMD$mu_SMD, model_est_SMD$variance)

## meta-meta-analysis
MMA_magnitude_SMD <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_SMD) 
## meta-regression
### label approach for each meta-analysis
model_est_SMD$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
model_est_SMD$approach <- factor(model_est_SMD$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_SMD <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_SMD) 


# adjusted_SMD
## absoulte value of mean
model_est_adjusted_SMD$abs_mean <- abs(model_est_adjusted_SMD$mu_SMD)
## folded sampling variance
### get orignal sampling variance first
model_est_adjusted_SMD$variance <- (model_est_adjusted_SMD$SE_SMD)^2
model_est_adjusted_SMD$folded_v <- folded_error(model_est_adjusted_SMD$mu_SMD, model_est_adjusted_SMD$variance)

## meta-meta-analysis
MMA_magnitude_adjusted_SMD <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_adjusted_SMD) 
## meta-regression
### label approach for each meta-analysis
model_est_adjusted_SMD$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
model_est_adjusted_SMD$approach <- factor(model_est_adjusted_SMD$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_adjusted_SMD <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_adjusted_SMD) 



# SMDH
## absoulte value of mean
model_est_SMDH$abs_mean <- abs(model_est_SMDH$mu_SMDH)
## folded sampling variance
### get orignal sampling variance first
model_est_SMDH$variance <- (model_est_SMDH$SE_SMDH)^2
model_est_SMDH$folded_v <- folded_error(model_est_SMDH$mu_SMDH, model_est_SMDH$variance)

## meta-meta-analysis
MMA_magnitude_SMDH <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_SMDH) 
## meta-regression
### label approach for each meta-analysis
model_est_SMDH$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
model_est_SMDH$approach <- factor(model_est_SMDH$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_SMDH <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_SMDH) 





# adjusted_SMDH
## absoulte value of mean
model_est_adjusted_SMDH$abs_mean <- abs(model_est_adjusted_SMDH$mu_SMDH)
## folded sampling variance
### get orignal sampling variance first
model_est_adjusted_SMDH$variance <- (model_est_adjusted_SMDH$SE_SMDH)^2
model_est_adjusted_SMDH$folded_v <- folded_error(model_est_adjusted_SMDH$mu_SMDH, model_est_adjusted_SMDH$variance)

## meta-meta-analysis
MMA_magnitude_adjusted_SMDH <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_adjusted_SMDH) 
## meta-regression
### label approach for each meta-analysis
model_est_adjusted_SMDH$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
model_est_SMD$approach <- factor(model_est_SMD$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_SMD <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_SMD) 




# lnVR
## absoulte value of mean
model_est_VR$abs_mean <- abs(model_est_VR$mu_VR)
## folded sampling variance
### get orignal sampling variance first
model_est_VR$variance <- (model_est_VR$SE_VR)^2
model_est_VR$folded_v <- folded_error(model_est_VR$mu_VR, model_est_VR$variance)

## meta-meta-analysis
MMA_magnitude_VR <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_VR) 
## meta-regression
### label approach for each meta-analysis
model_est_VR$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
model_est_lnrr$approach <- factor(model_est_lnrr$approach, levels = rev(c("O", "E")))

MMA_magnitude_regression_lnrr <- rma(yi = abs_mean, vi = folded_v, mods = ~ relevel(approach, ref = "O") -1, test = "t", method = "REML", data = model_est_lnrr) 




# lnCVR
## absoulte value of mean
model_est_CVR$abs_mean <- abs(model_est_CVR$mu_CVR)
## folded sampling variance
### get orignal sampling variance first
model_est_CVR$variance <- (model_est_CVR$SE_CVR)^2
model_est_CVR$folded_v <- folded_error(model_est_CVR$mu_CVR, model_est_CVR$variance)

## meta-meta-analysis
MMA_magnitude_CVR <- rma(yi = abs_mean, vi = folded_v, test = "t", method = "REML", data = model_est_CVR) 
## meta-regression
### label approach for each meta-analysis
model_est_CVR$approach <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
MMA_magnitude_regression_CVR <- rma(yi = abs_mean, vi = folded_v, mods = ~ approach -1, test = "t", method = "REML", data = model_est_CVR)





# MMA_magnitude_RR_results <- mod_results(MMA_magnitude_RR, mod = "Int")
# orchard_plot(MMA_magnitude_RR_results, mod = "Int", xlab = "lnRR*") + scale_y_discrete(labels = c("MAOM")) +
#   ggtitle("(A)")


MMA_magnitude_RR_results <- mod_results(MMA_magnitude_RR, mod = "Int")
MMA_magnitude_lnrr_results <- mod_results(MMA_magnitude_lnrr, mod = "Int")
MMA_magnitude_SMD_results <- mod_results(MMA_magnitude_SMD, mod = "Int")
MMA_magnitude_SMDH_results <- mod_results(MMA_magnitude_SMDH, mod = "Int")

MMA_magnitude_mean_results <- submerge(MMA_magnitude_SMDH_results, MMA_magnitude_SMD_results, MMA_magnitude_lnrr_results,  MMA_magnitude_RR_results, mix = TRUE)


# # reorder column names
# MMA_magnitude_mean_results$mod_table$name <-  factor(MMA_magnitude_mean_results$mod_table$name, levels = rev(c("Intrcpt1","Intrcpt2", "Intrcpt3", "Intrcpt4")))

table_results <- MMA_magnitude_mean_results$mod_table

orchard_magnitude_mean <- orchaRd::orchard_plot(MMA_magnitude_mean_results, mod = "Int", xlab = "The effect of stressors on ecosystem response magnitude", k = FALSE, transfm = "none", angle = 0)+ xlim(-1.5, 8) + scale_y_discrete(labels = c("SMDH", "SMD","lnRR", "lnRR*")) + labs(title = "(A)", y = "") +
  theme(axis.text.x = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, colour = "black")) +
annotate(geom = "text",
x = 5.3, y = 1.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[1]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[1]], 3),  " to ", round(table_results$upperCL[[1]], 4), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[1]], 3), " to ",
round(table_results$upperPR[[1]], 3), "]")) +
annotate(geom = "text", x = -1, y = 1.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 5.3, y = 2.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[2]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[2]], 3),  " to ", round(table_results$upperCL[[2]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[2]], 3), " to ",
round(table_results$upperPR[[2]], 3), "]")) +
annotate(geom = "text", x = -1, y = 2.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 5.3, y = 3.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[3]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[3]], 3),  " to ", round(table_results$upperCL[[3]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[3]], 3), " to ",
round(table_results$upperPR[[3]], 3), "]")) +
annotate(geom = "text", x = -1, y = 3.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 5.3, y = 4.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[4]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[4]], 3),  " to ", round(table_results$upperCL[[4]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[4]], 3), " to ",
round(table_results$upperPR[[4]], 3), "]")) +
annotate(geom = "text", x = -1, y = 4.2, size = 3, label = paste("italic(k)==", "30"), parse = TRUE) 

 # theme(axis.text.x = element_text(size = 14),
 #        axis.text.y = element_text(size = 15),
 #        axis.title = element_text(size = 12))

  
  


png(filename = "./Figures/orchard_magnitude_mean.png", width = 4, height = 4, units = "in", type = "windows", res = 400)
orchard_magnitude_mean
dev.off() 




MMA_magnitude_adjusted_RR_results <- mod_results(MMA_magnitude_adjusted_RR, mod = "Int")
MMA_magnitude_adjusted_lnrr_results <- mod_results(MMA_magnitude_adjusted_lnrr, mod = "Int")
MMA_magnitude_adjusted_SMD_results <- mod_results(MMA_magnitude_adjusted_SMD, mod = "Int")
MMA_magnitude_adjusted_SMDH_results <- mod_results(MMA_magnitude_adjusted_SMDH, mod = "Int")

MMA_magnitude_adjusted_mean_results <- submerge(MMA_magnitude_adjusted_SMDH_results, MMA_magnitude_adjusted_SMD_results, MMA_magnitude_adjusted_lnrr_results,  MMA_magnitude_adjusted_RR_results, mix = TRUE)


table_results <- MMA_magnitude_adjusted_mean_results$mod_table

orchard_magnitude_adjusted_mean <- orchard_plot(MMA_magnitude_adjusted_mean_results, mod = "Int", xlab = "Publication bias corrected ecosystem response magnitude", transfm = "none", angle = 0, k = FALSE,) + xlim(-1.5, 8) + scale_y_discrete(labels = c("SMDH", "SMD","lnRR", "lnRR*")) +
  labs(title = "(B)", y = "") + 
  theme(axis.text.x = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, colour = "black")) +
  annotate(geom = "text",
x = 5.3, y = 1.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[1]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[1]], 3),  " to ", round(table_results$upperCL[[1]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[1]], 3), " to ",
round(table_results$upperPR[[1]], 3), "]")) +
annotate(geom = "text", x = -1, y = 1.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 5.3, y = 2.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[2]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[2]], 3),  " to ", round(table_results$upperCL[[2]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[2]], 3), " to ",
round(table_results$upperPR[[2]], 3), "]")) +
annotate(geom = "text", x = -1, y = 2.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 5.3, y = 3.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[3]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[3]], 3),  " to ", round(table_results$upperCL[[3]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[3]], 3), " to ",
round(table_results$upperPR[[3]], 3), "]")) +
annotate(geom = "text", x = -1, y = 3.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 5.3, y = 4.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[4]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[4]], 3),  " to ", round(table_results$upperCL[[4]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[4]], 3), " to ",
round(table_results$upperPR[[4]], 3), "]")) +
annotate(geom = "text", x = -1, y = 4.2, size = 3, label = paste("italic(k)==", "30"), parse = TRUE) 
 # theme(axis.text.x = element_text(size = 14),
 #        axis.text.y = element_text(size = 15),
 #        axis.title = element_text(size = 12))


png(filename = "./Figures/orchard_magnitude_adjusted_mean.png", width = 4, height = 4, units = "in", type = "windows", res = 400)
orchard_magnitude_adjusted_mean
dev.off() 



orchard_magnitude_mean_all <- orchard_magnitude_mean + orchard_magnitude_adjusted_mean + plot_layout(ncol = 2, nrow = 1, widths = 8, heights = 4)

png(filename = "./Figures/orchard_magnitude_mean_all.png", width = 10, height = 5, units = "in", type = "windows", res = 400)
orchard_magnitude_mean_all
dev.off() 








MMA_magnitude_VR_results <- mod_results(MMA_magnitude_VR, mod = "Int")
MMA_magnitude_CVR_results <- mod_results(MMA_magnitude_CVR, mod = "Int")

MMA_magnitude_variance_results <- submerge(MMA_magnitude_CVR_results, MMA_magnitude_VR_results, mix = TRUE)

table_results <- MMA_magnitude_variance_results$mod_table

orchard_magnitude_variance <- orchaRd::orchard_plot(MMA_magnitude_variance_results, mod = "Int", xlab = "The effect of stressors on ecosystem response variability", k = FALSE, transfm = "none", angle = 0)+ xlim(-0.19, 1.2) + scale_y_discrete(labels = c("lnCVR", "lnVR")) + labs(title = "(C)", y = "") +
  theme(axis.text.x = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, colour = "black")) +
annotate(geom = "text",
x = 0.73, y = 1.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[1]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[1]], 3),  " to ", round(table_results$upperCL[[1]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[1]], 3), " to ",
round(table_results$upperPR[[1]], 3), "]")) +
annotate(geom = "text", x = -0.1, y = 1.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) +
  
annotate(geom = "text",
x = 0.73, y = 2.2, size = 3,label = paste0("Estimate = ", round(table_results$estimate[[2]],
3), "\n", "[95% CI = ", round(table_results$lowerCL[[2]], 3),  " to ", round(table_results$upperCL[[2]], 3), "]", "\n", "[95% PI = ",
round(table_results$lowerPR[[2]], 3), " to ",
round(table_results$upperPR[[2]], 3), "]")) +
annotate(geom = "text", x = -0.1, y = 2.2, size = 3, label = paste("italic(k)==", "12"), parse = TRUE) 
  # theme(axis.text.x = element_text(size = 12),
  #       axis.text.y = element_text(size = 12),
  #       axis.title = element_text(size = 12))
  
  


png(filename = "./Figures/orchard_magnitude_variance.png", width = 4, height = 4, units = "in", type = "windows", res = 400)
orchard_magnitude_variance
dev.off() 







# png(filename = "./Figures/orchard_magnitude.png", width = 5, height = 12, units = "in", type = "windows", res = 400)
# orchard_magnitude_mean + orchard_magnitude_adjusted_mean + orchard_magnitude_variance + plot_layout(ncol = 1, nrow = 3) # widths = 6, heights = 12
# dev.off() 



pdf(file = "./Figures/fig.2_magnitude.pdf", width = 4.5, height = 11)
  orchard_magnitude_mean + orchard_magnitude_adjusted_mean + orchard_magnitude_variance + plot_layout(nrow = 3, ncol = 1, heights =  c(1,1,0.7))
dev.off()


```






### 2. Adjusted-lnRR* 
(i.e. PET-PEESE for lnRR or meta-regression model for SMD)

#### 2.1 Estimate adjusted-lnRR* (bias-corrected version)

```{r}

# intercepts from meta-regression using SE as moderator 
#load(here("data","model_est_PET_PEESE_RR.sei.intercept.RData"))
# slopes from meta-regression using variance as moderator     
#load(here("data","model_est_PET_PEESE_RR.sei.slope.RData"))
# intercepts from meta-regression using SE as moderator 
#load(here("data","model_est_PET_PEESE_RR.var.intercept.RData"))
# slopes from meta-regression using variance as moderator 
#load(here("data","model_est_PET_PEESE_RR.var.slopet.RData"))

#***************************************************************#
#                       PET-PEESE approach                      #
#***************************************************************#

#----------------------------------------------------------------#
#              first-stage: using PET to model SE                #
#----------------------------------------------------------------#


model_list_PET_PEESE_RR.sei <- list() # rep(NA, length(dat_list))
for (i in 1:length(dat_list)) {
 model_list_PET_PEESE_RR.sei[i] <- rma.mv(data = dat_list[[i]], yi = yi, V = vi, mods = ~ sqrt(vi),random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

# get intercept
model_est_PET_PEESE_RR.sei.intercept <- data.frame(MA_case=model_est_RR$MA_case,
                  mu_RR=sapply(model_list_PET_PEESE_RR.sei, function(x) x$beta[1]),
                  SE_RR=sapply(model_list_PET_PEESE_RR.sei, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_RR.sei, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_RR.sei, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_RR.sei, function(x) x$pval)[c(seq(1,60,2))]) # odd columns for intercept's p-value

#save(model_est_PET_PEESE_RR.sei.intercept,file = here("data","model_est_PET_PEESE_RR.intercept.slope.RData"))
#load(here("data","model_est_PET_PEESE_RR.sei.intercept.RData"))


# get slope
model_est_PET_PEESE_RR.sei.slope <- data.frame(MA_case=model_est_RR$MA_case,
                  mu_RR=sapply(model_list_PET_PEESE_RR.sei, function(x) x$beta[2]),
                  SE_RR=sapply(model_list_PET_PEESE_RR.sei, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_RR.sei, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_RR.sei, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_RR.sei, function(x) x$pval)[c(seq(2,60,2))]) # even columns for slope's p-value



#save(model_est_PET_PEESE_RR.sei.slope,file = here("data","model_est_PET_PEESE_RR.sei.slope.RData"))
#load(here("data","model_est_PET_PEESE_RR.sei.slope.RData"))

#----------------------------------------------------------------#
#        second-stage: using PEESE to model variance (SE^2)      #
#----------------------------------------------------------------#

# 26th meta-analysis has problem in optimization - It means design matrix is not invertible and therefore can't be used to develop a regression model. This results from linearly dependent columns, i.e. strongly correlated variables (https://stats.stackexchange.com/questions/76488/error-system-is-computationally-singular-when-running-a-glm)
# So we have to seperately fit the datsets 1-25, and 27-30, and then combine thme into a list

model_list_PET_PEESE_RR.var1_25 <- list() 
for (i in 1:25) {
 model_list_PET_PEESE_RR.var1_25[i] <- rma.mv(data = dat_list[[i]], yi = yi, V = vi, mods = ~ vi,random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

model_list_PET_PEESE_RR.var27_30 <- list() 
for (i in 27:30) {
 model_list_PET_PEESE_RR.var27_30[i] <- rma.mv(data = dat_list[[i]], yi = yi, V = vi, mods = ~ vi,random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

# append(model_list_PET_PEESE_RR.var1_25, model_list_PET_PEESE_RR.var27_30[c(27:30)])

# get intercept1_25
model_est_PET_PEESE_RR.var.intercept1_25 <- data.frame(MA_case=model_est_RR$MA_case[1:25],
                  mu_RR=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$beta[1]),
                  SE_RR=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$pval)[c(seq(1,50,2))]) # odd columns for intercept's p-value

# get intercept26
model_est_PET_PEESE_RR.var.intercept26 <- data.frame(MA_case=model_est_PET_PEESE_RR.sei.intercept$MA_case[26],
                  mu_RR=0,
                  SE_RR=0,
                  ll_NHST=0,
                  ul_NHST=0,
                  p_value=1) # because we could not fit PEESE model, so we can not obtain corresponding estimates. We will use estimates from PET, so here we arbitaryly assume estiamtes from PEESE,

# get intercept27_30
model_est_PET_PEESE_RR.var.intercept27_30 <- data.frame(MA_case=model_est_RR$MA_case[27:30],
                  mu_RR=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$beta[1]),
                  SE_RR=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$pval)[c(seq(1,8,2))]) # odd columns for intercept's p-value


# combine intercept
model_est_PET_PEESE_RR.var.intercept <- rbind(model_est_PET_PEESE_RR.var.intercept1_25, model_est_PET_PEESE_RR.var.intercept26, model_est_PET_PEESE_RR.var.intercept27_30)

# save(model_est_PET_PEESE_RR.var.intercept,file = here("data","model_est_PET_PEESE_RR.var.intercept.RData"))
#load(here("data","model_est_PET_PEESE_RR.var.intercept.RData"))

#get slope1_25
model_est_PET_PEESE_RR.var.slope1_25 <- data.frame(MA_case=model_est_RR$MA_case[1:25],
                  mu_RR=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$beta[2]),
                  SE_RR=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_RR.var1_25, function(x) x$pval)[c(seq(2,50,2))]) # odd columns for slope's p-value


#get slope26
model_est_PET_PEESE_RR.var.slope26 <- data.frame(MA_case=model_est_PET_PEESE_RR.sei.slope$MA_case[26],
                  mu_RR=0,
                  SE_RR=0,
                  ll_NHST=0,
                  ul_NHST=0,
                  p_value=1) # because we could not fit PEESE model, so w can not obtain corresponding estimates. We will use estimates from PET, so here we arbitaryly assume  estiamtes from PEESE,


#get slope27_30
model_est_PET_PEESE_RR.var.slope27_30 <- data.frame(MA_case=model_est_RR$MA_case[27:30],
                  mu_RR=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$beta[2]),
                  SE_RR=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_RR.var27_30[27:30], function(x) x$pval)[c(seq(2,8,2))]) # odd columns for slope's p-value


# combine slope
model_est_PET_PEESE_RR.var.slope <- rbind(model_est_PET_PEESE_RR.var.slope1_25, model_est_PET_PEESE_RR.var.slope26, model_est_PET_PEESE_RR.var.slope27_30)

#save(model_est_PET_PEESE_RR.var.slope,file = here("data","model_est_PET_PEESE_RR.var.slope.RData"))
#load(here("data","model_est_PET_PEESE_RR.var.slopet.RData"))


# using PET’s intercept (se as moderator) when slope is not sig but PEEESE’s intercept (variance or se^2 as moderator) if PET’s slope is sig

model_est_PET_PEESE_RR.sei.intercept$id <- c(1:30)
model_est_PET_PEESE_RR.sei.slope$id <- c(1:30)
model_est_PET_PEESE_RR.var.intercept$id <- c(1:30)
model_est_PET_PEESE_RR.var.slope$id <- c(1:30)


model_est_PET_PEESE_RR.sei.slope.sig <- model_est_PET_PEESE_RR.sei.slope %>% subset(p_value < 0.05) 

model_est_PET_PEESE_RR.sei.slope.nonsig <- model_est_PET_PEESE_RR.sei.slope %>% subset(p_value > 0.05)

# get location of PET's sig slope and non-sig slope, respectively
location.sig <- which(model_est_PET_PEESE_RR.sei.slope$p_value < 0.05)
location.nonsig <- which(model_est_PET_PEESE_RR.sei.slope$p_value > 0.05)


# get the intercpet from PEESE (when PET’s slope is sig) and PET (when PET’s slope is nonsig)

model_est_PET_PEESE_RR <- rbind(model_est_PET_PEESE_RR.sei.intercept[location.nonsig,],model_est_PET_PEESE_RR.var.intercept[location.sig,]) 

model_est_PET_PEESE_RR <- model_est_PET_PEESE_RR[order(model_est_PET_PEESE_RR$id),] # reorder according to the sequences of meta-analyses

# replace 26th case
model_est_PET_PEESE_RR[26,] <- model_est_PET_PEESE_RR.sei.intercept[26,]

# obtain absolute value
model_est_PET_PEESE_RR2 <- model_est_PET_PEESE_RR
model_est_PET_PEESE_RR2$mu_RR <- abs(model_est_PET_PEESE_RR$mu_RR)

model_est_RR2 <- model_est_RR
model_est_RR2$mu_RR <- abs(model_est_RR$mu_RR)



# make comparision plot to compare original estimates and corrected estimates
# creat a table for paired comparision of meta-analysis overall mean (MAOM) and bias-corrected estimate (cMAOM)
## estimate <- c(rep('MAOM', 15), rep('cMAOM', 15))

dummy <- rep("Dummy", 30)
 wide.data <- 
   tibble::tibble(
     MAOM = model_est_RR2$mu_RR,
     cMAOM = model_est_PET_PEESE_RR2$mu_RR,
     Dummy = dummy, ID = 1:30, MA_case = model_est_PET_PEESE_RR2$MA_case)

include.point <- which((wide.data$`cMAOM` - wide.data$MAOM)<0)

wide.data3 <- wide.data[include.point,]


my.data3 <- 
  wide.data3 %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired3 <- 
  my.data3 %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot3 <- two.group.paired3 %>% 
  cohens_d() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic means (lnRR*)",
      effsize.ylabel = "Differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot3.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot3 
dev.off()




# 
# 
# my.data   <- 
#   wide.data %>%
#   tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)
# 
# 
# two.group.paired <- 
#   my.data %>%
#   dabest(Group, Measurement, 
#          idx = c("Naive", "PET-PEESE"), 
#          paired = TRUE, id.col = ID)
# 
# paired.plot <- two.group.paired %>% 
#   mean_diff() %>% 
#   plot(#rawplot.ylim = c(-2, 1),
#        #effsize.ylim = c(-2, 1),
#        #rawplot.markersize = 1,
#        #rawplot.groupwidth = 0.4,
#       rawplot.ylabel = "Meta-analytic estimate (lnRR)",
#       effsize.ylabel = "Mean differences (bootstrap resampling)",
#       axes.title.fontsize = 14, # default is 14
#       palette = c("Dark2")
#       )
# 
# 
# png(filename = "./Figures/paired.plot.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
# paired.plot 
# dev.off()
# 
# 
# 
# 
# 
# model_est_PET_PEESE_RR.var.intercept[26,] <- model_est_PET_PEESE_RR.sei.intercept[26,]
# 
# model_est_PET_PEESE_RR.var.intercept2 <- model_est_PET_PEESE_RR.var.intercept
# 
# model_est_PET_PEESE_RR.var.intercept2$mu_RR <- abs(model_est_PET_PEESE_RR.var.intercept2$mu_RR)
# 
# 
# wide.data2 <- 
#   tibble::tibble(
#     Naive = model_est_RR2$mu_RR,
#     `PET-PEESE` = model_est_PET_PEESE_RR.var.intercept2$mu_RR,
#     Dummy = dummy, ID = 1:30, MA_case = model_est_PET_PEESE_RR.var.intercept2$MA_case)
# 
# 
# my.data2 <- 
#   wide.data2 %>%
#   tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)
# 
# 
# two.group.paired2 <- 
#   my.data2 %>%
#   dabest(Group, Measurement, 
#          idx = c("Naive", "PET-PEESE"), 
#          paired = TRUE, id.col = ID)
# 
# paired.plot2 <- two.group.paired2 %>% 
#   mean_diff() %>% 
#   plot(#rawplot.ylim = c(-2, 1),
#        #effsize.ylim = c(-2, 1),
#        #rawplot.markersize = 1,
#        #rawplot.groupwidth = 0.4,
#       rawplot.ylabel = "Meta-analytic estimate (lnRR)",
#       effsize.ylabel = "Mean differences (bootstrap resampling)",
#       axes.title.fontsize = 14, # default is 14
#       palette = c("Dark2")
#       )
# 
# 
# png(filename = "./Figures/paired.plot2.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
# paired.plot2 
# dev.off()

```



#### 2.2 Compile datasets for adjusted lnRR*
We only had 21 meta-analyses showing the correct direction slope. For the left 9 meta-analyses, we used original meta-analysis overall mean

```{r}

# model estimates for adjusted lnRR
#load(here("data","model_est_adjusted_RR.RData"))
# models for adjusted lnRR
#load(here("data","model_list_adjusted_RR.RData")) 


# used models: model_list_RR, model_list_PET_PEESE_RR.sei, model_list_PET_PEESE_RR.var1_25, model_list_PET_PEESE_RR.var27_30


# using estimates from model_est_PET_PEESE_RR if in a correct direction of slope. Otherwise it should use estimates from model_est_RR
model_est_adjusted_RR <- data.frame(MA_case=model_est_PET_PEESE_RR$MA_case,
                    mu_RR=c(model_est_PET_PEESE_RR$mu_RR[1],                                            model_est_PET_PEESE_RR$mu_RR[2],
                            model_est_PET_PEESE_RR$mu_RR[3],
                            model_est_RR$mu_RR[4],
                            model_est_RR$mu_RR[5],
                            model_est_RR$mu_RR[6],
                            model_est_PET_PEESE_RR$mu_RR[7],                                            model_est_PET_PEESE_RR$mu_RR[8],
                            model_est_PET_PEESE_RR$mu_RR[9],
                            model_est_RR$mu_RR[10],
                            model_est_PET_PEESE_RR$mu_RR[11],
                            model_est_RR$mu_RR[12],
                            model_est_PET_PEESE_RR$mu_RR[13],
                            model_est_PET_PEESE_RR$mu_RR[14],
                            model_est_PET_PEESE_RR$mu_RR[15],
                            model_est_RR$mu_RR[16],
                            model_est_RR$mu_RR[17],
                            model_est_PET_PEESE_RR$mu_RR[18],
                            model_est_PET_PEESE_RR$mu_RR[19],
                            model_est_PET_PEESE_RR$mu_RR[20],
                            model_est_PET_PEESE_RR$mu_RR[21],
                            model_est_PET_PEESE_RR$mu_RR[22],
                            model_est_PET_PEESE_RR$mu_RR[23],
                            model_est_RR$mu_RR[24],
                            model_est_PET_PEESE_RR$mu_RR[25],
                            model_est_PET_PEESE_RR$mu_RR[26],
                            model_est_PET_PEESE_RR$mu_RR[27],
                            model_est_PET_PEESE_RR$mu_RR[28],
                            model_est_PET_PEESE_RR$mu_RR[29],
                            model_est_RR$mu_RR[30]),
                    
                    SE_RR=c(model_est_PET_PEESE_RR$SE_RR[1],                                            model_est_PET_PEESE_RR$SE_RR[2],
                            model_est_PET_PEESE_RR$SE_RR[3],
                            model_est_RR$SE_RR[4],
                            model_est_RR$SE_RR[5],
                            model_est_RR$SE_RR[6],
                            model_est_PET_PEESE_RR$SE_RR[7],                                            model_est_PET_PEESE_RR$SE_RR[8],
                            model_est_PET_PEESE_RR$SE_RR[9],
                            model_est_RR$SE_RR[10],
                            model_est_PET_PEESE_RR$SE_RR[11],
                            model_est_RR$SE_RR[12],
                            model_est_PET_PEESE_RR$SE_RR[13],
                            model_est_PET_PEESE_RR$SE_RR[14],
                            model_est_PET_PEESE_RR$SE_RR[15],
                            model_est_RR$SE_RR[16],
                            model_est_RR$SE_RR[17],
                            model_est_PET_PEESE_RR$SE_RR[18],
                            model_est_PET_PEESE_RR$SE_RR[19],
                            model_est_PET_PEESE_RR$SE_RR[20],
                            model_est_PET_PEESE_RR$SE_RR[21],
                            model_est_PET_PEESE_RR$SE_RR[22],
                            model_est_PET_PEESE_RR$SE_RR[23],
                            model_est_RR$SE_RR[24],
                            model_est_PET_PEESE_RR$SE_RR[25],
                            model_est_PET_PEESE_RR$SE_RR[26],
                            model_est_PET_PEESE_RR$SE_RR[27],
                            model_est_PET_PEESE_RR$SE_RR[28],
                            model_est_PET_PEESE_RR$SE_RR[29],
                            model_est_RR$SE_RR[30]),
                    
                ll_NHST=c(model_est_PET_PEESE_RR$ll_NHST[1],                                            model_est_PET_PEESE_RR$ll_NHST[2],
                            model_est_PET_PEESE_RR$ll_NHST[3],
                            model_est_RR$ll_NHST[4],
                            model_est_RR$ll_NHST[5],
                            model_est_RR$ll_NHST[6],
                            model_est_PET_PEESE_RR$ll_NHST[7],                                          model_est_PET_PEESE_RR$ll_NHST[8],
                            model_est_PET_PEESE_RR$ll_NHST[9],
                            model_est_RR$ll_NHST[10],
                            model_est_PET_PEESE_RR$ll_NHST[11],
                            model_est_RR$ll_NHST[12],
                            model_est_PET_PEESE_RR$ll_NHST[13],
                            model_est_PET_PEESE_RR$ll_NHST[14],
                            model_est_PET_PEESE_RR$ll_NHST[15],
                            model_est_RR$ll_NHST[16],
                            model_est_RR$ll_NHST[17],
                            model_est_PET_PEESE_RR$ll_NHST[18],
                            model_est_PET_PEESE_RR$ll_NHST[19],
                            model_est_PET_PEESE_RR$ll_NHST[20],
                            model_est_PET_PEESE_RR$ll_NHST[21],
                            model_est_PET_PEESE_RR$ll_NHST[22],
                            model_est_PET_PEESE_RR$ll_NHST[23],
                            model_est_RR$ll_NHST[24],
                            model_est_PET_PEESE_RR$ll_NHST[25],
                            model_est_PET_PEESE_RR$ll_NHST[26],
                            model_est_PET_PEESE_RR$ll_NHST[27],
                            model_est_PET_PEESE_RR$ll_NHST[28],
                            model_est_PET_PEESE_RR$ll_NHST[29],
                            model_est_RR$ll_NHST[30]),
                
                  ul_NHST=c(model_est_PET_PEESE_RR$ul_NHST[1],                                          model_est_PET_PEESE_RR$ul_NHST[2],
                            model_est_PET_PEESE_RR$ul_NHST[3],
                            model_est_RR$ul_NHST[4],
                            model_est_RR$ul_NHST[5],
                            model_est_RR$ul_NHST[6],
                            model_est_PET_PEESE_RR$ul_NHST[7],                                          model_est_PET_PEESE_RR$ul_NHST[8],
                            model_est_PET_PEESE_RR$ul_NHST[9],
                            model_est_RR$ul_NHST[10],
                            model_est_PET_PEESE_RR$ul_NHST[11],
                            model_est_RR$ul_NHST[12],
                            model_est_PET_PEESE_RR$ul_NHST[13],
                            model_est_PET_PEESE_RR$ul_NHST[14],
                            model_est_PET_PEESE_RR$ul_NHST[15],
                            model_est_RR$ul_NHST[16],
                            model_est_RR$ul_NHST[17],
                            model_est_PET_PEESE_RR$ul_NHST[18],
                            model_est_PET_PEESE_RR$ul_NHST[19],
                            model_est_PET_PEESE_RR$ul_NHST[20],
                            model_est_PET_PEESE_RR$ul_NHST[21],
                            model_est_PET_PEESE_RR$ul_NHST[22],
                            model_est_PET_PEESE_RR$ul_NHST[23],
                            model_est_RR$ul_NHST[24],
                            model_est_PET_PEESE_RR$ul_NHST[25],
                            model_est_PET_PEESE_RR$ul_NHST[26],
                            model_est_PET_PEESE_RR$ul_NHST[27],
                            model_est_PET_PEESE_RR$ul_NHST[28],
                            model_est_PET_PEESE_RR$ul_NHST[29],
                            model_est_RR$ul_NHST[30]),
                
                  p_value=c(model_est_PET_PEESE_RR$p_value[1],                                          model_est_PET_PEESE_RR$p_value[2],
                            model_est_PET_PEESE_RR$p_value[3],
                            model_est_RR$p_value[4],
                            model_est_RR$p_value[5],
                            model_est_RR$p_value[6],
                            model_est_PET_PEESE_RR$p_value[7],                                          model_est_PET_PEESE_RR$p_value[8],
                            model_est_PET_PEESE_RR$p_value[9],
                            model_est_RR$p_value[10],
                            model_est_PET_PEESE_RR$p_value[11],
                            model_est_RR$p_value[12],
                            model_est_PET_PEESE_RR$p_value[13],
                            model_est_PET_PEESE_RR$p_value[14],
                            model_est_PET_PEESE_RR$p_value[15],
                            model_est_RR$p_value[16],
                            model_est_RR$p_value[17],
                            model_est_PET_PEESE_RR$p_value[18],
                            model_est_PET_PEESE_RR$p_value[19],
                            model_est_PET_PEESE_RR$p_value[20],
                            model_est_PET_PEESE_RR$p_value[21],
                            model_est_PET_PEESE_RR$p_value[22],
                            model_est_PET_PEESE_RR$p_value[23],
                            model_est_RR$p_value[24],
                            model_est_PET_PEESE_RR$p_value[25],
                            model_est_PET_PEESE_RR$p_value[26],
                            model_est_PET_PEESE_RR$p_value[27],
                            model_est_PET_PEESE_RR$p_value[28],
                            model_est_PET_PEESE_RR$p_value[29],
                            model_est_RR$p_value[30])) 

# replace SE by original SE (unconditional SE)
model_est_adjusted_RR$SE_RR <- model_est_RR$SE_RR

# using effective N based estimates where possible (using lnRR dataset's bias-corrected estimates to replace lnRR* dataset's bias-corrected estimates for 12 meta-analyses)
## using model_est_adjusted_lnrr$MA_case to check which meta-analyses should be replaced
model_est_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                    mu_RR=c(model_est_adjusted_lnrr$mu_lnrr[1], # m1_1
                            model_est_adjusted_lnrr$mu_lnrr[2], # m1_2
                            model_est_adjusted_lnrr$mu_lnrr[3], # m2_1
                            model_est_adjusted_lnrr$mu_lnrr[4], # m2_2
                            model_est_RR$mu_RR[5],
                            model_est_RR$mu_RR[6],
                            model_est_adjusted_lnrr$mu_lnrr[5], # m5_1
                            model_est_adjusted_lnrr$mu_lnrr[6], # m6_1
                            model_est_adjusted_lnrr$mu_lnrr[7], # m6_2
                            model_est_adjusted_lnrr$mu_lnrr[8], # m6_3
                            model_est_adjusted_lnrr$mu_lnrr[9], # m6_4
                            model_est_adjusted_lnrr$mu_lnrr[10], # m6_5
                            model_est_PET_PEESE_RR$mu_RR[13],
                            model_est_PET_PEESE_RR$mu_RR[14],
                            model_est_PET_PEESE_RR$mu_RR[15],
                            model_est_adjusted_lnrr$mu_lnrr[11], # m9_1
                            model_est_RR$mu_RR[17],
                            model_est_adjusted_lnrr$mu_lnrr[12], # m11_1
                            model_est_PET_PEESE_RR$mu_RR[19],
                            model_est_PET_PEESE_RR$mu_RR[20],
                            model_est_PET_PEESE_RR$mu_RR[21],
                            model_est_PET_PEESE_RR$mu_RR[22],
                            model_est_PET_PEESE_RR$mu_RR[23],
                            model_est_RR$mu_RR[24],
                            model_est_PET_PEESE_RR$mu_RR[25],
                            model_est_PET_PEESE_RR$mu_RR[26],
                            model_est_PET_PEESE_RR$mu_RR[27],
                            model_est_PET_PEESE_RR$mu_RR[28],
                            model_est_PET_PEESE_RR$mu_RR[29],
                            model_est_RR$mu_RR[30]),
                    
                    SE_RR=c(model_est_adjusted_lnrr$SE_lnrr[1], # m1_1
                            model_est_adjusted_lnrr$SE_lnrr[2], # m1_2
                            model_est_adjusted_lnrr$SE_lnrr[3], # m2_1
                            model_est_adjusted_lnrr$SE_lnrr[4], # m2_2
                            model_est_RR$SE_RR[5],
                            model_est_RR$SE_RR[6],
                            model_est_adjusted_lnrr$SE_lnrr[5], # m5_1
                            model_est_adjusted_lnrr$SE_lnrr[6], # m6_1
                            model_est_adjusted_lnrr$SE_lnrr[7], # m6_2
                            model_est_adjusted_lnrr$SE_lnrr[8], # m6_3
                            model_est_adjusted_lnrr$SE_lnrr[9], # m6_4
                            model_est_adjusted_lnrr$SE_lnrr[10], # m6_5
                            model_est_PET_PEESE_RR$SE_RR[13],
                            model_est_PET_PEESE_RR$SE_RR[14],
                            model_est_PET_PEESE_RR$SE_RR[15],
                            model_est_adjusted_lnrr$SE_lnrr[11], # m9_1
                            model_est_RR$SE_RR[17],
                            model_est_adjusted_lnrr$SE_lnrr[12], # m11_1
                            model_est_PET_PEESE_RR$SE_RR[19],
                            model_est_PET_PEESE_RR$SE_RR[20],
                            model_est_PET_PEESE_RR$SE_RR[21],
                            model_est_PET_PEESE_RR$SE_RR[22],
                            model_est_PET_PEESE_RR$SE_RR[23],
                            model_est_RR$SE_RR[24],
                            model_est_PET_PEESE_RR$SE_RR[25],
                            model_est_PET_PEESE_RR$SE_RR[26],
                            model_est_PET_PEESE_RR$SE_RR[27],
                            model_est_PET_PEESE_RR$SE_RR[28],
                            model_est_PET_PEESE_RR$SE_RR[29],
                            model_est_RR$SE_RR[30]),
                    
                ll_NHST=c(model_est_adjusted_lnrr$ll_NHST[1], # m1_1
                            model_est_adjusted_lnrr$ll_NHST[2], # m1_2
                            model_est_adjusted_lnrr$ll_NHST[3], # m2_1
                            model_est_adjusted_lnrr$ll_NHST[4], # m2_2
                            model_est_RR$ll_NHST[5],
                            model_est_RR$ll_NHST[6],
                            model_est_adjusted_lnrr$ll_NHST[5], # m5_1
                            model_est_adjusted_lnrr$ll_NHST[6], # m6_1
                            model_est_adjusted_lnrr$ll_NHST[7], # m6_2
                            model_est_adjusted_lnrr$ll_NHST[8], # m6_3
                            model_est_adjusted_lnrr$ll_NHST[9], # m6_4
                            model_est_adjusted_lnrr$ll_NHST[10], # m6_5
                            model_est_PET_PEESE_RR$ll_NHST[13],
                            model_est_PET_PEESE_RR$ll_NHST[14],
                            model_est_PET_PEESE_RR$ll_NHST[15],
                            model_est_adjusted_lnrr$ll_NHST[11], # m9_1
                            model_est_RR$ll_NHST[17],
                            model_est_adjusted_lnrr$ll_NHST[12], # m11_1
                            model_est_PET_PEESE_RR$ll_NHST[19],
                            model_est_PET_PEESE_RR$ll_NHST[20],
                            model_est_PET_PEESE_RR$ll_NHST[21],
                            model_est_PET_PEESE_RR$ll_NHST[22],
                            model_est_PET_PEESE_RR$ll_NHST[23],
                            model_est_RR$ll_NHST[24],
                            model_est_PET_PEESE_RR$ll_NHST[25],
                            model_est_PET_PEESE_RR$ll_NHST[26],
                            model_est_PET_PEESE_RR$ll_NHST[27],
                            model_est_PET_PEESE_RR$ll_NHST[28],
                            model_est_PET_PEESE_RR$ll_NHST[29],
                            model_est_RR$ll_NHST[30]),
                
                  ul_NHST=c(model_est_adjusted_lnrr$ul_NHST[1], # m1_1
                            model_est_adjusted_lnrr$ul_NHST[2], # m1_2
                            model_est_adjusted_lnrr$ul_NHST[3], # m2_1
                            model_est_adjusted_lnrr$ul_NHST[4], # m2_2
                            model_est_RR$ul_NHST[5],
                            model_est_RR$ul_NHST[6],
                            model_est_adjusted_lnrr$ul_NHST[5], # m5_1
                            model_est_adjusted_lnrr$ul_NHST[6], # m6_1
                            model_est_adjusted_lnrr$ul_NHST[7], # m6_2
                            model_est_adjusted_lnrr$ul_NHST[8], # m6_3
                            model_est_adjusted_lnrr$ul_NHST[9], # m6_4
                            model_est_adjusted_lnrr$ul_NHST[10], # m6_5
                            model_est_PET_PEESE_RR$ul_NHST[13],
                            model_est_PET_PEESE_RR$ul_NHST[14],
                            model_est_PET_PEESE_RR$ul_NHST[15],
                            model_est_adjusted_lnrr$ul_NHST[11], # m9_1
                            model_est_RR$ul_NHST[17],
                            model_est_adjusted_lnrr$ul_NHST[12], # m11_1
                            model_est_PET_PEESE_RR$ul_NHST[19],
                            model_est_PET_PEESE_RR$ul_NHST[20],
                            model_est_PET_PEESE_RR$ul_NHST[21],
                            model_est_PET_PEESE_RR$ul_NHST[22],
                            model_est_PET_PEESE_RR$ul_NHST[23],
                            model_est_RR$ul_NHST[24],
                            model_est_PET_PEESE_RR$ul_NHST[25],
                            model_est_PET_PEESE_RR$ul_NHST[26],
                            model_est_PET_PEESE_RR$ul_NHST[27],
                            model_est_PET_PEESE_RR$ul_NHST[28],
                            model_est_PET_PEESE_RR$ul_NHST[29],
                            model_est_RR$ul_NHST[30]),
                
                  p_value=c(model_est_adjusted_lnrr$p_value[1], # m1_1
                            model_est_adjusted_lnrr$p_value[2], # m1_2
                            model_est_adjusted_lnrr$p_value[3], # m2_1
                            model_est_adjusted_lnrr$p_value[4], # m2_2
                            model_est_RR$p_value[5],
                            model_est_RR$p_value[6],
                            model_est_adjusted_lnrr$p_value[5], # m5_1
                            model_est_adjusted_lnrr$p_value[6], # m6_1
                            model_est_adjusted_lnrr$p_value[7], # m6_2
                            model_est_adjusted_lnrr$p_value[8], # m6_3
                            model_est_adjusted_lnrr$p_value[9], # m6_4
                            model_est_adjusted_lnrr$p_value[10], # m6_5
                            model_est_PET_PEESE_RR$p_value[13],
                            model_est_PET_PEESE_RR$p_value[14],
                            model_est_PET_PEESE_RR$p_value[15],
                            model_est_adjusted_lnrr$p_value[11], # m9_1
                            model_est_RR$p_value[17],
                            model_est_adjusted_lnrr$p_value[12], # m11_1
                            model_est_PET_PEESE_RR$p_value[19],
                            model_est_PET_PEESE_RR$p_value[20],
                            model_est_PET_PEESE_RR$p_value[21],
                            model_est_PET_PEESE_RR$p_value[22],
                            model_est_PET_PEESE_RR$p_value[23],
                            model_est_RR$p_value[24],
                            model_est_PET_PEESE_RR$p_value[25],
                            model_est_PET_PEESE_RR$p_value[26],
                            model_est_PET_PEESE_RR$p_value[27],
                            model_est_PET_PEESE_RR$p_value[28],
                            model_est_PET_PEESE_RR$p_value[29],
                            model_est_RR$p_value[30])) 


#save(model_est_adjusted_RR,file = here("data","model_est_adjusted_RR.RData"))
#load(here("data","model_est_adjusted_RR.RData"))

# get locations from model_est_PET_PEESE_RR.sei.slope.nonsig (models from model_list_PET_PEESE_RR.sei) and model_est_PET_PEESE_RR.sei.slope.sig (models from model_list_PET_PEESE_RR.var1_25 and model_list_PET_PEESE_RR.var27_30)

PET_PEESE_list_RR <- list(model_list_PET_PEESE_RR.var1_25[[1]], 
                          model_list_PET_PEESE_RR.var1_25[[2]], 
                          model_list_PET_PEESE_RR.var1_25[[3]],
                          model_list_PET_PEESE_RR.sei[[4]],
                          model_list_PET_PEESE_RR.var1_25[[5]],
                          model_list_PET_PEESE_RR.sei[[6]],
                          model_list_PET_PEESE_RR.var1_25[[7]],
                          model_list_PET_PEESE_RR.sei[[8]],
                          model_list_PET_PEESE_RR.sei[[9]],
                          model_list_PET_PEESE_RR.sei[[10]],
                          model_list_PET_PEESE_RR.sei[[11]],
                          model_list_PET_PEESE_RR.sei[[12]],
                          model_list_PET_PEESE_RR.sei[[13]],
                          model_list_PET_PEESE_RR.sei[[14]],
                          model_list_PET_PEESE_RR.sei[[15]],
                          model_list_PET_PEESE_RR.sei[[16]],
                          model_list_PET_PEESE_RR.sei[[17]],
                          model_list_PET_PEESE_RR.sei[[18]],
                          model_list_PET_PEESE_RR.var1_25[[19]],
                          model_list_PET_PEESE_RR.sei[[20]],
                          model_list_PET_PEESE_RR.sei[[21]],
                          model_list_PET_PEESE_RR.sei[[22]],
                          model_list_PET_PEESE_RR.sei[[23]],
                          model_list_PET_PEESE_RR.sei[[24]],
                          model_list_PET_PEESE_RR.sei[[25]],
                          model_list_PET_PEESE_RR.sei[[26]],
                          model_list_PET_PEESE_RR.sei[[27]],
                          model_list_PET_PEESE_RR.sei[[28]],
                          model_list_PET_PEESE_RR.var27_30[[29]],
                          model_list_PET_PEESE_RR.sei[[30]])



# get locations from my.data3
model_list_adjusted_RR <- list(PET_PEESE_list_RR[[1]],
                               PET_PEESE_list_RR[[2]],
                               PET_PEESE_list_RR[[3]],
                               model_list_RR[[4]],
                               model_list_RR[[5]],
                               model_list_RR[[6]],
                               PET_PEESE_list_RR[[7]],
                               PET_PEESE_list_RR[[8]],
                               PET_PEESE_list_RR[[9]],
                               model_list_RR[[10]],
                               PET_PEESE_list_RR[[11]],
                               model_list_RR[[12]],
                               PET_PEESE_list_RR[[13]],
                               PET_PEESE_list_RR[[14]],
                               PET_PEESE_list_RR[[15]],
                               model_list_RR[[16]],
                               model_list_RR[[17]],
                               PET_PEESE_list_RR[[18]],
                               PET_PEESE_list_RR[[19]],
                               PET_PEESE_list_RR[[20]],
                               PET_PEESE_list_RR[[21]],
                               PET_PEESE_list_RR[[22]],
                               PET_PEESE_list_RR[[23]],
                               model_list_RR[[24]],
                               PET_PEESE_list_RR[[25]],
                               PET_PEESE_list_RR[[26]],
                               PET_PEESE_list_RR[[27]],
                               PET_PEESE_list_RR[[28]],
                               PET_PEESE_list_RR[[29]],
                               model_list_RR[[30]])



# using effective N based models where possible (using lnRR dataset's bias-corrected models to replace lnRR* dataset's bias-corrected models for 12 meta-analyses)
## using model_est_adjusted_lnrr$MA_case to check which meta-analyses should be replaced

model_list_adjusted_RR <- list(model_list_adjusted_lnrr[[1]], # m1_1
                               model_list_adjusted_lnrr[[2]], # m1_2
                               model_list_adjusted_lnrr[[3]], # m2_1
                               model_list_adjusted_lnrr[[4]], # m2_2
                               model_list_adjusted_RR[[5]],
                               model_list_adjusted_RR[[6]],
                               model_list_adjusted_lnrr[[5]], # m5_1
                               model_list_adjusted_lnrr[[6]], # m6_1
                               model_list_adjusted_lnrr[[7]], # m6_2
                               model_list_adjusted_lnrr[[8]], # m6_3
                               model_list_adjusted_lnrr[[9]], # m6_4
                               model_list_adjusted_lnrr[[10]], # m6_5
                               model_list_adjusted_RR[[13]],
                               model_list_adjusted_RR[[14]],
                               model_list_adjusted_RR[[15]],
                               model_list_adjusted_lnrr[[11]], # m9_1
                               model_list_adjusted_RR[[17]],
                               model_list_adjusted_lnrr[[12]], # m11_1
                               model_list_adjusted_RR[[19]],
                               model_list_adjusted_RR[[20]],
                               model_list_adjusted_RR[[21]],
                               model_list_adjusted_RR[[22]],
                               model_list_adjusted_RR[[23]],
                               model_list_adjusted_RR[[24]],
                               model_list_adjusted_RR[[25]],
                               model_list_adjusted_RR[[26]],
                               model_list_adjusted_RR[[27]],
                               model_list_adjusted_RR[[28]],
                               model_list_adjusted_RR[[29]],
                               model_list_adjusted_RR[[30]])

#save(model_list_adjusted_RR,file = here("data","model_list_adjusted_RR.RData"))
#load(here("data","model_list_adjusted_RR.RData")) 

```




#### 2.3 MA power calculation

```{r}
#load(here("data","model_est_adjusted_RR.RData")) 

#***************************************************************#
#             power for 36 meta-analytic cases                  #
#***************************************************************#
# make a list of data # using raw data where possible
dat_list_adjusted <- list(lnrr[[1]], # m1_1
                 lnrr[[2]], # m1_2
                 lnrr[[3]], # m2_1
                 lnrr[[4]], # m2_2
                 dat_m3_1,
                 dat_m4_1,
                 lnrr[[5]], # m5_1
                 lnrr[[6]], # m6_1
                 lnrr[[7]], # m6_2
                 lnrr[[8]], # m6_3
                 lnrr[[9]], # m6_4
                 lnrr[[10]], # m6_5
                 dat_m7_1,
                 dat_m7_2,
                 dat_m8_1,
                 lnrr[[11]], # m9_1
                 dat_m10_1,
                 lnrr[[12]], # m11_1
                 dat_m12_1,
                 dat_m13_1,
                 dat_m13_2,
                 dat_m14_1,
                 dat_m14_2,
                 dat_m14_3,
                 dat_m15_1,
                 dat_m16_1,
                 dat_m16_2,
                 dat_m20_1,
                 dat_m23_1,
                 dat_m24_1)


#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_adjusted_RR$MA.power <- power.ma_Shinichi(mu=model_est_adjusted_RR$mu,SE=model_est_adjusted_RR$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_adjusted_RR$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_adjusted_RR$mu[i],se=model_est_adjusted_RR$SE[i],alpha=0.05) %>% unlist()
}

model_est_adjusted_RR$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_adjusted_RR$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_adjusted_RR$mu[i],se=model_est_adjusted_RR$SE[i],alpha=0.05) %>% unlist()
}

model_est_adjusted_RR$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_adjusted_RR$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_adjusted_RR$mu[i],se=model_est_adjusted_RR$SE[i],alpha=0.05) %>% unlist()
}

model_est_adjusted_RR$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_adjusted_RR, file = "./meta-analysis_adjusted_power_RR.csv", row.names = FALSE)

# save(model_est_adjusted_RR,file = here("data","model_est_adjusted_RR.RData"))
#load(here("data","model_est_adjusted_RR.RData"))
```



#### 2.4 Individual power

##### 2.4.1 Calculation

```{r}
#load(here("data","dat_list_adjusted.RData"))

#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_RR <- NA
for (i in 1:length(dat_list)) {
  power.F_RR[i] <- power.individual_Shinichi(mu=rep(model_est_adjusted_RR$mu_RR[i], length(dat_list_adjusted[[i]]$vi)), se=sqrt(dat_list_adjusted[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_RR)) {
  dat_list_adjusted[[i]]$power.F_RR <- power.F_RR[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_RR <- NA
for (i in 1:length(dat_list)) {
  power.F.S_RR[i] <- mapply(error_S, mu=rep(model_est_adjusted_RR$mu_RR[i], length(dat_list_adjusted[[i]]$vi)), se=sqrt(dat_list_adjusted[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_RR)) {
  dat_list_adjusted[[i]]$power.F.S_RR <- power.F.S_RR[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_RR <- NA
for (i in 1:length(dat_list)) {
  power.F.M_RR[i] <- mapply(error_M, mu=rep(model_est_adjusted_RR$mu_RR[i], length(dat_list_adjusted[[i]]$vi)), se=sqrt(dat_list_adjusted[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_RR)) {
  dat_list_adjusted[[i]]$power.F.M_RR <- power.F.M_RR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_RR <- NA
for (i in 1:length(dat_list)) {
  power.F.M2_RR[i] <- mapply(error_M2, mu=rep(model_est_adjusted_RR$mu_RR[i], length(dat_list_adjusted[[i]]$vi)), se=sqrt(dat_list_adjusted[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_RR)) {
  dat_list_adjusted[[i]]$power.F.M2_RR <- power.F.M2_RR[[i]]
}



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_RR <- NA
for (i in 1:length(model_list_adjusted_RR)) {
  blups.list_RR[i] <- ranef(model_list_adjusted_RR[[i]]) %>% list()
}

# get study index - match two components random effect
index.list_RR <- NA # list()
for (i in 1:length(model_list_adjusted_RR)) {
  index.list_RR[i] <- match(as.character(dat_list_adjusted[[i]]$Study),rownames(blups.list_RR[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_RR <-NA
for (i in 1:length(model_list_adjusted_RR)) {
  effect.R_RR[i] <- mapply(sum, model_est_adjusted_RR$mu_RR[i], blups.list_RR[[i]]$Study[index.list_RR[[i]],1], blups.list_RR[[i]]$Unit_ID[,1]) %>% list()
}

#--------------------- (1) two tailed power ---------------------#
power.R_RR <- NA
for (i in 1:length(dat_list)) {
  power.R_RR[i] <- power.individual_Shinichi(mu=effect.R_RR[[i]], se=sqrt(dat_list_adjusted[[i]]$vi)) %>% list()}

# plot(power_RR[[1]]-power_RR2[[1]]) - check discrepancy
# allocate each set of power into corresponding dataset
for (i in 1:length(power.R_RR)) {
  dat_list_adjusted[[i]]$power.R_RR <- power.R_RR[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect, which does not account for random effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_RR <- NA
for (i in 1:length(dat_list)) {
  power.R.S_RR[i] <- mapply(error_S, mu=effect.R_RR[[i]], se=sqrt(dat_list_adjusted[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.R.S_RR)) {
  dat_list_adjusted[[i]]$power.R.S_RR <- power.R.S_RR[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_RR <- NA
for (i in 1:length(dat_list)) {
  power.R.M_RR[i] <- mapply(error_M, mu=effect.R_RR[[i]], se=sqrt(dat_list_adjusted[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.R.M_RR)) {
  dat_list_adjusted[[i]]$power.R.M_RR <- power.R.M_RR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_RR <- NA
for (i in 1:length(dat_list)) {
  power.R.M2_RR[i] <- mapply(error_M2, mu=effect.R_RR[[i]], se=sqrt(dat_list_adjusted[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into corresponding dataset
for (i in 1:length(power.R.M2_RR)) {
  dat_list_adjusted[[i]]$power.R.M2_RR <- power.R.M2_RR[[i]]
}


#save(dat_list_adjusted,file = here("data","dat_list_adjusted.RData"))
#load(here("data","dat_list_adjusted.RData"))
```



##### 2.4.2 Summary of individual power

```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F_RR))[6,])  # early version, sapply(mapply(summary, sapply(dat_list_adjusted, function(x) x$power_RR)), function(x) x[2])


#---------------------- (2) type S error -----------------------#
power.F.S_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.S_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.S_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.S_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.S_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.S_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.S_RR))[6,])


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M_RR))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M2_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M2_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M2_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M2_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M2_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.F.M2_RR))[6,])




#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R_RR))[6,])


#---------------------- (2) type S error -----------------------#
power.R.S_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.S_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.S_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.S_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.S_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.S_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.S_RR))[6,])



#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M_RR))[6,])


#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_adjusted_RR <- data.frame(MA_case=model_est_adjusted_RR$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M2_RR))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M2_RR))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M2_RR))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M2_RR))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M2_RR))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted, function(x) x$power.R.M2_RR))[6,])
```

##### 2.4.3 SE of individual power

```{r}

#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_RR
se.F_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.F_mean[i] <- sd(dat_list_adjusted[[i]]$power.F_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.F_RR[!is.na(dat_list_adjusted[[i]]$power.F_RR)]))
}

power.F_summary_adjusted_RR$se.F_mean <- se.F_mean

#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_RR
se.F.S_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.F.S_mean[i] <- sd(dat_list_adjusted[[i]]$power.F.S_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.F.S_RR[!is.na(dat_list_adjusted[[i]]$power.F.S_RR)]))
}

power.F.S_summary_adjusted_RR$se.F.S_mean <- se.F.S_mean


#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_RR
se.F.M_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.F.M_mean[i] <- sd(dat_list_adjusted[[i]]$power.F.M_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.F.M_RR[!is.na(dat_list_adjusted[[i]]$power.F.M_RR)]))
}

power.F.M_summary_adjusted_RR$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.F.M2_mean[i] <- sd(dat_list_adjusted[[i]]$power.F.M2_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.F.M2_RR[!is.na(dat_list_adjusted[[i]]$power.F.M2_RR)]))
}

power.F.M2_summary_adjusted_RR$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_RR
se.R_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.R_mean[i] <- sd(dat_list_adjusted[[i]]$power.R_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.R_RR[!is.na(dat_list_adjusted[[i]]$power.R_RR)]))
}

power.R_summary_adjusted_RR$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_RR
se.R.S_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.R.S_mean[i] <- sd(dat_list_adjusted[[i]]$power.R.S_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.R.S_RR[!is.na(dat_list_adjusted[[i]]$power.R.S_RR)]))
}

power.R.S_summary_adjusted_RR$se.R.S_mean <- se.R.S_mean


#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_RR
se.R.M_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.R.M_mean[i] <- sd(dat_list_adjusted[[i]]$power.R.M_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.R.M_RR[!is.na(dat_list_adjusted[[i]]$power.R.M_RR)]))
}

power.R.M_summary_adjusted_RR$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(dat_list_adjusted)) {
  se.R.M2_mean[i] <- sd(dat_list_adjusted[[i]]$power.R.M2_RR, na.rm=TRUE) / sqrt(length(dat_list_adjusted[[i]]$power.R.M2_RR[!is.na(dat_list_adjusted[[i]]$power.R.M2_RR)]))
}

power.R.M2_summary_adjusted_RR$se.R.M2_mean <- se.R.M2_mean
```


#### 2.5 Regression

##### 2.5.1 MA power

```{r}
# Add k and N to the dataset
N_RR <- NA
N_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Study)))

k_RR <- NA
k_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Unit_ID)))


model_est_adjusted_RR$k <- k_RR
model_est_adjusted_RR$N <- N_RR

# load meta-analysis level power
#load(here("data","model_est_adjusted_RR.RData"))
#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#--------------------- (1) two tailed power ---------------------#
MMA_MA_adjusted_RR <- lm(MA.power~1, weights = k, data = model_est_adjusted_RR) 
MMA_MA_adjusted_RR$coefficients
# log
MMA_MA_adjusted_RR2 <- lm(log(MA.power)~1, weights = k, data = model_est_adjusted_RR)
# this is median
MMA_MA_adjusted_RR2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_adjusted_RR2$coefficients + 0.5*var(log(model_est_adjusted_RR$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_adjusted_RR2) %>% exp()
# # logit
# MMA_MA_adjusted_RR3 <- lm(car::logit(MA.power)~1, weights = k, data = model_est_adjusted_RR)
# # I am not sure what this is - but this is not the mean
# MMA_MA_adjusted_RR3$coefficients %>% inv.logit() # or plogis()
# compare residuals

par(mfrow = c(1, 2))
residuals(MMA_MA_adjusted_RR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_adjusted_RR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_MA_adjusted_RR3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 
#---------------------- (2) type S error -----------------------#
MMA_MA.S_adjusted_RR <- lm(MA.power.S~1, weights = k, data = model_est_adjusted_RR) 
MMA_MA.S_adjusted_RR$coefficients
# log
MMA_MA.S_adjusted_RR2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_adjusted_RR) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_adjusted_RR2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_adjusted_RR2$coefficients + 0.5*var(log(model_est_adjusted_RR$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_adjusted_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# # logit
# MMA_MA.S_adjusted_RR3 <- lm(car::logit(MA.power.S)~1, weights = k, data = model_est_adjusted_RR)
# MMA_MA.S_adjusted_RR3$coefficients %>% inv.logit() # or plogis()
# make plot
png(filename = "./Figures/residual/MA.MAOM.S_adjusted_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA.S_adjusted_RR) %>% hist( main = paste("Orignal scale (meta-analysis Type S)"), xlab = "Residual")
residuals(MMA_MA.S_adjusted_RR2) %>% hist( main = paste("Log scale (meta-analysis Type S)"), xlab = "Residual")
dev.off()
#residuals(MMA_MA.S_adjusted_RR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#
# note that logit transformation is not suitable for Type M, because M error is not the probability. So I have not done logit transformation for M
MMA_MA.M_adjusted_RR <- lm(MA.power.M~1, weights = k, data = model_est_adjusted_RR) 
MMA_MA.M_adjusted_RR$coefficients
# log
MMA_MA.M_adjusted_RR2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_adjusted_RR)
# this is median
MMA_MA.M_adjusted_RR2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA.M_adjusted_RR2$coefficients + 0.5*var(log(model_est_adjusted_RR$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_adjusted_RR2) %>% exp()

# make plot
png(filename = "./Figures/residual/MA.MAOM.M_adjusted_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA.M_adjusted_RR) %>% hist(main = paste("Orignal scale (meta-analysis Type M)"), xlab = "Residual")
residuals(MMA_MA.M_adjusted_RR2) %>% hist(main = paste("Log scale (meta-analysis Type M)"), xlab = "Residual")
dev.off()




#-------------- (3) type M2 error (overestimate ratio) -------------#
# note that logit transformation is not suitable for Type M, because M error is not the probability. So I have not done logit transformation for M
MMA_MA.M2_adjusted_RR <- lm(MA.power.M2~1, weights = k, data = model_est_adjusted_RR) 
MMA_MA.M2_adjusted_RR$coefficients
# log
MMA_MA.M2_adjusted_RR2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_adjusted_RR)
# this is median
MMA_MA.M2_adjusted_RR2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA.M2_adjusted_RR2$coefficients + 0.5*var(log(model_est_adjusted_RR$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_adjusted_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_adjusted_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_adjusted_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# #--------------------- (1) two tailed power ---------------------#
# MMA_MA_adjusted_RR <- lm(MA.power~1, weights = k, data = model_est_adjusted_RR) 
# 
# summary(MMA_MA_adjusted_RR)
# 
# #---------------------- (2) type S error -----------------------#
# MMA_MA.S_adjusted_RR <- lm(MA.power.S~1, weights = k, data = model_est_adjusted_RR) 
# 
# summary(MMA_MA.S_adjusted_RR)
# 
# #-------------- (3) type M error (overestimate ratio) -------------#
# 
# MMA_MA.M_adjusted_RR <- lm(MA.power.M~1, weights = k, data = model_est_adjusted_RR) 
# 
# summary(MMA_MA.M_adjusted_RR)

```


##### 2.5.2 Individual power

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique in case some studies have same identities
# dat_list_adjusted[[1]]$Study <- paste("m1_1_", dat_list_adjusted[[1]]$Study, sep = "")
# dat_list_adjusted[[2]]$Study <- paste("m1_2_", dat_list_adjusted[[2]]$Study, sep = "")
# dat_list_adjusted[[3]]$Study <- paste("m2_1_", dat_list_adjusted[[3]]$Study, sep = "")
# dat_list_adjusted[[4]]$Study <- paste("m2_2_", dat_list_adjusted[[4]]$Study, sep = "")
# dat_list_adjusted[[5]]$Study <- paste("m3_1_", dat_list_adjusted[[5]]$Study, sep = "")
# dat_list_adjusted[[6]]$Study <- paste("m4_1_", dat_list_adjusted[[6]]$Study, sep = "")
# dat_list_adjusted[[7]]$Study <- paste("m5_1_", dat_list_adjusted[[7]]$Study, sep = "")
# dat_list_adjusted[[8]]$Study <- paste("m6_1_", dat_list_adjusted[[8]]$Study, sep = "")
# dat_list_adjusted[[9]]$Study <- paste("m6_2_", dat_list_adjusted[[9]]$Study, sep = "")
# dat_list_adjusted[[10]]$Study <- paste("m6_3_", dat_list_adjusted[[10]]$Study, sep = "")
# dat_list_adjusted[[11]]$Study <- paste("m6_4_", dat_list_adjusted[[11]]$Study, sep = "")
# dat_list_adjusted[[12]]$Study <- paste("m6_5_", dat_list_adjusted[[12]]$Study, sep = "")
# dat_list_adjusted[[13]]$Study <- paste("m7_1_", dat_list_adjusted[[13]]$Study, sep = "")
# dat_list_adjusted[[14]]$Study <- paste("m7_2_", dat_list_adjusted[[14]]$Study, sep = "")
# dat_list_adjusted[[15]]$Study <- paste("m8_1_", dat_list_adjusted[[15]]$Study, sep = "")
# dat_list_adjusted[[16]]$Study <- paste("m9_1_", dat_list_adjusted[[16]]$Study, sep = "")
# dat_list_adjusted[[17]]$Study <- paste("m10_1_", dat_list_adjusted[[17]]$Study, sep = "")
# dat_list_adjusted[[18]]$Study <- paste("m11_1_", dat_list_adjusted[[18]]$Study, sep = "")
# dat_list_adjusted[[19]]$Study <- paste("m12_1_", dat_list_adjusted[[19]]$Study, sep = "")
# dat_list_adjusted[[20]]$Study <- paste("m13_1_", dat_list_adjusted[[20]]$Study, sep = "")
# dat_list_adjusted[[21]]$Study <- paste("m13_2_", dat_list_adjusted[[21]]$Study, sep = "")
# dat_list_adjusted[[22]]$Study <- paste("m14_1_", dat_list_adjusted[[22]]$Study, sep = "")
# dat_list_adjusted[[23]]$Study <- paste("m14_2_", dat_list_adjusted[[23]]$Study, sep = "")
# dat_list_adjusted[[24]]$Study <- paste("m14_3_", dat_list_adjusted[[24]]$Study, sep = "")
# dat_list_adjusted[[25]]$Study <- paste("m15_1_", dat_list_adjusted[[25]]$Study, sep = "")
# dat_list_adjusted[[26]]$Study <- paste("m16_1_", dat_list_adjusted[[26]]$Study, sep = "")
# dat_list_adjusted[[27]]$Study <- paste("m16_2_", dat_list_adjusted[[27]]$Study, sep = "")
# dat_list_adjusted[[28]]$Study <- paste("m20_1_", dat_list_adjusted[[28]]$Study, sep = "")
# dat_list_adjusted[[29]]$Study <- paste("m23_1_", dat_list_adjusted[[29]]$Study, sep = "")
# dat_list_adjusted[[30]]$Study <- paste("m24_1_", dat_list_adjusted[[30]]$Study, sep = "")




studyID_RR <- NA
for (i in 1:length(dat_list)) {
  studyID_RR[i] <- dat_list_adjusted[[i]]$Study %>% list()
}


MA_case_RR <- c(rep('m1_1',length(dat_list_adjusted[[1]]$Study)),
                  rep('m1_2',length(dat_list_adjusted[[2]]$Study)),
                  rep('m2_1',length(dat_list_adjusted[[3]]$Study)),
                  rep('m2_2',length(dat_list_adjusted[[4]]$Study)),
                  rep('m3_1',length(dat_list_adjusted[[5]]$Study)),
                  rep('m4_1',length(dat_list_adjusted[[6]]$Study)),
                  rep('m5_1',length(dat_list_adjusted[[7]]$Study)),
                  rep('m6_1',length(dat_list_adjusted[[8]]$Study)),
                  rep('m6_2',length(dat_list_adjusted[[9]]$Study)),
                  rep('m6_3',length(dat_list_adjusted[[10]]$Study)),
                  rep('m6_4',length(dat_list_adjusted[[11]]$Study)),
                  rep('m6_5',length(dat_list_adjusted[[12]]$Study)),
                  rep('m7_1',length(dat_list_adjusted[[13]]$Study)),
                  rep('m7_2',length(dat_list_adjusted[[14]]$Study)),
                  rep('m8_1',length(dat_list_adjusted[[15]]$Study)),
                  rep('m9_1',length(dat_list_adjusted[[16]]$Study)),
                  rep('m10_1',length(dat_list_adjusted[[17]]$Study)),
                  rep('m11_1',length(dat_list_adjusted[[18]]$Study)),
                  rep('m12_1',length(dat_list_adjusted[[19]]$Study)),#m12_1 which 
                  rep('m13_1',length(dat_list_adjusted[[20]]$Study)),
                  rep('m13_2',length(dat_list_adjusted[[21]]$Study)),
                  rep('m14_1',length(dat_list_adjusted[[22]]$Study)),
                  rep('m14_2',length(dat_list_adjusted[[23]]$Study)), 
                  rep('m14_3',length(dat_list_adjusted[[24]]$Study)),
                  rep('m15_1',length(dat_list_adjusted[[25]]$Study)),
                  rep('m16_1',length(dat_list_adjusted[[26]]$Study)),
                  rep('m16_2',length(dat_list_adjusted[[27]]$Study)),
                  rep('m20_1',length(dat_list_adjusted[[28]]$Study)),
                  rep('m23_1',length(dat_list_adjusted[[29]]$Study)), #m23_1
                  rep('m24_1',length(dat_list_adjusted[[30]]$Study))
                  )

#MA_case_RR <- c("1m1_1", "2m1_2", "3m2_1", "4m2_2", "5m3_1", "6m4_1", "7m5_1", "8m6_1", "9m6_2", "10m6_3", "11m6_4",  "12m6_5",  "13m7_1",  "14m7_2",  "15m8_1",  "16m9_1",  "17m10_1", "18m11_1", "19m12_1", "20m13_1", "21m13_2" ,"22m14_1", "23m14_2", "24m14_3", "25m15_1", "26m16_1", "27m16_2", "28m20_1", "29m23_1", "30m24_1")


stressor_RR <-  c(rep('BD_loss',length(dat_list_adjusted[[1]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted[[2]]$Study)),
                  rep('Fert',length(dat_list_adjusted[[3]]$Study)),
                  rep('Fert',length(dat_list_adjusted[[4]]$Study)),
                  rep('Warm',length(dat_list_adjusted[[5]]$Study)),
                  rep('Fert',length(dat_list_adjusted[[6]]$Study)),
                  rep('Fert',length(dat_list_adjusted[[7]]$Study)),
                  rep('LUC',length(dat_list_adjusted[[8]]$Study)),
                  rep('LUC',length(dat_list_adjusted[[9]]$Study)),
                  rep('LUC',length(dat_list_adjusted[[10]]$Study)),
                  rep('LUC',length(dat_list_adjusted[[11]]$Study)),
                  rep('LUC',length(dat_list_adjusted[[12]]$Study)),
                  rep('Fert',length(dat_list_adjusted[[13]]$Study)),
                  rep('Fert',length(dat_list_adjusted[[14]]$Study)),
                  rep('Precip',length(dat_list_adjusted[[15]]$Study)),
                  rep('LUC',length(dat_list_adjusted[[16]]$Study)),
                  rep('Warm',length(dat_list_adjusted[[17]]$Study)),
                  rep('Inv',length(dat_list_adjusted[[18]]$Study)),
                  rep('Fire',length(dat_list_adjusted[[19]]$Study)),#m12_1
                  rep('Fire',length(dat_list_adjusted[[20]]$Study)),
                  rep('Fire',length(dat_list_adjusted[[21]]$Study)),
                  rep('Warm',length(dat_list_adjusted[[22]]$Study)),
                  rep('Warm',length(dat_list_adjusted[[23]]$Study)), 
                  rep('Warm',length(dat_list_adjusted[[24]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted[[25]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted[[26]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted[[27]]$Study)),
                  rep('Acid',length(dat_list_adjusted[[28]]$Study)),
                  rep('Inv',length(dat_list_adjusted[[29]]$Study)), #m23_1
                  rep('Inv',length(dat_list_adjusted[[30]]$Study))
                  )
#stressor_RR <- c("1BD_loss","2BD_loss","3Fert","4Fert","5Warm","6Fert","7Fert","8LUC","9LUC","10LUC","11LUC","12LUC","13Fert","14Fert","15Precip","16LUC","17Warm","18Inv","19Fire","20Fire","21Fire","22Warm","23Warm","24Warm","25BD_loss","26BD_loss","27BD_loss","28Acid","29Inv","30Inv")


approach_RR <-  c(rep('E',length(dat_list_adjusted[[1]]$Study)),
                  rep('E',length(dat_list_adjusted[[2]]$Study)),
                  rep('E',length(dat_list_adjusted[[3]]$Study)),
                  rep('E',length(dat_list_adjusted[[4]]$Study)),
                  rep('E',length(dat_list_adjusted[[5]]$Study)),
                  rep('E',length(dat_list_adjusted[[6]]$Study)),
                  rep('E',length(dat_list_adjusted[[7]]$Study)),
                  rep('O',length(dat_list_adjusted[[8]]$Study)),
                  rep('O',length(dat_list_adjusted[[9]]$Study)),
                  rep('O',length(dat_list_adjusted[[10]]$Study)),
                  rep('O',length(dat_list_adjusted[[11]]$Study)),
                  rep('O',length(dat_list_adjusted[[12]]$Study)),
                  rep('E',length(dat_list_adjusted[[13]]$Study)),
                  rep('E',length(dat_list_adjusted[[14]]$Study)),
                  rep('E',length(dat_list_adjusted[[15]]$Study)),
                  rep('O',length(dat_list_adjusted[[16]]$Study)),
                  rep('O',length(dat_list_adjusted[[17]]$Study)),
                  rep('O',length(dat_list_adjusted[[18]]$Study)),
                  dat_m12_1$approach,#m12_1
                  rep('O',length(dat_list_adjusted[[20]]$Study)),
                  rep('O',length(dat_list_adjusted[[21]]$Study)),
                  rep('E',length(dat_list_adjusted[[22]]$Study)),
                  rep('E',length(dat_list_adjusted[[23]]$Study)),
                  rep('E',length(dat_list_adjusted[[24]]$Study)),
                  rep('E',length(dat_list_adjusted[[25]]$Study)),
                  rep('E',length(dat_list_adjusted[[26]]$Study)),
                  rep('E',length(dat_list_adjusted[[27]]$Study)),
                  rep('E',length(dat_list_adjusted[[28]]$Study)),
                  dat_m23_1$approach,#m23_1
                  rep('O',length(dat_list_adjusted[[30]]$Study))
                  )
#approach_RR <- c("1E","2E","3E","4E","5E","6E","7E","8O","9O","10O","11O","12O","13E","14E","15E","16O","17O","18O","19B","20O","21O","22E","23E","24E","25E","26E","27E","28E","29B","30O")

studyID_RR <- unlist(studyID_RR)
power.F_RR <- unlist(power.F_RR)
power.F.S_RR <- unlist(power.F.S_RR)
power.F.M_RR <- unlist(power.F.M_RR)
power.F.M2_RR <- unlist(power.F.M2_RR)
power.R_RR <- unlist(power.R_RR)
power.R.S_RR <- unlist(power.R.S_RR)
power.R.M_RR <- unlist(power.R.M_RR)
power.R.M2_RR <- unlist(power.R.M2_RR)


individual_est_adjusted_RR <- data.frame("MA_case_adjusted_RR" = MA_case_RR,
                                          "studyID_adjusted_RR" = studyID_RR,
                                "stressor_adjusted_RR" = stressor_RR,
                                "approach_adjusted_RR" = approach_RR,
                                "power.F_adjusted_RR" = power.F_RR,
                                "power.F.S_adjusted_RR" = power.F.S_RR,
                                "power.F.M_adjusted_RR" = power.F.M_RR,
                                "power.F.M2_adjusted_RR" = power.F.M2_RR,
                                "power.R_adjusted_RR" = power.R_RR,
                                "power.R.S_adjusted_RR" = power.R.S_RR,
                                "power.R.M_adjusted_RR" = power.R.M_RR,
                                "power.R.M2_adjusted_RR" = power.R.M2_RR)
# #add false positive report probability (FRP)
# individual_est_adjusted_RR$FRP <- (0.05 * (1 - 0.3)) / (0.05 * (1 - 0.3) + 0.3*individual_est_adjusted_RR$power.F_adjusted_RR)
# 
# 
# MMA_power.F_adjusted_RR_FRP <- lmer(log(FRP) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# # this is median 
# summary(MMA_power.F_adjusted_RR_FRP)$coefficients[1] %>% exp()


# save(individual_est_adjusted_RR,file = here("data","individual_est_adjusted_RR.RData"))



# load individual level power
#load(here("data","individual_est_adjusted_RR.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_adjusted_RR <- lmer(power.F_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.F_adjusted_RR)$coefficients[1]
# log
MMA_power.F_adjusted_RR2 <- lmer(log(power.F_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# this is median 
summary(MMA_power.F_adjusted_RR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F_adjusted_RR))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_adjusted_RR2) %>% exp()

# # logit
# MMA_power.F_adjusted_RR3 <- lmer(car::logit(power.F_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# summary(MMA_power.F_adjusted_RR3)$coefficients[1] %>% inv.logit()

# compare residual
png(filename = "./Figures/residual/MAOM.power_adjusted_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_RR) %>% hist(main = paste("Orignal scale (experiment power)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_RR2) %>% hist(main = paste("Log scale (experiment power)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.F_adjusted_RR3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 

# include approach_adjusted_RR as fixed effect and stressor as random effect
# your example code returned contrast estimates. I used -1 to get non-contrast estimate. -1 is general? It seems that it fits both rma and lmer  
#TODO - this model does not really make sesne - comapred to what you said you did in the method
MMA_power.F_adjusted_RR.approach <- lmer(power.F_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.F_adjusted_RR.approach)$coefficients
# log
MMA_power.F_adjusted_RR.approach2 <- lmer(log(power.F_adjusted_RR) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.F_adjusted_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.F_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_adjusted_RR.approach2) %>% exp()


# # logit
# MMA_power.F_adjusted_RR.approach3 <- lmer(car::logit(power.F_adjusted_RR) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# summary(MMA_power.F_adjusted_RR.approach3)$coefficients %>% inv.logit()
# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_RR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_RR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_power.F_adjusted_RR.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 



# contrasting model
MMA_power.F_adjusted_RR.approach4 <- lmer(log(power.F_adjusted_RR) ~ 1 + I(approach_adjusted_RR) + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# check p value
summary(MMA_power.F_adjusted_RR.approach4)

#---------------------- (2) type S error -----------------------#
MMA_power.F.S_adjusted_RR <- lmer(power.F.S_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.F.S_adjusted_RR)$coefficients[1]
# there is a issue in log transformation. some values of Type S are zero. Those can not be log-transformed
# TODO - we need to adjust S by adding a small value
# find the second smallest value and add
#min2 <- min(individual_est_adjusted_RR$power.F.S_adjusted_RR[individual_est_adjusted_RR$power.F.S_adjusted_RR != #min(individual_est_adjusted_RR$power.F.S_adjusted_RR)])
# better to just add 0.025 like invlogit
MMA_power.F.S_adjusted_RR2 <- lmer(log(power.F.S_adjusted_RR + 0.025) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_adjusted_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_adjusted_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_adjusted_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# # logit
# # of course this has the same problem but they automatically add 0.02
# MMA_power.F.S_adjusted_RR3 <- lmer(car::logit(power.F.S_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# summary(MMA_power.F.S_adjusted_RR3)$coefficients[1] %>% inv.logit()
# make plot
png(filename = "./Figures/residual/MAOM.S_adjusted_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_adjusted_RR) %>% hist(main = paste("Orignal scale (experiment Type S)"), xlab = "Residual")
residuals(MMA_power.F.S_adjusted_RR2) %>% hist( main = paste("Log scale (experiment Type S)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.F.S_adjusted_RR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 



# include approach_adjusted_RR as fixed effect and stressor as random effect
MMA_power.F.S_adjusted_RR.approach <- lmer(power.F.S_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.F.S_adjusted_RR.approach)$coefficients
# log
MMA_power.F.S_adjusted_RR.approach2 <- lmer(log(power.F.S_adjusted_RR + 0.025) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_adjusted_RR.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.F.S_adjusted_RR.approach4 <- lmer(log(power.F.S_adjusted_RR + 0.025) ~ 1 + I(approach_adjusted_RR) + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# check p value
summary(MMA_power.F.S_adjusted_RR.approach4)

#---------------------- (2) type M error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.F.M_adjusted_RR <- lmer(power.F.M_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

summary(MMA_power.F.M_adjusted_RR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnRR are very low. This probably makes some of Type M error extremely high. 
# # load datset containing 30 meta-analyses with lnRR and sampling variance
# load(here("data","dat_list.RData"))
# # load individual level Type M error
# load(here("data","power.F.M_adjusted_RR.RData"))
# # have a loot at some strange sampling variances and corresponding Type M
# dat_list[[27]]$vi[69:71]
# power.F.M_adjusted_RR[[27]][69:71]
# but log transformation can work
MMA_power.F.M_adjusted_RR2 <- lmer(log(power.F.M_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

# this is median
summary(MMA_power.F.M_adjusted_RR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.F.M_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F.M_adjusted_RR))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_adjusted_RR2) %>% exp()




# make plot
png(filename = "./Figures/residual/MAOM.M_adjusted_RR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_adjusted_RR) %>% hist(main = paste("Orignal scale (experiment Type M)"), xlab = "Residual")
residuals(MMA_power.F.M_adjusted_RR2) %>% hist(main = paste("Log scale (experiment Type M)"), xlab = "Residual")
dev.off()



# include approach_adjusted_RR as fixed effect and stressor as random effect
MMA_power.F.M_adjusted_RR.approach <- lmer(power.F.M_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.F.M_adjusted_RR.approach)$coefficients
# log
MMA_power.F.M_adjusted_RR.approach2 <- lmer(log(power.F.M_adjusted_RR) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.F.M_adjusted_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F.M_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.F.M_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_adjusted_RR.approach2) %>% exp()


# contrasting model
MMA_power.F.M_adjusted_RR.approach4 <- lmer(log(power.F.M_adjusted_RR) ~ 1 + I(approach_adjusted_RR) + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# check p value
summary(MMA_power.F.M_adjusted_RR.approach4)


#---------------------- (2) type M2 error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.F.M2_adjusted_RR <- lmer(power.F.M2_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

summary(MMA_power.F.M2_adjusted_RR)$coefficients[1] 

# log 
MMA_power.F.M2_adjusted_RR2 <- lmer(log(power.F.M2_adjusted_RR+0.025) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

# this is median
summary(MMA_power.F.M2_adjusted_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.F.M2_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F.M2_adjusted_RR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_adjusted_RR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_adjusted_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_adjusted_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_RR as fixed effect and stressor as random effect
MMA_power.F.M2_adjusted_RR.approach <- lmer(power.F.M2_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.F.M2_adjusted_RR.approach)$coefficients
# log
MMA_power.F.M2_adjusted_RR.approach2 <- lmer(log(power.F.M2_adjusted_RR + 0.025) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.F.M2_adjusted_RR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F.M2_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.F.M2_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_adjusted_RR.approach2) %>% exp() - 0.025
 


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.R_adjusted_RR <- lmer(power.R_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.R_adjusted_RR)$coefficients[1]
# log
MMA_power.R_adjusted_RR2 <- lmer(log(power.R_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# this is median 
summary(MMA_power.R_adjusted_RR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R_adjusted_RR))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_adjusted_RR2) %>% exp()

# # logit
# MMA_power.R_adjusted_RR3 <- lmer(car::logit(power.R_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# summary(MMA_power.R_adjusted_RR3)$coefficients[1] %>% inv.logit()

# compare residual
png(filename = "./Figures/residual/power.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_RR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_RR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
dev.off()
#residuals(MMA_power.R_adjusted_RR3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 

# include approach_adjusted_RR as fixed effect and stressor as random effect

#TODO - this model does not really make sesne - comapred to what you said you did in the method
MMA_power.R_adjusted_RR.approach <- lmer(power.R_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.R_adjusted_RR.approach)$coefficients
# log
MMA_power.R_adjusted_RR.approach2 <- lmer(log(power.R_adjusted_RR) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.R_adjusted_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.R_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_adjusted_RR.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_RR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_RR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_power.R_adjusted_RR.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 


# contrasting model
MMA_power.R_adjusted_RR.approach4 <- lmer(log(power.R_adjusted_RR) ~ 1 + I(approach_adjusted_RR) + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# check p value
summary(MMA_power.R_adjusted_RR.approach4)


#---------------------- (2) type S error -----------------------#
MMA_power.R.S_adjusted_RR <- lmer(power.R.S_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.R.S_adjusted_RR)$coefficients[1]
# log
MMA_power.R.S_adjusted_RR2 <- lmer(log(power.R.S_adjusted_RR + 0.025) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_adjusted_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_adjusted_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_adjusted_RR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# # logit
# # of course this has the same problem but they automatically add 0.02
# MMA_power.R.S_adjusted_RR3 <- lmer(car::logit(power.R.S_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)
# summary(MMA_power.R.S_adjusted_RR3)$coefficients[1] %>% inv.logit()
# make plot
png(filename = "./Figures/residual/S.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_adjusted_RR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_adjusted_RR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.R.S_adjusted_RR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 



# include approach_adjusted_RR as fixed effect and stressor as random effect
MMA_power.R.S_adjusted_RR.approach <- lmer(power.R.S_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.R.S_adjusted_RR.approach)$coefficients
# log
MMA_power.R.S_adjusted_RR.approach2 <- lmer(log(power.R.S_adjusted_RR + 0.025) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_RR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_adjusted_RR.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.R.S_adjusted_RR.approach4 <- lmer(log(power.R.S_adjusted_RR + 0.025) ~ 1 + I(approach_adjusted_RR) + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# check p value
summary(MMA_power.R.S_adjusted_RR.approach4)


#---------------------- (2) type M error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.R.M_adjusted_RR <- lmer(power.R.M_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

summary(MMA_power.R.M_adjusted_RR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnRR are very low. This probably makes some of Type M error extremely high. 
# # load datset containing 30 meta-analyses with lnRR and sampling variance
# load(here("data","dat_list.RData"))
# # load individual level Type M error
# load(here("data","power.R.M_adjusted_RR.RData"))
# # have a loot at some strange sampling variances and corresponding Type M
# dat_list[[27]]$vi[69:71]
# power.R.M_adjusted_RR[[27]][69:71]
# but log transformation can work
MMA_power.R.M_adjusted_RR2 <- lmer(log(power.R.M_adjusted_RR) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

# this is median
summary(MMA_power.R.M_adjusted_RR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.R.M_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R.M_adjusted_RR))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_adjusted_RR2) %>% exp()

# make plot
png(filename = "./Figures/residual/M.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_adjusted_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_adjusted_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 
dev.off()



# include approach_adjusted_RR as fixed effect and stressor as random effect
MMA_power.R.M_adjusted_RR.approach <- lmer(power.R.M_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.R.M_adjusted_RR.approach)$coefficients
# log
MMA_power.R.M_adjusted_RR.approach2 <- lmer(log(power.R.M_adjusted_RR) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.R.M_adjusted_RR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R.M_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.R.M_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_adjusted_RR.approach2) %>% exp()




# contrasting model
MMA_power.R.M_adjusted_RR.approach4 <- lmer(log(power.R.M_adjusted_RR) ~ 1 + I(approach_adjusted_RR) + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# check p value
summary(MMA_power.R.M_adjusted_RR.approach4)

#---------------------- (2) type M2 error -----------------------#
# there is a issue in Type M if we use lmer. Type M error in some effect sizes are extremely high, which made lmer() work not well
 
MMA_power.R.M2_adjusted_RR <- lmer(power.R.M2_adjusted_RR ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

summary(MMA_power.R.M2_adjusted_RR)$coefficients[1] 

# log 
MMA_power.R.M2_adjusted_RR2 <- lmer(log(power.R.M2_adjusted_RR+0.025) ~ 1 + (1 | studyID_adjusted_RR), data = individual_est_adjusted_RR)

# this is median
summary(MMA_power.R.M2_adjusted_RR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(summary(MMA_power.R.M2_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R.M2_adjusted_RR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_adjusted_RR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_adjusted_RR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_adjusted_RR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_RR as fixed effect and stressor as random effect
MMA_power.R.M2_adjusted_RR.approach <- lmer(power.R.M2_adjusted_RR ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
summary(MMA_power.R.M2_adjusted_RR.approach)$coefficients
# log
MMA_power.R.M2_adjusted_RR.approach2 <- lmer(log(power.R.M2_adjusted_RR + 0.025) ~ 1 + I(approach_adjusted_RR) -1 + (1 | studyID_adjusted_RR) + (1 | stressor_adjusted_RR), data = individual_est_adjusted_RR)
# this is median
summary(MMA_power.R.M2_adjusted_RR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R.M2_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.R.M2_adjusted_RR[individual_est_adjusted_RR$approach_adjusted_RR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_adjusted_RR.approach2) %>% exp() - 0.025



# #----------------------------------------------------------------#
# #           (i) intercept (overall mean) as true effect
# #----------------------------------------------------------------#
# 
# # add study ID
# power.F_summary_adjusted_RR$Study <- c(1,1,2,2,3,4,5,6,6,6,6,6,7,7,8,9,10,11,11,13,13,14,14,14,15,16,16,17,18,19)
# 
# # add N and k
# N_RR <- NA
# for (i in 1:length(dat_list_adjusted)) {
#   n_RR[i] <- dat_list_adjusted[[i]]$Unit_ID %>% length()
# }
# 
# k_RR <- NA
# for (i in 1:length(dat_list_adjusted)) {
#   k_RR[i] <- dat_list_adjusted[[i]]$Study %>% length()
# }
# 
# power.F_summary_adjusted_RR$N <- N_RR
# power.F_summary_adjusted_RR$k <- k_RR
# 
# 
# 
# approach_RR <- c("E","E","E","E","E","E","E","O","O","O","O","O","E","E","E","O","O","O","B","O","O","E","E","E","E","E","E","E","B","O")
# 
# treatment_RR <- c("Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pu","Pr","Pu","Pu","Pu","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr","Pr")
# 
# stressor_RR <- c("BD_loss","BD_loss","Fert","Fert","Warm","Fert","Fert","LUC","LUC","LUC","LUC","LUC","Fert","Fert","Precip","LUC","Warm","Inv","Fire","Fire","Fire","Warm","Warm","Warm","BD_loss","BD_loss","BD_loss","Acid","Inv","Inv")
# 
# stressor_RR %>% as.data.frame() # check the correctness
# 
# moderator_RR <- cbind(approach_RR, treatment_RR, stressor_RR)
# 
# power.F_summary_adjusted_RR <- cbind(power.F_summary_adjusted_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F_summary_adjusted_RR$approach_RR <- factor(power.F_summary_adjusted_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# #--------------------- (1) two tailed power ---------------------#
# MMA_power.F_adjusted_RR.approach <- with(power.F_summary_adjusted_RR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F_adjusted_RR.stressor <- with(power.F_summary_adjusted_RR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F_adjusted_RR <- with(power.F_summary_adjusted_RR, rma(yi = Mean, sei = se.F_mean,   method = "REML", test = "t"))
# 
# 
# 
# #---------------------- (2) type S error -----------------------#
# power.F.S_summary_adjusted_RR <- cbind(power.F.S_summary_adjusted_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.S_summary_adjusted_RR$approach_RR <- factor(power.F.S_summary_adjusted_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# MMA_power.F.S_adjusted_RR.approach <- with(power.F.S_summary_adjusted_RR, rma(yi = Mean, sei = se.F.S_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.S_adjusted_RR.stressor <- with(power.F.S_summary_adjusted_RR, rma(yi = Mean, sei = se.F.S_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F.S_adjusted_RR <- with(power.F.S_summary_adjusted_RR, rma(yi = Mean, sei = se.F.S_mean,   method = "REML", test = "t"))
# 
# 
# 
# #-------------- (3) type M error (overestimate ratio) -------------#
# power.F.M_summary_adjusted_RR <- cbind(power.F.M_summary_adjusted_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_adjusted_RR$approach_RR <- factor(power.F.M_summary_adjusted_RR$approach_RR, levels=c("O", "E", "B"))
# 
# MMA_power.F.M_adjusted_RR.approach <- with(power.F.M_summary_adjusted_RR, rma(yi = Median, sei = se.F.M_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.M_adjusted_RR.stressor <- with(power.F.M_summary_adjusted_RR, rma(yi = Median, sei = se.F.M_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F.M_adjusted_RR <- with(power.F.M_summary_adjusted_RR, rma(yi = Mean, sei = se.F.M_mean,   method = "REML", test = "t")) 
# 
# MMA_power.F.M2_adjusted_RR <- with(power.F.M2_summary_adjusted_RR, rma(yi = Mean, sei = se.F.M2_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# #----------------------------------------------------------------#
# #                 (ii) effect size specific effect as true effect
# #----------------------------------------------------------------#
# power.R_summary_adjusted_RR <- cbind(power.R_summary_adjusted_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.R_summary_adjusted_RR$approach_RR <- factor(power.R_summary_adjusted_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# MMA_power.R_adjusted_RR.approach <- with(power.R_summary_adjusted_RR, rma(yi = Mean, sei = se.R_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.R_adjusted_RR.stressor <- with(power.R_summary_adjusted_RR, rma(yi = Mean, sei = se.R_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# 
# MMA_power.R_adjusted_RR <- with(power.R_summary_adjusted_RR, rma(yi = Mean, sei = se.R_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# power.R.S_summary_adjusted_RR <- cbind(power.R.S_summary_adjusted_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.R.S_summary_adjusted_RR$approach_RR <- factor(power.R.S_summary_adjusted_RR$approach_RR, levels=c("O", "E", "B"))
# 
# 
# MMA_power.R.S_adjusted_RR.approach <- with(power.R.S_summary_adjusted_RR, rma(yi = Mean, sei = se.R.S_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.R.S_adjusted_RR.stressor <- with(power.R.S_summary_adjusted_RR, rma(yi = Mean, sei = se.R.S_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.R.S_adjusted_RR <- with(power.R.S_summary_adjusted_RR, rma(yi = Mean, sei = se.R.S_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# power.R.M_summary_adjusted_RR <- cbind(power.R.M_summary_adjusted_RR, moderator_RR)
# 
# # convert moderator to factor with desired ordering of levels
# power.R.M_summary_adjusted_RR$approach_RR <- factor(power.R.M_summary_adjusted_RR$approach_RR, levels=c("O", "E", "B"))
# 
# MMA_power.R.M_adjusted_RR.approach <- with(power.R.M_summary_adjusted_RR, rma(yi = Median, sei = se.R.M_mean,  mods = ~ I(approach_RR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.R.M_adjusted_RR.stressor <- with(power.R.M_summary_adjusted_RR, rma(yi = Median, sei = se.R.M_mean,  mods = ~ I(stressor_RR) -1, method = "REML", test = "t")) 
# 
# MMA_power.R.M_adjusted_RR <- with(power.R.M_summary_adjusted_RR, rma(yi = Median, sei = se.R.M_mean,   method = "REML", test = "t")) # median rather than mean
# 
# MMA_power.R.M2_adjusted_RR <- with(power.R.M2_summary_adjusted_RR, rma(yi = Mean, sei = se.R.M2_mean,   method = "REML", test = "t"))
# 

```





### Results reporting
```{r}


lnRR <- sapply(dat_list, function(x) x$yi) %>% unlist

# Make all the effects positive
lnRR <- abs(lnRR)

# Table 1
# Calculate percentiles r
percentiles_lnRR <- quantile(lnRR, prob = c(0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6,0.65,0.7,0.75,0.8,0.85,0.9,0.95)) 

percentiles_lnRR <- as.data.frame(round(percentiles_lnRR,2))



# Percentiles for Cohen's thresholds
quantile(lnRR, prob = c(0.20)) # small
quantile(lnRR, prob = c(0.50)) # medium
quantile(lnRR, prob = c(0.80)) # large


quantile(individual_est_RR$power.F_RR, prob = c(0.80))


lnRR1 <- data.frame(lnRR)





ggplot(data=lnRR1, aes(lnRR)) + geom_histogram(binwidth=0.25, color='black', fill='skyblue1') +
  geom_vline(aes(xintercept=quantile(lnRR, prob = c(0.25))), color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(lnRR, prob = c(0.50))), color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(lnRR, prob = c(0.75))), color="red", linetype="dashed", size=1) +
  scale_x_continuous(breaks=seq(0, 10, 1)) +
  labs(x = "lnRR", y = "Frequency") +
  theme_cowplot()+
  annotate("text", x = -0.1, y = 1200, label = "25th", size=3.5)+
  annotate("text", x = 0.55, y = 1200, label = "50th", size=3.5)+
  annotate("text", x = 1.00, y = 1200, label = "75th", size=3.5) -> percentiles_lnRR.p

png(filename = "./Figures/percentiles_lnRR.p.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
percentiles_lnRR.p
dev.off()


model_est_RR2 <- model_est_RR
model_est_RR2$mu_RR <- abs(model_est_RR2$mu_RR)






ggplot(data=individual_est_RR, aes(power.F_RR)) + geom_histogram(binwidth=0.05, color='black', fill='skyblue1') +
  geom_vline(aes(xintercept=quantile(power.F_RR, prob = c(0.25))), color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(power.F_RR, prob = c(0.50))), color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(power.F_RR, prob = c(0.75))), color="red", linetype="dashed", size=1) +
  scale_x_continuous(breaks=seq(0, 10, 1)) +
  labs(x = "lnRR", y = "Frequency") +
  theme_cowplot() -> percentiles_lnRR.p
  #annotate("text", x = -0.1, y = 1200, label = "25th", size=3.5)+
  #annotate("text", x = 0.55, y = 1200, label = "50th", size=3.5)+
  #annotate("text", x = 1.00, y = 1200, label = "75th", size=3.5) 

png(filename = "./Figures/percentiles_lnRR.p.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
percentiles_lnRR.p
dev.off()





ggplot(data=individual_est_RR, aes(power.F.S_RR)) + geom_histogram(binwidth=0.05, color='black', fill='skyblue1') +
  geom_vline(aes(xintercept=quantile(power.F.S_RR, prob = c(0.25))), color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(power.F.S_RR, prob = c(0.50))), color="red", linetype="dashed", size=1) +
  geom_vline(aes(xintercept=quantile(power.F.S_RR, prob = c(0.75))), color="red", linetype="dashed", size=1) +
  scale_x_continuous(breaks=seq(0, 10, 1)) +
  labs(x = "lnRR", y = "Frequency") +
  theme_cowplot() -> percentiles_lnRR.p.S
  #annotate("text", x = -0.1, y = 1200, label = "25th", size=3.5)+
  #annotate("text", x = 0.55, y = 1200, label = "50th", size=3.5)+
  #annotate("text", x = 1.00, y = 1200, label = "75th", size=3.5) 

png(filename = "./Figures/percentiles_lnRR.p.S.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
percentiles_lnRR.p.S
dev.off()







# meta-meta-analysis


estimates.CI <- function(model){
  db.mf <- data.frame(round(model$b,3),row.names = 1:nrow(model$b))
  db.mf <- cbind(db.mf,round(model$ci.lb,3),round(model$ci.ub,3),row.names(model$b))
  names(db.mf) <- c("mean","lower","upper","estimate")
  return(db.mf[,c("estimate","mean","lower","upper")])
}

estimates.CI2 <- function(model){
  db.mf <- data.frame(round(model$b,1),row.names = 1:nrow(model$b))
  db.mf <- cbind(db.mf,round(model$ci.lb,1),round(model$ci.ub,1),row.names(model$b))
  names(db.mf) <- c("mean","lower","upper","estimate")
  return(db.mf[,c("estimate","mean","lower","upper")])
}

MMA_power.F_RR
MMA_power.F.S_RR 
MMA_power.F.M_RR
MMA_power.F.M2_RR

MMA_power.R_RR
MMA_power.R.S_RR 
MMA_power.R.M_RR
MMA_power.R.M2_RR

MMA_power.F_adjusted_RR
MMA_power.F.S_adjusted_RR 
MMA_power.F.M_adjusted_RR
MMA_power.F.M2_adjusted_RR


MMA_power.R_adjusted_RR
MMA_power.R.S_adjusted_RR 
MMA_power.R.M_adjusted_RR
MMA_power.R.M2_adjusted_RR

## power ##
estimates.CI(MMA_power.F_RR);estimates.CI(MMA_power.R_RR);estimates.CI(MMA_power.F_adjusted_RR);estimates.CI(MMA_power.R_adjusted_RR)

estimates.CI(MMA_power.F_SMD);estimates.CI(MMA_power.R_SMD);estimates.CI(MMA_power.F_adjusted_SMD);estimates.CI(MMA_power.R_adjusted_SMD)

estimates.CI(MMA_power.F_VR);estimates.CI(MMA_power.R_VR)
estimates.CI(MMA_power.F_CVR);estimates.CI(MMA_power.R_CVR)


estimates.CI(MMA_MA_RR);estimates.CI(MMA_MA_adjusted_RR)
estimates.CI(MMA_MA_SMD);estimates.CI(MMA_MA_adjusted_SMD)
estimates.CI(MMA_MA_VR);estimates.CI(MMA_MA_CVR)


##Type S##
estimates.CI(MMA_power.F.S_RR);estimates.CI(MMA_power.R.S_RR);estimates.CI(MMA_power.F.S_adjusted_RR);estimates.CI(MMA_power.R.S_adjusted_RR)

estimates.CI(MMA_power.F.S_SMD);estimates.CI(MMA_power.R.S_SMD);estimates.CI(MMA_power.F.S_adjusted_SMD);estimates.CI(MMA_power.R.S_adjusted_SMD)

estimates.CI(MMA_power.F.S_VR);estimates.CI(MMA_power.R.S_VR)
estimates.CI(MMA_power.F.S_CVR);estimates.CI(MMA_power.R.S_CVR)


estimates.CI(MMA_MA.S_RR);estimates.CI(MMA_MA.S_adjusted_RR)
estimates.CI(MMA_MA.S_SMD);estimates.CI(MMA_MA.S_adjusted_SMD)
estimates.CI(MMA_MA.S_VR);estimates.CI(MMA_MA.S_CVR)




##Type M##
estimates.CI2(MMA_power.F.M_RR);estimates.CI2(MMA_power.R.M_RR);estimates.CI2(MMA_power.F.M_adjusted_RR);estimates.CI2(MMA_power.R.M_adjusted_RR)

estimates.CI2(MMA_power.F.M_SMD);estimates.CI2(MMA_power.R.M_SMD);estimates.CI2(MMA_power.F.M_adjusted_SMD);estimates.CI2(MMA_power.R.M_adjusted_SMD)

estimates.CI2(MMA_power.F.M_VR);estimates.CI2(MMA_power.R.M_VR)
estimates.CI2(MMA_power.F.M_CVR);estimates.CI2(MMA_power.R.M_CVR)


estimates.CI2(MMA_MA.M_RR);estimates.CI2(MMA_MA.M_adjusted_RR)
estimates.CI2(MMA_MA.M_SMD);estimates.CI2(MMA_MA.M_adjusted_SMD)
estimates.CI2(MMA_MA.M_VR);estimates.CI2(MMA_MA.M_CVR)




## meta-regression
estimates.CI(MMA_power.F_RR.approach);estimates.CI(MMA_power.F_RR.stressor)
estimates.CI(MMA_power.F_adjusted_RR.approach);estimates.CI(MMA_power.F_adjusted_RR.stressor)


estimates.CI2(MMA_power.F.M_RR.approach);estimates.CI2(MMA_power.F.M_RR.stressor)
estimates.CI2(MMA_power.F.M_adjusted_RR.approach);estimates.CI2(MMA_power.F.M_adjusted_RR.stressor)


estimates.CI(MMA_power.F.S_RR.approach);estimates.CI(MMA_power.F.S_RR.stressor)
estimates.CI(MMA_power.F.S_adjusted_RR.approach);estimates.CI(MMA_power.F.S_adjusted_RR.stressor)



estimates.CI(MMA_power.F_CVR.approach);estimates.CI(MMA_power.F_CVR.stressor)
estimates.CI(MMA_power.F_VR.approach);estimates.CI(MMA_power.F_VR.stressor)


estimates.CI2(MMA_power.F.M_CVR.approach);estimates.CI2(MMA_power.F.M_CVR.stressor)
estimates.CI2(MMA_power.F.M_VR.approach);estimates.CI2(MMA_power.F.M_VR.stressor)


estimates.CI(MMA_power.F.S_CVR.approach);estimates.CI(MMA_power.F.S_CVR.stressor)
estimates.CI(MMA_power.F.S_VR.approach);estimates.CI(MMA_power.F.S_VR.stressor)





## adjusted estimates
;estimates.CI(MMA_power.R_RR.stressor);estimates.CI(MMA_power.F_adjusted_RR.stressor);estimates.CI(MMA_power.R_adjusted_RR.stressor)

estimates.CI(MMA_power.R_adjusted_RR.approach)

# lnRR
N_RR <- NA
N_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Study)))

k_RR <- NA
k_RR <- mapply(length, sapply(dat_list, function(x) unique(x$Unit_ID)))

# SMD
N_SMD <- NA
N_SMD <- mapply(length, sapply(SMD, function(x) unique(x$Study)))

k_SMD <- NA
k_SMD <- mapply(length, sapply(SMD, function(x) unique(x$Unit_ID)))

# lnVR
N_VR <- NA
N_VR <- mapply(length, sapply(lnVR, function(x) unique(x$Study)))

k_VR <- NA
k_VR <- mapply(length, sapply(lnVR, function(x) unique(x$Unit_ID)))

# lnCVR
N_CVR <- NA
N_CVR <- mapply(length, sapply(lnCVR, function(x) unique(x$Study)))

k_CVR <- NA
k_CVR <- mapply(length, sapply(lnCVR, function(x) unique(x$Unit_ID)))


MMA_power.F_RR <- with(model_est_RR, rma(yi = mu_RR, sei = SE_RR,   method = "REML", test = "t"))

# meta-analysis level meta-analysis
model_est_RR$k <- k_RR
model_est_adjusted_RR$k <- k_RR

model_est_SMD$k <- k_SMD
model_est_adjusted_SMD$k <- k_SMD

model_est_VR$k <- k_VR
model_est_CVR$k <- k_CVR




# rma(yi = Mean, sei = se.R_mean, test = “t”)) This will give you I2 etc - this may be good


# https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/confint



# Median of adequately powered studies
# lnRR*
power.F_RR_unlist <-sapply(dat_list, function(x) x$power.F_RR) %>% unlist()
power.F_RR_unlist80 <- which(power.F_RR_unlist>0.8)
100*length(power.F_RR_unlist80)/length(power.F_RR_unlist)

power.R_RR_unlist <- sapply(dat_list, function(x) x$power.R_RR) %>% unlist()
power.R_RR_unlist80 <- which(power.R_RR_unlist>0.8)
100*length(power.R_RR_unlist80)/length(power.R_RR_unlist)


power.F_RR_unlist <- sapply(dat_list_adjusted, function(x) x$power.F_RR) %>% unlist()
power.F_RR_unlist80 <- which(power.F_RR_unlist>0.8)
100*length(power.F_RR_unlist80)/length(power.F_RR_unlist)

power.R_RR_unlist <- sapply(dat_list_adjusted, function(x) x$power.R_RR) %>% unlist()
power.R_RR_unlist80 <- which(power.R_RR_unlist>0.8)
100*length(power.R_RR_unlist80)/length(power.R_RR_unlist)



# lnrr
power.F_lnrr_unlist <-sapply(lnrr, function(x) x$power.F_lnrr) %>% unlist()
power.F_lnrr_unlist80 <- which(power.F_lnrr_unlist>0.8)
100*length(power.F_lnrr_unlist80)/length(power.F_lnrr_unlist)

power.R_lnrr_unlist <- sapply(lnrr, function(x) x$power.R_lnrr) %>% unlist()
power.R_lnrr_unlist80 <- which(power.R_lnrr_unlist>0.8)
100*length(power.R_lnrr_unlist80)/length(power.R_lnrr_unlist)


power.F_lnrr_unlist <- sapply(dat_list_adjusted_lnrr, function(x) x$power.F_lnrr) %>% unlist()
power.F_lnrr_unlist80 <- which(power.F_lnrr_unlist>0.8)
100*length(power.F_lnrr_unlist80)/length(power.F_lnrr_unlist)

power.R_lnrr_unlist <- sapply(dat_list_adjusted_lnrr, function(x) x$power.R_lnrr) %>% unlist()
power.R_lnrr_unlist80 <- which(power.R_lnrr_unlist>0.8)
100*length(power.R_lnrr_unlist80)/length(power.R_lnrr_unlist)

# SMD
power.F_SMD_unlist <-sapply(SMD, function(x) x$power.F_SMD) %>% unlist()
power.F_SMD_unlist80 <- which(power.F_SMD_unlist>0.8)
100*length(power.F_SMD_unlist80)/length(power.F_SMD_unlist)

power.R_SMD_unlist <- sapply(SMD, function(x) x$power.R_SMD) %>% unlist()
power.R_SMD_unlist80 <- which(power.R_SMD_unlist>0.8)
100*length(power.R_SMD_unlist80)/length(power.R_SMD_unlist)

power.F_SMD_unlist <-power.F_adjusted_SMD %>% unlist()
power.F_SMD_unlist80 <- which(power.F_SMD_unlist>0.8)
100*length(power.F_SMD_unlist80)/length(power.F_SMD_unlist)

# SMDH
power.F_SMDH_unlist <-sapply(SMDH, function(x) x$power.F_SMDH) %>% unlist()
power.F_SMDH_unlist80 <- which(power.F_SMDH_unlist>0.8)
100*length(power.F_SMDH_unlist80)/length(power.F_SMDH_unlist)

power.R_SMDH_unlist <- sapply(SMDH, function(x) x$power.R_SMDH) %>% unlist()
power.R_SMDH_unlist80 <- which(power.R_SMDH_unlist>0.8)
100*length(power.R_SMDH_unlist80)/length(power.R_SMDH_unlist)

power.F_SMDH_unlist <-power.F_adjusted_SMDH %>% unlist()
power.F_SMDH_unlist80 <- which(power.F_SMDH_unlist>0.8)
100*length(power.F_SMDH_unlist80)/length(power.F_SMDH_unlist)

power.R_SMD_unlist <-power.R_adjusted_SMD %>% unlist()
power.R_SMD_unlist80 <- which(power.R_SMD_unlist>0.8)
100*length(power.R_SMD_unlist80)/length(power.R_SMD_unlist)



# lnVR
power.F_VR_unlist <-sapply(lnVR, function(x) x$power.F_VR) %>% unlist()
power.F_VR_unlist80 <- which(power.F_VR_unlist>0.8)
100*length(power.F_VR_unlist80)/length(power.F_VR_unlist)

power.R_VR_unlist <- sapply(lnVR, function(x) x$power.R_VR) %>% unlist()
power.R_VR_unlist80 <- which(power.R_VR_unlist>0.8)
100*length(power.R_VR_unlist80)/length(power.R_VR_unlist)


# lnCVR
power.F_CVR_unlist <-sapply(lnCVR, function(x) x$power.F_CVR) %>% unlist()
power.F_CVR_unlist80 <- which(power.F_CVR_unlist>0.8)
100*length(power.F_CVR_unlist80)/length(power.F_CVR_unlist)

power.R_CVR_unlist <- sapply(lnCVR, function(x) x$power.R_CVR) %>% unlist()
power.R_CVR_unlist80 <- which(power.R_CVR_unlist>0.8)
100*length(power.R_CVR_unlist80)/length(power.R_CVR_unlist)



#meta-analysis level
100*length(which(model_est_RR$MA.power>0.8))/length(model_est_RR$MA.power)

100*length(which(model_est_adjusted_RR$MA.power>0.8))/length(model_est_RR$MA.power)

100*length(which(model_est_lnrr$MA.power>0.8))/length(model_est_lnrr$MA.power)

100*length(which(model_est_adjusted_lnrr$MA.power>0.8))/length(model_est_lnrr$MA.power)

100*length(which(model_est_SMD$MA.power>0.8))/length(model_est_SMD$MA.power)

100*length(which(model_est_adjusted_SMD$MA.power>0.8))/length(model_est_adjusted_SMD$MA.power)

100*length(which(model_est_SMDH$MA.power>0.8))/length(model_est_SMDH$MA.power)

100*length(which(model_est_adjusted_SMDH$MA.power>0.8))/length(model_est_SMDH$MA.power)

100*length(which(model_est_VR$MA.power>0.8))/length(model_est_VR$MA.power)

100*length(which(model_est_CVR$MA.power>0.8))/length(model_est_CVR$MA.power)


# meta-meta-analysis
MMA_power.F_SMD
MMA_power.F.S_SMD 
MMA_power.F.M_SMD
MMA_power.F.M2_SMD

MMA_power.R_SMD
MMA_power.R.S_SMD 
MMA_power.R.M_SMD
MMA_power.R.M2_SMD

MMA_power.F_adjusted_SMD
MMA_power.F.S_adjusted_SMD 
MMA_power.F.M_adjusted_SMD
MMA_power.F.M2_adjusted_SMD


MMA_power.R_adjusted_SMD
MMA_power.R.S_adjusted_SMD 
MMA_power.R.M_adjusted_SMD
MMA_power.R.M2_adjusted_SMD





# meta-meta-analysis
MMA_power.F_VR
MMA_power.F.S_VR 
MMA_power.F.M_VR
MMA_power.F.M2_VR

MMA_power.R_VR
MMA_power.R.S_VR 
MMA_power.R.M_VR
MMA_power.R.M2_VR







# meta-meta-analysis
MMA_power.F_CVR
MMA_power.F.S_CVR 
MMA_power.F.M_CVR
MMA_power.F.M2_CVR

MMA_power.R_CVR
MMA_power.R.S_CVR 
MMA_power.R.M_CVR
MMA_power.R.M2_CVR



# meta-regression

MMA_power.F_RR.approach
MMA_power.F.M_RR.approach
MMA_power.F.S_RR.approach

MMA_power.F_RR.stressor
MMA_power.F.M_RR.stressor
MMA_power.F.S_RR.stressor

MMA_power.F_adjusted_RR.approach # summary(MMA_power.F_adjusted_RR.approach,digits=3)
MMA_power.F.M_adjusted_RR.approach
MMA_power.F.S_adjusted_RR.approach


MMA_power.F_adjusted_RR.stressor
MMA_power.F.M_adjusted_RR.stressor
MMA_power.F.S_adjusted_RR.stressor



MMA_power.F_CVR.approach
MMA_power.F.M_CVR.approach
MMA_power.F.S_CVR.approach

MMA_power.F_CVR.stressor
MMA_power.F.M_CVR.stressor
MMA_power.F.S_CVR.stressor



MMA_power.F_VR.approach
MMA_power.F.M_VR.approach
MMA_power.F.S_VR.approach

MMA_power.F_VR.stressor
MMA_power.F.M_VR.stressor
MMA_power.F.S_VR.stressor




d90_power_RR_unlist <- d90_power_RR %>% unlist()
d90_power_RRunlist80 <- which(d90_power_RR_unlist>0.8)
100*length(d90_power_RRunlist80)/length(d90_power_RR_unlist)

d20_power_RR_unlist <- d20_power_RR %>% unlist()
d20_power_RRunlist80 <- which(d20_power_RR_unlist>0.8)
100*length(d20_power_RRunlist80)/length(d20_power_RR_unlist)

      
model_est_RR
power.F_summary_RR

model_est_RR %>% select(MA_case, p_value, MA.power) %>% filter(p_value < 0.05) -> model_est_RR.sig  # find the studies which show significant results
which(model_est_RR.sig$MA.power > 0.8) %>% length


model_est_RR$MA.power.M %>% summary()
MMA_power.F.M_RR


MMA_power.F.S_RR


MMA_power.F_RR
MMA_power.F.S_RR 
MMA_power.F.M_RR
MMA_power.F.M2_RR 

MMA_power.F_RR.approach
MMA_power.F.M_RR.approach
MMA_power.F.S_RR.approach

MMA_power.F_RR.stressor

MMA_power.R_RR
MMA_power.R.S_RR 
MMA_power.R.M_RR
MMA_power.R.M2_RR 


power.F_summary_RR$Median %>% range


MMA_power_RR_d90
MMA_power_RR_d100







power.F_CVR_unlist <- power.F_CVR %>% unlist()
power.F_CVR_unlist80 <- which(power.F_CVR_unlist>0.8)
100*length(power.F_CVR_unlist80)/length(power.F_CVR_unlist)

power.R_CVR_unlist <- power.R_CVR %>% unlist()
power.R_CVR_unlist80 <- which(power.R_CVR_unlist>0.8)
100*length(power.R_CVR_unlist80)/length(power.R_CVR_unlist)

d90_power_CVR_unlist <- d90_power_CVR %>% unlist()
d90_power_CVRunlist80 <- which(d90_power_CVR_unlist>0.8)
100*length(d90_power_CVRunlist80)/length(d90_power_CVR_unlist)

d20_power_CVR_unlist <- d20_power_CVR %>% unlist()
d20_power_CVRunlist80 <- which(d20_power_CVR_unlist>0.8)
100*length(d20_power_CVRunlist80)/length(d20_power_CVR_unlist)

      
model_est_CVR
power.F_summary_CVR

model_est_CVR %>% select(MA_case, p_value, MA.power) %>% filter(p_value < 0.05) -> model_est_CVR.sig  # find the studies which show significant results
which(model_est_CVR.sig$MA.power > 0.8) %>% length


model_est_CVR$MA.power.M %>% summary()
MMA_power.F.M_CVR


model_est_CVR$MA.power.S %>% summary()
MMA_power.F.S_CVR


MMA_power.F_CVR
MMA_power.F.S_CVR 
MMA_power.F.M_CVR
MMA_power.F.M2_CVR 

MMA_power.F_CVR.approach
MMA_power.F.M_CVR.approach
MMA_power.F.S_CVR.approach

MMA_power.R_CVR
MMA_power.R.S_CVR 
MMA_power.R.M_CVR
MMA_power.R.M2_CVR 

power.F_summary_RR$Median %>% range

MMA_power_CVR_d90
MMA_power_CVR_d100






power.F_VR_unlist <- power.F_VR %>% unlist()
power.F_VR_unlist80 <- which(power.F_VR_unlist>0.8)
100*length(power.F_VR_unlist80)/length(power.F_VR_unlist)

power.R_VR_unlist <- power.R_VR %>% unlist()
power.R_VR_unlist80 <- which(power.R_VR_unlist>0.8)
100*length(power.R_VR_unlist80)/length(power.R_VR_unlist)

d90_power_VR_unlist <- d90_power_VR %>% unlist()
d90_power_VRunlist80 <- which(d90_power_VR_unlist>0.8)
100*length(d90_power_VRunlist80)/length(d90_power_VR_unlist)

d20_power_VR_unlist <- d20_power_VR %>% unlist()
d20_power_VRunlist80 <- which(d20_power_VR_unlist>0.8)
100*length(d20_power_VRunlist80)/length(d20_power_VR_unlist)

      
model_est_VR
power.F_summary_VR

model_est_VR %>% select(MA_case, p_value, MA.power) %>% filter(p_value < 0.05) -> model_est_VR.sig  # find the studies which show significant results
which(model_est_VR.sig$MA.power > 0.8) %>% length


model_est_VR$MA.power.M %>% summary()
MMA_power.F.M_VR


MMA_power.F.S_VR


MMA_power.F_VR
MMA_power.F.S_VR 
MMA_power.F.M_VR
MMA_power.F.M2_VR 

MMA_power.F_VR.approach
MMA_power.F.M_VR.approach
MMA_power.F.S_VR.approach

MMA_power.R_VR
MMA_power.R.S_VR 
MMA_power.R.M_VR
MMA_power.R.M2_VR 

power.F_summary_RR$Median %>% range

MMA_power_VR_d90
MMA_power_VR_d100

```








### Model estiamte extractions
In this section, we extractd the estimates (median, mean and 95% CIs) from lm and lmer model, both for individual level and meta-analysis level 

```{r}
# meta-analysis level
# power
MMA_MA_RR2_estimate <- data.frame(coef(summary(MMA_MA_RR2))%>% exp() %>%  round(3))
MMA_MA_RR2_estimate$lb.ci <- (confint(MMA_MA_RR2) %>% exp() %>%  round(3))[1]
MMA_MA_RR2_estimate$ub.ci <- (confint(MMA_MA_RR2) %>% exp() %>%  round(3))[2]
MMA_MA_RR2_estimate$Mean <- (MMA_MA_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)



MMA_MA_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_MA_adjusted_RR2))%>% exp() %>%  round(3))
MMA_MA_adjusted_RR2_estimate$lb.ci <- (confint(MMA_MA_adjusted_RR2) %>% exp() %>%  round(3))[1]
MMA_MA_adjusted_RR2_estimate$ub.ci <- (confint(MMA_MA_adjusted_RR2) %>% exp() %>%  round(3))[2]
MMA_MA_adjusted_RR2_estimate$Mean <- (MMA_MA_adjusted_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)




MMA_MA_lnrr2_estimate <- data.frame(coef(summary(MMA_MA_lnrr2))%>% exp() %>%  round(3))
MMA_MA_lnrr2_estimate$lb.ci <- (confint(MMA_MA_lnrr2) %>% exp() %>%  round(3))[1]
MMA_MA_lnrr2_estimate$ub.ci <- (confint(MMA_MA_lnrr2) %>% exp() %>%  round(3))[2]
MMA_MA_lnrr2_estimate$Mean <- (MMA_MA_lnrr2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)


MMA_MA_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_MA_adjusted_lnrr2))%>% exp() %>%  round(3))
MMA_MA_adjusted_lnrr2_estimate$lb.ci <- (confint(MMA_MA_adjusted_lnrr2) %>% exp() %>%  round(3))[1]
MMA_MA_adjusted_lnrr2_estimate$ub.ci <- (confint(MMA_MA_adjusted_lnrr2) %>% exp() %>%  round(3))[2]
MMA_MA_adjusted_lnrr2_estimate$Mean <- (MMA_MA_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)



MMA_MA_SMD2_estimate <- data.frame(coef(summary(MMA_MA_SMD2))%>% exp() %>%  round(3))
MMA_MA_SMD2_estimate$lb.ci <- (confint(MMA_MA_SMD2) %>% exp() %>%  round(3))[1]
MMA_MA_SMD2_estimate$ub.ci <- (confint(MMA_MA_SMD2) %>% exp() %>%  round(3))[2]
MMA_MA_SMD2_estimate$Mean <- (MMA_MA_SMD2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)



MMA_MA_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_MA_adjusted_SMD2))%>% exp() %>%  round(3))
MMA_MA_adjusted_SMD2_estimate$lb.ci <- (confint(MMA_MA_adjusted_SMD2) %>% exp() %>%  round(3))[1]
MMA_MA_adjusted_SMD2_estimate$ub.ci <- (confint(MMA_MA_adjusted_SMD2) %>% exp() %>%  round(3))[2]
MMA_MA_adjusted_SMD2_estimate$Mean <- (MMA_MA_adjusted_SMD2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)




MMA_MA_SMDH2_estimate <- data.frame(coef(summary(MMA_MA_SMDH2))%>% exp() %>%  round(3))
MMA_MA_SMDH2_estimate$lb.ci <- (confint(MMA_MA_SMDH2) %>% exp() %>%  round(3))[1]
MMA_MA_SMDH2_estimate$ub.ci <- (confint(MMA_MA_SMDH2) %>% exp() %>%  round(3))[2]
MMA_MA_SMDH2_estimate$Mean <- (MMA_MA_SMDH2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)



MMA_MA_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_MA_adjusted_SMDH2))%>% exp() %>%  round(3))
MMA_MA_adjusted_SMDH2_estimate$lb.ci <- (confint(MMA_MA_adjusted_SMDH2) %>% exp() %>%  round(3))[1]
MMA_MA_adjusted_SMDH2_estimate$ub.ci <- (confint(MMA_MA_adjusted_SMDH2) %>% exp() %>%  round(3))[2]
MMA_MA_adjusted_SMDH2_estimate$Mean <- (MMA_MA_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)



MMA_MA_VR2_estimate <- data.frame(coef(summary(MMA_MA_VR2))%>% exp() %>%  round(3))
MMA_MA_VR2_estimate$lb.ci <- (confint(MMA_MA_VR2) %>% exp() %>%  round(3))[1]
MMA_MA_VR2_estimate$ub.ci <- (confint(MMA_MA_VR2) %>% exp() %>%  round(3))[2]
MMA_MA_VR2_estimate$Mean <- (MMA_MA_VR2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)


MMA_MA_CVR2_estimate <- data.frame(coef(summary(MMA_MA_CVR2))%>% exp() %>%  round(3))
MMA_MA_CVR2_estimate$lb.ci <- (confint(MMA_MA_CVR2) %>% exp() %>%  round(3))[1]
MMA_MA_CVR2_estimate$ub.ci <- (confint(MMA_MA_CVR2) %>% exp() %>%  round(3))[2]
MMA_MA_CVR2_estimate$Mean <- (MMA_MA_CVR2$coefficients + 0.5*var(log(model_est_RR$MA.power))) %>% exp() %>%  round(3)



# type S
MMA_MA.S_RR2_estimate <- data.frame(coef(summary(MMA_MA.S_RR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_RR2_estimate$lb.ci <- (confint(MMA_MA.S_RR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_RR2_estimate$ub.ci <- (confint(MMA_MA.S_RR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_RR2_estimate$Mean <- (MMA_MA.S_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025




MMA_MA.S_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_MA.S_adjusted_RR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_adjusted_RR2_estimate$lb.ci <- (confint(MMA_MA.S_adjusted_RR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_adjusted_RR2_estimate$ub.ci <- (confint(MMA_MA.S_adjusted_RR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_adjusted_RR2_estimate$Mean <- (MMA_MA.S_adjusted_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.S_lnrr2_estimate <- data.frame(coef(summary(MMA_MA.S_lnrr2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_lnrr2_estimate$lb.ci <- (confint(MMA_MA.S_lnrr2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_lnrr2_estimate$ub.ci <- (confint(MMA_MA.S_lnrr2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_lnrr2_estimate$Mean <- (MMA_MA.S_lnrr2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025


MMA_MA.S_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_MA.S_adjusted_lnrr2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_adjusted_lnrr2_estimate$lb.ci <- (confint(MMA_MA.S_adjusted_lnrr2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_adjusted_lnrr2_estimate$ub.ci <- (confint(MMA_MA.S_adjusted_lnrr2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_adjusted_lnrr2_estimate$Mean <- (MMA_MA.S_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025




MMA_MA.S_SMD2_estimate <- data.frame(coef(summary(MMA_MA.S_SMD2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_SMD2_estimate$lb.ci <- (confint(MMA_MA.S_SMD2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_SMD2_estimate$ub.ci <- (confint(MMA_MA.S_SMD2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_SMD2_estimate$Mean <- (MMA_MA.S_SMD2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.S_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_MA.S_adjusted_SMD2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_adjusted_SMD2_estimate$lb.ci <- (confint(MMA_MA.S_adjusted_SMD2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_adjusted_SMD2_estimate$ub.ci <- (confint(MMA_MA.S_adjusted_SMD2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_adjusted_SMD2_estimate$Mean <- (MMA_MA.S_adjusted_SMD2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.S_SMDH2_estimate <- data.frame(coef(summary(MMA_MA.S_SMDH2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_SMDH2_estimate$lb.ci <- (confint(MMA_MA.S_SMDH2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_SMDH2_estimate$ub.ci <- (confint(MMA_MA.S_SMDH2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_SMDH2_estimate$Mean <- (MMA_MA.S_SMDH2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.S_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_MA.S_adjusted_SMDH2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_adjusted_SMDH2_estimate$lb.ci <- (confint(MMA_MA.S_adjusted_SMDH2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_adjusted_SMDH2_estimate$ub.ci <- (confint(MMA_MA.S_adjusted_SMDH2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_adjusted_SMDH2_estimate$Mean <- (MMA_MA.S_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.S_VR2_estimate <- data.frame(coef(summary(MMA_MA.S_VR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_VR2_estimate$lb.ci <- (confint(MMA_MA.S_VR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_VR2_estimate$ub.ci <- (confint(MMA_MA.S_VR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_VR2_estimate$Mean <- (MMA_MA.S_VR2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.S_CVR2_estimate <- data.frame(coef(summary(MMA_MA.S_CVR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.S_CVR2_estimate$lb.ci <- (confint(MMA_MA.S_CVR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.S_CVR2_estimate$ub.ci <- (confint(MMA_MA.S_CVR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.S_CVR2_estimate$Mean <- (MMA_MA.S_CVR2$coefficients + 0.5*var(log(model_est_RR$MA.power.S + 0.025))) %>% exp()  %>%  round(3) - 0.025





# type M
MMA_MA.M_RR2_estimate <- data.frame(coef(summary(MMA_MA.M_RR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_RR2_estimate$lb.ci <- (confint(MMA_MA.M_RR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_RR2_estimate$ub.ci <- (confint(MMA_MA.M_RR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_RR2_estimate$Mean <- (MMA_MA.M_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_MA.M_adjusted_RR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_adjusted_RR2_estimate$lb.ci <- (confint(MMA_MA.M_adjusted_RR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_adjusted_RR2_estimate$ub.ci <- (confint(MMA_MA.M_adjusted_RR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_adjusted_RR2_estimate$Mean <- (MMA_MA.M_adjusted_RR2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_lnrr2_estimate <- data.frame(coef(summary(MMA_MA.M_lnrr2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_lnrr2_estimate$lb.ci <- (confint(MMA_MA.M_lnrr2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_lnrr2_estimate$ub.ci <- (confint(MMA_MA.M_lnrr2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_lnrr2_estimate$Mean <- (MMA_MA.M_lnrr2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025


MMA_MA.M_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_MA.M_adjusted_lnrr2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_adjusted_lnrr2_estimate$lb.ci <- (confint(MMA_MA.M_adjusted_lnrr2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_adjusted_lnrr2_estimate$ub.ci <- (confint(MMA_MA.M_adjusted_lnrr2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_adjusted_lnrr2_estimate$Mean <- (MMA_MA.M_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025




MMA_MA.M_SMD2_estimate <- data.frame(coef(summary(MMA_MA.M_SMD2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_SMD2_estimate$lb.ci <- (confint(MMA_MA.M_SMD2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_SMD2_estimate$ub.ci <- (confint(MMA_MA.M_SMD2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_SMD2_estimate$Mean <- (MMA_MA.M_SMD2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_MA.M_adjusted_SMD2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_adjusted_SMD2_estimate$lb.ci <- (confint(MMA_MA.M_adjusted_SMD2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_adjusted_SMD2_estimate$ub.ci <- (confint(MMA_MA.M_adjusted_SMD2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_adjusted_SMD2_estimate$Mean <- (MMA_MA.M_adjusted_SMD2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_SMDH2_estimate <- data.frame(coef(summary(MMA_MA.M_SMDH2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_SMDH2_estimate$lb.ci <- (confint(MMA_MA.M_SMDH2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_SMDH2_estimate$ub.ci <- (confint(MMA_MA.M_SMDH2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_SMDH2_estimate$Mean <- (MMA_MA.M_SMDH2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_MA.M_adjusted_SMDH2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_adjusted_SMDH2_estimate$lb.ci <- (confint(MMA_MA.M_adjusted_SMDH2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_adjusted_SMDH2_estimate$ub.ci <- (confint(MMA_MA.M_adjusted_SMDH2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_adjusted_SMDH2_estimate$Mean <- (MMA_MA.M_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_VR2_estimate <- data.frame(coef(summary(MMA_MA.M_VR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_VR2_estimate$lb.ci <- (confint(MMA_MA.M_VR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_VR2_estimate$ub.ci <- (confint(MMA_MA.M_VR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_VR2_estimate$Mean <- (MMA_MA.M_VR2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025



MMA_MA.M_CVR2_estimate <- data.frame(coef(summary(MMA_MA.M_CVR2))%>% exp() %>%  round(3) - 0.025)
MMA_MA.M_CVR2_estimate$lb.ci <- (confint(MMA_MA.M_CVR2) %>% exp() %>%  round(3) - 0.025)[1]
MMA_MA.M_CVR2_estimate$ub.ci <- (confint(MMA_MA.M_CVR2) %>% exp() %>%  round(3) - 0.025)[2]
MMA_MA.M_CVR2_estimate$Mean <- (MMA_MA.M_CVR2$coefficients + 0.5*var(log(model_est_RR$MA.power.M + 0.025))) %>% exp()  %>%  round(3) - 0.025




# individual level
# power
#lnRR*
MMA_power.F_RR2_estimate <- data.frame(coef(summary(MMA_power.F_RR2)) %>% exp() %>% round(3))
MMA_power.F_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.F_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.F_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_RR2_estimate$Mean <- (summary(MMA_power.F_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)


MMA_power.F_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_power.F_adjusted_RR2)) %>% exp() %>% round(3))
MMA_power.F_adjusted_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.F_adjusted_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_adjusted_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.F_adjusted_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_adjusted_RR2_estimate$Mean <- (summary(MMA_power.F_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)



MMA_power.R_RR2_estimate <- data.frame(coef(summary(MMA_power.R_RR2)) %>% exp() %>% round(3))
MMA_power.R_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.R_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.R_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_RR2_estimate$Mean <- (summary(MMA_power.R_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)


MMA_power.R_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_power.R_adjusted_RR2)) %>% exp() %>% round(3))
MMA_power.R_adjusted_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.R_adjusted_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_adjusted_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.R_adjusted_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_adjusted_RR2_estimate$Mean <- (summary(MMA_power.R_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)



#lnrr
MMA_power.F_lnrr2_estimate <- data.frame(coef(summary(MMA_power.F_lnrr2)) %>% exp() %>% round(3))
MMA_power.F_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.F_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.F_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_lnrr2_estimate$Mean <- (summary(MMA_power.F_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)


MMA_power.F_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_power.F_adjusted_lnrr2)) %>% exp() %>% round(3))
MMA_power.F_adjusted_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.F_adjusted_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_adjusted_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.F_adjusted_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_adjusted_lnrr2_estimate$Mean <- (summary(MMA_power.F_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)



MMA_power.R_lnrr2_estimate <- data.frame(coef(summary(MMA_power.R_lnrr2)) %>% exp() %>% round(3))
MMA_power.R_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.R_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.R_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_lnrr2_estimate$Mean <- (summary(MMA_power.R_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)


MMA_power.R_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_power.R_adjusted_lnrr2)) %>% exp() %>% round(3))
MMA_power.R_adjusted_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.R_adjusted_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_adjusted_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.R_adjusted_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_adjusted_lnrr2_estimate$Mean <- (summary(MMA_power.R_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)



# SMD
MMA_power.F_SMD2_estimate <- data.frame(coef(summary(MMA_power.F_SMD2)) %>% exp() %>% round(3))
MMA_power.F_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.F_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.F_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_SMD2_estimate$Mean <- (summary(MMA_power.F_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)


MMA_power.F_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_power.F_adjusted_SMD2)) %>% exp() %>% round(3))
MMA_power.F_adjusted_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.F_adjusted_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_adjusted_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.F_adjusted_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_adjusted_SMD2_estimate$Mean <- (summary(MMA_power.F_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)



MMA_power.R_SMD2_estimate <- data.frame(coef(summary(MMA_power.R_SMD2)) %>% exp() %>% round(3))
MMA_power.R_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.R_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.R_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_SMD2_estimate$Mean <- (summary(MMA_power.R_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)


MMA_power.R_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_power.R_adjusted_SMD2)) %>% exp() %>% round(3))
MMA_power.R_adjusted_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.R_adjusted_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_adjusted_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.R_adjusted_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_adjusted_SMD2_estimate$Mean <- (summary(MMA_power.R_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)



# SMDH
MMA_power.F_SMDH2_estimate <- data.frame(coef(summary(MMA_power.F_SMDH2)) %>% exp() %>% round(3))
MMA_power.F_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.F_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.F_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_SMDH2_estimate$Mean <- (summary(MMA_power.F_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)


MMA_power.F_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_power.F_adjusted_SMDH2)) %>% exp() %>% round(3))
MMA_power.F_adjusted_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.F_adjusted_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_adjusted_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.F_adjusted_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_adjusted_SMDH2_estimate$Mean <- (summary(MMA_power.F_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)



MMA_power.R_SMDH2_estimate <- data.frame(coef(summary(MMA_power.R_SMDH2)) %>% exp() %>% round(3))
MMA_power.R_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.R_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.R_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_SMDH2_estimate$Mean <- (summary(MMA_power.R_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)


MMA_power.R_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_power.R_adjusted_SMDH2)) %>% exp() %>% round(3))
MMA_power.R_adjusted_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.R_adjusted_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_adjusted_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.R_adjusted_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_adjusted_SMDH2_estimate$Mean <- (summary(MMA_power.R_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)




# lnVR
MMA_power.F_VR2_estimate <- data.frame(coef(summary(MMA_power.F_VR2)) %>% exp() %>% round(3))
MMA_power.F_VR2_estimate$lb.ci <- data.frame(confint(MMA_power.F_VR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_VR2_estimate$ub.ci <- data.frame(confint(MMA_power.F_VR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_VR2_estimate$Mean <- (summary(MMA_power.F_VR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)


MMA_power.R_VR2_estimate <- data.frame(coef(summary(MMA_power.R_VR2)) %>% exp() %>% round(3))
MMA_power.R_VR2_estimate$lb.ci <- data.frame(confint(MMA_power.R_VR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_VR2_estimate$ub.ci <- data.frame(confint(MMA_power.R_VR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_VR2_estimate$Mean <- (summary(MMA_power.R_VR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)




# lnCVR
MMA_power.F_CVR2_estimate <- data.frame(coef(summary(MMA_power.F_CVR2)) %>% exp() %>% round(3))
MMA_power.F_CVR2_estimate$lb.ci <- data.frame(confint(MMA_power.F_CVR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F_CVR2_estimate$ub.ci <- data.frame(confint(MMA_power.F_CVR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F_CVR2_estimate$Mean <- (summary(MMA_power.F_CVR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR))) %>% exp() %>% round(3)


MMA_power.R_CVR2_estimate <- data.frame(coef(summary(MMA_power.R_CVR2)) %>% exp() %>% round(3))
MMA_power.R_CVR2_estimate$lb.ci <- data.frame(confint(MMA_power.R_CVR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R_CVR2_estimate$ub.ci <- data.frame(confint(MMA_power.R_CVR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R_CVR2_estimate$Mean <- (summary(MMA_power.R_CVR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR))) %>% exp() %>% round(3)



# type S
# lnRR*
MMA_power.F.S_RR2_estimate <- data.frame(coef(summary(MMA_power.F.S_RR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_RR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_RR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_RR2_estimate$Mean <- (summary(MMA_power.F.S_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		



MMA_power.F.S_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_power.F.S_adjusted_RR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_adjusted_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_adjusted_RR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_adjusted_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_adjusted_RR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_adjusted_RR2_estimate$Mean <- (summary(MMA_power.F.S_adjusted_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025




MMA_power.R.S_RR2_estimate <- data.frame(coef(summary(MMA_power.R.S_RR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_RR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_RR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_RR2_estimate$Mean <- (summary(MMA_power.R.S_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		

MMA_power.R.S_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_power.R.S_adjusted_RR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_adjusted_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_adjusted_RR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_adjusted_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_adjusted_RR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_adjusted_RR2_estimate$Mean <- (summary(MMA_power.R.S_adjusted_RR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_RR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_RR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025






# lnrr
MMA_power.F.S_lnrr2_estimate <- data.frame(coef(summary(MMA_power.F.S_lnrr2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_lnrr2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_lnrr2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_lnrr2_estimate$Mean <- (summary(MMA_power.F.S_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		



MMA_power.F.S_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_power.F.S_adjusted_lnrr2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_adjusted_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_adjusted_lnrr2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_adjusted_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_adjusted_lnrr2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_adjusted_lnrr2_estimate$Mean <- (summary(MMA_power.F.S_adjusted_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025




MMA_power.R.S_lnrr2_estimate <- data.frame(coef(summary(MMA_power.R.S_lnrr2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_lnrr2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_lnrr2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_lnrr2_estimate$Mean <- (summary(MMA_power.R.S_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		

MMA_power.R.S_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_power.R.S_adjusted_lnrr2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_adjusted_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_adjusted_lnrr2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_adjusted_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_adjusted_lnrr2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_adjusted_lnrr2_estimate$Mean <- (summary(MMA_power.R.S_adjusted_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025




# SMD
MMA_power.F.S_SMD2_estimate <- data.frame(coef(summary(MMA_power.F.S_SMD2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_SMD2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_SMD2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_SMD2_estimate$Mean <- (summary(MMA_power.F.S_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		



MMA_power.F.S_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_power.F.S_adjusted_SMD2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_adjusted_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_adjusted_SMD2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_adjusted_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_adjusted_SMD2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_adjusted_SMD2_estimate$Mean <- (summary(MMA_power.F.S_adjusted_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025




MMA_power.R.S_SMD2_estimate <- data.frame(coef(summary(MMA_power.R.S_SMD2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_SMD2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_SMD2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_SMD2_estimate$Mean <- (summary(MMA_power.R.S_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		

MMA_power.R.S_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_power.R.S_adjusted_SMD2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_adjusted_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_adjusted_SMD2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_adjusted_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_adjusted_SMD2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_adjusted_SMD2_estimate$Mean <- (summary(MMA_power.R.S_adjusted_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025





# SMDH
MMA_power.F.S_SMDH2_estimate <- data.frame(coef(summary(MMA_power.F.S_SMDH2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_SMDH2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_SMDH2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_SMDH2_estimate$Mean <- (summary(MMA_power.F.S_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		



MMA_power.F.S_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_power.F.S_adjusted_SMDH2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_adjusted_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_adjusted_SMDH2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_adjusted_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_adjusted_SMDH2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_adjusted_SMDH2_estimate$Mean <- (summary(MMA_power.F.S_adjusted_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025




MMA_power.R.S_SMDH2_estimate <- data.frame(coef(summary(MMA_power.R.S_SMDH2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_SMDH2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_SMDH2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_SMDH2_estimate$Mean <- (summary(MMA_power.R.S_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		

MMA_power.R.S_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_power.R.S_adjusted_SMDH2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_adjusted_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_adjusted_SMDH2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_adjusted_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_adjusted_SMDH2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_adjusted_SMDH2_estimate$Mean <- (summary(MMA_power.R.S_adjusted_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025



# lnVR
MMA_power.F.S_VR2_estimate <- data.frame(coef(summary(MMA_power.F.S_VR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_VR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_VR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_VR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_VR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_VR2_estimate$Mean <- (summary(MMA_power.F.S_VR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_VR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_VR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		

MMA_power.R.S_VR2_estimate <- data.frame(coef(summary(MMA_power.R.S_VR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_VR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_VR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_VR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_VR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_VR2_estimate$Mean <- (summary(MMA_power.R.S_VR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_VR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_VR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		
# lnCVR
MMA_power.F.S_CVR2_estimate <- data.frame(coef(summary(MMA_power.F.S_CVR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.F.S_CVR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.S_CVR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.F.S_CVR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.S_CVR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.F.S_CVR2_estimate$Mean <- (summary(MMA_power.F.S_CVR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_CVR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_CVR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		

MMA_power.R.S_CVR2_estimate <- data.frame(coef(summary(MMA_power.R.S_CVR2)) %>% exp()  %>% round(3) - 0.025) 
MMA_power.R.S_CVR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.S_CVR2) %>% exp()  %>% round(3) - 0.025)$X2.5..[3]
MMA_power.R.S_CVR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.S_CVR2) %>% exp()  %>% round(3) - 0.025)$X97.5..[3]
MMA_power.R.S_CVR2_estimate$Mean <- (summary(MMA_power.R.S_CVR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_CVR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_CVR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() %>% round(3) - 0.025
		


# Type M
#lnRR*
MMA_power.F.M_RR2_estimate <- data.frame(coef(summary(MMA_power.F.M_RR2)) %>% exp() %>% round(3))
MMA_power.F.M_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_RR2_estimate$Mean <- (summary(MMA_power.F.M_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)


MMA_power.F.M_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_power.F.M_adjusted_RR2)) %>% exp() %>% round(3))
MMA_power.F.M_adjusted_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_adjusted_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_adjusted_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_adjusted_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_adjusted_RR2_estimate$Mean <- (summary(MMA_power.F.M_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)



MMA_power.R.M_RR2_estimate <- data.frame(coef(summary(MMA_power.R.M_RR2)) %>% exp() %>% round(3))
MMA_power.R.M_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_RR2_estimate$Mean <- (summary(MMA_power.R.M_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)


MMA_power.R.M_adjusted_RR2_estimate <- data.frame(coef(summary(MMA_power.R.M_adjusted_RR2)) %>% exp() %>% round(3))
MMA_power.R.M_adjusted_RR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_adjusted_RR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_adjusted_RR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_adjusted_RR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_adjusted_RR2_estimate$Mean <- (summary(MMA_power.R.M_adjusted_RR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)



#lnrr
MMA_power.F.M_lnrr2_estimate <- data.frame(coef(summary(MMA_power.F.M_lnrr2)) %>% exp() %>% round(3))
MMA_power.F.M_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_lnrr2_estimate$Mean <- (summary(MMA_power.F.M_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)


MMA_power.F.M_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_power.F.M_adjusted_lnrr2)) %>% exp() %>% round(3))
MMA_power.F.M_adjusted_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_adjusted_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_adjusted_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_adjusted_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_adjusted_lnrr2_estimate$Mean <- (summary(MMA_power.F.M_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)



MMA_power.R.M_lnrr2_estimate <- data.frame(coef(summary(MMA_power.R.M_lnrr2)) %>% exp() %>% round(3))
MMA_power.R.M_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_lnrr2_estimate$Mean <- (summary(MMA_power.R.M_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)


MMA_power.R.M_adjusted_lnrr2_estimate <- data.frame(coef(summary(MMA_power.R.M_adjusted_lnrr2)) %>% exp() %>% round(3))
MMA_power.R.M_adjusted_lnrr2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_adjusted_lnrr2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_adjusted_lnrr2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_adjusted_lnrr2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_adjusted_lnrr2_estimate$Mean <- (summary(MMA_power.R.M_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)



# SMD
MMA_power.F.M_SMD2_estimate <- data.frame(coef(summary(MMA_power.F.M_SMD2)) %>% exp() %>% round(3))
MMA_power.F.M_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_SMD2_estimate$Mean <- (summary(MMA_power.F.M_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)


MMA_power.F.M_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_power.F.M_adjusted_SMD2)) %>% exp() %>% round(3))
MMA_power.F.M_adjusted_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_adjusted_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_adjusted_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_adjusted_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_adjusted_SMD2_estimate$Mean <- (summary(MMA_power.F.M_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)



MMA_power.R.M_SMD2_estimate <- data.frame(coef(summary(MMA_power.R.M_SMD2)) %>% exp() %>% round(3))
MMA_power.R.M_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_SMD2_estimate$Mean <- (summary(MMA_power.R.M_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)


MMA_power.R.M_adjusted_SMD2_estimate <- data.frame(coef(summary(MMA_power.R.M_adjusted_SMD2)) %>% exp() %>% round(3))
MMA_power.R.M_adjusted_SMD2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_adjusted_SMD2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_adjusted_SMD2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_adjusted_SMD2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_adjusted_SMD2_estimate$Mean <- (summary(MMA_power.R.M_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)



# SMDH
MMA_power.F.M_SMDH2_estimate <- data.frame(coef(summary(MMA_power.F.M_SMDH2)) %>% exp() %>% round(3))
MMA_power.F.M_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_SMDH2_estimate$Mean <- (summary(MMA_power.F.M_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)


MMA_power.F.M_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_power.F.M_adjusted_SMDH2)) %>% exp() %>% round(3))
MMA_power.F.M_adjusted_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_adjusted_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_adjusted_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_adjusted_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_adjusted_SMDH2_estimate$Mean <- (summary(MMA_power.F.M_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)



MMA_power.R.M_SMDH2_estimate <- data.frame(coef(summary(MMA_power.R.M_SMDH2)) %>% exp() %>% round(3))
MMA_power.R.M_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_SMDH2_estimate$Mean <- (summary(MMA_power.R.M_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)


MMA_power.R.M_adjusted_SMDH2_estimate <- data.frame(coef(summary(MMA_power.R.M_adjusted_SMDH2)) %>% exp() %>% round(3))
MMA_power.R.M_adjusted_SMDH2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_adjusted_SMDH2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_adjusted_SMDH2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_adjusted_SMDH2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_adjusted_SMDH2_estimate$Mean <- (summary(MMA_power.R.M_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)




# lnVR
MMA_power.F.M_VR2_estimate <- data.frame(coef(summary(MMA_power.F.M_VR2)) %>% exp() %>% round(3))
MMA_power.F.M_VR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_VR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_VR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_VR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_VR2_estimate$Mean <- (summary(MMA_power.F.M_VR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)


MMA_power.R.M_VR2_estimate <- data.frame(coef(summary(MMA_power.R.M_VR2)) %>% exp() %>% round(3))
MMA_power.R.M_VR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_VR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_VR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_VR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_VR2_estimate$Mean <- (summary(MMA_power.R.M_VR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)




# lnCVR
MMA_power.F.M_CVR2_estimate <- data.frame(coef(summary(MMA_power.F.M_CVR2)) %>% exp() %>% round(3))
MMA_power.F.M_CVR2_estimate$lb.ci <- data.frame(confint(MMA_power.F.M_CVR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.F.M_CVR2_estimate$ub.ci <- data.frame(confint(MMA_power.F.M_CVR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.F.M_CVR2_estimate$Mean <- (summary(MMA_power.F.M_CVR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR))) %>% exp() %>% round(3)


MMA_power.R.M_CVR2_estimate <- data.frame(coef(summary(MMA_power.R.M_CVR2)) %>% exp() %>% round(3))
MMA_power.R.M_CVR2_estimate$lb.ci <- data.frame(confint(MMA_power.R.M_CVR2) %>% exp() %>% round(3))$X2.5..[3]
MMA_power.R.M_CVR2_estimate$ub.ci <- data.frame(confint(MMA_power.R.M_CVR2) %>% exp() %>% round(3))$X97.5..[3]
MMA_power.R.M_CVR2_estimate$Mean <- (summary(MMA_power.R.M_CVR2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R.M_RR))) %>% exp() %>% round(3)


```




### Tables in the main text
In this section, we made tables used in main text.
Table 2 = power for individual and meta-analysis levels
Table 3 = Type S for individual and meta-analysis levels
Table 4 = Type M for individual and meta-analysis levels

```{r}
# table for individual level power
table_individual_power <- data.frame("effect_size" = c(rep("lnRR*",4),
                                                       rep("lnRR",4),
                                                       rep("SMD",4),
                                                       rep("SMDH",4),
                                                       rep("lnVR",2),
                                                       rep("lnCVR",2)), 
           "true_effect" = c("cMAOM", "cESSP", "MAOM", "ESSP", # lnRR*
                             "cMAOM", "cESSP", "MAOM", "ESSP", # lnRR
                             "cMAOM", "cESSP", "MAOM", "ESSP", # SMD
                             "cMAOM", "cESSP", "MAOM", "ESSP", # SMDH
                             "MAOM", "ESSP", # lnVR
                             "MAOM", "ESSP"), # lnCVR
           "Median" = c(MMA_power.F_adjusted_RR2_estimate$Estimate,
                        MMA_power.R_adjusted_RR2_estimate$Estimate,
                        MMA_power.F_RR2_estimate$Estimate,
                        MMA_power.R_RR2_estimate$Estimate,
                        
                        MMA_power.F_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.R_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.F_lnrr2_estimate$Estimate,
                        MMA_power.R_lnrr2_estimate$Estimate,
                        
                        MMA_power.F_adjusted_SMD2_estimate$Estimate,
                        MMA_power.R_adjusted_SMD2_estimate$Estimate,
                        MMA_power.F_SMD2_estimate$Estimate,
                        MMA_power.R_SMD2_estimate$Estimate,
                        
                        MMA_power.F_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.R_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.F_SMDH2_estimate$Estimate,
                        MMA_power.R_SMDH2_estimate$Estimate,
                        
                        MMA_power.F_VR2_estimate$Estimate,
                        MMA_power.R_VR2_estimate$Estimate,
                        
                        MMA_power.F_CVR2_estimate$Estimate,
                        MMA_power.R_CVR2_estimate$Estimate
                        ),
           'CI.lb' = c(MMA_power.F_adjusted_RR2_estimate$lb.ci,
                        MMA_power.R_adjusted_RR2_estimate$lb.ci,
                        MMA_power.F_RR2_estimate$lb.ci,
                        MMA_power.R_RR2_estimate$lb.ci,
                        
                        MMA_power.F_adjusted_lnrr2_estimate$lb.ci,
                        MMA_power.R_adjusted_lnrr2_estimate$lb.ci,
                        MMA_power.F_lnrr2_estimate$lb.ci,
                        MMA_power.R_lnrr2_estimate$lb.ci,
                        
                        MMA_power.F_adjusted_SMD2_estimate$lb.ci,
                        MMA_power.R_adjusted_SMD2_estimate$lb.ci,
                        MMA_power.F_SMD2_estimate$lb.ci,
                        MMA_power.R_SMD2_estimate$lb.ci,
                        
                        MMA_power.F_adjusted_SMDH2_estimate$lb.ci,
                        MMA_power.R_adjusted_SMDH2_estimate$lb.ci,
                        MMA_power.F_SMDH2_estimate$lb.ci,
                        MMA_power.R_SMDH2_estimate$lb.ci,
                        
                        MMA_power.F_VR2_estimate$lb.ci,
                        MMA_power.R_VR2_estimate$lb.ci,
                        
                        MMA_power.F_CVR2_estimate$lb.ci,
                        MMA_power.R_CVR2_estimate$lb.ci
                        ),
           'CI.ub' = c(MMA_power.F_adjusted_RR2_estimate$ub.ci,
                        MMA_power.R_adjusted_RR2_estimate$ub.ci,
                        MMA_power.F_RR2_estimate$ub.ci,
                        MMA_power.R_RR2_estimate$ub.ci,
                        
                        MMA_power.F_adjusted_lnrr2_estimate$ub.ci,
                        MMA_power.R_adjusted_lnrr2_estimate$ub.ci,
                        MMA_power.F_lnrr2_estimate$ub.ci,
                        MMA_power.R_lnrr2_estimate$ub.ci,
                        
                        MMA_power.F_adjusted_SMD2_estimate$ub.ci,
                        MMA_power.R_adjusted_SMD2_estimate$ub.ci,
                        MMA_power.F_SMD2_estimate$ub.ci,
                        MMA_power.R_SMD2_estimate$ub.ci,
                        
                        MMA_power.F_adjusted_SMDH2_estimate$ub.ci,
                        MMA_power.R_adjusted_SMDH2_estimate$ub.ci,
                        MMA_power.F_SMDH2_estimate$ub.ci,
                        MMA_power.R_SMDH2_estimate$ub.ci,
                        
                        MMA_power.F_VR2_estimate$ub.ci,
                        MMA_power.R_VR2_estimate$ub.ci,
                        
                        MMA_power.F_CVR2_estimate$ub.ci,
                        MMA_power.R_CVR2_estimate$ub.ci
                        ),
           'Mean' = c(MMA_power.F_adjusted_RR2_estimate$Mean,
                        MMA_power.R_adjusted_RR2_estimate$Mean,
                        MMA_power.F_RR2_estimate$Mean,
                        MMA_power.R_RR2_estimate$Mean,
                        
                        MMA_power.F_adjusted_lnrr2_estimate$Mean,
                        MMA_power.R_adjusted_lnrr2_estimate$Mean,
                        MMA_power.F_lnrr2_estimate$Mean,
                        MMA_power.R_lnrr2_estimate$Mean,
                        
                        MMA_power.F_adjusted_SMD2_estimate$Mean,
                        MMA_power.R_adjusted_SMD2_estimate$Mean,
                        MMA_power.F_SMD2_estimate$Mean,
                        MMA_power.R_SMD2_estimate$Mean,
                        
                        MMA_power.F_adjusted_SMDH2_estimate$Mean,
                        MMA_power.R_adjusted_SMDH2_estimate$Mean,
                        MMA_power.F_SMDH2_estimate$Mean,
                        MMA_power.R_SMDH2_estimate$Mean,
                        
                        MMA_power.F_VR2_estimate$Mean,
                        MMA_power.R_VR2_estimate$Mean,
                        
                        MMA_power.F_CVR2_estimate$Mean,
                        MMA_power.R_CVR2_estimate$Mean
                        ))
write.csv(table_individual_power, file = "data/table_individual_power.csv", na="NA", row.names = FALSE)



# table for meta-analysis level power
table_ma_power <- data.frame("effect_size" = c(rep("lnRR*",2),
                                                       rep("lnRR",2),
                                                       rep("SMD",2),
                                                       rep("SMDH",2),
                                                       rep("lnVR",1),
                                                       rep("lnCVR",1)), 
           "true_effect" = c("cMAOM", "MAOM", # lnRR*
                             "cMAOM",  "MAOM",  # lnRR
                             "cMAOM",  "MAOM",  # SMD
                             "cMAOM",  "MAOM", # SMDH
                             "MAOM", # lnVR
                             "MAOM"), # lnCVR
           "Median" = c(MMA_MA_adjusted_RR2_estimate$Estimate,
                        MMA_MA_RR2_estimate$Estimate,
                       
                        MMA_MA_adjusted_lnrr2_estimate$Estimate,
                        MMA_MA_lnrr2_estimate$Estimate,
                        
                        MMA_MA_adjusted_SMD2_estimate$Estimate,
                        MMA_MA_SMD2_estimate$Estimate,
                        
                        MMA_MA_adjusted_SMDH2_estimate$Estimate,
                        MMA_MA_SMDH2_estimate$Estimate,

                        MMA_MA_VR2_estimate$Estimate,

                        MMA_MA_CVR2_estimate$Estimate
                        ),
           'CI.lb' = c(MMA_MA_adjusted_RR2_estimate$lb.ci,
                        MMA_MA_RR2_estimate$lb.ci,
                       
                        MMA_MA_adjusted_lnrr2_estimate$lb.ci,
                        MMA_MA_lnrr2_estimate$lb.ci,
                        
                        MMA_MA_adjusted_SMD2_estimate$lb.ci,
                        MMA_MA_SMD2_estimate$lb.ci,
                        
                        MMA_MA_adjusted_SMDH2_estimate$lb.ci,
                        MMA_MA_SMDH2_estimate$lb.ci,

                        MMA_MA_VR2_estimate$lb.ci,

                        MMA_MA_CVR2_estimate$lb.ci
                        ),
           'CI.ub' = c(MMA_MA_adjusted_RR2_estimate$ub.ci,
                        MMA_MA_RR2_estimate$ub.ci,
                       
                        MMA_MA_adjusted_lnrr2_estimate$ub.ci,
                        MMA_MA_lnrr2_estimate$ub.ci,
                        
                        MMA_MA_adjusted_SMD2_estimate$ub.ci,
                        MMA_MA_SMD2_estimate$ub.ci,
                        
                        MMA_MA_adjusted_SMDH2_estimate$ub.ci,
                        MMA_MA_SMDH2_estimate$ub.ci,

                        MMA_MA_VR2_estimate$ub.ci ,

                        MMA_MA_CVR2_estimate$ub.ci
                        ),
           'Mean' = c(MMA_MA_adjusted_RR2_estimate$Mean,
                        MMA_MA_RR2_estimate$Mean,
                       
                        MMA_MA_adjusted_lnrr2_estimate$Mean,
                        MMA_MA_lnrr2_estimate$Mean,
                        
                        MMA_MA_adjusted_SMD2_estimate$Mean,
                        MMA_MA_SMD2_estimate$Mean,
                        
                        MMA_MA_adjusted_SMDH2_estimate$Mean,
                        MMA_MA_SMDH2_estimate$Mean,

                        MMA_MA_VR2_estimate$Mean,

                        MMA_MA_CVR2_estimate$Mean
                        ))
write.csv(table_ma_power, file = "data/table_ma_power.csv", na="NA", row.names = FALSE)





# table for individual level Type S
table_individual_TypeS <- data.frame("effect_size" = c(rep("lnRR*",4),
                                                       rep("lnRR",4),
                                                       rep("SMD",4),
                                                       rep("SMDH",4),
                                                       rep("lnVR",2),
                                                       rep("lnCVR",2)), 
           "true_effect" = c("cMAOM", "cESSP", "MAOM", "ESSP", # lnRR*
                             "cMAOM", "cESSP", "MAOM", "ESSP", # lnRR
                             "cMAOM", "cESSP", "MAOM", "ESSP", # SMD
                             "cMAOM", "cESSP", "MAOM", "ESSP", # SMDH
                             "MAOM", "ESSP", # lnVR
                             "MAOM", "ESSP"), # lnCVR
           "Median" = c(MMA_power.F.S_adjusted_RR2_estimate$Estimate,
                        MMA_power.R.S_adjusted_RR2_estimate$Estimate,
                        MMA_power.F.S_RR2_estimate$Estimate,
                        MMA_power.R.S_RR2_estimate$Estimate,
                        
                        MMA_power.F.S_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.R.S_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.F.S_lnrr2_estimate$Estimate,
                        MMA_power.R.S_lnrr2_estimate$Estimate,
                        
                        MMA_power.F.S_adjusted_SMD2_estimate$Estimate,
                        MMA_power.R.S_adjusted_SMD2_estimate$Estimate,
                        MMA_power.F.S_SMD2_estimate$Estimate,
                        MMA_power.R.S_SMD2_estimate$Estimate,
                        
                        MMA_power.F.S_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.R.S_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.F.S_SMDH2_estimate$Estimate,
                        MMA_power.R.S_SMDH2_estimate$Estimate,
                        
                        MMA_power.F.S_VR2_estimate$Estimate,
                        MMA_power.R.S_VR2_estimate$Estimate,
                        
                        MMA_power.F.S_CVR2_estimate$Estimate,
                        MMA_power.R.S_CVR2_estimate$Estimate
                        ),
           'CI.lb' = c(MMA_power.F.S_adjusted_RR2_estimate$lb.ci,
                        MMA_power.R.S_adjusted_RR2_estimate$lb.ci,
                        MMA_power.F.S_RR2_estimate$lb.ci,
                        MMA_power.R.S_RR2_estimate$lb.ci,
                        
                        MMA_power.F.S_adjusted_lnrr2_estimate$lb.ci,
                        MMA_power.R.S_adjusted_lnrr2_estimate$lb.ci,
                        MMA_power.F.S_lnrr2_estimate$lb.ci,
                        MMA_power.R.S_lnrr2_estimate$lb.ci,
                        
                        MMA_power.F.S_adjusted_SMD2_estimate$lb.ci,
                        MMA_power.R.S_adjusted_SMD2_estimate$lb.ci,
                        MMA_power.F.S_SMD2_estimate$lb.ci,
                        MMA_power.R.S_SMD2_estimate$lb.ci,
                        
                        MMA_power.F.S_adjusted_SMDH2_estimate$lb.ci,
                        MMA_power.R.S_adjusted_SMDH2_estimate$lb.ci,
                        MMA_power.F.S_SMDH2_estimate$lb.ci,
                        MMA_power.R.S_SMDH2_estimate$lb.ci,
                        
                        MMA_power.F.S_VR2_estimate$lb.ci,
                        MMA_power.R.S_VR2_estimate$lb.ci,
                        
                        MMA_power.F.S_CVR2_estimate$lb.ci,
                        MMA_power.R.S_CVR2_estimate$lb.ci
                        ),
           'CI.ub' = c(MMA_power.F.S_adjusted_RR2_estimate$ub.ci,
                        MMA_power.R.S_adjusted_RR2_estimate$ub.ci,
                        MMA_power.F.S_RR2_estimate$ub.ci,
                        MMA_power.R.S_RR2_estimate$ub.ci,
                        
                        MMA_power.F.S_adjusted_lnrr2_estimate$ub.ci,
                        MMA_power.R.S_adjusted_lnrr2_estimate$ub.ci,
                        MMA_power.F.S_lnrr2_estimate$ub.ci,
                        MMA_power.R.S_lnrr2_estimate$ub.ci,
                        
                        MMA_power.F.S_adjusted_SMD2_estimate$ub.ci,
                        MMA_power.R.S_adjusted_SMD2_estimate$ub.ci,
                        MMA_power.F.S_SMD2_estimate$ub.ci,
                        MMA_power.R.S_SMD2_estimate$ub.ci,
                        
                        MMA_power.F.S_adjusted_SMDH2_estimate$ub.ci,
                        MMA_power.R.S_adjusted_SMDH2_estimate$ub.ci,
                        MMA_power.F.S_SMDH2_estimate$ub.ci,
                        MMA_power.R.S_SMDH2_estimate$ub.ci,
                        
                        MMA_power.F.S_VR2_estimate$ub.ci,
                        MMA_power.R.S_VR2_estimate$ub.ci,
                        
                        MMA_power.F.S_CVR2_estimate$ub.ci,
                        MMA_power.R.S_CVR2_estimate$ub.ci
                        ),
           'Mean' = c(MMA_power.F.S_adjusted_RR2_estimate$Mean,
                        MMA_power.R.S_adjusted_RR2_estimate$Mean,
                        MMA_power.F.S_RR2_estimate$Mean,
                        MMA_power.R.S_RR2_estimate$Mean,
                        
                        MMA_power.F.S_adjusted_lnrr2_estimate$Mean,
                        MMA_power.R.S_adjusted_lnrr2_estimate$Mean,
                        MMA_power.F.S_lnrr2_estimate$Mean,
                        MMA_power.R.S_lnrr2_estimate$Mean,
                        
                        MMA_power.F.S_adjusted_SMD2_estimate$Mean,
                        MMA_power.R.S_adjusted_SMD2_estimate$Mean,
                        MMA_power.F.S_SMD2_estimate$Mean,
                        MMA_power.R.S_SMD2_estimate$Mean,
                        
                        MMA_power.F.S_adjusted_SMDH2_estimate$Mean,
                        MMA_power.R.S_adjusted_SMDH2_estimate$Mean,
                        MMA_power.F.S_SMDH2_estimate$Mean,
                        MMA_power.R.S_SMDH2_estimate$Mean,
                        
                        MMA_power.F.S_VR2_estimate$Mean,
                        MMA_power.R.S_VR2_estimate$Mean,
                        
                        MMA_power.F.S_CVR2_estimate$Mean,
                        MMA_power.R.S_CVR2_estimate$Mean
                        ))
write.csv(table_individual_TypeS, file = "data/table_individual_TypeS.csv", na="NA", row.names = FALSE)



# table for meta-analysis level Type S
table_ma_TypeS <- data.frame("effect_size" = c(rep("lnRR*",2),
                                                       rep("lnRR",2),
                                                       rep("SMD",2),
                                                       rep("SMDH",2),
                                                       rep("lnVR",1),
                                                       rep("lnCVR",1)), 
           "true_effect" = c("cMAOM", "MAOM", # lnRR*
                             "cMAOM",  "MAOM",  # lnRR
                             "cMAOM",  "MAOM",  # SMD
                             "cMAOM",  "MAOM", # SMDH
                             "MAOM", # lnVR
                             "MAOM"), # lnCVR
           "Median" = c(MMA_MA.S_adjusted_RR2_estimate$Estimate,
                        MMA_MA.S_RR2_estimate$Estimate,
                       
                        MMA_MA.S_adjusted_lnrr2_estimate$Estimate,
                        MMA_MA.S_lnrr2_estimate$Estimate,
                        
                        MMA_MA.S_adjusted_SMD2_estimate$Estimate,
                        MMA_MA.S_SMD2_estimate$Estimate,
                        
                        MMA_MA.S_adjusted_SMDH2_estimate$Estimate,
                        MMA_MA.S_SMDH2_estimate$Estimate,

                        MMA_MA.S_VR2_estimate$Estimate,

                        MMA_MA.S_CVR2_estimate$Estimate
                        ),
           'CI.lb' = c(MMA_MA.S_adjusted_RR2_estimate$lb.ci,
                        MMA_MA.S_RR2_estimate$lb.ci,
                       
                        MMA_MA.S_adjusted_lnrr2_estimate$lb.ci,
                        MMA_MA.S_lnrr2_estimate$lb.ci,
                        
                        MMA_MA.S_adjusted_SMD2_estimate$lb.ci,
                        MMA_MA.S_SMD2_estimate$lb.ci,
                        
                        MMA_MA.S_adjusted_SMDH2_estimate$lb.ci,
                        MMA_MA.S_SMDH2_estimate$lb.ci,

                        MMA_MA.S_VR2_estimate$lb.ci,

                        MMA_MA.S_CVR2_estimate$lb.ci
                        ),
           'CI.ub' = c(MMA_MA.S_adjusted_RR2_estimate$ub.ci,
                        MMA_MA.S_RR2_estimate$ub.ci,
                       
                        MMA_MA.S_adjusted_lnrr2_estimate$ub.ci,
                        MMA_MA.S_lnrr2_estimate$ub.ci,
                        
                        MMA_MA.S_adjusted_SMD2_estimate$ub.ci,
                        MMA_MA.S_SMD2_estimate$ub.ci,
                        
                        MMA_MA.S_adjusted_SMDH2_estimate$ub.ci,
                        MMA_MA.S_SMDH2_estimate$ub.ci,

                        MMA_MA.S_VR2_estimate$ub.ci ,

                        MMA_MA.S_CVR2_estimate$ub.ci
                        ),
           'Mean' = c(MMA_MA.S_adjusted_RR2_estimate$Mean,
                        MMA_MA.S_RR2_estimate$Mean,
                       
                        MMA_MA.S_adjusted_lnrr2_estimate$Mean,
                        MMA_MA.S_lnrr2_estimate$Mean,
                        
                        MMA_MA.S_adjusted_SMD2_estimate$Mean,
                        MMA_MA.S_SMD2_estimate$Mean,
                        
                        MMA_MA.S_adjusted_SMDH2_estimate$Mean,
                        MMA_MA.S_SMDH2_estimate$Mean,

                        MMA_MA.S_VR2_estimate$Mean,

                        MMA_MA.S_CVR2_estimate$Mean
                        ))
write.csv(table_ma_TypeS, file = "data/table_ma_TypeS.csv", na="NA", row.names = FALSE)




# table for individual level Type M
table_individual_TypeM <- data.frame("effect_size" = c(rep("lnRR*",4),
                                                       rep("lnRR",4),
                                                       rep("SMD",4),
                                                       rep("SMDH",4),
                                                       rep("lnVR",2),
                                                       rep("lnCVR",2)), 
           "true_effect" = c("cMAOM", "cESSP", "MAOM", "ESSP", # lnRR*
                             "cMAOM", "cESSP", "MAOM", "ESSP", # lnRR
                             "cMAOM", "cESSP", "MAOM", "ESSP", # SMD
                             "cMAOM", "cESSP", "MAOM", "ESSP", # SMDH
                             "MAOM", "ESSP", # lnVR
                             "MAOM", "ESSP"), # lnCVR
           "Median" = c(MMA_power.F.M_adjusted_RR2_estimate$Estimate,
                        MMA_power.R.M_adjusted_RR2_estimate$Estimate,
                        MMA_power.F.M_RR2_estimate$Estimate,
                        MMA_power.R.M_RR2_estimate$Estimate,
                        
                        MMA_power.F.M_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.R.M_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.F.M_lnrr2_estimate$Estimate,
                        MMA_power.R.M_lnrr2_estimate$Estimate,
                        
                        MMA_power.F.M_adjusted_SMD2_estimate$Estimate,
                        MMA_power.R.M_adjusted_SMD2_estimate$Estimate,
                        MMA_power.F.M_SMD2_estimate$Estimate,
                        MMA_power.R.M_SMD2_estimate$Estimate,
                        
                        MMA_power.F.M_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.R.M_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.F.M_SMDH2_estimate$Estimate,
                        MMA_power.R.M_SMDH2_estimate$Estimate,
                        
                        MMA_power.F.M_VR2_estimate$Estimate,
                        MMA_power.R.M_VR2_estimate$Estimate,
                        
                        MMA_power.F.M_CVR2_estimate$Estimate,
                        MMA_power.R.M_CVR2_estimate$Estimate
                        ),
           'CI.lb' = c(MMA_power.F.M_adjusted_RR2_estimate$lb.ci,
                        MMA_power.R.M_adjusted_RR2_estimate$lb.ci,
                        MMA_power.F.M_RR2_estimate$lb.ci,
                        MMA_power.R.M_RR2_estimate$lb.ci,
                        
                        MMA_power.F.M_adjusted_lnrr2_estimate$lb.ci,
                        MMA_power.R.M_adjusted_lnrr2_estimate$lb.ci,
                        MMA_power.F.M_lnrr2_estimate$lb.ci,
                        MMA_power.R.M_lnrr2_estimate$lb.ci,
                        
                        MMA_power.F.M_adjusted_SMD2_estimate$lb.ci,
                        MMA_power.R.M_adjusted_SMD2_estimate$lb.ci,
                        MMA_power.F.M_SMD2_estimate$lb.ci,
                        MMA_power.R.M_SMD2_estimate$lb.ci,
                        
                        MMA_power.F.M_adjusted_SMDH2_estimate$lb.ci,
                        MMA_power.R.M_adjusted_SMDH2_estimate$lb.ci,
                        MMA_power.F.M_SMDH2_estimate$lb.ci,
                        MMA_power.R.M_SMDH2_estimate$lb.ci,
                        
                        MMA_power.F.M_VR2_estimate$lb.ci,
                        MMA_power.R.M_VR2_estimate$lb.ci,
                        
                        MMA_power.F.M_CVR2_estimate$lb.ci,
                        MMA_power.R.M_CVR2_estimate$lb.ci
                        ),
           'CI.ub' = c(MMA_power.F.M_adjusted_RR2_estimate$ub.ci,
                        MMA_power.R.M_adjusted_RR2_estimate$ub.ci,
                        MMA_power.F.M_RR2_estimate$ub.ci,
                        MMA_power.R.M_RR2_estimate$ub.ci,
                        
                        MMA_power.F.M_adjusted_lnrr2_estimate$ub.ci,
                        MMA_power.R.M_adjusted_lnrr2_estimate$ub.ci,
                        MMA_power.F.M_lnrr2_estimate$ub.ci,
                        MMA_power.R.M_lnrr2_estimate$ub.ci,
                        
                        MMA_power.F.M_adjusted_SMD2_estimate$ub.ci,
                        MMA_power.R.M_adjusted_SMD2_estimate$ub.ci,
                        MMA_power.F.M_SMD2_estimate$ub.ci,
                        MMA_power.R.M_SMD2_estimate$ub.ci,
                        
                        MMA_power.F.M_adjusted_SMDH2_estimate$ub.ci,
                        MMA_power.R.M_adjusted_SMDH2_estimate$ub.ci,
                        MMA_power.F.M_SMDH2_estimate$ub.ci,
                        MMA_power.R.M_SMDH2_estimate$ub.ci,
                        
                        MMA_power.F.M_VR2_estimate$ub.ci,
                        MMA_power.R.M_VR2_estimate$ub.ci,
                        
                        MMA_power.F.M_CVR2_estimate$ub.ci,
                        MMA_power.R.M_CVR2_estimate$ub.ci
                        ),
           'Mean' = c(MMA_power.F.M_adjusted_RR2_estimate$Mean,
                        MMA_power.R.M_adjusted_RR2_estimate$Mean,
                        MMA_power.F.M_RR2_estimate$Mean,
                        MMA_power.R.M_RR2_estimate$Mean,
                        
                        MMA_power.F.M_adjusted_lnrr2_estimate$Mean,
                        MMA_power.R.M_adjusted_lnrr2_estimate$Mean,
                        MMA_power.F.M_lnrr2_estimate$Mean,
                        MMA_power.R.M_lnrr2_estimate$Mean,
                        
                        MMA_power.F.M_adjusted_SMD2_estimate$Mean,
                        MMA_power.R.M_adjusted_SMD2_estimate$Mean,
                        MMA_power.F.M_SMD2_estimate$Mean,
                        MMA_power.R.M_SMD2_estimate$Mean,
                        
                        MMA_power.F.M_adjusted_SMDH2_estimate$Mean,
                        MMA_power.R.M_adjusted_SMDH2_estimate$Mean,
                        MMA_power.F.M_SMDH2_estimate$Mean,
                        MMA_power.R.M_SMDH2_estimate$Mean,
                        
                        MMA_power.F.M_VR2_estimate$Mean,
                        MMA_power.R.M_VR2_estimate$Mean,
                        
                        MMA_power.F.M_CVR2_estimate$Mean,
                        MMA_power.R.M_CVR2_estimate$Mean
                        ))
write.csv(table_individual_TypeM, file = "data/table_individual_TypeM.csv", na="NA", row.names = FALSE)



# table for meta-analysis level Type M
table_ma_TypeM <- data.frame("effect_size" = c(rep("lnRR*",2),
                                                       rep("lnRR",2),
                                                       rep("SMD",2),
                                                       rep("SMDH",2),
                                                       rep("lnVR",1),
                                                       rep("lnCVR",1)), 
           "true_effect" = c("cMAOM", "MAOM", # lnRR*
                             "cMAOM",  "MAOM",  # lnRR
                             "cMAOM",  "MAOM",  # SMD
                             "cMAOM",  "MAOM", # SMDH
                             "MAOM", # lnVR
                             "MAOM"), # lnCVR
           "Median" = c(MMA_MA.M_adjusted_RR2_estimate$Estimate,
                        MMA_MA.M_RR2_estimate$Estimate,
                       
                        MMA_MA.M_adjusted_lnrr2_estimate$Estimate,
                        MMA_MA.M_lnrr2_estimate$Estimate,
                        
                        MMA_MA.M_adjusted_SMD2_estimate$Estimate,
                        MMA_MA.M_SMD2_estimate$Estimate,
                        
                        MMA_MA.M_adjusted_SMDH2_estimate$Estimate,
                        MMA_MA.M_SMDH2_estimate$Estimate,

                        MMA_MA.M_VR2_estimate$Estimate,

                        MMA_MA.M_CVR2_estimate$Estimate
                        ),
           'CI.lb' = c(MMA_MA.M_adjusted_RR2_estimate$lb.ci,
                        MMA_MA.M_RR2_estimate$lb.ci,
                       
                        MMA_MA.M_adjusted_lnrr2_estimate$lb.ci,
                        MMA_MA.M_lnrr2_estimate$lb.ci,
                        
                        MMA_MA.M_adjusted_SMD2_estimate$lb.ci,
                        MMA_MA.M_SMD2_estimate$lb.ci,
                        
                        MMA_MA.M_adjusted_SMDH2_estimate$lb.ci,
                        MMA_MA.M_SMDH2_estimate$lb.ci,

                        MMA_MA.M_VR2_estimate$lb.ci,

                        MMA_MA.M_CVR2_estimate$lb.ci
                        ),
           'CI.ub' = c(MMA_MA.M_adjusted_RR2_estimate$ub.ci,
                        MMA_MA.M_RR2_estimate$ub.ci,
                       
                        MMA_MA.M_adjusted_lnrr2_estimate$ub.ci,
                        MMA_MA.M_lnrr2_estimate$ub.ci,
                        
                        MMA_MA.M_adjusted_SMD2_estimate$ub.ci,
                        MMA_MA.M_SMD2_estimate$ub.ci,
                        
                        MMA_MA.M_adjusted_SMDH2_estimate$ub.ci,
                        MMA_MA.M_SMDH2_estimate$ub.ci,

                        MMA_MA.M_VR2_estimate$ub.ci ,

                        MMA_MA.M_CVR2_estimate$ub.ci
                        ),
           'Mean' = c(MMA_MA.M_adjusted_RR2_estimate$Mean,
                        MMA_MA.M_RR2_estimate$Mean,
                       
                        MMA_MA.M_adjusted_lnrr2_estimate$Mean,
                        MMA_MA.M_lnrr2_estimate$Mean,
                        
                        MMA_MA.M_adjusted_SMD2_estimate$Mean,
                        MMA_MA.M_SMD2_estimate$Mean,
                        
                        MMA_MA.M_adjusted_SMDH2_estimate$Mean,
                        MMA_MA.M_SMDH2_estimate$Mean,

                        MMA_MA.M_VR2_estimate$Mean,

                        MMA_MA.M_CVR2_estimate$Mean
                        ))
write.csv(table_ma_TypeM, file = "data/table_ma_TypeM.csv", na="NA", row.names = FALSE)

```




### Heatmaps - power
In this section, we made heatmaps to show results for statistical power

```{r}
library(metaviz)
library(TOSTER)
library(puniform)
library(dplyr)
library(tidyr)
library(viridis)

library(ggthemes)



#stressor_RR <- c("1BD_loss","2BD_loss","3Fert","4Fert","5Warm","6Fert","7Fert","8LUC","9LUC","10LUC","11LUC","12LUC","13Fert","14Fert","15Precip","16LUC","17Warm","18Inv","19Fire","20Fire","21Fire","22Warm","23Warm","24Warm","25BD_loss","26BD_loss","27BD_loss","28Acid","29Inv","30Inv")

stressor_RR <- c("BD loss 1","BD loss 2","Fert 1","Fert 2","Warm 1","Fert 3","Fert 4","LUC 1","LUC 2","LUC 3","LUC 4","LUC 5","Fert 5","Fert 6","Precip ","LUC 6","Warm 2","Inv 1","Fire 1","Fire 2","Fire 3","Warm 3","Warm 4","Warm 5","BD loss 3","BD loss 4","BD loss 5","Acid","Inv 2","Inv 3")

intercept_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_RR$mu_RR,
                              power=power.F_summary_RR$Median,
                              effect=rep(c("MAOM"),30),
                              es_cat=rep(c("a.Intercept_es"),30))


intercept_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_adjusted_RR$mu_RR,
                              power=power.F_summary_adjusted_RR$Median,
                              effect=rep(c("cMAOM"),30),
                            es_cat=rep(c("a.Intercept_es"),30))



blup_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_RR$mu_RR,
                              power=power.R_summary_RR$Median,
                              effect=rep(c("ESSP"),30),
                              es_cat=rep(c("b.BLUP_es"),30))


blup_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_adjusted_RR$mu_RR,
                              power=power.R_summary_adjusted_RR$Median,
                              effect=rep(c("cESSP"),30),
                              es_cat=rep(c("b.BLUP_es"),30))




# d1_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d1_RR$Median,
#                               effect=rep(c("1%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# 
# d5_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d5_RR$Median,
#                               effect=rep(c("5%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# d10_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d10_RR$Median,
#                               effect=rep(c("10%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# d20_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d20_RR$Median,
#                               effect=rep(c("20%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# d30_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d30_RR$Median,
#                               effect=rep(c("30%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# d40_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d40_RR$Median,
#                               effect=rep(c("40%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# 
# d50_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d50_RR$Median,
#                               effect=rep(c("50%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# 
# d60_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d60_RR$Median,
#                               effect=rep(c("60%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# 
# d70_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d70_RR$Median,
#                               effect=rep(c("70%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# 
# d80_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d80_RR$Median,
#                               effect=rep(c("80%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# d90_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d90_RR$Median,
#                               effect=rep(c("90%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))
# 
# d100_RR <- data.frame(MA_case=model_est_RR$MA_case,
#                               es=model_est_RR$mu_RR,
#                               power=power_summary_d100_RR$Median,
#                               effect=rep(c("100%"),30),
#                               es_cat=rep(c("Hypothetical_es"),30))



MA.power_RR <- data.frame(stressor_RR=stressor_RR,
                                 es=model_est_RR$mu_RR,
                                 power=model_est_RR$MA.power,
                                 effect=rep(c("MAOM.MA"),30),
                                 es_cat=rep(c("c.MA.power"),30))

MA.power_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                                 es=model_est_adjusted_RR$mu_RR,
                                 power=model_est_adjusted_RR$MA.power,
                            effect=rep(c("cMAOM.MA"),30),
                                 es_cat=rep(c("c.MA.power"),30))


power_firepower_RR <- rbind(intercept_adjusted_RR,
                            intercept_RR,
                            blup_adjusted_RR,
                            blup_RR,
                            MA.power_adjusted_RR,
                            MA.power_RR
                         #d1_RR,
                         #d5_RR,
                         # d10_RR,
                         # d20_RR,
                         # d30_RR,
                         # d40_RR,
                         # d50_RR,
                         # d60_RR,
                         # d70_RR,
                         # d80_RR,
                         # d90_RR,
                         # d100_RR
                         )

power_firepower_RR$number <- c(1:(6*30)) # for reorder

power_firepower_RR$es <- abs(power_firepower_RR$es)

#power_firepower_RR$power[1] <- 100
#power_firepower_RR$power[2] <- 100

# convert moderator to factor with desired ordering of levels
# power_firepower_RR$effect <- factor(power_firepower_RR$effect, levels=rev(c("cMAOM","MAOM", "cESSP", "ESSP", "cMAOM.MA", "MAOM.MA")))



firepower_plot_RR <- ggplot(data = power_firepower_RR) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_RR, fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Statistical power",
    low = "white", # #56B4E9
    #mid = "white",
    high = "#CC79A7", 
    #midpoint = 0.5, # if using scale_fill_gradient2, it needs mid color and midpoint
    limits = c(0,1),
    guide = "colourbar",
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) +  labs(x ="Response magnitude \n lnRR*", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), legend.position = "none" ) +
  scale_x_discrete(position = "top") + labs(title = "(A)")


png(filename = "./Figures/firepower_plot_RR.png", width = 8, height = 10, units = "in", type = "windows", res = 400)
firepower_plot_RR 
dev.off()


pdf(file = "./Figures/figure3_colour_bar.pdf", width = 8, height = 10)
firepower_plot_RR 
dev.off()

# ggsave(plot = firepower_plot_RR,filename = "./Figures/Figure3a.pdf", height = 10, width = 6, units = 'cm', dpi = 300, scale = 2.5) 



#save(power_firepower_RR, file = here("data","figure_3A(lnRR_star).RData"))

write.csv(power_firepower_RR, file = "data/figure_3A(lnRR_star).csv", na="NA", row.names = FALSE)


#stressor_CVR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_CVR <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_CVR <- data.frame(stressor_CVR=stressor_CVR,
                              es=model_est_CVR$mu_CVR,
                              power=power.F_summary_CVR$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))


blup_CVR <- data.frame(stressor_CVR=stressor_CVR,
                              es=model_est_CVR$mu_CVR,
                              power=power.R_summary_CVR$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))

# d1_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d1_CVR$Median,
#                               effect=rep(c("1%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d5_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d5_CVR$Median,
#                               effect=rep(c("5%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d10_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d10_CVR$Median,
#                               effect=rep(c("10%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d20_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d20_CVR$Median,
#                               effect=rep(c("20%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d30_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d30_CVR$Median,
#                               effect=rep(c("30%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d40_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d40_CVR$Median,
#                               effect=rep(c("40%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d50_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d50_CVR$Median,
#                               effect=rep(c("50%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d60_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d60_CVR$Median,
#                               effect=rep(c("60%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d70_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d70_CVR$Median,
#                               effect=rep(c("70%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d80_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d80_CVR$Median,
#                               effect=rep(c("80%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d90_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d90_CVR$Median,
#                               effect=rep(c("90%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d100_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
#                               es=model_est_CVR$mu_CVR,
#                               power=power_summary_d100_CVR$Median,
#                               effect=rep(c("100%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))


MA.power_CVR <- data.frame(stressor_CVR=stressor_CVR,
                                 es=model_est_CVR$mu_CVR,
                                 power=model_est_CVR$MA.power,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


power_firepower_CVR <- rbind(intercept_CVR,
                         blup_CVR,
                         MA.power_CVR
                         # d1_CVR,
                         # d5_CVR,
                         # d10_CVR,
                         # d20_CVR,
                         # d30_CVR,
                         # d40_CVR,
                         # d50_CVR,
                         # d60_CVR,
                         # d70_CVR,
                         # d80_CVR,
                         # d90_CVR,
                         # d100_CVR
                         )

power_firepower_CVR$number <- c(1:(3*12)) # for reorder
power_firepower_CVR$es <- abs(power_firepower_CVR$es)


firepower_plot_CVR <- ggplot(data = power_firepower_CVR) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_CVR,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Statistical power",
    low = "white", 
    #mid = "white",
    high = "#CC79A7", 
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar",
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response variability \n lnCVR", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_blank(), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none") + scale_x_discrete(position = "top") + labs(title = "(E)")



png(filename = "./Figures/firepower_plot_CVR.png", width = 6, height = 6, units = "in", type = "windows", res = 400)
firepower_plot_CVR 
dev.off()


#save(power_firepower_CVR, file = here("data","figure_4B(lnCVR).RData"))

write.csv(power_firepower_CVR, file = "data/figure_4B(lnCVR).csv", na="NA", row.names = FALSE)




#stressor_VR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_VR <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_VR <- data.frame(stressor_VR=stressor_VR,
                              es=model_est_VR$mu_VR,
                              power=power.F_summary_VR$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))


blup_VR <- data.frame(stressor_VR=stressor_VR,
                              es=model_est_VR$mu_VR,
                              power=power.R_summary_VR$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))

# d1_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d1_VR$Median,
#                               effect=rep(c("1%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d5_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d5_VR$Median,
#                               effect=rep(c("5%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d10_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d10_VR$Median,
#                               effect=rep(c("10%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d20_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d20_VR$Median,
#                               effect=rep(c("20%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d30_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d30_VR$Median,
#                               effect=rep(c("30%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d40_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d40_VR$Median,
#                               effect=rep(c("40%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d50_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d50_VR$Median,
#                               effect=rep(c("50%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d60_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d60_VR$Median,
#                               effect=rep(c("60%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d70_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d70_VR$Median,
#                               effect=rep(c("70%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d80_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d80_VR$Median,
#                               effect=rep(c("80%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d90_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d90_VR$Median,
#                               effect=rep(c("90%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d100_VR <- data.frame(MA_case=model_est_VR$MA_case,
#                               es=model_est_VR$mu_VR,
#                               power=power_summary_d100_VR$Median,
#                               effect=rep(c("100%"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))


MA.power_VR <- data.frame(stressor_VR=stressor_VR,
                                 es=model_est_VR$mu_VR,
                                 power=model_est_VR$MA.power,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


power_firepower_VR <- rbind(intercept_VR,
                         blup_VR,
                         MA.power_VR
                         # d1_VR,
                         # d5_VR,
                         # d10_VR,
                         # d20_VR,
                         # d30_VR,
                         # d40_VR,
                         # d50_VR,
                         # d60_VR,
                         # d70_VR,
                         # d80_VR,
                         # d90_VR,
                         # d100_VR
                         )

power_firepower_VR$number <- c(1:(3*12)) # for reorder
power_firepower_VR$es <- abs(power_firepower_VR$es)


firepower_plot_VR <- ggplot(data = power_firepower_VR) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_VR,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Statistical power",
    low = "white", 
    #mid = "white",
    high = "#CC79A7", 
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar",
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response variability \n lnVR", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_blank(), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=10),
                                         legend.title = element_text(size=10),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none"
                                         ) +  scale_x_discrete(position = "top") + labs(title = "(C)")
 
  # theme(#legend.position = "top",
  #                       #legend.direction = "horizontal",
  #                       legend.text = element_text(size=10),
  #                       legend.title = element_text(size=10))



png(filename = "./Figures/firepower_plot_VR.png", width = 6, height = 6, units = "in", type = "windows", res = 400)
firepower_plot_VR 
dev.off()


#save(power_firepower_VR, file = here("data","figure_4A(lnVR).RData"))

write.csv(power_firepower_VR, file = "data/figure_4A(lnVR).csv", na="NA", row.names = FALSE)




firepower_plot_CVR_VR <- ggarrange(firepower_plot_VR, firepower_plot_CVR , heights = c(5,5), widths = c(5,5), nrow = 2, ncol = 1)

png(filename = "./Figures/firepower_plot_CVR_VR.png", width = 6, height = 10, units = "in", type = "windows", res = 400)
firepower_plot_CVR_VR
dev.off()


ggsave(plot = firepower_plot_CVR_VR,
       filename = "./Figures/Figure4.pdf",
       height = 10, width = 6, units = 'cm', dpi = 300, scale = 2.5) 



#stressor_SMD <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_SMD <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_SMD$mu_SMD,
                              power=power.F_summary_SMD$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))

intercept_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_adjusted_SMD$mu_SMD,
                            power=power.F_summary_adjusted_SMD$Median,
                              effect=rep(c("cMAOM"),12),
                            es_cat=rep(c("a.Intercept_es"),12))




blup_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_SMD$mu_SMD,
                              power=power.R_summary_SMD$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))




blup_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_adjusted_SMD$mu_SMD,
                            power=power.R_summary_adjusted_SMD$Median,
                              effect=rep(c("cESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))



# d0.1_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.1_SMD$Median,
#                               effect=rep(c("0.1"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d0.2_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.2_SMD$Median,
#                               effect=rep(c("0.2"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d0.3_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.3_SMD$Median,
#                               effect=rep(c("0.3"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d0.4_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.4_SMD$Median,
#                               effect=rep(c("0.4"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d0.5_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.5_SMD$Median,
#                               effect=rep(c("0.5"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# d0.6_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.6_SMD$Median,
#                               effect=rep(c("0.6"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d0.7_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.7_SMD$Median,
#                               effect=rep(c("0.7"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d0.8_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.8_SMD$Median,
#                               effect=rep(c("0.8"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d0.9_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d0.9_SMD$Median,
#                               effect=rep(c("0.9"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))
# 
# 
# d1.0_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
#                               es=model_est_SMD$mu_SMD,
#                               power=power_summary_d1.0_SMD$Median,
#                               effect=rep(c("1.0"),12),
#                               es_cat=rep(c("Hypothetical_es"),12))


MA.power_SMD <- data.frame(stressor_SMD=stressor_SMD,
                                 es=model_est_SMD$mu_SMD,
                                 power=model_est_SMD$MA.power,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


MA.power_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                                 es=model_est_adjusted_SMD$mu_SMD,
                                 power=model_est_adjusted_SMD$MA.power,
                            effect=rep(c("cMAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))



power_firepower_SMD <- rbind(intercept_adjusted_SMD, 
                             intercept_SMD,
                             blup_adjusted_SMD,
                             blup_SMD,
                             MA.power_adjusted_SMD,
                             MA.power_SMD
                         # d0.1_SMD,
                         # d0.2_SMD,
                         # d0.3_SMD,
                         # d0.4_SMD,
                         # d0.5_SMD,
                         # d0.6_SMD,
                         # d0.7_SMD,
                         # d0.8_SMD,
                         # d0.9_SMD,
                         # d1.0_SMD
                         )

power_firepower_SMD$number <- c(1:(6*12)) # for reorder

power_firepower_SMD$es <- abs(power_firepower_SMD$es)



firepower_plot_SMD <- ggplot(data = power_firepower_SMD) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_SMD,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Statistical power",
    low = "white", # #56B4E9
    #mid = "white",
    high = "#CC79A7", 
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar",
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response magnitude \n SMD", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none"
                                         ) + scale_x_discrete(position = "top") + labs(title = "(B)")




png(filename = "./Figures/firepower_plot_SMD.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
firepower_plot_SMD 
dev.off()





#save(power_firepower_SMD, file = here("data","figure_3B(SMD).RData"))

write.csv(power_firepower_SMD, file = "data/figure_3B(SMD).csv", na="NA", row.names = FALSE)





#stressor_SMDH <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_SMDH <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_SMDH$mu_SMDH,
                              power=power.F_summary_SMDH$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))

intercept_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_adjusted_SMDH$mu_SMDH,
                            power=power.F_summary_adjusted_SMDH$Median,
                              effect=rep(c("cMAOM"),12),
                            es_cat=rep(c("a.Intercept_es"),12))




blup_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_SMDH$mu_SMDH,
                              power=power.R_summary_SMDH$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))




blup_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_adjusted_SMDH$mu_SMDH,
                            power=power.R_summary_adjusted_SMDH$Median,
                              effect=rep(c("cESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))


MA.power_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                                 es=model_est_SMDH$mu_SMDH,
                                 power=model_est_SMDH$MA.power,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


MA.power_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                                 es=model_est_adjusted_SMDH$mu_SMDH,
                                 power=model_est_adjusted_SMDH$MA.power,
                            effect=rep(c("cMAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))



power_firepower_SMDH <- rbind(intercept_adjusted_SMDH, 
                             intercept_SMDH,
                             blup_adjusted_SMDH,
                             blup_SMDH,
                             MA.power_adjusted_SMDH,
                             MA.power_SMDH
                             )

power_firepower_SMDH$number <- c(1:(6*12)) # for reorder

power_firepower_SMDH$es <- abs(power_firepower_SMDH$es)



firepower_plot_SMDH <- ggplot(data = power_firepower_SMDH) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_SMDH,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Statistical power",
    low = "white", 
    #mid = "white",
    high = "#CC79A7", 
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar",
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response magnitude \n SMDH", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), legend.position = "none") + scale_x_discrete(position = "top") + labs(title = "(D)")





png(filename = "./Figures/firepower_plot_SMDH.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
firepower_plot_SMDH 
dev.off()



#save(power_firepower_SMDH, file = here("data","figure_3B(SMDH).RData"))

write.csv(power_firepower_SMDH, file = "data/figure_3B(SMDH).csv", na="NA", row.names = FALSE)




# layout
firepower_plot_SMD_SMDH <- ggarrange(firepower_plot_SMD, firepower_plot_SMDH, heights = c(5,5), widths = c(5,5), nrow = 2, ncol = 1)

png(filename = "./Figures/firepower_plot_SMD_SMDH.png", width = 6, height = 10, units = "in", type = "windows", res = 400)
firepower_plot_SMD_SMDH
dev.off()


ggsave(plot = firepower_plot_SMD_SMDH,
       filename = "./Figures/Figure3b.pdf",
       height = 10, width = 6, units = 'cm', dpi = 300, scale = 2.5) 






  
png(filename = "./Figures/firepower_plot_power.png", width = 10, height = 10, units = "in", type = "windows", res = 400)
  firepower_plot_RR + {
    firepower_plot_SMD + firepower_plot_VR +
    firepower_plot_SMDH + firepower_plot_CVR +
    plot_layout(nrow = 2, ncol = 2, widths = c(2,1,2,1))
  } + plot_layout(ncol = 2, widths = c(0.65,1))
dev.off()


pdf(file = "./Figures/figure4.pdf", width = 10, height = 10)
  firepower_plot_RR + {
    firepower_plot_SMD + firepower_plot_VR +
    firepower_plot_SMDH + firepower_plot_CVR +
    plot_layout(nrow = 2, ncol = 2, widths = c(2,1,2,1))
  } + plot_layout(ncol = 2, widths = c(0.65,1))
dev.off()


```



### Forest plots 
In this section, we made forest plosts to show meta-analytic means and their bias-corrected verison for each stressor (meta-analytic case). 
We also did equivalence test for additional analysis

```{r}
# mean differences
# creat function for equivalence test
eqTmeta <- function(mu,se,l_eqbound,h_eqbound,alpha=0.05) {
z_low_TOST <- (mu + l_eqbound) / se
z_high_TOST <- (mu + h_eqbound) / se
p_low_TOST <- pnorm(-abs(z_low_TOST)) # lower tail
p_high_TOST <- pnorm(abs(z_high_TOST)) # upper tail
LL_CI_TOST <- mu - qnorm(1-alpha, lower.tail = T)*se # one-tail
UL_CI_TOST <- mu + qnorm(1-alpha, lower.tail = T)*se # one-tail
return(data.frame(LL_CI_TOST = LL_CI_TOST,
       UL_CI_TOST = UL_CI_TOST))
 }
 
# require(TOSTER)
#   ET_d10_RR <- TOSTmeta(ES = model_est_RR$mu_RR,se = model_est_RR$SE_RR,low_eqbound_d = -log(110/100),high_eqbound_d =log(110/100), plot = FALSE) %>% as.data.frame() # Perform an equivalence test



eqt_d10_RR <- eqTmeta(
        mu = model_est_RR$mu_RR,
        se = model_est_RR$SE_RR,
        l_eqbound = -log(110/100),
        h_eqbound = log(110/100)
        )

model_est_RR$ll_eqt_d10 <- eqt_d10_RR$LL_CI_TOST
model_est_RR$ul_eqt_d10 <- eqt_d10_RR$UL_CI_TOST 
 


eqt_d20_RR <- eqTmeta(
        mu = model_est_RR$mu_RR,
        se = model_est_RR$SE_RR,
        l_eqbound = -log(120/100),
        h_eqbound = log(120/100)
        )

model_est_RR$ll_eqt_d20 <- eqt_d20_RR$LL_CI_TOST
model_est_RR$ul_eqt_d20 <- eqt_d20_RR$UL_CI_TOST 
       
  
eqt_d40_RR <- eqTmeta(
        mu = model_est_RR$mu_RR,
        se = model_est_RR$SE_RR,
        l_eqbound = -log(140/100),
        h_eqbound = log(140/100)
        )

model_est_RR$ll_eqt_d40 <- eqt_d40_RR$LL_CI_TOST
model_est_RR$ul_eqt_d40 <- eqt_d40_RR$UL_CI_TOST 


## forst plots for lnRR*
stressor_RR <- c("BD loss 1","BD loss 2","Fert 1","Fert 2","Warm 1","Fert 3","Fert 4","LUC 1","LUC 2","LUC 3","LUC 4","LUC 5","Fert 5","Fert 6","Precip ","LUC 6","Warm 2","Inv 1","Fire 1","Fire 2","Fire 3","Warm 3","Warm 4","Warm 5","BD loss 3","BD loss 4","BD loss 5","Acid","Inv 2","Inv 3")
model_est_RR$stressor_RR <- stressor_RR
forest_plot_enhanced_RR <-
      ggplot(model_est_RR,aes(x = reorder(stressor_RR, -mu_RR), y = mu_RR, size = MA.power.M)) +
      geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black") +
    #annotate("rect", xmin = -Inf, ymin = -log(110/100), xmax = Inf, ymax = log(110/100), fill = "#CC79A7", alpha = 0.18) +
    #annotate("rect", xmin = -Inf, ymin = -log(120/100), xmax = Inf, ymax = log(120/100), fill = "#CC79A7", alpha = 0.15) +
    #annotate("rect", xmin = -Inf, ymin = -log(140/100), xmax = Inf, ymax = log(140/100), fill = "#CC79A7", alpha = 0.1) +
    # annotate("rect", xmin = -Inf, ymin = -log(160/100), xmax = Inf, ymax = log(160/100), fill = "#D55E00", alpha = 0.1) +
      # geom_point(color = "black",shape = 18, size = 4) +
      # geom_point(shape = 21, fill = "black") +
      geom_linerange(aes(ymin = ll_NHST, ymax = ul_NHST), size = 0.5, colour = "black") +
      #geom_linerange(aes(ymin = ll_eqt_d10, ymax = ul_eqt_d10), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d20, ymax = ul_eqt_d20), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d40, ymax = ul_eqt_d40), size = 1.2, colour = "black") + 
      geom_point(shape = 21, fill = "black") +
      theme(axis.text.x = element_text(size = 8)) +
      coord_flip() +
      #theme_minimal() +
      theme(strip.text = element_text(size = 8, face = "bold",angle = 90
      )) +
      theme(strip.background = element_rect(colour = "black", fill = "white")) +
      theme(panel.background = element_rect(fill = NA)) +
      theme(axis.title.y = element_text(face = "bold", size = 12)) +
      theme(axis.title.x = element_text(face = "bold", size = 12),
            plot.title = element_text(size = 5)) +
      theme(axis.title.y = element_blank(),
            #axis.line = element_line(size = 0.8,color = 'black'),
            axis.ticks = element_line(size = 0.5, color = 'black'),
            axis.ticks.length = unit(0.15, 'cm'),
            panel.border = element_rect(size = 0.8,colour = "black",fill = NA)) + 
     theme(legend.position = c(1, 0.95), legend.justification = c(1, 0.95),
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "vertical",
           legend.background = element_rect(fill = NA)) + 
     labs(title = "Type M errors in global change studies", x=" ", y=expression("Response magnitude (lnRR*)"),size=expression(paste("Overestimate\nratio"))) + 
     # theme_bw() +
     theme(plot.title = element_text(colour = 'black', size = 8, face = 'bold')) +
  scale_y_continuous(limits = c(-1.2,1.2), breaks =seq(-1,1,by=0.5))
  #expression(paste("Overestimate\nratio"))

 
png(filename = "./Figures/forest_plot_enhanced_RR.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_RR
dev.off()    
       


## forst plots for adjusted lnRR*
model_est_adjusted_RR$stressor_RR <- stressor_RR
forest_plot_enhanced_adjusted_RR <-
      ggplot(model_est_adjusted_RR,aes(x = reorder(stressor_RR, -mu_RR), y = mu_RR, size = MA.power.M)) +
      geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black") +
    #annotate("rect", xmin = -Inf, ymin = -log(110/100), xmax = Inf, ymax = log(110/100), fill = "#CC79A7", alpha = 0.18) +
    #annotate("rect", xmin = -Inf, ymin = -log(120/100), xmax = Inf, ymax = log(120/100), fill = "#CC79A7", alpha = 0.15) +
    #annotate("rect", xmin = -Inf, ymin = -log(140/100), xmax = Inf, ymax = log(140/100), fill = "#CC79A7", alpha = 0.1) +
    # annotate("rect", xmin = -Inf, ymin = -log(160/100), xmax = Inf, ymax = log(160/100), fill = "#D55E00", alpha = 0.1) +
      # geom_point(color = "black",shape = 18, size = 4) +
      # geom_point(shape = 21, fill = "black") +
      geom_linerange(aes(ymin = ll_NHST, ymax = ul_NHST), size = 0.5, colour = "black") +
      #geom_linerange(aes(ymin = ll_eqt_d10, ymax = ul_eqt_d10), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d20, ymax = ul_eqt_d20), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d40, ymax = ul_eqt_d40), size = 1.2, colour = "black") + 
      geom_point(shape = 21, fill = "black") +
      theme(axis.text.x = element_text(size = 8)) +
      coord_flip() +
      #theme_minimal() +
      theme(strip.text = element_text(size = 8, face = "bold",angle = 90
      )) +
      theme(strip.background = element_rect(colour = "black", fill = "white")) +
      theme(panel.background = element_rect(fill = NA)) +
      theme(axis.title.y = element_text(face = "bold", size = 12)) +
      theme(axis.title.x = element_text(face = "bold", size = 12),
            plot.title = element_text(size = 5)) +
      theme(axis.title.y = element_blank(),
            #axis.line = element_line(size = 0.8,color = 'black'),
            axis.ticks = element_line(size = 0.5, color = 'black'),
            axis.ticks.length = unit(0.15, 'cm'),
            panel.border = element_rect(size = 0.8,colour = "black",fill = NA)) + 
     theme(legend.position = c(1, 0.95), legend.justification = c(1, 0.95),
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "vertical",
           legend.background = element_rect(fill = NA)) + 
     labs(title = "Type M errors in global change studies", x=" ", y=expression("Corrected response magnitude (lnRR*)"),size=expression(paste("Overestimate\nratio"))) + 
     # theme_bw() +
     theme(plot.title = element_text(colour = 'black', size = 8, face = 'bold')) +
  scale_y_continuous(limits = c(-2.5,7), breaks =seq(-2,6,by=2))


 
png(filename = "./Figures/forest_plot_enhanced_adjusted_RR.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_adjusted_RR
dev.off()  





    
## forst plosts for SMD
model_est_SMD$stressor_SMD <- stressor_SMD  
forest_plot_enhanced_SMD <-
      ggplot(model_est_SMD,aes(x = reorder(stressor_SMD, -mu_SMD), y = mu_SMD, size = MA.power.M)) +
      geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black") +
      geom_linerange(aes(ymin = ll_NHST, ymax = ul_NHST), size = 0.5, colour = "black") +
      geom_point(shape = 21, fill = "black") +
      theme(axis.text.x = element_text(size = 8)) +
      coord_flip() +
      #theme_minimal() +
      theme(strip.text = element_text(size = 8, face = "bold",angle = 90
      )) +
      theme(strip.background = element_rect(colour = "black", fill = "white")) +
      theme(panel.background = element_rect(fill = NA)) +
      theme(axis.title.y = element_text(face = "bold", size = 12)) +
      theme(axis.title.x = element_text(face = "bold", size = 12),
            plot.title = element_text(size = 5)) +
      theme(axis.title.y = element_blank(),
            #axis.line = element_line(size = 0.8,color = 'black'),
            axis.ticks = element_line(size = 0.5, color = 'black'),
            axis.ticks.length = unit(0.15, 'cm'),
            panel.border = element_rect(size = 0.8,colour = "black",fill = NA)) + 
     theme(legend.position = c(1, 0.95), legend.justification = c(1, 0.95),
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "vertical",
           legend.background = element_rect(fill = NA)) + 
     labs(title = "Type M errors in global change studies", x=" ", y=expression("Response magnitude (SMD)"),size=expression(paste("Overestimate\nratio"))) + 
     # theme_bw() +
     theme(plot.title = element_text(colour = 'black', size = 8, face = 'bold')) +
  scale_y_continuous(limits = c(-4,13), breaks =seq(-4,12,by=3))


 
png(filename = "./Figures/forest_plot_enhanced_SMD.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_SMD
dev.off()    
       



model_est_adjusted_SMD$stressor_SMD <- stressor_SMD
forest_plot_enhanced_adjusted_SMD <-
      ggplot(model_est_adjusted_SMD,aes(x = reorder(stressor_SMD, -mu_SMD), y = mu_SMD, size = MA.power.M)) +
      geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black") +
      geom_linerange(aes(ymin = ll_NHST, ymax = ul_NHST), size = 0.5, colour = "black") +
      geom_point(shape = 21, fill = "black") +
      theme(axis.text.x = element_text(size = 8)) +
      coord_flip() +
      #theme_minimal() +
      theme(strip.text = element_text(size = 8, face = "bold",angle = 90
      )) +
      theme(strip.background = element_rect(colour = "black", fill = "white")) +
      theme(panel.background = element_rect(fill = NA)) +
      theme(axis.title.y = element_text(face = "bold", size = 12)) +
      theme(axis.title.x = element_text(face = "bold", size = 12),
            plot.title = element_text(size = 5)) +
      theme(axis.title.y = element_blank(),
            #axis.line = element_line(size = 0.8,color = 'black'),
            axis.ticks = element_line(size = 0.5, color = 'black'),
            axis.ticks.length = unit(0.15, 'cm'),
            panel.border = element_rect(size = 0.8,colour = "black",fill = NA)) + 
     theme(legend.position = c(1, 0.95), legend.justification = c(1, 0.95),
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "vertical",
           legend.background = element_rect(fill = NA)) + 
     labs(title = "Type M errors in global change studies", x=" ", y=expression("Corrected response magnitude (SMD)"),size=expression(paste("Overestimate\nratio"))) + 
     # theme_bw() +
     theme(plot.title = element_text(colour = 'black', size = 8, face = 'bold')) +
  scale_y_continuous(limits = c(-4,13), breaks =seq(-4,12,by=3))


 
png(filename = "./Figures/forest_plot_enhanced_adjusted_SMD.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_adjusted_SMD
dev.off()      
    
    
      

    
 ggarrange(forest_plot_enhanced_SMD,forest_plot_enhanced_adjusted_SMD, heights = c(5,5), widths = c(5,5), nrow = 1, ncol = 2, align = "h") -> forest_plot_enhanced_SMD_SMD_adjusted

png(filename = "./Figures/forest_plot_enhanced_SMD_SMD_adjusted.png", width = 10, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_SMD_SMD_adjusted
dev.off()   
    
    
    
    
# variance differences    
eqt_d10_CVR <- eqTmeta(
        mu = model_est_CVR$mu_CVR,
        se = model_est_CVR$SE_CVR,
        l_eqbound = -log(110/100),
        h_eqbound = log(110/100)
        )

model_est_CVR$ll_eqt_d10 <- eqt_d10_CVR$LL_CI_TOST
model_est_CVR$ul_eqt_d10 <- eqt_d10_CVR$UL_CI_TOST 
 

eqt_d20_CVR <- eqTmeta(
        mu = model_est_CVR$mu_CVR,
        se = model_est_CVR$SE_CVR,
        l_eqbound = -log(120/100),
        h_eqbound = log(120/100)
        )

model_est_CVR$ll_eqt_d20 <- eqt_d20_CVR$LL_CI_TOST
model_est_CVR$ul_eqt_d20 <- eqt_d20_CVR$UL_CI_TOST 
       
  
eqt_d40_CVR <- eqTmeta(
        mu = model_est_CVR$mu_CVR,
        se = model_est_CVR$SE_CVR,
        l_eqbound = -log(140/100),
        h_eqbound = log(140/100)
        )

model_est_CVR$ll_eqt_d40 <- eqt_d40_CVR$LL_CI_TOST
model_est_CVR$ul_eqt_d40 <- eqt_d40_CVR$UL_CI_TOST 
       

# forest plots for lnCVR
model_est_CVR$stressor_CVR <- stressor_CVR
forest_plot_enhanced_CVR <-
      ggplot(model_est_CVR,aes(x = reorder(stressor_CVR, -mu_CVR), y = mu_CVR, size = MA.power.M)) +
      geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black") +
    #annotate("rect", xmin = -Inf, ymin = -log(110/100), xmax = Inf, ymax = log(110/100), fill = "#CC79A7", alpha = 0.18) +
    #annotate("rect", xmin = -Inf, ymin = -log(120/100), xmax = Inf, ymax = log(120/100), fill = "#CC79A7", alpha = 0.15) +
    #annotate("rect", xmin = -Inf, ymin = -log(140/100), xmax = Inf, ymax = log(140/100), fill = "#CC79A7", alpha = 0.1) +
    # annotate("rect", xmin = -Inf, ymin = -log(160/100), xmax = Inf, ymax = log(160/100), fill = "#D55E00", alpha = 0.1) +
      # geom_point(color = "black",shape = 18, size = 4) +
      # geom_point(shape = 21, fill = "black") +
      geom_linerange(aes(ymin = ll_NHST, ymax = ul_NHST), size = 0.5, colour = "black") +
      #geom_linerange(aes(ymin = ll_eqt_d10, ymax = ul_eqt_d10), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d20, ymax = ul_eqt_d20), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d40, ymax = ul_eqt_d40), size = 1.2, colour = "black") + 
      geom_point(shape = 21, fill = "black") +
      theme(axis.text.x = element_text(size = 8)) +
      coord_flip() +
      #theme_minimal() +
      theme(strip.text = element_text(size = 8, face = "bold",angle = 90
      )) +
      theme(strip.background = element_rect(colour = "black", fill = "white")) +
      theme(panel.background = element_rect(fill = NA)) +
      theme(axis.title.y = element_text(face = "bold", size = 12)) +
      theme(axis.title.x = element_text(face = "bold", size = 12),
            plot.title = element_text(size = 5)) +
      theme(axis.title.y = element_blank(),
            #axis.line = element_line(size = 0.8,color = 'black'),
            axis.ticks = element_line(size = 0.5, color = 'black'),
            axis.ticks.length = unit(0.15, 'cm'),
            panel.border = element_rect(size = 0.8,colour = "black",fill = NA)) + 
     theme(legend.position = c(1, 0.95), legend.justification = c(1, 0.95),
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "vertical",
           legend.background = element_rect(fill = NA)) + 
     labs(title = "Type M errors in global change studies", x=" ", y=expression("Response variability (lnCVR)"),size=expression(paste("Overestimate\nratio"))) + 
     # theme_bw() +
     theme(plot.title = element_text(colour = 'black', size = 8, face = 'bold')) +
   scale_y_continuous(limits = c(-1.2,1.5), breaks =seq(-1,1,by=0.5))


png(filename = "./Figures/forest_plot_enhanced_CVR.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_CVR
dev.off()        
    
    
    
    
# forest plosts for lnVR
eqt_d10_VR <- eqTmeta(
        mu = model_est_VR$mu_VR,
        se = model_est_VR$SE_VR,
        l_eqbound = -log(110/100),
        h_eqbound = log(110/100)
        )

model_est_VR$ll_eqt_d10 <- eqt_d10_VR$LL_CI_TOST
model_est_VR$ul_eqt_d10 <- eqt_d10_VR$UL_CI_TOST 
 

eqt_d20_VR <- eqTmeta(
        mu = model_est_VR$mu_VR,
        se = model_est_VR$SE_VR,
        l_eqbound = -log(120/100),
        h_eqbound = log(120/100)
        )

model_est_VR$ll_eqt_d20 <- eqt_d20_VR$LL_CI_TOST
model_est_VR$ul_eqt_d20 <- eqt_d20_VR$UL_CI_TOST 
       
  
eqt_d40_VR <- eqTmeta(
        mu = model_est_VR$mu_VR,
        se = model_est_VR$SE_VR,
        l_eqbound = -log(140/100),
        h_eqbound = log(140/100)
        )

model_est_VR$ll_eqt_d40 <- eqt_d40_VR$LL_CI_TOST
model_est_VR$ul_eqt_d40 <- eqt_d40_VR$UL_CI_TOST 
       


model_est_VR$stressor_VR <- stressor_VR
forest_plot_enhanced_VR <-
      ggplot(model_est_VR,aes(x = reorder(stressor_VR, -mu_VR), y = mu_VR, size = MA.power.M)) +
      geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black") +
    #annotate("rect", xmin = -Inf, ymin = -log(110/100), xmax = Inf, ymax = log(110/100), fill = "#CC79A7", alpha = 0.18) +
    #annotate("rect", xmin = -Inf, ymin = -log(120/100), xmax = Inf, ymax = log(120/100), fill = "#CC79A7", alpha = 0.15) +
    #annotate("rect", xmin = -Inf, ymin = -log(140/100), xmax = Inf, ymax = log(140/100), fill = "#CC79A7", alpha = 0.1) +
    # annotate("rect", xmin = -Inf, ymin = -log(160/100), xmax = Inf, ymax = log(160/100), fill = "#D55E00", alpha = 0.1) +
      # geom_point(color = "black",shape = 18, size = 4) +
      # geom_point(shape = 21, fill = "black") +
      geom_linerange(aes(ymin = ll_NHST, ymax = ul_NHST), size = 0.5, colour = "black") +
      #geom_linerange(aes(ymin = ll_eqt_d10, ymax = ul_eqt_d10), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d20, ymax = ul_eqt_d20), size = 1.2, colour = "black") + 
      #geom_linerange(aes(ymin = ll_eqt_d40, ymax = ul_eqt_d40), size = 1.2, colour = "black") + 
      geom_point(shape = 21, fill = "black") +
      theme(axis.text.x = element_text(size = 8)) +
      coord_flip() +
      #theme_minimal() +
      theme(strip.text = element_text(size = 8, face = "bold",angle = 90
      )) +
      theme(strip.background = element_rect(colour = "black", fill = "white")) +
      theme(panel.background = element_rect(fill = NA)) +
      theme(axis.title.y = element_text(face = "bold", size = 12)) +
      theme(axis.title.x = element_text(face = "bold", size = 12),
            plot.title = element_text(size = 5)) +
      theme(axis.title.y = element_blank(),
            #axis.line = element_line(size = 0.8,color = 'black'),
            axis.ticks = element_line(size = 0.5, color = 'black'),
            axis.ticks.length = unit(0.15, 'cm'),
            panel.border = element_rect(size = 0.8,colour = "black",fill = NA)) + 
     theme(legend.position = c(1, 0.95), legend.justification = c(1, 0.95),
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "vertical",
           legend.background = element_rect(fill = NA)) + 
     labs(title = "Type M errors in global change studies", x=" ", y=expression("Response variability (lnVR)"),size=expression(paste("Overestimate\nratio"))) + 
     # theme_bw() +
     theme(plot.title = element_text(colour = 'black', size = 8, face = 'bold')) +
  scale_y_continuous(limits = c(-1.2,1.5), breaks =seq(-1,1,by=0.5))



 
png(filename = "./Figures/forest_plot_enhanced_VR.png", width = 5, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_VR
dev.off()     
    

# layout
ggarrange(forest_plot_enhanced_CVR,forest_plot_enhanced_VR, heights = c(5,5), widths = c(5,5), nrow = 1, ncol = 2, align = "h") -> forest_plot_enhanced_CVR_VR

png(filename = "./Figures/forest_plot_enhanced_CVR_VR.png", width = 10, height = 6, units = "in", type = "windows", res = 400)
forest_plot_enhanced_CVR_VR
dev.off()

    
  
```


### Heatmaps - Type S
In this section, we made heatmaps to show results for Type S

```{r}
stressor_RR <- c("BD loss 1","BD loss 2","Fert 1","Fert 2","Warm 1","Fert 3","Fert 4","LUC 1","LUC 2","LUC 3","LUC 4","LUC 5","Fert 5","Fert 6","Precip ","LUC 6","Warm 2","Inv 1","Fire 1","Fire 2","Fire 3","Warm 3","Warm 4","Warm 5","BD loss 3","BD loss 4","BD loss 5","Acid","Inv 2","Inv 3")

intercept_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_RR$mu_RR,
                              power=power.F.S_summary_RR$Median,
                              effect=rep(c("MAOM"),30),
                              es_cat=rep(c("a.Intercept_es"),30))


intercept_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_adjusted_RR$mu_RR,
                              power=power.F.S_summary_adjusted_RR$Median,
                              effect=rep(c("cMAOM"),30),
                            es_cat=rep(c("a.Intercept_es"),30))



blup_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_RR$mu_RR,
                              power=power.R.S_summary_RR$Median,
                              effect=rep(c("ESSP"),30),
                              es_cat=rep(c("b.BLUP_es"),30))


blup_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_adjusted_RR$mu_RR,
                              power=power.R.S_summary_adjusted_RR$Median,
                              effect=rep(c("cESSP"),30),
                              es_cat=rep(c("b.BLUP_es"),30))





MA.power_RR <- data.frame(stressor_RR=stressor_RR,
                                 es=model_est_RR$mu_RR,
                                 power=model_est_RR$MA.power.S,
                                 effect=rep(c("MAOM.MA"),30),
                                 es_cat=rep(c("c.MA.power"),30))

MA.power_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                                 es=model_est_adjusted_RR$mu_RR,
                                 power=model_est_adjusted_RR$MA.power.S,
                            effect=rep(c("cMAOM.MA"),30),
                                 es_cat=rep(c("c.MA.power"),30))


power_firepower_RR <- rbind(intercept_adjusted_RR,
                            intercept_RR,
                            blup_adjusted_RR,
                            blup_RR,
                            MA.power_adjusted_RR,
                            MA.power_RR
                         )

power_firepower_RR$number <- c(1:(6*30)) # for reorder

power_firepower_RR$es <- abs(power_firepower_RR$es)


# convert moderator to factor with desired ordering of levels
# power_firepower_RR$effect <- factor(power_firepower_RR$effect, levels=rev(c("cMAOM","MAOM", "cESSP", "ESSP", "cMAOM.MA", "MAOM.MA")))



firepower_plot.typeS_RR <- ggplot(data = power_firepower_RR) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_RR, fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type S error",
    low = "#009E73",  #009E73
    #mid = "#0072B2",
    high = "red",   
    #midpoint = 0.25,
    limits = c(0,0.5),
    guide = "colourbar"
  )  + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) +  labs(x ="Response magnitude \n lnRR*", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), legend.position = "none" ) +
  scale_x_discrete(position = "top") + labs(title = "(A)") 



png(filename = "./Figures/firepower_plot.typeS_RR.png", width = 8, height = 10, units = "in", type = "windows", res = 400)
firepower_plot.typeS_RR 
dev.off()


pdf(file = "./Figures/figure4_colour_bar.pdf", width = 8, height = 10)
firepower_plot.typeS_RR 
dev.off()

#save(power_firepower_RR, file = here("data","figure_6A(lnRR_star).RData"))

write.csv(power_firepower_RR, file = "data/figure_6A(lnRR_star).csv", na="NA", row.names = FALSE)                         



#stressor_CVR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_CVR <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_CVR <- data.frame(stressor_CVR=stressor_CVR,
                              es=model_est_CVR$mu_CVR,
                              power=power.F.S_summary_CVR$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))


blup_CVR <- data.frame(stressor_CVR=stressor_CVR,
                              es=model_est_CVR$mu_CVR,
                              power=power.R.S_summary_CVR$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))



MA.power_CVR <- data.frame(stressor_CVR=stressor_CVR,
                                 es=model_est_CVR$mu_CVR,
                                 power=model_est_CVR$MA.power.S,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


power_firepower_CVR <- rbind(intercept_CVR,
                         blup_CVR,
                         MA.power_CVR
                         )

power_firepower_CVR$number <- c(1:(3*12)) # for reorder
power_firepower_CVR$es <- abs(power_firepower_CVR$es)


firepower_plot.typeS_CVR <- ggplot(data = power_firepower_CVR) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_CVR,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type S error",
    low = "#009E73",
    #mid = "#0072B2",
    high = "red",
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar"
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response variability \n lnCVR", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_blank(), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none") + scale_x_discrete(position = "top") + labs(title = "(E)")



png(filename = "./Figures/firepower_plot.typeS_CVR.png", width = 6, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeS_CVR 
dev.off()


#save(power_firepower_CVR, file = here("data","figure_8B(lnCVR).RData"))

write.csv(power_firepower_CVR, file = "data/figure_8B(lnCVR).csv", na="NA", row.names = FALSE)  


#stressor_VR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_VR <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_VR <- data.frame(stressor_VR=stressor_VR,
                              es=model_est_VR$mu_VR,
                              power=power.F.S_summary_VR$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))


blup_VR <- data.frame(stressor_VR=stressor_VR,
                              es=model_est_VR$mu_VR,
                              power=power.R.S_summary_VR$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))


MA.power_VR <- data.frame(stressor_VR=stressor_VR,
                                 es=model_est_VR$mu_VR,
                                 power=model_est_VR$MA.power.S,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


power_firepower_VR <- rbind(intercept_VR,
                         blup_VR,
                         MA.power_VR
                         )

power_firepower_VR$number <- c(1:(3*12)) # for reorder
power_firepower_VR$es <- abs(power_firepower_VR$es)


firepower_plot.typeS_VR <- ggplot(data = power_firepower_VR) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_VR,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type S error",
    low = "#009E73",
    #mid = "#0072B2",
    high = "red",
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar"
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response variability \n lnVR", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_blank(), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=10),
                                         legend.title = element_text(size=10),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none"
                                         ) + scale_x_discrete(position = "top") + labs(title = "(C)") 
  


png(filename = "./Figures/firepower_plot.typeS_VR.png", width = 6, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeS_VR 
dev.off()


#save(power_firepower_VR, file = here("data","figure_8A(lnVR).RData"))
write.csv(power_firepower_VR, file = "data/figure_8B(lnVR).csv", na="NA", row.names = FALSE)  




# layout
firepower_plot.typeS_CVR_VR <- ggarrange(firepower_plot.typeS_VR, firepower_plot.typeS_CVR , heights = c(5,5), widths = c(5,5), nrow = 2, ncol = 1, align = "h")

png(filename = "./Figures/firepower_plot.typeS_CVR_VR.png", width = 6, height = 10, units = "in", type = "windows", res = 400)
firepower_plot.typeS_CVR_VR
dev.off()





#stressor_SMD <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_SMD <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_SMD$mu_SMD,
                              power=power.F.S_summary_SMD$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))

intercept_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_adjusted_SMD$mu_SMD,
                            power=power.F.S_summary_adjusted_SMD$Median,
                              effect=rep(c("cMAOM"),12),
                            es_cat=rep(c("a.Intercept_es"),12))




blup_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_SMD$mu_SMD,
                              power=power.R.S_summary_SMD$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))




blup_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_adjusted_SMD$mu_SMD,
                            power=power.R.S_summary_adjusted_SMD$Median,
                              effect=rep(c("cESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))



MA.power_SMD <- data.frame(stressor_SMD=stressor_SMD,
                                 es=model_est_SMD$mu_SMD,
                                 power=model_est_SMD$MA.power.S,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


MA.power_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                                 es=model_est_adjusted_SMD$mu_SMD,
                                 power=model_est_adjusted_SMD$MA.power.S,
                            effect=rep(c("cMAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))



power_firepower_SMD <- rbind(intercept_adjusted_SMD, 
                             intercept_SMD,
                             blup_adjusted_SMD,
                             blup_SMD,
                             MA.power_adjusted_SMD,
                             MA.power_SMD
                         )

power_firepower_SMD$number <- c(1:(6*12)) # for reorder

power_firepower_SMD$es <- abs(power_firepower_SMD$es)



firepower_plot.typeS_SMD <- ggplot(data = power_firepower_SMD) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_SMD, fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type S error",
    low = "#009E73",
    #mid = "#0072B2",
    high = "red",
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar"
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response magnitude \n SMD", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none"
                                         ) + scale_x_discrete(position = "top") + labs(title = "(B)")



png(filename = "./Figures/firepower_plot.typeS_SMD.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeS_SMD 
dev.off()


#save(power_firepower_SMD, file = here("data","figure_6B(SMD).RData"))
write.csv(power_firepower_SMD, file = "data/figure_6B(SMD).csv", na="NA", row.names = FALSE)  




#stressor_SMDH <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_SMDH <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_SMDH$mu_SMDH,
                              power=power.F.S_summary_SMDH$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))

intercept_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_adjusted_SMDH$mu_SMDH,
                            power=power.F.S_summary_adjusted_SMDH$Median,
                              effect=rep(c("cMAOM"),12),
                            es_cat=rep(c("a.Intercept_es"),12))




blup_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_SMDH$mu_SMDH,
                              power=power.R.S_summary_SMDH$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))




blup_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_adjusted_SMDH$mu_SMDH,
                            power=power.R.S_summary_adjusted_SMDH$Median,
                              effect=rep(c("cESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))


MA.power_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                                 es=model_est_SMDH$mu_SMDH,
                                 power=model_est_SMDH$MA.power.S,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


MA.power_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                                 es=model_est_adjusted_SMDH$mu_SMDH,
                                 power=model_est_adjusted_SMDH$MA.power.S,
                            effect=rep(c("cMAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))



power_firepower_SMDH <- rbind(intercept_adjusted_SMDH, 
                             intercept_SMDH,
                             blup_adjusted_SMDH,
                             blup_SMDH,
                             MA.power_adjusted_SMDH,
                             MA.power_SMDH
                             )

power_firepower_SMDH$number <- c(1:(6*12)) # for reorder

power_firepower_SMDH$es <- abs(power_firepower_SMDH$es)



firepower_plot.typeS_SMDH <- ggplot(data = power_firepower_SMDH) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_SMDH,fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
   scale_fill_gradient(
    name = "Type S error",
    low = "#009E73",
    #mid = "#0072B2",
    high = "red",
    #midpoint = 0.5,
    limits = c(0,1),
    guide = "colourbar"
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response magnitude \n SMDH", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), legend.position = "none") + scale_x_discrete(position = "top") + labs(title = "(D)") 



png(filename = "./Figures/firepower_plot.typeS_SMDH.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeS_SMDH 
dev.off()


#save(power_firepower_SMDH, file = here("data","figure_6B(SMDH).RData"))
write.csv(power_firepower_SMDH, file = "data/figure_6B(SMDH).csv", na="NA", row.names = FALSE)  



# layout
firepower_plot.typeS_SMD_SMDH <- ggarrange(firepower_plot.typeS_SMD, firepower_plot.typeS_SMDH, heights = c(5,5), widths = c(5,5), nrow = 2, ncol = 1, align = "h")

png(filename = "./Figures/firepower_plot.typeS_SMD_SMDH.png", width = 6, height = 10, units = "in", type = "windows", res = 400)
firepower_plot.typeS_SMD_SMDH
dev.off()




png(filename = "./Figures/firepower_plot.typeS.png", width = 10, height = 10, units = "in", type = "windows", res = 400)
  firepower_plot.typeS_RR + {
    firepower_plot.typeS_SMD + firepower_plot.typeS_VR +
    firepower_plot.typeS_SMDH + firepower_plot.typeS_CVR +
    plot_layout(nrow = 2, ncol = 2, widths = c(2,1,2,1))
  } + plot_layout(ncol = 2, widths = c(0.65,1))
dev.off()	


pdf(file = "./Figures/figure4.pdf", width = 10, height = 10)
  firepower_plot.typeS_RR + {
    firepower_plot.typeS_SMD + firepower_plot.typeS_VR +
    firepower_plot.typeS_SMDH + firepower_plot.typeS_CVR +
    plot_layout(nrow = 2, ncol = 2, widths = c(2,1,2,1))
  } + plot_layout(ncol = 2, widths = c(0.65,1))
dev.off()

```



### Heatmaps - Type M
In this section, we made heatmaps to show results for Type M

```{r}
stressor_RR <- c("BD loss 1","BD loss 2","Fert 1","Fert 2","Warm 1","Fert 3","Fert 4","LUC 1","LUC 2","LUC 3","LUC 4","LUC 5","Fert 5","Fert 6","Precip ","LUC 6","Warm 2","Inv 1","Fire 1","Fire 2","Fire 3","Warm 3","Warm 4","Warm 5","BD loss 3","BD loss 4","BD loss 5","Acid","Inv 2","Inv 3")

intercept_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_RR$mu_RR,
                              power=power.F.M_summary_RR$Median,
                              effect=rep(c("MAOM"),30),
                              es_cat=rep(c("a.Intercept_es"),30))


intercept_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_adjusted_RR$mu_RR,
                              power=power.F.M_summary_adjusted_RR$Median,
                              effect=rep(c("cMAOM"),30),
                            es_cat=rep(c("a.Intercept_es"),30))



blup_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_RR$mu_RR,
                              power=power.R.M_summary_RR$Median,
                              effect=rep(c("ESSP"),30),
                              es_cat=rep(c("b.BLUP_es"),30))


blup_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                              es=model_est_adjusted_RR$mu_RR,
                              power=power.R.M_summary_adjusted_RR$Median,
                              effect=rep(c("cESSP"),30),
                              es_cat=rep(c("b.BLUP_es"),30))





MA.power_RR <- data.frame(stressor_RR=stressor_RR,
                                 es=model_est_RR$mu_RR,
                                 power=model_est_RR$MA.power.M,
                                 effect=rep(c("MAOM.MA"),30),
                                 es_cat=rep(c("c.MA.power"),30))

MA.power_adjusted_RR <- data.frame(stressor_RR=stressor_RR,
                                 es=model_est_adjusted_RR$mu_RR,
                                 power=model_est_adjusted_RR$MA.power.M,
                            effect=rep(c("cMAOM.MA"),30),
                                 es_cat=rep(c("c.MA.power"),30))


power_firepower_RR <- rbind(intercept_adjusted_RR,
                            intercept_RR,
                            blup_adjusted_RR,
                            blup_RR,
                            MA.power_adjusted_RR,
                            MA.power_RR
                         )

power_firepower_RR$number <- c(1:(6*30)) # for reorder

power_firepower_RR$es <- abs(power_firepower_RR$es)


# convert moderator to factor with desired ordering of levels
# power_firepower_RR$effect <- factor(power_firepower_RR$effect, levels=rev(c("cMAOM","MAOM", "cESSP", "ESSP", "cMAOM.MA", "MAOM.MA")))



firepower_plot.typeM_RR <- ggplot(data = power_firepower_RR) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_RR, fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type M error",
    low = "white",  # #E69F00
    #mid = "white",
    high = "#E69F00", 
    #midpoint = 2,
    limits = c(0.8,3),
    guide = "colourbar"
  )  + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) +  labs(x ="Response magnitude \n lnRR*", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), legend.position = "none" ) +
  scale_x_discrete(position = "top") + labs(title = "(A)") 



png(filename = "./Figures/firepower_plot.typeM_RR.png", width = 8, height = 10, units = "in", type = "windows", res = 400)
firepower_plot.typeM_RR 
dev.off()

pdf(file = "./Figures/figure5_colour_bar.pdf", width = 8, height = 10)
firepower_plot.typeM_RR 
dev.off()


#save(power_firepower_RR, file = here("data","figure_5A(lnRR_star).RData"))
write.csv(power_firepower_RR, file = "data/figure_5A(lnRR_star).csv", na="NA", row.names = FALSE)  


                         

#stressor_CVR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_CVR <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_CVR <- data.frame(stressor_CVR=stressor_CVR,
                              es=model_est_CVR$mu_CVR,
                              power=power.F.M_summary_CVR$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))


blup_CVR <- data.frame(stressor_CVR=stressor_CVR,
                              es=model_est_CVR$mu_CVR,
                              power=power.R.M_summary_CVR$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))



MA.power_CVR <- data.frame(stressor_CVR=stressor_CVR,
                                 es=model_est_CVR$mu_CVR,
                                 power=model_est_CVR$MA.power.M,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


power_firepower_CVR <- rbind(intercept_CVR,
                         blup_CVR,
                         MA.power_CVR
                         )

power_firepower_CVR$number <- c(1:(3*12)) # for reorder
power_firepower_CVR$es <- abs(power_firepower_CVR$es)


firepower_plot.typeM_CVR <- ggplot(data = power_firepower_CVR) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_CVR,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type M error",
    low = "white",  # #E69F00
    #mid = "white",
    high = "#E69F00",
    #midpoint = 2,
    limits = c(0.8,3),
    guide = "colourbar"
  ) + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response variability \n lnCVR", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_blank(), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none") + scale_x_discrete(position = "top") + labs(title = "(E)")



png(filename = "./Figures/firepower_plot.typeM_CVR.png", width = 6, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeM_CVR 
dev.off()



#save(power_firepower_CVR, file = here("data","figure_7B(lnCVR).RData"))
write.csv(power_firepower_CVR, file = "data/figure_7B(lnCVR).csv", na="NA", row.names = FALSE)




#stressor_VR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_VR <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_VR <- data.frame(stressor_VR=stressor_VR,
                              es=model_est_VR$mu_VR,
                              power=power.F.M_summary_VR$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))


blup_VR <- data.frame(stressor_VR=stressor_VR,
                              es=model_est_VR$mu_VR,
                              power=power.R.M_summary_VR$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))


MA.power_VR <- data.frame(stressor_VR=stressor_VR,
                                 es=model_est_VR$mu_VR,
                                 power=model_est_VR$MA.power.M,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


power_firepower_VR <- rbind(intercept_VR,
                         blup_VR,
                         MA.power_VR
                         )

power_firepower_VR$number <- c(1:(3*12)) # for reorder
power_firepower_VR$es <- abs(power_firepower_VR$es)


firepower_plot.typeM_VR <- ggplot(data = power_firepower_VR) +
  geom_tile(aes(
    x = reorder(effect,number), 
    y = stressor_VR,
    fill = power, width = 0.95, height = 1
  )) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type M error",
    low = "white",  # #E69F00
    #mid = "white",
    high = "#E69F00",
    #midpoint = 2,
    limits = c(0.8,3),
    guide = "colourbar"
  )  + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response variability \n lnVR", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_blank(), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=10),
                                         legend.title = element_text(size=10),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none"
                                         ) +  scale_x_discrete(position = "top") + labs(title = "(C)") 
  


png(filename = "./Figures/firepower_plot.typeM_VR.png", width = 6, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeM_VR 
dev.off()



#save(power_firepower_VR, file = here("data","figure_7A(lnVR).RData"))
write.csv(power_firepower_VR, file = "data/figure_7A(lnVR).csv", na="NA", row.names = FALSE)



firepower_plot.typeM_CVR_VR <- ggarrange(firepower_plot.typeM_VR, firepower_plot.typeM_CVR , heights = c(5,5), widths = c(5,5), nrow = 2, ncol = 1, align = "h")

png(filename = "./Figures/firepower_plot.typeM_CVR_VR.png", width = 6, height = 10, units = "in", type = "windows", res = 400)
firepower_plot.typeM_CVR_VR
dev.off()





#stressor_SMD <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_SMD <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_SMD$mu_SMD,
                              power=power.F.M_summary_SMD$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))

intercept_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_adjusted_SMD$mu_SMD,
                            power=power.F.M_summary_adjusted_SMD$Median,
                              effect=rep(c("cMAOM"),12),
                            es_cat=rep(c("a.Intercept_es"),12))




blup_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_SMD$mu_SMD,
                              power=power.R.M_summary_SMD$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))




blup_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                              es=model_est_adjusted_SMD$mu_SMD,
                            power=power.R.M_summary_adjusted_SMD$Median,
                              effect=rep(c("cESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))



MA.power_SMD <- data.frame(stressor_SMD=stressor_SMD,
                                 es=model_est_SMD$mu_SMD,
                                 power=model_est_SMD$MA.power.M,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


MA.power_adjusted_SMD <- data.frame(stressor_SMD=stressor_SMD,
                                 es=model_est_adjusted_SMD$mu_SMD,
                                 power=model_est_adjusted_SMD$MA.power.M,
                            effect=rep(c("cMAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))



power_firepower_SMD <- rbind(intercept_adjusted_SMD, 
                             intercept_SMD,
                             blup_adjusted_SMD,
                             blup_SMD,
                             MA.power_adjusted_SMD,
                             MA.power_SMD
                         )

power_firepower_SMD$number <- c(1:(6*12)) # for reorder

power_firepower_SMD$es <- abs(power_firepower_SMD$es)



firepower_plot.typeM_SMD <- ggplot(data = power_firepower_SMD) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_SMD, fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type M error",
    low = "white",  # #E69F00
    #mid = "white",
    high = "#E69F00",
    #midpoint = 2,
    limits = c(0.8,3),
    guide = "colourbar"
  )  + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response magnitude \n SMD", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), 
                                         legend.position = "none"
                                         ) + scale_x_discrete(position = "top") + labs(title = "(B)")



png(filename = "./Figures/firepower_plot.typeM_SMD.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeM_SMD 
dev.off()



#save(power_firepower_SMD, file = here("data","figure_5B(SMD).RData"))
write.csv(power_firepower_SMD, file = "data/figure_5B(SMD).csv", na="NA", row.names = FALSE)



#stressor_SMDH <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")

stressor_SMDH <- c("BD loss 1","BD loss 2", "Fert 1", "Fert 2", "Fert 3", "LUC 1","LUC 2","LUC 3","LUC 4","LUC 5", "LUC 6", "Inv 1")

intercept_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_SMDH$mu_SMDH,
                              power=power.F.M_summary_SMDH$Median,
                              effect=rep(c("MAOM"),12),
                              es_cat=rep(c("a.Intercept_es"),12))

intercept_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_adjusted_SMDH$mu_SMDH,
                            power=power.F.M_summary_adjusted_SMDH$Median,
                              effect=rep(c("cMAOM"),12),
                            es_cat=rep(c("a.Intercept_es"),12))




blup_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_SMDH$mu_SMDH,
                              power=power.R.M_summary_SMDH$Median,
                              effect=rep(c("ESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))




blup_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                              es=model_est_adjusted_SMDH$mu_SMDH,
                            power=power.R.M_summary_adjusted_SMDH$Median,
                              effect=rep(c("cESSP"),12),
                              es_cat=rep(c("b.BLUP_es"),12))


MA.power_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                                 es=model_est_SMDH$mu_SMDH,
                                 power=model_est_SMDH$MA.power.M,
                                 effect=rep(c("MAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))


MA.power_adjusted_SMDH <- data.frame(stressor_SMDH=stressor_SMDH,
                                 es=model_est_adjusted_SMDH$mu_SMDH,
                                 power=model_est_adjusted_SMDH$MA.power.M,
                            effect=rep(c("cMAOM.MA"),12),
                                 es_cat=rep(c("c.MA.power"),12))



power_firepower_SMDH <- rbind(intercept_adjusted_SMDH, 
                             intercept_SMDH,
                             blup_adjusted_SMDH,
                             blup_SMDH,
                             MA.power_adjusted_SMDH,
                             MA.power_SMDH
                             )

power_firepower_SMDH$number <- c(1:(6*12)) # for reorder

power_firepower_SMDH$es <- abs(power_firepower_SMDH$es)



firepower_plot.typeM_SMDH <- ggplot(data = power_firepower_SMDH) +
  geom_tile(aes(x = reorder(effect,number), y = stressor_SMDH,fill = power, width = 0.95, height = 1)) +
  theme(aspect.ratio = 0.3) +
  scale_fill_gradient(
    name = "Type M error",
    low = "white",  # #E69F00
    #mid = "white",
    high = "#E69F00",
    #midpoint = 2,
    limits = c(0.8,3),
    guide = "colourbar"
  )  + 
  facet_grid( ~ es_cat, scale = 'free_x', space = "free_x") +
  theme_tufte(base_family = "Helvetica") +
  theme(strip.text.x = element_blank()) + labs(x ="Response magnitude \n SMDH", y = "") + theme(axis.text.x = element_text(size = 12, colour = "black", angle = -45, margin = margin(t = 0, r = 0, b = 5, l = 0)),
                                         axis.text.y = element_text(size = 12, colour = "black"), 
                                         axis.ticks.y = element_blank(),
                                         axis.title.x = element_text(size = 12, colour = "black", face = "bold"),
                                         legend.text = element_text(size=12),
                                         legend.title = element_text(size=12),
                                         legend.key.width = unit(0.5,"in"),
                                         legend.key.height = unit(0.4,"in"), legend.position = "none") + scale_x_discrete(position = "top") + labs(title = "(D)")



png(filename = "./Figures/firepower_plot.typeM_SMDH.png", width = 8, height = 6, units = "in", type = "windows", res = 400)
firepower_plot.typeM_SMDH 
dev.off()



#save(power_firepower_SMDH, file = here("data","figure_5B(SMDH).RData"))
write.csv(power_firepower_SMDH, file = "data/figure_5B(SMDH).csv", na="NA", row.names = FALSE)




firepower_plot.typeM_SMD_SMDH <- ggarrange(firepower_plot.typeM_SMD, firepower_plot.typeM_SMDH, heights = c(5,5), widths = c(5,5), nrow = 2, ncol = 1, align = "h")

png(filename = "./Figures/firepower_plot.typeM_SMD_SMDH.png", width = 6, height = 10, units = "in", type = "windows", res = 400)
firepower_plot.typeM_SMD_SMDH
dev.off()



png(filename = "./Figures/firepower_plot.typeM.png", width = 10, height = 10, units = "in", type = "windows", res = 400)
  firepower_plot.typeM_RR + {
    firepower_plot.typeM_SMD + firepower_plot.typeM_VR +
    firepower_plot.typeM_SMDH + firepower_plot.typeM_CVR +
    plot_layout(nrow = 2, ncol = 2, widths = c(2,1,2,1))
  } + plot_layout(ncol = 2, widths = c(0.65,1))
dev.off()



pdf(file = "./Figures/figure5.pdf", width = 10, height = 10)
  firepower_plot.typeM_RR + {
    firepower_plot.typeM_SMD + firepower_plot.typeM_VR +
    firepower_plot.typeM_SMDH + firepower_plot.typeM_CVR +
    plot_layout(nrow = 2, ncol = 2, widths = c(2,1,2,1))
  } + plot_layout(ncol = 2, widths = c(0.65,1))
dev.off()

```




### E-O power
```{r}

# MAOM
forest_power.MAOM <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('MAOM',8)),
                                'power' = c(E_power.F_RR, E_power.F_lnrr, E_power.F_SMD, E_power.F_SMDH,O_power.F_RR, O_power.F_lnrr, O_power.F_SMD, O_power.F_SMDH),
                           'll' = c(E_power.F_RR_ll, E_power.F_lnrr_ll,  E_power.F_SMD_ll, E_power.F_SMDH_ll, O_power.F_RR_ll, O_power.F_lnrr_ll,  O_power.F_SMD_ll, O_power.F_SMDH_ll),
                           'ul' = c(E_power.F_RR_ul, E_power.F_lnrr_ul,  E_power.F_SMD_ul, E_power.F_SMDH_ul, O_power.F_RR_ul, O_power.F_lnrr_ul,  O_power.F_SMD_ul, O_power.F_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_power.MAOM$es <- factor(forest_power.MAOM$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))
# forest_power$Effect <- factor(forest_power$Effect, levels = c("MAOM",  "ESSP", "cMAOM", "cESSP")) # or levels = rev(c())



ggplot() +
    #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
    geom_pointrange(data = forest_power.MAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
    geom_pointrange(data = forest_power.MAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
    facet_grid( ~Effect, scale = 'free', space = "free_x") +
    scale_y_continuous(limits = c(0, 1)) + 
    labs(title = "(A)", x = "Response magnitude", y = "Statistical power [median \u00B1 95% CI]") +
    coord_flip() + 
    theme_minimal() +
    theme(legend.position = "top",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
          legend.text = element_text(size=8),
          legend.title = element_text(size=10),
          legend.direction = "horizontal",
          legend.background = element_rect(fill = NA)) + 
    # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.4, label = paste0(" ")) -> approach.P.MAOM_mean





# cMAOM
forest_power.cMAOM <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('cMAOM',8)),
                                'power' = c(E_power.F_adjusted_RR, E_power.F_adjusted_lnrr, E_power.F_adjusted_SMD, E_power.F_adjusted_SMDH,O_power.F_adjusted_RR, O_power.F_adjusted_lnrr, O_power.F_adjusted_SMD, O_power.F_adjusted_SMDH),
                           'll' = c(E_power.F_adjusted_RR_ll, E_power.F_adjusted_lnrr_ll,  E_power.F_adjusted_SMD_ll, E_power.F_adjusted_SMDH_ll, O_power.F_adjusted_RR_ll, O_power.F_adjusted_lnrr_ll,  O_power.F_adjusted_SMD_ll, O_power.F_adjusted_SMDH_ll),
                           'ul' = c(E_power.F_adjusted_RR_ul, E_power.F_adjusted_lnrr_ul,  E_power.F_adjusted_SMD_ul, E_power.F_adjusted_SMDH_ul, O_power.F_adjusted_RR_ul, O_power.F_adjusted_lnrr_ul,  O_power.F_adjusted_SMD_ul, O_power.F_adjusted_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_power.cMAOM$es <- factor(forest_power.cMAOM$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_power.cMAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_power.cMAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 1)) + 
  labs(title = "(B)", x = "Response magnitude", y = "Statistical power [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.4, label = paste0(" ")) -> approach.P.cMAOM_adjusted_mean




# png(filename = "./Figures/approach.P.cMAOM_adjusted_mean.png", width = 4, height = 4, units = "in", type = "windows", res = 400)
# approach.P.cMAOM_adjusted_mean
# dev.off() 





# ESSP
forest_power.ESSP <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('ESSP',8)),
                                'power' = c(E_power.R_RR, E_power.R_lnrr, E_power.R_SMD, E_power.R_SMDH,O_power.R_RR, O_power.R_lnrr, O_power.R_SMD, O_power.R_SMDH),
                           'll' = c(E_power.R_RR_ll, E_power.R_lnrr_ll,  E_power.R_SMD_ll, E_power.R_SMDH_ll, O_power.R_RR_ll, O_power.R_lnrr_ll,  O_power.R_SMD_ll, O_power.R_SMDH_ll),
                           'ul' = c(E_power.R_RR_ul, E_power.R_lnrr_ul,  E_power.R_SMD_ul, E_power.R_SMDH_ul, O_power.R_RR_ul, O_power.R_lnrr_ul,  O_power.R_SMD_ul, O_power.R_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_power.ESSP$es <- factor(forest_power.ESSP$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_power.ESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_power.ESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 1)) + 
  labs(title = "(C)", x = "Response magnitude", y = "Statistical power [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.49, label = paste0(" ")) -> approach.P.ESSP_mean





# cESSP
forest_power.cESSP <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('cESSP',8)),
                                'power' = c(E_power.R_adjusted_RR, E_power.R_adjusted_lnrr, E_power.R_adjusted_SMD, E_power.R_adjusted_SMDH,O_power.R_adjusted_RR, O_power.R_adjusted_lnrr, O_power.R_adjusted_SMD, O_power.R_adjusted_SMDH),
                           'll' = c(E_power.R_adjusted_RR_ll, E_power.R_adjusted_lnrr_ll,  E_power.R_adjusted_SMD_ll, E_power.R_adjusted_SMDH_ll, O_power.R_adjusted_RR_ll, O_power.R_adjusted_lnrr_ll,  O_power.R_adjusted_SMD_ll, O_power.R_adjusted_SMDH_ll),
                           'ul' = c(E_power.R_adjusted_RR_ul, E_power.R_adjusted_lnrr_ul,  E_power.R_adjusted_SMD_ul, E_power.R_adjusted_SMDH_ul, O_power.R_adjusted_RR_ul, O_power.R_adjusted_lnrr_ul,  O_power.R_adjusted_SMD_ul, O_power.R_adjusted_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_power.cESSP$es <- factor(forest_power.cESSP$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_power.cESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_power.cESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 1)) + 
  labs(title = "(D)", x = "Response magnitude", y = "Statistical power [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.49, label = paste0("*")) -> approach.P.cESSP_adjusted_mean




# MAOM
forest_power.MAOM <- data.frame('Approach' = c(rep('Experimental', 2), rep('Observational', 2)),
                                'es' = c('lnVR', 'lnCVR', 'lnVR', 'lnCVR'),
                                'Effect' = c(rep('MAOM',4)),
                                'power' = c(E_power.R_VR, E_power.R_CVR, O_power.R_VR, O_power.R_CVR),
                           'll' = c(E_power.R_VR_ll, E_power.R_CVR_ll,  O_power.R_VR_ll, O_power.R_CVR_ll),
                           'ul' = c(E_power.R_VR_ul, E_power.R_CVR_ul,  O_power.R_VR_ul, O_power.R_CVR_ul),
                           'effect_type' = c(rep('Variance differences',4)))



# convert moderator to factor with desired ordering of levels
forest_power.MAOM$es <- factor(forest_power.MAOM$es, levels=rev(c("lnVR","lnCVR")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_power.MAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_power.MAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 1)) + 
  labs(title = "(E)", x = "Response variability", y = "Statistical power [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) -> approach.P.MAOM_variance 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) 
   #annotate(geom = "text", x = 2.14, y = 0.45, label = paste0("*")) 
  



# 
# ESSP
forest_power.ESSP <- data.frame('Approach' = c(rep('Experimental', 2), rep('Observational', 2)),
                                'es' = c('lnVR', 'lnCVR', 'lnVR', 'lnCVR'),
                                'Effect' = c(rep('ESSP',4)),
                                'power' = c(E_power.R_VR, E_power.R_CVR, O_power.R_VR, O_power.R_CVR),
                           'll' = c(E_power.R_VR_ll, E_power.R_CVR_ll,  O_power.R_VR_ll, O_power.R_CVR_ll),
                           'ul' = c(E_power.R_VR_ul, E_power.R_CVR_ul,  O_power.R_VR_ul, O_power.R_CVR_ul),
                           'effect_type' = c(rep('Variance differences',4)))



# convert moderator to factor with desired ordering of levels
forest_power.ESSP$es <- factor(forest_power.ESSP$es, levels=rev(c("lnVR","lnCVR")))


ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_power.ESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_power.ESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 1)) + 
  labs(title = "(F)", x = "Response variability", y = "Statistical power [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) -> approach.P.ESSP_variance 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) 
#annotate(geom = "text", x = 4.1, y = 0.49, label = paste0("*"))



```


### E-O Type S

```{r}

# MAOM
forest_TypeS.MAOM <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('MAOM',8)),
                                'power' = c(E_power.F.S_RR, E_power.F.S_lnrr, E_power.F.S_SMD, E_power.F.S_SMDH,O_power.F.S_RR, O_power.F.S_lnrr, O_power.F.S_SMD, O_power.F.S_SMDH),
                           'll' = c(E_power.F.S_RR_ll, E_power.F.S_lnrr_ll,  E_power.F.S_SMD_ll, E_power.F.S_SMDH_ll, O_power.F.S_RR_ll, O_power.F.S_lnrr_ll,  O_power.F.S_SMD_ll, O_power.F.S_SMDH_ll),
                           'ul' = c(E_power.F.S_RR_ul, E_power.F.S_lnrr_ul,  E_power.F.S_SMD_ul, E_power.F.S_SMDH_ul, O_power.F.S_RR_ul, O_power.F.S_lnrr_ul,  O_power.F.S_SMD_ul, O_power.F.S_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeS.MAOM$es <- factor(forest_TypeS.MAOM$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS.MAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS.MAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
scale_color_manual(values = c("#D55E00","#0072B2")) +
    facet_grid( ~Effect, scale = 'free', space = "free_x") +
    scale_y_continuous(limits = c(0, 0.2)) + 
    labs(title = "(M)", x = "Response magnitude", y = "Type S error [median \u00B1 95% CI]") +
    coord_flip() + 
    theme_minimal() +
  theme(legend.position = "top",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
   theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeS.MAOM_mean  
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    # theme(plot.title = element_text(hjust = -0.08))
    #annotate(geom = "text", x = 4.1, y = 0.48, label = paste0("*")) 



# cMAOM
forest_TypeS.cMAOM <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('cMAOM',8)),
                                'power' = c(E_power.F.S_adjusted_RR, E_power.F.S_adjusted_lnrr, E_power.F.S_adjusted_SMD, E_power.F.S_adjusted_SMDH,O_power.F.S_adjusted_RR, O_power.F.S_adjusted_lnrr, O_power.F.S_adjusted_SMD, O_power.F.S_adjusted_SMDH),
                           'll' = c(E_power.F.S_adjusted_RR_ll, E_power.F.S_adjusted_lnrr_ll,  E_power.F.S_adjusted_SMD_ll, E_power.F.S_adjusted_SMDH_ll, O_power.F.S_adjusted_RR_ll, O_power.F.S_adjusted_lnrr_ll,  O_power.F.S_adjusted_SMD_ll, O_power.F.S_adjusted_SMDH_ll),
                           'ul' = c(E_power.F.S_adjusted_RR_ul, E_power.F.S_adjusted_lnrr_ul,  E_power.F.S_adjusted_SMD_ul, E_power.F.S_adjusted_SMDH_ul, O_power.F.S_adjusted_RR_ul, O_power.F.S_adjusted_lnrr_ul,  O_power.F.S_adjusted_SMD_ul, O_power.F.S_adjusted_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeS.cMAOM$es <- factor(forest_TypeS.cMAOM$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS.cMAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS.cMAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 0.2)) + 
  labs(title = "(N)", x = "Response magnitude", y = "Type S error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeS.cMAOM_adjusted_mean 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) 
    #annotate(geom = "text", x = 4.1, y = 0.4, label = paste0("*")) 




# ESSP
forest_TypeS.ESSP <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('ESSP',8)),
                                'power' = c(E_power.R.S_RR, E_power.R.S_lnrr, E_power.R.S_SMD, E_power.R.S_SMDH,O_power.R.S_RR, O_power.R.S_lnrr, O_power.R.S_SMD, O_power.R.S_SMDH),
                           'll' = c(E_power.R.S_RR_ll, E_power.R.S_lnrr_ll,  E_power.R.S_SMD_ll, E_power.R.S_SMDH_ll, O_power.R.S_RR_ll, O_power.R.S_lnrr_ll,  O_power.R.S_SMD_ll, O_power.R.S_SMDH_ll),
                           'ul' = c(E_power.R.S_RR_ul, E_power.R.S_lnrr_ul,  E_power.R.S_SMD_ul, E_power.R.S_SMDH_ul, O_power.R.S_RR_ul, O_power.R.S_lnrr_ul,  O_power.R.S_SMD_ul, O_power.R.S_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeS.ESSP$es <- factor(forest_TypeS.ESSP$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS.ESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS.ESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 0.2)) + 
  labs(title = "(O)", x = "Response magnitude", y = "Type S error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.1, label = paste0(" ")) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeS.ESSP_mean



# cESSP
forest_TypeS.cESSP <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('cESSP',8)),
                                'power' = c(E_power.R.S_adjusted_RR, E_power.R.S_adjusted_lnrr, E_power.R.S_adjusted_SMD, E_power.R.S_adjusted_SMDH,O_power.R.S_adjusted_RR, O_power.R.S_adjusted_lnrr, O_power.R.S_adjusted_SMD, O_power.R.S_adjusted_SMDH),
                           'll' = c(E_power.R.S_adjusted_RR_ll, E_power.R.S_adjusted_lnrr_ll,  E_power.R.S_adjusted_SMD_ll, E_power.R.S_adjusted_SMDH_ll, O_power.R.S_adjusted_RR_ll, O_power.R.S_adjusted_lnrr_ll,  O_power.R.S_adjusted_SMD_ll, O_power.R.S_adjusted_SMDH_ll),
                           'ul' = c(E_power.R.S_adjusted_RR_ul, E_power.R.S_adjusted_lnrr_ul,  E_power.R.S_adjusted_SMD_ul, E_power.R.S_adjusted_SMDH_ul, O_power.R.S_adjusted_RR_ul, O_power.R.S_adjusted_lnrr_ul,  O_power.R.S_adjusted_SMD_ul, O_power.R.S_adjusted_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeS.cESSP$es <- factor(forest_TypeS.cESSP$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS.cESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS.cESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 0.2)) + 
  labs(title = "(P)", x = "Response magnitude", y = "Type S error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.08, label = paste0("*")) +
   theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeS.cESSP_adjusted_mean



# MAOM
forest_TypeS.MAOM <- data.frame('Approach' = c(rep('Experimental', 2), rep('Observational', 2)),
                                'es' = c('lnVR', 'lnCVR', 'lnVR', 'lnCVR'),
                                'Effect' = c(rep('MAOM',4)),
                                'power' = c(E_power.R.S_VR, E_power.R.S_CVR, O_power.R.S_VR, O_power.R.S_CVR),
                           'll' = c(E_power.R.S_VR_ll, E_power.R.S_CVR_ll,  O_power.R.S_VR_ll, O_power.R.S_CVR_ll),
                           'ul' = c(E_power.R.S_VR_ul, E_power.R.S_CVR_ul,  O_power.R.S_VR_ul, O_power.R.S_CVR_ul),
                           'effect_type' = c(rep('Variance differences',4)))



# convert moderator to factor with desired ordering of levels
forest_TypeS.MAOM$es <- factor(forest_TypeS.MAOM$es, levels=rev(c("lnVR","lnCVR")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS.MAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS.MAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 0.2)) + 
  labs(title = "(Q)", x = "Response variability", y = "Type S error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeS.MAOM_variance 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) 
   #annotate(geom = "text", x = 2.14, y = 0.45, label = paste0("*")) 
  


# 
# ESSP
forest_TypeS.ESSP <- data.frame('Approach' = c(rep('Experimental', 2), rep('Observational', 2)),
                                'es' = c('lnVR', 'lnCVR', 'lnVR', 'lnCVR'),
                                'Effect' = c(rep('ESSP',4)),
                                'power' = c(E_power.R.S_VR, E_power.R.S_CVR, O_power.R.S_VR, O_power.R.S_CVR),
                           'll' = c(E_power.R.S_VR_ll, E_power.R.S_CVR_ll,  O_power.R.S_VR_ll, O_power.R.S_CVR_ll),
                           'ul' = c(E_power.R.S_VR_ul, E_power.R.S_CVR_ul,  O_power.R.S_VR_ul, O_power.R.S_CVR_ul),
                           'effect_type' = c(rep('Variance differences',4)))



# convert moderator to factor with desired ordering of levels
forest_TypeS.ESSP$es <- factor(forest_TypeS.ESSP$es, levels=rev(c("lnVR","lnCVR")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS.ESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS.ESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 0.2)) + 
  labs(title = "(R)", x = "Response variability", y = "Type S error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeS.ESSP_variance 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) 
 
#annotate(geom = "text", x = 4.1, y = 0.49, label = paste0("*"))


```




### E-O Type M

```{r}
# MAOM
forest_TypeM.MAOM <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('MAOM',8)),
                                'power' = c(E_power.F.M_RR, E_power.F.M_lnrr, E_power.F.M_SMD, E_power.F.M_SMDH,O_power.F.M_RR, O_power.F.M_lnrr, O_power.F.M_SMD, O_power.F.M_SMDH),
                           'll' = c(E_power.F.M_RR_ll, E_power.F.M_lnrr_ll,  E_power.F.M_SMD_ll, E_power.F.M_SMDH_ll, O_power.F.M_RR_ll, O_power.F.M_lnrr_ll,  O_power.F.M_SMD_ll, O_power.F.M_SMDH_ll),
                           'ul' = c(E_power.F.M_RR_ul, E_power.F.M_lnrr_ul,  E_power.F.M_SMD_ul, E_power.F.M_SMDH_ul, O_power.F.M_RR_ul, O_power.F.M_lnrr_ul,  O_power.F.M_SMD_ul, O_power.F.M_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeM.MAOM$es <- factor(forest_TypeM.MAOM$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM.MAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM.MAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
scale_color_manual(values = c("#D55E00","#0072B2")) +
    facet_grid( ~Effect, scale = 'free', space = "free_x") +
    scale_y_continuous(limits = c(0, 16)) + 
    labs(title = "(G)", x = "Response magnitude", y = "Type M error [median \u00B1 95% CI]") +
    coord_flip() + 
    theme_minimal() +
  theme(legend.position = "top",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
   theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) + 
    annotate(geom = "text", x = 4.1, y = 6, label = paste0(" ")) -> approach.TypeM.MAOM_mean 
    




# cMAOM
forest_TypeM.cMAOM <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('cMAOM',8)),
                                'power' = c(E_power.F.M_adjusted_RR, E_power.F.M_adjusted_lnrr, E_power.F.M_adjusted_SMD, E_power.F.M_adjusted_SMDH,O_power.F.M_adjusted_RR, O_power.F.M_adjusted_lnrr, O_power.F.M_adjusted_SMD, O_power.F.M_adjusted_SMDH),
                           'll' = c(E_power.F.M_adjusted_RR_ll, E_power.F.M_adjusted_lnrr_ll,  E_power.F.M_adjusted_SMD_ll, E_power.F.M_adjusted_SMDH_ll, O_power.F.M_adjusted_RR_ll, O_power.F.M_adjusted_lnrr_ll,  O_power.F.M_adjusted_SMD_ll, O_power.F.M_adjusted_SMDH_ll),
                           'ul' = c(E_power.F.M_adjusted_RR_ul, E_power.F.M_adjusted_lnrr_ul,  E_power.F.M_adjusted_SMD_ul, E_power.F.M_adjusted_SMDH_ul, O_power.F.M_adjusted_RR_ul, O_power.F.M_adjusted_lnrr_ul,  O_power.F.M_adjusted_SMD_ul, O_power.F.M_adjusted_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeM.cMAOM$es <- factor(forest_TypeM.cMAOM$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM.cMAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM.cMAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 16)) + 
  labs(title = "(H)", x = "Response magnitude", y = "Type M error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) +
    annotate(geom = "text", x = 4.1, y = 9, label = paste0("*")) ->   approach.TypeM.cMAOM_adjusted_mean
    



# ESSP
forest_TypeM.ESSP <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('ESSP',8)),
                                'power' = c(E_power.R.M_RR, E_power.R.M_lnrr, E_power.R.M_SMD, E_power.R.M_SMDH,O_power.R.M_RR, O_power.R.M_lnrr, O_power.R.M_SMD, O_power.R.M_SMDH),
                           'll' = c(E_power.R.M_RR_ll, E_power.R.M_lnrr_ll,  E_power.R.M_SMD_ll, E_power.R.M_SMDH_ll, O_power.R.M_RR_ll, O_power.R.M_lnrr_ll,  O_power.R.M_SMD_ll, O_power.R.M_SMDH_ll),
                           'ul' = c(E_power.R.M_RR_ul, E_power.R.M_lnrr_ul,  E_power.R.M_SMD_ul, E_power.R.M_SMDH_ul, O_power.R.M_RR_ul, O_power.R.M_lnrr_ul,  O_power.R.M_SMD_ul, O_power.R.M_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeM.ESSP$es <- factor(forest_TypeM.ESSP$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM.ESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM.ESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 16)) + 
  labs(title = "(I)", x = "Response magnitude", y = "Type M error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.1, label = paste0(" ")) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeM.ESSP_mean




# cESSP
forest_TypeM.cESSP <- data.frame('Approach' = c(rep('Experimental', 4), rep('Observational', 4)),
                                'es' = c('lnRR*', 'lnRR', 'SMD', 'SMDH',
                                         'lnRR*', 'lnRR', 'SMD', 'SMDH'),
                                'Effect' = c(rep('cESSP',8)),
                                'power' = c(E_power.R.M_adjusted_RR, E_power.R.M_adjusted_lnrr, E_power.R.M_adjusted_SMD, E_power.R.M_adjusted_SMDH,O_power.R.M_adjusted_RR, O_power.R.M_adjusted_lnrr, O_power.R.M_adjusted_SMD, O_power.R.M_adjusted_SMDH),
                           'll' = c(E_power.R.M_adjusted_RR_ll, E_power.R.M_adjusted_lnrr_ll,  E_power.R.M_adjusted_SMD_ll, E_power.R.M_adjusted_SMDH_ll, O_power.R.M_adjusted_RR_ll, O_power.R.M_adjusted_lnrr_ll,  O_power.R.M_adjusted_SMD_ll, O_power.R.M_adjusted_SMDH_ll),
                           'ul' = c(E_power.R.M_adjusted_RR_ul, E_power.R.M_adjusted_lnrr_ul,  E_power.R.M_adjusted_SMD_ul, E_power.R.M_adjusted_SMDH_ul, O_power.R.M_adjusted_RR_ul, O_power.R.M_adjusted_lnrr_ul,  O_power.R.M_adjusted_SMD_ul, O_power.R.M_adjusted_SMDH_ul),
                           'effect_type' = c(rep('Mean differences',8)))



# convert moderator to factor with desired ordering of levels
forest_TypeM.cESSP$es <- factor(forest_TypeM.cESSP$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM.cESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM.cESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 16)) + 
  labs(title = "(J)", x = "Response magnitude", y = "Type M error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           # guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    #theme(plot.title = element_text(hjust = -0.08)) +
    annotate(geom = "text", x = 4.1, y = 0.08, label = paste0(" ")) +
   theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeM.cESSP_adjusted_mean




# MAOM
forest_TypeM.MAOM <- data.frame('Approach' = c(rep('Experimental', 2), rep('Observational', 2)),
                                'es' = c('lnVR', 'lnCVR', 'lnVR', 'lnCVR'),
                                'Effect' = c(rep('MAOM',4)),
                                'power' = c(E_power.R.M_VR, E_power.R.M_CVR, O_power.R.M_VR, O_power.R.M_CVR),
                           'll' = c(E_power.R.M_VR_ll, E_power.R.M_CVR_ll,  O_power.R.M_VR_ll, O_power.R.M_CVR_ll),
                           'ul' = c(E_power.R.M_VR_ul, E_power.R.M_CVR_ul,  O_power.R.M_VR_ul, O_power.R.M_CVR_ul),
                           'effect_type' = c(rep('Variance differences',4)))



# convert moderator to factor with desired ordering of levels
forest_TypeM.MAOM$es <- factor(forest_TypeM.MAOM$es, levels=rev(c("lnVR","lnCVR")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM.MAOM %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM.MAOM %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 16)) + 
  labs(title = "(K)", x = "Response variability", y = "Type M error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeM.MAOM_variance 
           
    

# 
# ESSP
forest_TypeM.ESSP <- data.frame('Approach' = c(rep('Experimental', 2), rep('Observational', 2)),
                                'es' = c('lnVR', 'lnCVR', 'lnVR', 'lnCVR'),
                                'Effect' = c(rep('ESSP',4)),
                                'power' = c(E_power.R.M_VR, E_power.R.M_CVR, O_power.R.M_VR, O_power.R.M_CVR),
                           'll' = c(E_power.R.M_VR_ll, E_power.R.M_CVR_ll,  O_power.R.M_VR_ll, O_power.R.M_CVR_ll),
                           'ul' = c(E_power.R.M_VR_ul, E_power.R.M_CVR_ul,  O_power.R.M_VR_ul, O_power.R.M_CVR_ul),
                           'effect_type' = c(rep('Variance differences',4)))



# convert moderator to factor with desired ordering of levels
forest_TypeM.ESSP$es <- factor(forest_TypeM.ESSP$es, levels=rev(c("lnVR","lnCVR")))




ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM.ESSP %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM.ESSP %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, colour = Approach), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  scale_color_manual(values = c("#D55E00","#0072B2")) +
  facet_grid( ~Effect, scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(0, 16)) + 
  labs(title = "(L)", x = "Response variability", y = "Type M error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_minimal() +
  theme(legend.position = "none",#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.text = element_text(size=8),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) +
  theme(axis.title.y = element_blank(),
         axis.text.y = element_blank()) -> approach.TypeM.ESSP_variance 


```




### layout power, S and M
```{r}
 

pdf(file = "./Figures/Figure9(first_col).pdf", width = 4, height = 12)
approach.P.MAOM_mean + approach.P.cMAOM_adjusted_mean +
             approach.P.ESSP_mean + approach.P.cESSP_adjusted_mean +
             approach.P.MAOM_variance + approach.P.ESSP_variance +
             plot_layout(nrow = 6, ncol = 1,  heights = c(1,1,1,1,0.5,0.5))
dev.off() 




pdf(file = "./Figures/Figure9(third_col).pdf", width = 4, height = 12)
 approach.TypeS.MAOM_mean + approach.TypeS.cMAOM_adjusted_mean +
             approach.TypeS.ESSP_mean + approach.TypeS.cESSP_adjusted_mean +
             approach.TypeS.MAOM_variance + approach.TypeS.ESSP_variance +
            plot_layout(nrow = 6, ncol = 1,  heights = c(1,1,1,1,0.5,0.5))
dev.off() 





pdf(file = "./Figures/Figure9(second_col).pdf", width = 4, height = 12)
approach.TypeM.MAOM_mean + approach.TypeM.cMAOM_adjusted_mean +
             approach.TypeM.ESSP_mean +  approach.TypeM.cESSP_adjusted_mean +
             approach.TypeM.MAOM_variance + approach.TypeM.ESSP_variance +
             plot_layout(nrow = 6, ncol = 1,  heights = c(1,1,1,1,0.5,0.5))
dev.off() 




pdf(file = "./Figures/Figure9.pdf", width = 9.5, height = 15)
approach.P.MAOM_mean + approach.TypeM.MAOM_mean + approach.TypeS.MAOM_mean + 
  
  
approach.P.cMAOM_adjusted_mean + approach.TypeM.cMAOM_adjusted_mean + approach.TypeS.cMAOM_adjusted_mean +
  
approach.P.ESSP_mean + approach.TypeM.ESSP_mean +  approach.TypeS.ESSP_mean + 
  
approach.P.cESSP_adjusted_mean + approach.TypeM.cESSP_adjusted_mean + approach.TypeS.cESSP_adjusted_mean +
  
approach.P.MAOM_variance + approach.TypeM.MAOM_variance + approach.TypeS.MAOM_variance + 
  
approach.P.ESSP_variance + approach.TypeM.ESSP_variance + approach.TypeS.ESSP_variance +
 
plot_layout(nrow = 6, ncol = 3,  heights = c(1,1,1,1,0.5,0.5,
                                             1,1,1,1,0.5,0.5,
                                             1,1,1,1,0.5,0.5))
dev.off()



```





### forestplot data for power (median 95% CI)
```{r}
# lnRR*
E_power.F_RR <- (summary(MMA_power.F_RR.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_RR <- (summary(MMA_power.F_RR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_RR <- confint(MMA_power.F_RR.approach2) %>% exp() %>% round(3)
E_power.F_RR_ll <- CI_RR[4]
E_power.F_RR_ul <- CI_RR[9]
O_power.F_RR_ll <- CI_RR[5]
O_power.F_RR_ul <- CI_RR[10]


E_power.R_RR <- (summary(MMA_power.R_RR.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_RR <- (summary(MMA_power.R_RR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_RR <- confint(MMA_power.R_RR.approach2) %>% exp() %>% round(3)
E_power.R_RR_ll <- CI_RR[4]
E_power.R_RR_ul <- CI_RR[9]
O_power.R_RR_ll <- CI_RR[5]
O_power.R_RR_ul <- CI_RR[10]



E_power.F_adjusted_RR <- (summary(MMA_power.F_adjusted_RR.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_adjusted_RR <- (summary(MMA_power.F_adjusted_RR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_RR <- confint(MMA_power.F_adjusted_RR.approach2) %>% exp() %>% round(3)
E_power.F_adjusted_RR_ll <- CI_adjusted_RR[4]
E_power.F_adjusted_RR_ul <- CI_adjusted_RR[9]
O_power.F_adjusted_RR_ll <- CI_adjusted_RR[5]
O_power.F_adjusted_RR_ul <- CI_adjusted_RR[10]


E_power.R_adjusted_RR <- (summary(MMA_power.R_adjusted_RR.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_adjusted_RR <- (summary(MMA_power.R_adjusted_RR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_RR <- confint(MMA_power.R_adjusted_RR.approach2) %>% exp() %>% round(3)
E_power.R_adjusted_RR_ll <- CI_adjusted_RR[4]
E_power.R_adjusted_RR_ul <- CI_adjusted_RR[9]
O_power.R_adjusted_RR_ll <- CI_adjusted_RR[5]
O_power.R_adjusted_RR_ul <- CI_adjusted_RR[10]

  
# lnrr
E_power.F_lnrr <- (summary(MMA_power.F_lnrr.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_lnrr <- (summary(MMA_power.F_lnrr.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_lnrr <- confint(MMA_power.F_lnrr.approach2) %>% exp() %>% round(3)
E_power.F_lnrr_ll <- CI_lnrr[4]
# E_power.F_lnrr_ul <- CI_lnrr[9] # more than 1, so truncate at 1
E_power.F_lnrr_ul <- 1
O_power.F_lnrr_ll <- CI_lnrr[5]
# O_power.F_lnrr_ul <- CI_lnrr[10] # more than 1, so truncate at 1
O_power.F_lnrr_ul <- 1


E_power.R_lnrr <- (summary(MMA_power.R_lnrr.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_lnrr <- (summary(MMA_power.R_lnrr.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_lnrr <- confint(MMA_power.R_lnrr.approach2) %>% exp() %>% round(3)
E_power.R_lnrr_ll <- CI_lnrr[4]
E_power.R_lnrr_ul <- CI_lnrr[9]
O_power.R_lnrr_ll <- CI_lnrr[5]
O_power.R_lnrr_ul <- CI_lnrr[10]



E_power.F_adjusted_lnrr <- (summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_adjusted_lnrr <- (summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_lnrr <- confint(MMA_power.F_adjusted_lnrr.approach2) %>% exp() %>% round(3)
E_power.F_adjusted_lnrr_ll <- CI_adjusted_lnrr[4]
# E_power.F_adjusted_lnrr_ul <- CI_adjusted_lnrr[9] # more than 1, so truncate at 1
E_power.F_adjusted_lnrr_ul <- 1
O_power.F_adjusted_lnrr_ll <- CI_adjusted_lnrr[5]
# O_power.F_adjusted_lnrr_ul <- CI_adjusted_lnrr[10] # more than 1, so truncate at 1
O_power.F_adjusted_lnrr_ul <- 1


E_power.R_adjusted_lnrr <- (summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_adjusted_lnrr <- (summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_lnrr <- confint(MMA_power.R_adjusted_lnrr.approach2) %>% exp() %>% round(3)
E_power.R_adjusted_lnrr_ll <- CI_adjusted_lnrr[4]
E_power.R_adjusted_lnrr_ul <- CI_adjusted_lnrr[9]
O_power.R_adjusted_lnrr_ll <- CI_adjusted_lnrr[5]
O_power.R_adjusted_lnrr_ul <- CI_adjusted_lnrr[10]




# SMD
E_power.F_SMD <- (summary(MMA_power.F_SMD.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_SMD <- (summary(MMA_power.F_SMD.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_SMD <- confint(MMA_power.F_SMD.approach2) %>% exp() %>% round(3)
E_power.F_SMD_ll <- CI_SMD[4]
# E_power.F_SMD_ul <- CI_SMD[9] # more than 1, so truncate at 1
E_power.F_SMD_ul <- 1
O_power.F_SMD_ll <- CI_SMD[5]
O_power.F_SMD_ul <- CI_SMD[10]




E_power.R_SMD <- (summary(MMA_power.R_SMD.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_SMD <- (summary(MMA_power.R_SMD.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_SMD <- confint(MMA_power.R_SMD.approach2) %>% exp() %>% round(3)
E_power.R_SMD_ll <- CI_SMD[4]
E_power.R_SMD_ul <- CI_SMD[9]
O_power.R_SMD_ll <- CI_SMD[5]
O_power.R_SMD_ul <- CI_SMD[10]



E_power.F_adjusted_SMD <- (summary(MMA_power.F_adjusted_SMD.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_adjusted_SMD <- (summary(MMA_power.F_adjusted_SMD.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_SMD <- confint(MMA_power.F_adjusted_SMD.approach2) %>% exp() %>% round(3)
E_power.F_adjusted_SMD_ll <- CI_adjusted_SMD[4]
E_power.F_adjusted_SMD_ul <- CI_adjusted_SMD[9]
O_power.F_adjusted_SMD_ll <- CI_adjusted_SMD[5]
O_power.F_adjusted_SMD_ul <- CI_adjusted_SMD[10] 



E_power.R_adjusted_SMD <- (summary(MMA_power.R_adjusted_SMD.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_adjusted_SMD <- (summary(MMA_power.R_adjusted_SMD.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_SMD <- confint(MMA_power.R_adjusted_SMD.approach2) %>% exp() %>% round(3)
E_power.R_adjusted_SMD_ll <- CI_adjusted_SMD[4]
E_power.R_adjusted_SMD_ul <- CI_adjusted_SMD[9]
O_power.R_adjusted_SMD_ll <- CI_adjusted_SMD[5]
O_power.R_adjusted_SMD_ul <- CI_adjusted_SMD[10]



# SMDH
E_power.F_SMDH <- (summary(MMA_power.F_SMDH.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_SMDH <- (summary(MMA_power.F_SMDH.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_SMDH <- confint(MMA_power.F_SMDH.approach2) %>% exp() %>% round(3)
E_power.F_SMDH_ll <- CI_SMDH[4]
E_power.F_SMDH_ul <- CI_SMDH[9]
O_power.F_SMDH_ll <- CI_SMDH[5]
O_power.F_SMDH_ul <- CI_SMDH[10]



E_power.R_SMDH <- (summary(MMA_power.R_SMDH.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_SMDH <- (summary(MMA_power.R_SMDH.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_SMDH <- confint(MMA_power.R_SMDH.approach2) %>% exp() %>% round(3)
E_power.R_SMDH_ll <- CI_SMDH[4]
E_power.R_SMDH_ul <- CI_SMDH[9]
O_power.R_SMDH_ll <- CI_SMDH[5]
O_power.R_SMDH_ul <- CI_SMDH[10]



E_power.F_adjusted_SMDH <- (summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_adjusted_SMDH <- (summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_SMDH <- confint(MMA_power.F_adjusted_SMDH.approach2) %>% exp() %>% round(3)
E_power.F_adjusted_SMDH_ll <- CI_adjusted_SMDH[4]
E_power.F_adjusted_SMDH_ul <- CI_adjusted_SMDH[9]
O_power.F_adjusted_SMDH_ll <- CI_adjusted_SMDH[5]
O_power.F_adjusted_SMDH_ul <- CI_adjusted_SMDH[10] 



E_power.R_adjusted_SMDH <- (summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_adjusted_SMDH <- (summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_adjusted_SMDH <- confint(MMA_power.R_adjusted_SMDH.approach2) %>% exp() %>% round(3)
E_power.R_adjusted_SMDH_ll <- CI_adjusted_SMDH[4]
E_power.R_adjusted_SMDH_ul <- CI_adjusted_SMDH[9]
O_power.R_adjusted_SMDH_ll <- CI_adjusted_SMDH[5]
O_power.R_adjusted_SMDH_ul <- CI_adjusted_SMDH[10]



# lnCVR
E_power.F_CVR <- (summary(MMA_power.F_CVR.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_CVR <- (summary(MMA_power.F_CVR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_CVR <- confint(MMA_power.F_CVR.approach2) %>% exp() %>% round(3)
E_power.F_CVR_ll <- CI_CVR[4]
E_power.F_CVR_ul <- CI_CVR[9]
O_power.F_CVR_ll <- CI_CVR[5]
O_power.F_CVR_ul <- CI_CVR[10]


E_power.R_CVR <- (summary(MMA_power.R_CVR.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_CVR <- (summary(MMA_power.R_CVR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_CVR <- confint(MMA_power.R_CVR.approach2) %>% exp() %>% round(3)
E_power.R_CVR_ll <- CI_CVR[4]
E_power.R_CVR_ul <- CI_CVR[9]
O_power.R_CVR_ll <- CI_CVR[5]
O_power.R_CVR_ul <- CI_CVR[10]



# lnVR
E_power.F_VR <- (summary(MMA_power.F_VR.approach2)$coefficients[1]) %>% exp() %>% round(3)

O_power.F_VR <- (summary(MMA_power.F_VR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_VR <- confint(MMA_power.F_VR.approach2) %>% exp() %>% round(3)
E_power.F_VR_ll <- CI_VR[4]
E_power.F_VR_ul <- CI_VR[9]
O_power.F_VR_ll <- CI_VR[5]
O_power.F_VR_ul <- CI_VR[10]


E_power.R_VR <- (summary(MMA_power.R_VR.approach2)$coefficients[1]) %>% exp() %>% round(3)
  
O_power.R_VR <- (summary(MMA_power.R_VR.approach2)$coefficients[2]) %>% exp() %>% round(3)

CI_VR <- confint(MMA_power.R_VR.approach2) %>% exp() %>% round(3)
E_power.R_VR_ll <- CI_VR[4]
E_power.R_VR_ul <- CI_VR[9]
O_power.R_VR_ll <- CI_VR[5]
O_power.R_VR_ul <- CI_VR[10]





forest_power <- data.frame('Approach' = c(rep('Experimental', 20), rep('Observational', 20)),
                                'es' = c(rep('lnRR*',4), rep('lnRR',4), rep('SMD',4), rep('SMDH',4), rep('lnVR',2), rep('lnCVR',2),rep('lnRR*',4), rep('lnRR',4), rep('SMD',4), rep('SMDH',4), rep('lnVR',2), rep('lnCVR',2)),
                                'Effect' = c('MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'MAOM', 'ESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP','MAOM', 'ESSP', 'MAOM', 'ESSP'),
                                'power' = c(E_power.F_RR, E_power.R_RR, E_power.F_adjusted_RR, E_power.R_adjusted_RR, E_power.F_lnrr, E_power.R_lnrr, E_power.F_adjusted_lnrr, E_power.R_adjusted_lnrr, E_power.F_SMD, E_power.R_SMD, E_power.F_adjusted_SMD, E_power.R_adjusted_SMD, E_power.F_SMDH, E_power.R_SMDH, E_power.F_adjusted_SMDH, E_power.R_adjusted_SMDH, E_power.F_VR, E_power.R_VR, E_power.F_CVR, E_power.R_CVR, O_power.F_RR, O_power.R_RR, O_power.F_adjusted_RR, O_power.R_adjusted_RR, O_power.F_lnrr, O_power.R_lnrr, O_power.F_adjusted_lnrr, O_power.R_adjusted_lnrr, O_power.F_SMD, O_power.R_SMD, O_power.F_adjusted_SMD, O_power.R_adjusted_SMD, O_power.F_SMDH, O_power.R_SMDH, O_power.F_adjusted_SMDH, O_power.R_adjusted_SMDH, O_power.F_CVR, O_power.R_CVR, O_power.F_VR, O_power.R_VR),
                           'll' = c(E_power.F_RR_ll, E_power.R_RR_ll, E_power.F_adjusted_RR_ll, E_power.R_adjusted_RR_ll, E_power.F_lnrr_ll, E_power.R_lnrr_ll, E_power.F_adjusted_lnrr_ll, E_power.R_adjusted_lnrr_ll, E_power.F_SMD_ll, E_power.R_SMD_ll, E_power.F_adjusted_SMD_ll, E_power.R_adjusted_SMD_ll, E_power.F_SMDH_ll, E_power.R_SMDH_ll, E_power.F_adjusted_SMDH_ll, E_power.R_adjusted_SMDH_ll, E_power.F_VR_ll, E_power.R_VR_ll, E_power.F_CVR_ll, E_power.R_CVR_ll, O_power.F_RR_ll, O_power.R_RR_ll, O_power.F_adjusted_RR_ll, O_power.R_adjusted_RR_ll, O_power.F_lnrr_ll, O_power.R_lnrr_ll, O_power.F_adjusted_lnrr_ll, O_power.R_adjusted_lnrr_ll, O_power.F_SMD_ll, O_power.R_SMD_ll, O_power.F_adjusted_SMD_ll, O_power.R_adjusted_SMD_ll, O_power.F_SMDH_ll, O_power.R_SMDH_ll, O_power.F_adjusted_SMDH_ll, O_power.R_adjusted_SMDH_ll, O_power.F_CVR_ll, O_power.R_CVR_ll, O_power.F_VR_ll, O_power.R_VR_ll),
                           'ul' = c(E_power.F_RR_ul, E_power.R_RR_ul, E_power.F_adjusted_RR_ul, E_power.R_adjusted_RR_ul, E_power.F_lnrr_ul, E_power.R_lnrr_ul, E_power.F_adjusted_lnrr_ul, E_power.R_adjusted_lnrr_ul, E_power.F_SMD_ul, E_power.R_SMD_ul, E_power.F_adjusted_SMD_ul, E_power.R_adjusted_SMD_ul, E_power.F_SMDH_ul, E_power.R_SMDH_ul, E_power.F_adjusted_SMDH_ul, E_power.R_adjusted_SMDH_ul, E_power.F_VR_ul, E_power.R_VR_ul, E_power.F_CVR_ul, E_power.R_CVR_ul, O_power.F_RR_ul, O_power.R_RR_ul, O_power.F_adjusted_RR_ul, O_power.R_adjusted_RR_ul, O_power.F_lnrr_ul, O_power.R_lnrr_ul, O_power.F_adjusted_lnrr_ul, O_power.R_adjusted_lnrr_ul, O_power.F_SMD_ul, O_power.R_SMD_ul, O_power.F_adjusted_SMD_ul, O_power.R_adjusted_SMD_ul, O_power.F_SMDH_ul, O_power.R_SMDH_ul, O_power.F_adjusted_SMDH_ul, O_power.R_adjusted_SMDH_ul, O_power.F_CVR_ul, O_power.R_CVR_ul, O_power.F_VR_ul, O_power.R_VR_ul),
                           'effect_type' = c(rep('Mean differences',16),rep('Variance differences',4),rep('Mean differences',16),rep('Variance differences',4)),
                           'Significance' = c(rep('p-value > 0.05',12),rep('p-value < 0.05',28)))


# convert moderator to factor with desired ordering of levels
forest_power$es <- factor(forest_power$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH", "lnCVR", "lnVR")))
forest_power$Effect <- factor(forest_power$Effect, levels = c("MAOM",  "ESSP", "cMAOM", "cESSP")) # or levels = rev(c())



ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_power %>% filter(Approach == 'Experimental'), aes(x = es, y = power, ymin = ll, ymax = ul, shape = Approach, colour = Significance), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_power %>% filter(Approach == 'Observational'), aes(x = es, y = power, ymin = ll, ymax = ul, shape = Approach, colour=Significance), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  facet_grid(cols = vars(Effect),rows = vars(effect_type) , scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(-0.01, 1.01)) + 
  labs(title = "(A)", x = "Effect size", y = "Overall statistical power [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_bw() +
  theme(#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.position = "top",
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) + 
    theme(plot.title = element_text(hjust = -0.08)) -> approach.P_RR

# scale_shape(forest_power$Significance,solid = TRUE)
# annotate(geom = "text", x = 1, y = 1, label = paste0("*"))


# p.approach_RR2<- ggarrange(p.approach_RR, p.approach_RR, p.approach_RR, heights = c(5,5,5), widths = c(5,5,5), nrow = 3, ncol = 1, align = "h")

png(filename = "./Figures/approach.P_RR.png", width = 8, height = 4, units = "in", type = "windows", res = 400)
approach.P_RR
dev.off() 

```




### forestplot data for Type S (median 95% CI)
```{r}
# lnRR*
E_power.F.S_RR <- (summary(MMA_power.F.S_RR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_RR <- (summary(MMA_power.F.S_RR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_RR <- confint(MMA_power.F.S_RR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.F.S_RR_ll <- CI_RR[4]
E_power.F.S_RR_ul <- CI_RR[9]
# O_power.F.S_RR_ll <- CI_RR[5] # boundary
O_power.F.S_RR_ll <- 0
O_power.F.S_RR_ul <- CI_RR[10]


E_power.R.S_RR <- (summary(MMA_power.R.S_RR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_RR <- (summary(MMA_power.R.S_RR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_RR <- confint(MMA_power.R.S_RR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_RR_ll <- CI_RR[4]
E_power.R.S_RR_ul <- CI_RR[9]
O_power.R.S_RR_ll <- CI_RR[5]
O_power.R.S_RR_ul <- CI_RR[10]



E_power.F.S_adjusted_RR <- (summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_adjusted_RR <- (summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_RR <- confint(MMA_power.F.S_adjusted_RR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.F.S_adjusted_RR_ll <- CI_adjusted_RR[4]
E_power.F.S_adjusted_RR_ul <- CI_adjusted_RR[9]
O_power.F.S_adjusted_RR_ll <- CI_adjusted_RR[5]
O_power.F.S_adjusted_RR_ul <- CI_adjusted_RR[10]


E_power.R.S_adjusted_RR <- (summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_adjusted_RR <- (summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_RR <- confint(MMA_power.R.S_adjusted_RR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_adjusted_RR_ll <- CI_adjusted_RR[4]
E_power.R.S_adjusted_RR_ul <- CI_adjusted_RR[9]
O_power.R.S_adjusted_RR_ll <- CI_adjusted_RR[5]
O_power.R.S_adjusted_RR_ul <- CI_adjusted_RR[10]

  
# lnrr
E_power.F.S_lnrr <- (summary(MMA_power.F.S_lnrr.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_lnrr <- (summary(MMA_power.F.S_lnrr.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_lnrr <- confint(MMA_power.F.S_lnrr.approach2) %>% exp() - 0.025 %>% round(3)
# E_power.F.S_lnrr_ll <- CI_lnrr[4] # negative values, so truncate at 0
E_power.F.S_lnrr_ll <- 0
E_power.F.S_lnrr_ul <- CI_lnrr[9]
# O_power.F.S_lnrr_ll <- CI_lnrr[5] # negative values, so truncate at 0 
O_power.F.S_lnrr_ll <- 0
O_power.F.S_lnrr_ul <- CI_lnrr[10]


E_power.R.S_lnrr <- (summary(MMA_power.R.S_lnrr.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_lnrr <- (summary(MMA_power.R.S_lnrr.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_lnrr <- confint(MMA_power.R.S_lnrr.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_lnrr_ll <- CI_lnrr[4]
E_power.R.S_lnrr_ul <- CI_lnrr[9]
O_power.R.S_lnrr_ll <- CI_lnrr[5]
O_power.R.S_lnrr_ul <- CI_lnrr[10]



E_power.F.S_adjusted_lnrr <- (summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_adjusted_lnrr <- (summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_lnrr <- confint(MMA_power.F.S_adjusted_lnrr.approach2) %>% exp() - 0.025 %>% round(3)
#E_power.F.S_adjusted_lnrr_ll <- CI_adjusted_lnrr[4] # negative values, so truncate at 0 
E_power.F.S_adjusted_lnrr_ll <- 0
E_power.F.S_adjusted_lnrr_ul <- CI_adjusted_lnrr[9] 
#O_power.F.S_adjusted_lnrr_ll <- CI_adjusted_lnrr[5] # negative values, so truncate at 0 
O_power.F.S_adjusted_lnrr_ll <- 0
O_power.F.S_adjusted_lnrr_ul <- CI_adjusted_lnrr[10] 



E_power.R.S_adjusted_lnrr <- (summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_adjusted_lnrr <- (summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_lnrr <- confint(MMA_power.R.S_adjusted_lnrr.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_adjusted_lnrr_ll <- CI_adjusted_lnrr[4]
E_power.R.S_adjusted_lnrr_ul <- CI_adjusted_lnrr[9]
O_power.R.S_adjusted_lnrr_ll <- CI_adjusted_lnrr[5]
O_power.R.S_adjusted_lnrr_ul <- CI_adjusted_lnrr[10]




# SMD
E_power.F.S_SMD <- (summary(MMA_power.F.S_SMD.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_SMD <- (summary(MMA_power.F.S_SMD.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_SMD <- confint(MMA_power.F.S_SMD.approach2) %>% exp() - 0.025 %>% round(3)
# E_power.F.S_SMD_ll <- CI_SMD[4] # negative values, so truncate at 0 
E_power.F.S_SMD_ll <- 0
E_power.F.S_SMD_ul <- CI_SMD[9] 
# O_power.F.S_SMD_ll <- CI_SMD[5] # negative values, so truncate at 0 
O_power.F.S_SMD_ll <- 0
O_power.F.S_SMD_ul <- CI_SMD[10] 



E_power.R.S_SMD <- (summary(MMA_power.R.S_SMD.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_SMD <- (summary(MMA_power.R.S_SMD.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_SMD <- confint(MMA_power.R.S_SMD.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_SMD_ll <- CI_SMD[4]
E_power.R.S_SMD_ul <- CI_SMD[9]
O_power.R.S_SMD_ll <- CI_SMD[5]
O_power.R.S_SMD_ul <- CI_SMD[10]



E_power.F.S_adjusted_SMD <- (summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_adjusted_SMD <- (summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_SMD <- confint(MMA_power.F.S_adjusted_SMD.approach2) %>% exp() - 0.025 %>% round(3)
# E_power.F.S_adjusted_SMD_ll <- CI_adjusted_SMD[4] # negative values, so truncate at 0 
E_power.F.S_adjusted_SMD_ll <- 0
E_power.F.S_adjusted_SMD_ul <- CI_adjusted_SMD[9]
# O_power.F.S_adjusted_SMD_ll <- CI_adjusted_SMD[5] # negative values, so truncate at 0 
O_power.F.S_adjusted_SMD_ll <- 0
O_power.F.S_adjusted_SMD_ul <- CI_adjusted_SMD[10] 


E_power.R.S_adjusted_SMD <- (summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_adjusted_SMD <- (summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_SMD <- confint(MMA_power.R.S_adjusted_SMD.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_adjusted_SMD_ll <- CI_adjusted_SMD[4]
E_power.R.S_adjusted_SMD_ul <- CI_adjusted_SMD[9]
O_power.R.S_adjusted_SMD_ll <- CI_adjusted_SMD[5]
O_power.R.S_adjusted_SMD_ul <- CI_adjusted_SMD[10]



# SMDH
E_power.F.S_SMDH <- (summary(MMA_power.F.S_SMDH.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_SMDH <- (summary(MMA_power.F.S_SMDH.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_SMDH <- confint(MMA_power.F.S_SMDH.approach2) %>% exp() - 0.025 %>% round(3)
# E_power.F.S_SMDH_ll <- CI_SMDH[4] # negative values, so truncate at 0 
E_power.F.S_SMDH_ll <- 0
E_power.F.S_SMDH_ul <- CI_SMDH[9] 
# O_power.F.S_SMDH_ll <- CI_SMDH[5] 
O_power.F.S_SMDH_ll <- 0
O_power.F.S_SMDH_ul <- CI_SMDH[10] 


E_power.R.S_SMDH <- (summary(MMA_power.R.S_SMDH.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_SMDH <- (summary(MMA_power.R.S_SMDH.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_SMDH <- confint(MMA_power.R.S_SMDH.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_SMDH_ll <- CI_SMDH[4]
E_power.R.S_SMDH_ul <- CI_SMDH[9]
# O_power.R.S_SMDH_ll <- CI_SMDH[5] 
O_power.R.S_SMDH_ll <- 0
O_power.R.S_SMDH_ul <- CI_SMDH[10]



E_power.F.S_adjusted_SMDH <- (summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_adjusted_SMDH <- (summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_SMDH <- confint(MMA_power.F.S_adjusted_SMDH.approach2) %>% exp() - 0.025 %>% round(3)
# E_power.F.S_adjusted_SMDH_ll <- CI_adjusted_SMDH[4]  # negative values, so truncate at 0
E_power.F.S_adjusted_SMDH_ll <- 0
E_power.F.S_adjusted_SMDH_ul <- CI_adjusted_SMDH[9]
#O_power.F.S_adjusted_SMDH_ll <- CI_adjusted_SMDH[5]
O_power.F.S_adjusted_SMDH_ll <- 0
O_power.F.S_adjusted_SMDH_ul <- CI_adjusted_SMDH[10]


E_power.R.S_adjusted_SMDH <- (summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_adjusted_SMDH <- (summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_adjusted_SMDH <- confint(MMA_power.R.S_adjusted_SMDH.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_adjusted_SMDH_ll <- CI_adjusted_SMDH[4]
E_power.R.S_adjusted_SMDH_ul <- CI_adjusted_SMDH[9]
O_power.R.S_adjusted_SMDH_ll <- CI_adjusted_SMDH[5]
O_power.R.S_adjusted_SMDH_ul <- CI_adjusted_SMDH[10]



# lnCVR
E_power.F.S_CVR <- (summary(MMA_power.F.S_CVR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_CVR <- (summary(MMA_power.F.S_CVR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_CVR <- confint(MMA_power.F.S_CVR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.F.S_CVR_ll <- CI_CVR[4]
E_power.F.S_CVR_ul <- CI_CVR[9]
O_power.F.S_CVR_ll <- CI_CVR[5]
#O_power.F.S_CVR_ul <- CI_CVR[10] 1.036941 larger than 1, so truncate at 1
O_power.F.S_CVR_ul <- 1


E_power.R.S_CVR <- (summary(MMA_power.R.S_CVR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_CVR <- (summary(MMA_power.R.S_CVR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_CVR <- confint(MMA_power.R.S_CVR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_CVR_ll <- CI_CVR[4]
E_power.R.S_CVR_ul <- CI_CVR[9]
O_power.R.S_CVR_ll <- CI_CVR[5]
O_power.R.S_CVR_ul <- CI_CVR[10]



# lnVR
E_power.F.S_VR <- (summary(MMA_power.F.S_VR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)

O_power.F.S_VR <- (summary(MMA_power.F.S_VR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_VR <- confint(MMA_power.F.S_VR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.F.S_VR_ll <- CI_VR[4]
E_power.F.S_VR_ul <- CI_VR[9]
# O_power.F.S_VR_ll <- CI_VR[5]
O_power.F.S_VR_ll <- 0
O_power.F.S_VR_ul <- CI_VR[10]


E_power.R.S_VR <- (summary(MMA_power.R.S_VR.approach2)$coefficients[1]) %>% exp() - 0.025 %>% round(3)
  
O_power.R.S_VR <- (summary(MMA_power.R.S_VR.approach2)$coefficients[2]) %>% exp() - 0.025 %>% round(3)

CI_VR <- confint(MMA_power.R.S_VR.approach2) %>% exp() - 0.025 %>% round(3)
E_power.R.S_VR_ll <- CI_VR[4]
E_power.R.S_VR_ul <- CI_VR[9]
# O_power.R.S_VR_ll <- CI_VR[5]
O_power.R.S_VR_ll <- 0
O_power.R.S_VR_ul <- CI_VR[10]




forest_TypeS <- data.frame('Approach' = c(rep('Experimental', 20), rep('Observational', 20)),
                                'es' = c(rep('lnRR*',4), rep('lnRR',4), rep('SMD',4), rep('SMDH',4), rep('lnVR',2), rep('lnCVR',2),rep('lnRR*',4), rep('lnRR',4), rep('SMD',4), rep('SMDH',4), rep('lnCVR',2), rep('lnVR',2)),
                                'Effect' = c('MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'MAOM', 'ESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP','MAOM', 'ESSP', 'MAOM', 'ESSP'),
                                'TypeS' = c(E_power.F.S_RR, E_power.R.S_RR, E_power.F.S_adjusted_RR, E_power.R.S_adjusted_RR, E_power.F.S_lnrr, E_power.R.S_lnrr, E_power.F.S_adjusted_lnrr, E_power.R.S_adjusted_lnrr, E_power.F.S_SMD, E_power.R.S_SMD, E_power.F.S_adjusted_SMD, E_power.R.S_adjusted_SMD, E_power.F.S_SMDH, E_power.R.S_SMDH, E_power.F.S_adjusted_SMDH, E_power.R.S_adjusted_SMDH, E_power.F.S_VR, E_power.R.S_VR, E_power.F.S_CVR, E_power.R.S_CVR, O_power.F.S_RR, O_power.R.S_RR, O_power.F.S_adjusted_RR, O_power.R.S_adjusted_RR, O_power.F.S_lnrr, O_power.R.S_lnrr, O_power.F.S_adjusted_lnrr, O_power.R.S_adjusted_lnrr, O_power.F.S_SMD, O_power.R.S_SMD, O_power.F.S_adjusted_SMD, O_power.R.S_adjusted_SMD, O_power.F.S_SMDH, O_power.R.S_SMDH, O_power.F.S_adjusted_SMDH, O_power.R.S_adjusted_SMDH, O_power.F.S_CVR, O_power.R.S_CVR, O_power.F.S_VR, O_power.R.S_VR),
                           'll' = c(E_power.F.S_RR_ll, E_power.R.S_RR_ll, E_power.F.S_adjusted_RR_ll, E_power.R.S_adjusted_RR_ll, E_power.F.S_lnrr_ll, E_power.R.S_lnrr_ll, E_power.F.S_adjusted_lnrr_ll, E_power.R.S_adjusted_lnrr_ll, E_power.F.S_SMD_ll, E_power.R.S_SMD_ll, E_power.F.S_adjusted_SMD_ll, E_power.R.S_adjusted_SMD_ll, E_power.F.S_SMDH_ll, E_power.R.S_SMDH_ll, E_power.F.S_adjusted_SMDH_ll, E_power.R.S_adjusted_SMDH_ll, E_power.F.S_VR_ll, E_power.R.S_VR_ll, E_power.F.S_CVR_ll, E_power.R.S_CVR_ll, O_power.F.S_RR_ll, O_power.R.S_RR_ll, O_power.F.S_adjusted_RR_ll, O_power.R.S_adjusted_RR_ll, O_power.F.S_lnrr_ll, O_power.R.S_lnrr_ll, O_power.F.S_adjusted_lnrr_ll, O_power.R.S_adjusted_lnrr_ll, O_power.F.S_SMD_ll, O_power.R.S_SMD_ll, O_power.F.S_adjusted_SMD_ll, O_power.R.S_adjusted_SMD_ll, O_power.F.S_SMDH_ll, O_power.R.S_SMDH_ll, O_power.F.S_adjusted_SMDH_ll, O_power.R.S_adjusted_SMDH_ll, O_power.F.S_CVR_ll, O_power.R.S_CVR_ll, O_power.F.S_VR_ll, O_power.R.S_VR_ll),
                           'ul' = c(E_power.F.S_RR_ul, E_power.R.S_RR_ul, E_power.F.S_adjusted_RR_ul, E_power.R.S_adjusted_RR_ul, E_power.F.S_lnrr_ul, E_power.R.S_lnrr_ul, E_power.F.S_adjusted_lnrr_ul, E_power.R.S_adjusted_lnrr_ul, E_power.F.S_SMD_ul, E_power.R.S_SMD_ul, E_power.F.S_adjusted_SMD_ul, E_power.R.S_adjusted_SMD_ul, E_power.F.S_SMDH_ul, E_power.R.S_SMDH_ul, E_power.F.S_adjusted_SMDH_ul, E_power.R.S_adjusted_SMDH_ul, E_power.F.S_VR_ul, E_power.R.S_VR_ul, E_power.F.S_CVR_ul, E_power.R.S_CVR_ul, O_power.F.S_RR_ul, O_power.R.S_RR_ul, O_power.F.S_adjusted_RR_ul, O_power.R.S_adjusted_RR_ul, O_power.F.S_lnrr_ul, O_power.R.S_lnrr_ul, O_power.F.S_adjusted_lnrr_ul, O_power.R.S_adjusted_lnrr_ul, O_power.F.S_SMD_ul, O_power.R.S_SMD_ul, O_power.F.S_adjusted_SMD_ul, O_power.R.S_adjusted_SMD_ul, O_power.F.S_SMDH_ul, O_power.R.S_SMDH_ul, O_power.F.S_adjusted_SMDH_ul, O_power.R.S_adjusted_SMDH_ul, O_power.F.S_CVR_ul, O_power.R.S_CVR_ul, O_power.F.S_VR_ul, O_power.R.S_VR_ul),
                           'effect_type' = c(rep('Mean differences',16),rep('Variance differences',4),rep('Mean differences',16),rep('Variance differences',4)),
                           'Significance' = c(rep('> 0.05',12),rep('< 0.05',28)))


# convert moderator to factor with desired ordering of levels
forest_TypeS$es <- factor(forest_power$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH", "lnCVR", "lnVR")))
forest_TypeS$Effect <- factor(forest_power$Effect, levels = c("MAOM",  "ESSP", "cMAOM", "cESSP")) # or levels = rev(c())



ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeS %>% filter(Approach == 'Experimental'), aes(x = es, y = TypeS, ymin = ll, ymax = ul, shape = Approach, colour = Significance), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeS %>% filter(Approach == 'Observational'), aes(x = es, y = TypeS, ymin = ll, ymax = ul, shape = Approach, colour=Significance), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  facet_grid(cols = vars(Effect),rows = vars(effect_type) , scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(-0.01, 1.01)) + 
  labs(title = "(C)", x = "Effect size", y = "Overall Type S error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_bw() +
  theme(#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.position = "none",
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) +
  theme(plot.title = element_text(hjust = -0.08)) -> approach.S_RR


# S.approach_RR2<- ggarrange(p.approach_RR, p.approach_RR, p.approach_RR, heights = c(5,5,5), widths = c(5,5,5), nrow = 3, ncol = 1, align = "h")

png(filename = "./Figures/approach.S_RR.png", width = 8, height = 4, units = "in", type = "windows", res = 400)
approach.S_RR
dev.off() 

```



### forestplot data for Type M (median 95% CI)
```{r}
# lnRR*
E_power.F.M_RR <- (summary(MMA_power.F.M_RR.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_RR <- (summary(MMA_power.F.M_RR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_RR <- confint(MMA_power.F.M_RR.approach2) %>% exp()  %>% round(3)
E_power.F.M_RR_ll <- CI_RR[4]
E_power.F.M_RR_ul <- CI_RR[9]
O_power.F.M_RR_ll <- CI_RR[5]
O_power.F.M_RR_ul <- CI_RR[10]


E_power.R.M_RR <- (summary(MMA_power.R.M_RR.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_RR <- (summary(MMA_power.R.M_RR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_RR <- confint(MMA_power.R.M_RR.approach2) %>% exp()  %>% round(3)
E_power.R.M_RR_ll <- CI_RR[4]
E_power.R.M_RR_ul <- CI_RR[9]
O_power.R.M_RR_ll <- CI_RR[5]
O_power.R.M_RR_ul <- CI_RR[10]



E_power.F.M_adjusted_RR <- (summary(MMA_power.F.M_adjusted_RR.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_adjusted_RR <- (summary(MMA_power.F.M_adjusted_RR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_RR <- confint(MMA_power.F.M_adjusted_RR.approach2) %>% exp()  %>% round(3)
E_power.F.M_adjusted_RR_ll <- CI_adjusted_RR[4]
E_power.F.M_adjusted_RR_ul <- CI_adjusted_RR[9]
O_power.F.M_adjusted_RR_ll <- CI_adjusted_RR[5]
O_power.F.M_adjusted_RR_ul <- CI_adjusted_RR[10]


E_power.R.M_adjusted_RR <- (summary(MMA_power.R.M_adjusted_RR.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_adjusted_RR <- (summary(MMA_power.R.M_adjusted_RR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_RR <- confint(MMA_power.R.M_adjusted_RR.approach2) %>% exp()  %>% round(3)
E_power.R.M_adjusted_RR_ll <- CI_adjusted_RR[4]
E_power.R.M_adjusted_RR_ul <- CI_adjusted_RR[9]
O_power.R.M_adjusted_RR_ll <- CI_adjusted_RR[5]
O_power.R.M_adjusted_RR_ul <- CI_adjusted_RR[10]

  
# lnrr
E_power.F.M_lnrr <- (summary(MMA_power.F.M_lnrr.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_lnrr <- (summary(MMA_power.F.M_lnrr.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_lnrr <- confint(MMA_power.F.M_lnrr.approach2) %>% exp()  %>% round(3)
E_power.F.M_lnrr_ll <- CI_lnrr[4]
E_power.F.M_lnrr_ul <- CI_lnrr[9]
O_power.F.M_lnrr_ll <- CI_lnrr[5] 
O_power.F.M_lnrr_ul <- CI_lnrr[10]


E_power.R.M_lnrr <- (summary(MMA_power.R.M_lnrr.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_lnrr <- (summary(MMA_power.R.M_lnrr.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_lnrr <- confint(MMA_power.R.M_lnrr.approach2) %>% exp()  %>% round(3)
E_power.R.M_lnrr_ll <- CI_lnrr[4]
E_power.R.M_lnrr_ul <- CI_lnrr[9]
O_power.R.M_lnrr_ll <- CI_lnrr[5]
O_power.R.M_lnrr_ul <- CI_lnrr[10]



E_power.F.M_adjusted_lnrr <- (summary(MMA_power.F.M_adjusted_lnrr.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_adjusted_lnrr <- (summary(MMA_power.F.M_adjusted_lnrr.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_lnrr <- confint(MMA_power.F.M_adjusted_lnrr.approach2) %>% exp()  %>% round(3)
E_power.F.M_adjusted_lnrr_ll <- CI_adjusted_lnrr[4] 
E_power.F.M_adjusted_lnrr_ul <- CI_adjusted_lnrr[9] 
O_power.F.M_adjusted_lnrr_ll <- CI_adjusted_lnrr[5] 
O_power.F.M_adjusted_lnrr_ul <- CI_adjusted_lnrr[10] 



E_power.R.M_adjusted_lnrr <- (summary(MMA_power.R.M_adjusted_lnrr.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_adjusted_lnrr <- (summary(MMA_power.R.M_adjusted_lnrr.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_lnrr <- confint(MMA_power.R.M_adjusted_lnrr.approach2) %>% exp()  %>% round(3)
E_power.R.M_adjusted_lnrr_ll <- CI_adjusted_lnrr[4]
E_power.R.M_adjusted_lnrr_ul <- CI_adjusted_lnrr[9]
O_power.R.M_adjusted_lnrr_ll <- CI_adjusted_lnrr[5]
O_power.R.M_adjusted_lnrr_ul <- CI_adjusted_lnrr[10]




# SMD
E_power.F.M_SMD <- (summary(MMA_power.F.M_SMD.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_SMD <- (summary(MMA_power.F.M_SMD.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_SMD <- confint(MMA_power.F.M_SMD.approach2) %>% exp()  %>% round(3)
E_power.F.M_SMD_ll <- CI_SMD[4] 
E_power.F.M_SMD_ul <- CI_SMD[9] 
O_power.F.M_SMD_ll <- CI_SMD[5] 
O_power.F.M_SMD_ul <- CI_SMD[10] 



E_power.R.M_SMD <- (summary(MMA_power.R.M_SMD.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_SMD <- (summary(MMA_power.R.M_SMD.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_SMD <- confint(MMA_power.R.M_SMD.approach2) %>% exp()  %>% round(3)
E_power.R.M_SMD_ll <- CI_SMD[4]
E_power.R.M_SMD_ul <- CI_SMD[9]
O_power.R.M_SMD_ll <- CI_SMD[5]
O_power.R.M_SMD_ul <- CI_SMD[10]



E_power.F.M_adjusted_SMD <- (summary(MMA_power.F.M_adjusted_SMD.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_adjusted_SMD <- (summary(MMA_power.F.M_adjusted_SMD.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_SMD <- confint(MMA_power.F.M_adjusted_SMD.approach2) %>% exp()  %>% round(3)
E_power.F.M_adjusted_SMD_ll <- CI_adjusted_SMD[4] 
E_power.F.M_adjusted_SMD_ul <- CI_adjusted_SMD[9] 
O_power.F.M_adjusted_SMD_ll <- CI_adjusted_SMD[5]
O_power.F.M_adjusted_SMD_ul <- CI_adjusted_SMD[10] 


E_power.R.M_adjusted_SMD <- (summary(MMA_power.R.M_adjusted_SMD.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_adjusted_SMD <- (summary(MMA_power.R.M_adjusted_SMD.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_SMD <- confint(MMA_power.R.M_adjusted_SMD.approach2) %>% exp()  %>% round(3)
E_power.R.M_adjusted_SMD_ll <- CI_adjusted_SMD[4]
E_power.R.M_adjusted_SMD_ul <- CI_adjusted_SMD[9]
O_power.R.M_adjusted_SMD_ll <- CI_adjusted_SMD[5]
O_power.R.M_adjusted_SMD_ul <- CI_adjusted_SMD[10]



# SMDH
E_power.F.M_SMDH <- (summary(MMA_power.F.M_SMDH.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_SMDH <- (summary(MMA_power.F.M_SMDH.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_SMDH <- confint(MMA_power.F.M_SMDH.approach2) %>% exp()  %>% round(3)
E_power.F.M_SMDH_ll <- CI_SMDH[4] 
E_power.F.M_SMDH_ul <- CI_SMDH[9] 
O_power.F.M_SMDH_ll <- CI_SMDH[5]  
O_power.F.M_SMDH_ul <- CI_SMDH[10] 


E_power.R.M_SMDH <- (summary(MMA_power.R.M_SMDH.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_SMDH <- (summary(MMA_power.R.M_SMDH.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_SMDH <- confint(MMA_power.R.M_SMDH.approach2) %>% exp()  %>% round(3)
E_power.R.M_SMDH_ll <- CI_SMDH[4]
E_power.R.M_SMDH_ul <- CI_SMDH[9]
O_power.R.M_SMDH_ll <- CI_SMDH[5] 
O_power.R.M_SMDH_ul <- CI_SMDH[10]



E_power.F.M_adjusted_SMDH <- (summary(MMA_power.F.M_adjusted_SMDH.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_adjusted_SMDH <- (summary(MMA_power.F.M_adjusted_SMDH.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_SMDH <- confint(MMA_power.F.M_adjusted_SMDH.approach2) %>% exp()  %>% round(3)
E_power.F.M_adjusted_SMDH_ll <- CI_adjusted_SMDH[4]  
E_power.F.M_adjusted_SMDH_ul <- CI_adjusted_SMDH[9]
O_power.F.M_adjusted_SMDH_ll <- CI_adjusted_SMDH[5]
O_power.F.M_adjusted_SMDH_ul <- CI_adjusted_SMDH[10]


E_power.R.M_adjusted_SMDH <- (summary(MMA_power.R.M_adjusted_SMDH.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_adjusted_SMDH <- (summary(MMA_power.R.M_adjusted_SMDH.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_adjusted_SMDH <- confint(MMA_power.R.M_adjusted_SMDH.approach2) %>% exp()  %>% round(3)
E_power.R.M_adjusted_SMDH_ll <- CI_adjusted_SMDH[4]
E_power.R.M_adjusted_SMDH_ul <- CI_adjusted_SMDH[9]
O_power.R.M_adjusted_SMDH_ll <- CI_adjusted_SMDH[5]
O_power.R.M_adjusted_SMDH_ul <- CI_adjusted_SMDH[10]



# lnCVR
E_power.F.M_CVR <- (summary(MMA_power.F.M_CVR.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_CVR <- (summary(MMA_power.F.M_CVR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_CVR <- confint(MMA_power.F.M_CVR.approach2) %>% exp()  %>% round(3)
E_power.F.M_CVR_ll <- CI_CVR[4]
E_power.F.M_CVR_ul <- CI_CVR[9]
O_power.F.M_CVR_ll <- CI_CVR[5]
O_power.F.M_CVR_ul <- CI_CVR[10] 


E_power.R.M_CVR <- (summary(MMA_power.R.M_CVR.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_CVR <- (summary(MMA_power.R.M_CVR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_CVR <- confint(MMA_power.R.M_CVR.approach2) %>% exp()  %>% round(3)
E_power.R.M_CVR_ll <- CI_CVR[4]
E_power.R.M_CVR_ul <- CI_CVR[9]
O_power.R.M_CVR_ll <- CI_CVR[5]
O_power.R.M_CVR_ul <- CI_CVR[10]



# lnVR
E_power.F.M_VR <- (summary(MMA_power.F.M_VR.approach2)$coefficients[1]) %>% exp()  %>% round(3)

O_power.F.M_VR <- (summary(MMA_power.F.M_VR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_VR <- confint(MMA_power.F.M_VR.approach2) %>% exp()  %>% round(3)
E_power.F.M_VR_ll <- CI_VR[4]
E_power.F.M_VR_ul <- CI_VR[9]
O_power.F.M_VR_ll <- CI_VR[5]
O_power.F.M_VR_ul <- CI_VR[10]


E_power.R.M_VR <- (summary(MMA_power.R.M_VR.approach2)$coefficients[1]) %>% exp()  %>% round(3)
  
O_power.R.M_VR <- (summary(MMA_power.R.M_VR.approach2)$coefficients[2]) %>% exp()  %>% round(3)

CI_VR <- confint(MMA_power.R.M_VR.approach2) %>% exp()  %>% round(3)
E_power.R.M_VR_ll <- CI_VR[4]
E_power.R.M_VR_ul <- CI_VR[9]
O_power.R.M_VR_ll <- CI_VR[5]
O_power.R.M_VR_ul <- CI_VR[10]




forest_TypeM <- data.frame('Approach' = c(rep('Experimental', 20), rep('Observational', 20)),
                                'es' = c(rep('lnRR*',4), rep('lnRR',4), rep('SMD',4), rep('SMDH',4), rep('lnVR',2), rep('lnCVR',2),rep('lnRR*',4), rep('lnRR',4), rep('SMD',4), rep('SMDH',4), rep('lnCVR',2), rep('lnVR',2)),
                                'Effect' = c('MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'MAOM', 'ESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP', 'MAOM', 'ESSP', 'cMAOM', 'cESSP','MAOM', 'ESSP', 'MAOM', 'ESSP'),
                                'TypeM' = c(E_power.F.M_RR, E_power.R.M_RR, E_power.F.M_adjusted_RR, E_power.R.M_adjusted_RR, E_power.F.M_lnrr, E_power.R.M_lnrr, E_power.F.M_adjusted_lnrr, E_power.R.M_adjusted_lnrr, E_power.F.M_SMD, E_power.R.M_SMD, E_power.F.M_adjusted_SMD, E_power.R.M_adjusted_SMD, E_power.F.M_SMDH, E_power.R.M_SMDH, E_power.F.M_adjusted_SMDH, E_power.R.M_adjusted_SMDH, E_power.F.M_VR, E_power.R.M_VR, E_power.F.M_CVR, E_power.R.M_CVR, O_power.F.M_RR, O_power.R.M_RR, O_power.F.M_adjusted_RR, O_power.R.M_adjusted_RR, O_power.F.M_lnrr, O_power.R.M_lnrr, O_power.F.M_adjusted_lnrr, O_power.R.M_adjusted_lnrr, O_power.F.M_SMD, O_power.R.M_SMD, O_power.F.M_adjusted_SMD, O_power.R.M_adjusted_SMD, O_power.F.M_SMDH, O_power.R.M_SMDH, O_power.F.M_adjusted_SMDH, O_power.R.M_adjusted_SMDH, O_power.F.M_CVR, O_power.R.M_CVR, O_power.F.M_VR, O_power.R.M_VR),
                           'll' = c(E_power.F.M_RR_ll, E_power.R.M_RR_ll, E_power.F.M_adjusted_RR_ll, E_power.R.M_adjusted_RR_ll, E_power.F.M_lnrr_ll, E_power.R.M_lnrr_ll, E_power.F.M_adjusted_lnrr_ll, E_power.R.M_adjusted_lnrr_ll, E_power.F.M_SMD_ll, E_power.R.M_SMD_ll, E_power.F.M_adjusted_SMD_ll, E_power.R.M_adjusted_SMD_ll, E_power.F.M_SMDH_ll, E_power.R.M_SMDH_ll, E_power.F.M_adjusted_SMDH_ll, E_power.R.M_adjusted_SMDH_ll, E_power.F.M_VR_ll, E_power.R.M_VR_ll, E_power.F.M_CVR_ll, E_power.R.M_CVR_ll, O_power.F.M_RR_ll, O_power.R.M_RR_ll, O_power.F.M_adjusted_RR_ll, O_power.R.M_adjusted_RR_ll, O_power.F.M_lnrr_ll, O_power.R.M_lnrr_ll, O_power.F.M_adjusted_lnrr_ll, O_power.R.M_adjusted_lnrr_ll, O_power.F.M_SMD_ll, O_power.R.M_SMD_ll, O_power.F.M_adjusted_SMD_ll, O_power.R.M_adjusted_SMD_ll, O_power.F.M_SMDH_ll, O_power.R.M_SMDH_ll, O_power.F.M_adjusted_SMDH_ll, O_power.R.M_adjusted_SMDH_ll, O_power.F.M_CVR_ll, O_power.R.M_CVR_ll, O_power.F.M_VR_ll, O_power.R.M_VR_ll),
                           'ul' = c(E_power.F.M_RR_ul, E_power.R.M_RR_ul, E_power.F.M_adjusted_RR_ul, E_power.R.M_adjusted_RR_ul, E_power.F.M_lnrr_ul, E_power.R.M_lnrr_ul, E_power.F.M_adjusted_lnrr_ul, E_power.R.M_adjusted_lnrr_ul, E_power.F.M_SMD_ul, E_power.R.M_SMD_ul, E_power.F.M_adjusted_SMD_ul, E_power.R.M_adjusted_SMD_ul, E_power.F.M_SMDH_ul, E_power.R.M_SMDH_ul, E_power.F.M_adjusted_SMDH_ul, E_power.R.M_adjusted_SMDH_ul, E_power.F.M_VR_ul, E_power.R.M_VR_ul, E_power.F.M_CVR_ul, E_power.R.M_CVR_ul, O_power.F.M_RR_ul, O_power.R.M_RR_ul, O_power.F.M_adjusted_RR_ul, O_power.R.M_adjusted_RR_ul, O_power.F.M_lnrr_ul, O_power.R.M_lnrr_ul, O_power.F.M_adjusted_lnrr_ul, O_power.R.M_adjusted_lnrr_ul, O_power.F.M_SMD_ul, O_power.R.M_SMD_ul, O_power.F.M_adjusted_SMD_ul, O_power.R.M_adjusted_SMD_ul, O_power.F.M_SMDH_ul, O_power.R.M_SMDH_ul, O_power.F.M_adjusted_SMDH_ul, O_power.R.M_adjusted_SMDH_ul, O_power.F.M_CVR_ul, O_power.R.M_CVR_ul, O_power.F.M_VR_ul, O_power.R.M_VR_ul),
                           'effect_type' = c(rep('Mean differences',16),rep('Variance differences',4),rep('Mean differences',16),rep('Variance differences',4)),
                           'Significance' = c(rep('> 0.05',12),rep('< 0.05',28)))


# convert moderator to factor with desired ordering of levels
forest_TypeM$es <- factor(forest_power$es, levels=rev(c("lnRR*","lnRR", "SMD", "SMDH", "lnCVR", "lnVR")))
forest_TypeM$Effect <- factor(forest_power$Effect, levels = c("MAOM",  "ESSP", "cMAOM", "cESSP")) # or levels = rev(c())



ggplot() +
      #geom_hline(yintercept = 0, lty="dashed",lwd=0.5, colour="black",alpha = 0.5) +
      geom_pointrange(data = forest_TypeM %>% filter(Approach == 'Experimental'), aes(x = es, y = TypeM, ymin = ll, ymax = ul, shape = Approach, colour = Significance), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = 0.15)) +
  geom_pointrange(data = forest_TypeM %>% filter(Approach == 'Observational'), aes(x = es, y = TypeM, ymin = ll, ymax = ul, shape = Approach, colour=Significance), size = 0.3, show.legend = T, fatten = 7, position = position_nudge(x = -0.15)) +
  facet_grid(cols = vars(Effect),rows = vars(effect_type) , scale = 'free', space = "free_x") +
  scale_y_continuous(limits = c(-0.01, 36)) + 
  labs(title = "(B)", x = "Effect size", y = "Overall Type M error [median \u00B1 95% CI]") +
  coord_flip() + 
  theme_bw() +
  theme(#legend.position = c(0.95, 0.1), legend.justification = c(0.95, 0.1),
           legend.position = "none",
           legend.text = element_text(size=10),
           legend.title = element_text(size=10),
           legend.direction = "horizontal",
           legend.background = element_rect(fill = NA)) + 
           guides(colour = guide_legend(order = 2),shape = guide_legend(order = 1)) +
  theme(plot.title = element_text(hjust = -0.08)) -> approach.M_RR


# S.approach_RR2<- ggarrange(p.approach_RR, p.approach_RR, p.approach_RR, heights = c(5,5,5), widths = c(5,5,5), nrow = 3, ncol = 1, align = "h")

png(filename = "./Figures/approach.M_RR.png", width = 8, height = 4, units = "in", type = "windows", res = 400)
approach.M_RR
dev.off() 







approach_RR_plot <- ggarrange(approach.P_RR, approach.M_RR, approach.S_RR, heights = c(5.8,5,5), widths = c(5,5,5), nrow = 3, ncol = 1, align = "v")

png(filename = "./Figures/approach_RR_plot.png", width = 8, height = 12.5, units = "in", type = "windows", res = 400)
approach_RR_plot
dev.off() 


```





### ballonplot for mean estimate
```{r}
# Computationally, FPRP (false-positive report probability) is the number of statistically significant false positive findings divided by the total number of statistically significant findings. TRP is the number of statistically significant true positive findings divided by the total number of statistically significant findings.

FPRP <- function(power, pi, alpha = 0.05) {
  sig.FPRP <- alpha * (1- pi) # the number of statistically significant false positive findings
  sig.PRRP <- power * pi  # the number of statistically significant true positive findings
  FPRP <- sig.FPRP / (sig.FPRP + sig.PRRP)
  return(FPRP)
  }

FPRP(individual_est_RR$power.F_RR, 0.25) %>% summary()

FPRP(power=0.233, pi=0.25)

sig.FPRP <- 0.05*(1-0.5)
sig.PRRP <- 0.233*0.5
sig <- sig.FPRP + sig.PRRP
sig.FPRP/sig

FPRP(power=0.064, pi=0.25)

FPRP_individual_power <- data.frame("effect_size" = rep(c("lnRR*", "lnRR", "SMD", "SMDH", "lnVR", "lnCVR"),4), 
           "true_effect" = rep(c("cMAOM",  # lnRR*
                             "cMAOM",  # lnRR
                             "cMAOM",  # SMD
                             "cMAOM",  # SMDH
                             "MAOM",   # lnVR
                             "MAOM"    # lnCVR
                             ),4), 
           "median_power" = rep(c(MMA_power.F_adjusted_RR2_estimate$Estimate,
                        MMA_power.F_adjusted_lnrr2_estimate$Estimate,
                        MMA_power.F_adjusted_SMD2_estimate$Estimate,
                        MMA_power.F_adjusted_SMDH2_estimate$Estimate,
                        MMA_power.F_VR2_estimate$Estimate,
                        MMA_power.F_CVR2_estimate$Estimate
                        ),4),
           "prior" = c(c(rep(0.01,6)),
                       #c(rep(0.1,6)),
                       c(rep(0.25,6)),
                       c(rep(0.50,6)),
                       c(rep(0.75,6))),
           "effect_type" = rep(c("Mean difference", "Mean difference","Mean difference","Mean difference","Variance difference","Variance difference"),4),
           "data_level" =  rep("Individual effect-size", 24)
           )




FPRP_MA_power <- data.frame("effect_size" = rep(c("lnRR*", "lnRR", "SMD", "SMDH", "lnVR", "lnCVR"),4), 
           "true_effect" = rep(c("cMAOM",  # lnRR*
                             "cMAOM",  # lnRR
                             "cMAOM",  # SMD
                             "cMAOM",  # SMDH
                             "MAOM",   # lnVR
                             "MAOM"    # lnCVR
                             ),4), 
           "median_power" = rep(c(MMA_MA_adjusted_RR2_estimate$Estimate,
                        MMA_MA_adjusted_lnrr2_estimate$Estimate,
                        MMA_MA_adjusted_SMD2_estimate$Estimate,
                        MMA_MA_adjusted_SMDH2_estimate$Estimate,
                        MMA_MA_VR2_estimate$Estimate,
                        MMA_MA_VR2_estimate$Estimate
                        ),4),
           "prior" = c(c(rep(0.01,6)),
                       #c(rep(0.1,6)),
                       c(rep(0.25,6)),
                       c(rep(0.50,6)),
                       c(rep(0.75,6))),
           "effect_type" = rep(c("Mean difference", "Mean difference","Mean difference","Mean difference","Variance difference","Variance difference"),4),
           "data_level" =  rep("Meta-analysis", 24)
           )


FPRP_power <- rbind(FPRP_individual_power, FPRP_MA_power)


# convert moderator to factor with desired ordering of levels
FPRP_individual_power$effect_size <- factor(FPRP_individual_power$effect_size, levels=rev(c("lnRR*", "lnRR","SMD", "SMDH", "lnVR", "lnCVR")))

FPRP_individual_power$FPRP <- FPRP(FPRP_individual_power$median_power, FPRP_individual_power$prior)




FPRP_power$effect_size <- factor(FPRP_power$effect_size, levels=rev(c("lnRR*", "lnRR","SMD", "SMDH", "lnVR", "lnCVR")))

FPRP_power$FPRP <- FPRP(FPRP_power$median_power, FPRP_power$prior)



# library(ggpubr)
FPRP_power_plot <- ggpubr::ggballoonplot(FPRP_power, x = "prior", y = "effect_size", size = "FPRP",    ggtheme = theme_bw(),
                                 fill = "FPRP",
                                 #fill = c("#009E73"),
                                 rotate.x.text = FALSE,
                                 size.range = c(1, 10),
                                 # show.label = TRUE
                                 facet.by = c("data_level"),
                                 xlab = TRUE, ylab = TRUE
                                 ) +
  guides(size = FALSE) +
  gradient_fill(c("blue", "white", "red")) +
  # scale_fill_manual(values = c("#009E73", "#CC79A7"), aesthetics = "fill") +
  scale_x_continuous(limits = c(0, 0.75),
                     breaks = c(0.01, 0.25, 0.50, 0.75),
                     labels = c('0.01', '0.25 \n 25% true H1', '0.50 \n 50% true H1', '0.75')) 



png(filename =  "Figures/FPRP_power_plot.png", height = 5, width = 8, units = "in", type = "windows", res = 400)
FPRP_power_plot
dev.off()












# power
# lnRR*
E_power.F_RR <- (summary(MMA_power.F_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F_RR ))) %>% exp() %>% round(3)
  
O_power.F_RR <- (summary(MMA_power.F_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.F_RR ))) %>% exp() %>% round(3)

E_power.R_RR <- (summary(MMA_power.R_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.R_RR ))) %>% exp() %>% round(3)
  
O_power.R_RR <- (summary(MMA_power.R_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.R_RR ))) %>% exp() %>% round(3)

E_power.F_adjusted_RR <-  (summary(MMA_power.F_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.F_adjusted_RR ))) %>% exp() %>% round(3)

O_power.F_adjusted_RR <- (summary(MMA_power.F_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.F_adjusted_RR ))) %>% exp() %>% round(3)
  
E_power.R_adjusted_RR <-  (summary(MMA_power.R_adjusted_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_RR$power.R_adjusted_RR ))) %>% exp() %>% round(3)

O_power.R_adjusted_RR <- (summary(MMA_power.R_adjusted_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_RR$power.R_adjusted_RR ))) %>% exp() %>% round(3)
  
# lnrr
E_power.F_lnrr <- (summary(MMA_power.F_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F_lnrr ))) %>% exp() %>% round(3)
  
O_power.F_lnrr <- (summary(MMA_power.F_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.F_lnrr ))) %>% exp() %>% round(3)

E_power.R_lnrr <- (summary(MMA_power.R_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R_lnrr ))) %>% exp() %>% round(3)
  
O_power.R_lnrr <- (summary(MMA_power.R_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.R_lnrr ))) %>% exp() %>% round(3)

E_power.F_adjusted_lnrr <-  (summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F_adjusted_lnrr ))) %>% exp() %>% round(3)

O_power.F_adjusted_lnrr <- (summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.F_adjusted_lnrr ))) %>% exp() %>% round(3)

E_power.R_adjusted_lnrr <-  (summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R_adjusted_lnrr ))) %>% exp() %>% round(3)

O_power.R_adjusted_lnrr <- (summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.R_adjusted_lnrr ))) %>% exp() %>% round(3)

# SMD
E_power.F_SMD <- (summary(MMA_power.F_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F_SMD ))) %>% exp() %>% round(3)
  
O_power.F_SMD <- (summary(MMA_power.F_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.F_SMD ))) %>% exp() %>% round(3)

E_power.R_SMD <- (summary(MMA_power.R_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R_SMD ))) %>% exp() %>% round(3)
  
O_power.R_SMD <- (summary(MMA_power.R_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.R_SMD ))) %>% exp() %>% round(3)

E_power.F_adjusted_SMD <-  (summary(MMA_power.F_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F_adjusted_SMD ))) %>% exp() %>% round(3)

O_power.F_adjusted_SMD <- (summary(MMA_power.F_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.F_adjusted_SMD ))) %>% exp() %>% round(3)

E_power.R_adjusted_SMD <-  (summary(MMA_power.R_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R_adjusted_SMD ))) %>% exp() %>% round(3)

O_power.R_adjusted_SMD <- (summary(MMA_power.R_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.R_adjusted_SMD ))) %>% exp() %>% round(3)


# SMDH
E_power.F_SMDH <- (summary(MMA_power.F_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F_SMDH ))) %>% exp() %>% round(3)
  
O_power.F_SMDH <- (summary(MMA_power.F_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.F_SMDH ))) %>% exp() %>% round(3)

E_power.R_SMDH <- (summary(MMA_power.R_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R_SMDH ))) %>% exp() %>% round(3)
  
O_power.R_SMDH <- (summary(MMA_power.R_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.R_SMDH ))) %>% exp() %>% round(3)

E_power.F_adjusted_SMDH <-  (summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F_adjusted_SMDH ))) %>% exp() %>% round(3)

O_power.F_adjusted_SMDH <- (summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.F_adjusted_SMDH ))) %>% exp() %>% round(3)

E_power.R_adjusted_SMDH <-  (summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R_adjusted_SMDH ))) %>% exp() %>% round(3)

O_power.R_adjusted_SMDH <- (summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.R_adjusted_SMDH ))) %>% exp() %>% round(3)


# lnCVR
E_power.F_CVR <- (summary(MMA_power.F_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F_CVR ))) %>% exp() %>% round(3)
  
O_power.F_CVR <- (summary(MMA_power.F_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.F_CVR ))) %>% exp() %>% round(3)

E_power.R_CVR <- (summary(MMA_power.R_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R_CVR ))) %>% exp() %>% round(3)
  
O_power.R_CVR <- (summary(MMA_power.R_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.R_CVR ))) %>% exp() %>% round(3)


# lnVR
E_power.F_VR <- (summary(MMA_power.F_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F_VR ))) %>% exp() %>% round(3)
  
O_power.F_VR <- (summary(MMA_power.F_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.F_VR ))) %>% exp() %>% round(3)

E_power.R_VR <- (summary(MMA_power.R_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R_VR ))) %>% exp() %>% round(3)
  
O_power.R_VR <- (summary(MMA_power.R_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.R_VR ))) %>% exp() %>% round(3)




ballon_power <- data.frame('approach' = c(rep('Experimental', 20),
                                          rep('Observational', 20)),
                                'es' = c(rep('lnRR*',4), 
                                         rep('lnRR',4), 
                                         rep('SMD',4), 
                                         rep('SMDH',4), 
                                         rep('lnVR',2),
                                         rep('lnCVR',2),
                                         rep('lnRR*',4), 
                                         rep('lnRR',4),
                                         rep('SMD',4),
                                         rep('SMDH',4),
                                         rep('lnVR',2),
                                         rep('lnCVR',2)),
                                'Effect' = c('MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 
                                             'MAOM', 'ESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP',
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 
                                             'MAOM', 'ESSP'),
                                'Power' = c(E_power.F_RR, E_power.R_RR, E_power.F_adjusted_RR, E_power.R_adjusted_RR, 
                                            E_power.F_lnrr, E_power.R_lnrr, E_power.F_adjusted_lnrr, E_power.R_adjusted_lnrr,
                                            E_power.F_SMD, E_power.R_SMD, E_power.F_adjusted_SMD, E_power.R_adjusted_SMD,
                                            E_power.F_SMDH, E_power.R_SMDH, E_power.F_adjusted_SMDH, E_power.R_adjusted_SMDH,
                                            E_power.F_VR, E_power.R_VR,
                                            E_power.F_CVR, E_power.R_CVR,
                                            O_power.F_RR, O_power.R_RR, O_power.F_adjusted_RR, O_power.R_adjusted_RR, 
                                            O_power.F_lnrr, O_power.R_lnrr, O_power.F_adjusted_lnrr, O_power.R_adjusted_lnrr,
                                            O_power.F_SMD, O_power.R_SMD, O_power.F_adjusted_SMD, O_power.R_adjusted_SMD,
                                            O_power.F_SMDH, O_power.R_SMDH, O_power.F_adjusted_SMDH, O_power.R_adjusted_SMDH,
                                            O_power.F_CVR, O_power.R_CVR,
                                            O_power.F_VR, O_power.R_VR),
                           'effect_type' = c(rep('Mean differences',16),rep('Variance differences',4),rep('Mean differences',16),rep('Variance differences',4)))


# convert moderator to factor with desired ordering of levels
ballon_power$es <- factor(ballon_power$es, levels=c("lnCVR", "lnVR", "SMDH", "SMD", "lnRR", "lnRR*"))
ballon_power$Effect <- factor(ballon_power$Effect, levels = c("MAOM","ESSP",  "cMAOM", "cESSP"))


# library(ggpubr)
ballon_power_plot <- ggballoonplot(ballon_power, x = "approach", y = "es", size = "Power", fill = "Effect", facet.by = c("Effect"),
             ggtheme = theme_bw())

#cols = vars(Effect),rows = vars(effect_type)
# ballon_plot <- ggplot(ballon_power, aes(x = approach, y = es, size = power, color=Effect)) +
#  geom_point()


png(filename =  "Figures/ballon_power_plot.png", height = 6, width = 7, units = "in", type = "windows", res = 400)
ballon_power_plot
dev.off()


		
		
# Type S
# lnRR*
E_power.F.S_RR <- (summary(MMA_power.F.S_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_RR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_RR <- (summary(MMA_power.F.S_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_RR.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_RR <- (summary(MMA_power.R.S_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_RR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_RR <- (summary(MMA_power.R.S_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_RR.approach2)$sigma^2)
        ) %>% exp() - 0.025



E_power.F.S_adjusted_RR <- (summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_RR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_adjusted_RR <- (summary(MMA_power.F.S_adjusted_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_RR.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_adjusted_RR <- (summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_RR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_adjusted_RR <- (summary(MMA_power.R.S_adjusted_RR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_RR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_RR.approach2)$sigma^2)
        ) %>% exp() - 0.025




# lnrr
E_power.F.S_lnrr <- (summary(MMA_power.F.S_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_lnrr.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_lnrr <- (summary(MMA_power.F.S_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_lnrr.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_lnrr <- (summary(MMA_power.R.S_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_lnrr.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_lnrr <- (summary(MMA_power.R.S_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_lnrr.approach2)$sigma^2)
        ) %>% exp() - 0.025



E_power.F.S_adjusted_lnrr <- (summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_lnrr.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_adjusted_lnrr <- (summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_lnrr.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_adjusted_lnrr <- (summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_lnrr.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_adjusted_lnrr <- (summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_lnrr.approach2)$sigma^2)
        ) %>% exp() - 0.025




# SMD
E_power.F.S_SMD <- (summary(MMA_power.F.S_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_SMD.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_SMD <- (summary(MMA_power.F.S_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_SMD.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_SMD <- (summary(MMA_power.R.S_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_SMD.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_SMD <- (summary(MMA_power.R.S_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_SMD.approach2)$sigma^2)
        ) %>% exp() - 0.025



E_power.F.S_adjusted_SMD <- (summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_SMD.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_adjusted_SMD <- (summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_SMD.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_adjusted_SMD <- (summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_SMD.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_adjusted_SMD <- (summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_SMD.approach2)$sigma^2)
        ) %>% exp() - 0.025



# SMDH
E_power.F.S_SMDH <- (summary(MMA_power.F.S_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_SMDH.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_SMDH <- (summary(MMA_power.F.S_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_SMDH.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_SMDH <- (summary(MMA_power.R.S_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_SMDH.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_SMDH <- (summary(MMA_power.R.S_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_SMDH.approach2)$sigma^2)
        ) %>% exp() - 0.025



E_power.F.S_adjusted_SMDH <- (summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_SMDH.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_adjusted_SMDH <- (summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_adjusted_SMDH.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_adjusted_SMDH <- (summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_SMDH.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_adjusted_SMDH <- (summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_adjusted_SMDH.approach2)$sigma^2)
        ) %>% exp() - 0.025




# lnVR
E_power.F.S_VR <- (summary(MMA_power.F.S_VR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_VR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_VR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_VR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_VR <- (summary(MMA_power.F.S_VR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_VR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_VR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_VR.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_VR <- (summary(MMA_power.R.S_VR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_VR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_VR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_VR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_VR <- (summary(MMA_power.R.S_VR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_VR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_VR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_VR.approach2)$sigma^2)
        ) %>% exp() - 0.025



# lnCVR
E_power.F.S_CVR <- (summary(MMA_power.F.S_CVR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_CVR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_CVR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_CVR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.F.S_CVR <- (summary(MMA_power.F.S_CVR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_CVR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.F.S_CVR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.F.S_CVR.approach2)$sigma^2)
        ) %>% exp() - 0.025


E_power.R.S_CVR <- (summary(MMA_power.R.S_CVR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_CVR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_CVR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_CVR.approach2)$sigma^2) 
        ) %>% exp() - 0.025
  
O_power.R.S_CVR <- (summary(MMA_power.R.S_CVR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_CVR.approach2)$varcor[[1]][[1]] + 
                    summary(MMA_power.R.S_CVR.approach2)$varcor[[2]][[1]] + 
                     summary(MMA_power.R.S_CVR.approach2)$sigma^2)
        ) %>% exp() - 0.025






ballon_typeS <- data.frame('approach' = c(rep('Experimental', 20),
                                          rep('Observational', 20)),
                                'es' = c(rep('lnRR*',4), 
                                         rep('lnRR',4), 
                                         rep('SMD',4), 
                                         rep('SMDH',4), 
                                         rep('lnVR',2),
                                         rep('lnCVR',2),
                                         rep('lnRR*',4), 
                                         rep('lnRR',4),
                                         rep('SMD',4),
                                         rep('SMDH',4),
                                         rep('lnVR',2),
                                         rep('lnCVR',2)),
                                'Effect' = c('MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 
                                             'MAOM', 'ESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP',
                                             'MAOM', 'ESSP', 'cMAOM', 'cESSP', 
                                             'MAOM', 'ESSP', 
                                             'MAOM', 'ESSP'),
                                'Power' = c(E_power.F.S_RR, E_power.R.S_RR, E_power.F.S_adjusted_RR, E_power.R.S_adjusted_RR, 
                                            E_power.F.S_lnrr, E_power.R.S_lnrr, E_power.F.S_adjusted_lnrr, E_power.R.S_adjusted_lnrr,
                                            E_power.F.S_SMD, E_power.R.S_SMD, E_power.F.S_adjusted_SMD, E_power.R.S_adjusted_SMD,
                                            E_power.F.S_SMDH, E_power.R.S_SMDH, E_power.F.S_adjusted_SMDH, E_power.R.S_adjusted_SMDH,
                                            E_power.F.S_VR, E_power.R.S_VR,
                                            E_power.F.S_CVR, E_power.R.S_CVR,
                                            O_power.F.S_RR, O_power.R.S_RR, O_power.F.S_adjusted_RR, O_power.R.S_adjusted_RR, 
                                            O_power.F.S_lnrr, O_power.R.S_lnrr, O_power.F.S_adjusted_lnrr, O_power.R.S_adjusted_lnrr,
                                            O_power.F.S_SMD, O_power.R.S_SMD, O_power.F.S_adjusted_SMD, O_power.R.S_adjusted_SMD,
                                            O_power.F.S_SMDH, O_power.R.S_SMDH, O_power.F.S_adjusted_SMDH, O_power.R.S_adjusted_SMDH,
                                            O_power.F.S_CVR, O_power.R.S_CVR,
                                            O_power.F.S_VR, O_power.R.S_VR),
                           'effect_type' = c(rep('Mean differences',16),rep('Variance differences',4),rep('Mean differences',16),rep('Variance differences',4)))


# convert moderator to factor with desired ordering of levels
ballon_typeS$es <- factor(ballon_power$es, levels=c("lnCVR", "lnVR", "SMDH", "SMD", "lnRR", "lnRR*"))
ballon_typeS$Effect <- factor(ballon_power$Effect, levels = c("MAOM","ESSP",  "cMAOM", "cESSP"))


# library(ggpubr)
ballon_typeS_plot <- ggballoonplot(ballon_typeS, x = "approach", y = "es", size = "Power", fill = "Effect", facet.by = c("Effect"),
             ggtheme = theme_bw())


png(filename =  "Figures/ballon_typeS_plot.png", height = 6, width = 7, units = "in", type = "windows", res = 400)
ballon_typeS_plot
dev.off()






summary(MMA_power.F.M_RR.approach2)$coefficients %>% exp()
confint(MMA_power.F.M_RR.approach2) %>% exp()

## experimental study
(summary(MMA_power.F.M_RR.approach2)$coefficients[1] + 0.5*var(log(individual_est_RR$power.F.M_RR ))) %>% exp()

## observational study
(summary(MMA_power.F.M_RR.approach2)$coefficients[2] + 0.5*var(log(individual_est_RR$power.F.M_RR ))) %>% exp()

```





### 3. lnCVR and lnVR
Assuming multi-level meta-analysis estimate as true effect, we want to calculate two-tailed power for 12 lnCVR and lnVR meta-analytic cases - relative variation and absolute variation.


#### 3.1 MA power calculation

```{r}
#***************************************************************#
#             power for 12 meta-analytic cases                  #
#***************************************************************#

# Import raw data
raw_m1_1 <- read.csv(file = "data/12_lnCVR_data/raw_m1_1.csv", header = TRUE) #sep=";"
raw_m1_2 <- read.csv(file = "data/12_lnCVR_data/raw_m1_2.csv", header = TRUE) 
raw_m2_1 <- read.csv(file = "data/12_lnCVR_data/raw_m2_1.csv", header = TRUE)
raw_m2_2 <- read.csv(file = "data/12_lnCVR_data/raw_m2_2.csv", header = TRUE) 
raw_m5_1 <- read.csv(file = "data/12_lnCVR_data/raw_m5_1.csv", header = TRUE)
raw_m6_1 <- read.csv(file = "data/12_lnCVR_data/raw_m6_1.csv", header = TRUE)
raw_m6_2 <- read.csv(file = "data/12_lnCVR_data/raw_m6_2.csv", header = TRUE) 
raw_m6_3 <- read.csv(file = "data/12_lnCVR_data/raw_m6_3.csv", header = TRUE)
raw_m6_4 <- read.csv(file = "data/12_lnCVR_data/raw_m6_4.csv", header = TRUE)
raw_m6_5 <- read.csv(file = "data/12_lnCVR_data/raw_m6_5.csv", header = TRUE)
raw_m9_1 <- read.csv(file = "data/12_lnCVR_data/raw_m9_1.csv", header = TRUE)
raw_m11_1 <- read.csv(file = "data/12_lnCVR_data/raw_m11_1.csv", header = TRUE)


# rename the column names of descriptive statistics to standard column names (i.e. "T_mean", "T_sd", "T_N", "C_mean", "C_sd", "C_N")
names(raw_m1_1)[str_detect(names(raw_m1_1), c("T.mean|T.sd|T.N|C.mean|C.sd|C.N"))] <- c("T_mean", "T_sd", "T_N", "C_mean", "C_sd", "C_N")
names(raw_m1_2)[str_detect(names(raw_m1_2), c("T.mean|T.sd|T.N|C.mean|C.sd|C.N"))] <- c("T_mean", "T_sd", "T_N", "C_mean", "C_sd", "C_N") 

names(raw_m2_1)[str_detect(names(raw_m2_1), c("con.mn|con.sd|con.n|fert.mn|fert.sd|fert.n"))] <- c( "C_mean", "C_sd", "C_N", "T_mean", "T_sd", "T_N")
names(raw_m2_2)[str_detect(names(raw_m2_2), c("con.mn|con.sd|con.n|fert.mn|fert.sd|fert.n"))] <- c( "C_mean", "C_sd", "C_N", "T_mean", "T_sd", "T_N")  

names(raw_m5_1)[str_detect(names(raw_m5_1), c("NT|NC|meanT|meanC|sdT|sdC"))] <- c("T_N", "C_N", "T_mean", "C_mean", "T_sd", "C_sd") 

names(raw_m6_1)[str_detect(names(raw_m6_1), c("p.mean|p.sd|p.n|d.mean|d.sd|d.n"))] <- c("C_mean","C_sd","C_N",  "T_mean","T_sd","T_N") 
names(raw_m6_2)[str_detect(names(raw_m6_2), c("p.mean|p.sd|p.n|d.mean|d.sd|d.n"))] <- c("C_mean","C_sd","C_N",  "T_mean","T_sd","T_N") 
names(raw_m6_3)[str_detect(names(raw_m6_3), c("p.mean|p.sd|p.n|d.mean|d.sd|d.n"))] <- c("C_mean","C_sd","C_N",  "T_mean","T_sd","T_N") 
names(raw_m6_4)[str_detect(names(raw_m6_4), c("p.mean|p.sd|p.n|d.mean|d.sd|d.n"))] <- c("C_mean","C_sd","C_N",  "T_mean","T_sd","T_N") 
names(raw_m6_5)[str_detect(names(raw_m6_5), c("p.mean|p.sd|p.n|d.mean|d.sd|d.n"))] <- c("C_mean","C_sd","C_N",  "T_mean","T_sd","T_N") 

names(raw_m9_1)[str_detect(names(raw_m9_1), c("N2O.trt|SD.N2O.trt|N.N2O.trt|N2O.ctr|SD.N2O.ctr|N.N2O.ctr"))] <- c("T_mean","T_sd","T_N","C_mean","C_sd","C_N")
names(raw_m11_1)[str_detect(names(raw_m11_1), c("Mean|SD|N|Mean.1|SD.1|N.1"))] <- c("C_mean","C_sd","C_N","T_mean","T_sd","T_N")


# make a list of data
dat_list_variation <- list(raw_m1_1,
                           raw_m1_2,
                           raw_m2_1,
                           raw_m2_2,
                           raw_m5_1,
                           raw_m6_1,
                           raw_m6_2,
                           raw_m6_3,
                           raw_m6_4,
                           raw_m6_5,
                           raw_m9_1,
                           raw_m11_1)

# calculate the number of total effect sizes - sample size
ES_number <- NA
ES_number <- mapply(unique, sapply(dat_list_variation, function(x) x$Unit_ID)) 
unlist(ES_number) %>% length() # 2004



# calculate 2 type of effect size statistics (i.e. llnCVR and lnVR)
# lnRR <- NA
# for (i in 1:length(dat_list_variation)) {
#   lnRR[i] <- escalc(measure = "ROM",
#                     m1i = T_mean,
#                     m2i = C_mean,
#                     sd1i = T_sd,
#                     sd2i = C_sd,
#                     n1i = T_N,
#                     n2i = C_N,
#                     data = dat_list_variation[[i]]) %>% list()
# }

lnCVR <- NA
for (i in 1:length(dat_list_variation)) {
  lnCVR[i] <- escalc(measure = "CVR",
                    m1i = T_mean,
                    m2i = C_mean,
                    sd1i = T_sd,
                    sd2i = C_sd,
                    n1i = T_N,
                    n2i = C_N,
                    data = dat_list_variation[[i]]) %>% list()
}

lnVR <- NA
for (i in 1:length(dat_list_variation)) {
  lnVR[i] <- escalc(measure = "VR",
                    m1i = T_mean,
                    m2i = C_mean,
                    sd1i = T_sd,
                    sd2i = C_sd,
                    n1i = T_N,
                    n2i = C_N,
                    data = dat_list_variation[[i]]) %>% list()
} 


# clean NA
for (i in 1:12) {
  lnCVR[[i]] <- lnCVR[[i]][!is.na(lnCVR[[i]]$yi),]
}

for (i in 1:12) {
  lnVR[[i]] <- lnVR[[i]][!is.na(lnVR[[i]]$yi),]
}


# prepare "ture" effect of variation (i.e. lnCVR and lnVR) for power analysis - fit multi-level meta-analytic models
model_list_CVR<- NA
for (i in 1:length(dat_list_variation)) {
 model_list_CVR[i] <- rma.mv(data = lnCVR[[i]], yi = yi, V = vi, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

model_list_VR<- NA
for (i in 1:length(dat_list_variation)) {
 model_list_VR[i] <- rma.mv(data = lnVR[[i]], yi = yi, V = vi, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}


#****************************************************************#
#------------------------------lnCVR-----------------------------#
#****************************************************************#

# we assume meta-analytic mean as ture effect, so we need to get estimate (mu) and corresponding error (SE)
model_est_CVR <- data.frame(MA_case=c("m1_1",
                                      "m1_2",
                                      "m2_1",
                                      "m2_2",
                                      "m5_1",
                                      "m6_1",
                                      "m6_2",
                                      "m6_3",
                                      "m6_4",
                                      "m6_5",
                                      "m9_1",
                                      "m11_1"),
                  mu_CVR=sapply(model_list_CVR, function(x) x$beta),
                  SE_CVR=sapply(model_list_CVR, function(x) x$se),
                  ll_NHST=sapply(model_list_CVR, function(x) x$ci.lb),
                  ul_NHST=sapply(model_list_CVR, function(x) x$ci.ub),
                  p_value=sapply(model_list_CVR, function(x) x$pval) %>% round(4))



#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_CVR$MA.power <- power.ma_Shinichi(mu=model_est_CVR$mu,SE=model_est_CVR$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_CVR$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_CVR$mu[i],se=model_est_CVR$SE[i],alpha=0.05) %>% unlist()
}

model_est_CVR$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_CVR$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_CVR$mu[i],se=model_est_CVR$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_CVR$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_CVR$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_CVR$mu[i],se=model_est_CVR$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_CVR$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_CVR, file = "./meta-analysis power_CVR.csv", row.names = FALSE)


#****************************************************************#
#-------------------------------lnVR-----------------------------#
#****************************************************************#

# we assume meta-analytic mean as ture effect, so we need to get estimate (mu) and corresponding error (SE)

model_est_VR <- data.frame(MA_case=model_est_CVR$MA_case,
                  mu_VR=sapply(model_list_VR, function(x) x$beta),
                  SE_VR=sapply(model_list_VR, function(x) x$se),
                  ll_NHST=sapply(model_list_VR, function(x) x$ci.lb),
                  ul_NHST=sapply(model_list_VR, function(x) x$ci.ub),
                  p_value=sapply(model_list_VR, function(x) x$pval))

#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_VR$MA.power <- power.ma_Shinichi(mu=model_est_VR$mu,SE=model_est_VR$SE)

#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_VR$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_VR$mu[i],se=model_est_VR$SE[i],alpha=0.05) %>% unlist()
}

model_est_VR$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_VR$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_VR$mu[i],se=model_est_VR$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_VR$MA.power.M <- MA.power.M

#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#  
MA.power.M2 <- NA
for (i in 1:length(model_est_VR$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_VR$mu[i],se=model_est_VR$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_VR$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_VR, file = "./meta-analysis power_VR.csv", row.names = FALSE)
```


#### 3.2 Individual power calculation

##### 3.2.1 Calculation
```{r}
#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference)


#****************************************************************#
#------------------------------lnCVR-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# lnCVR
power.F_CVR <- NA
for (i in 1:length(lnCVR)) {
  power.F_CVR[i] <- power.individual_Shinichi(mu=rep(model_list_CVR[[i]]$beta, length(lnCVR[[i]]$vi)), se=sqrt(lnCVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_CVR)) {
  lnCVR[[i]]$power.F_CVR <- power.F_CVR[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_CVR <- NA
for (i in 1:length(lnCVR)) {
  power.F.S_CVR[i] <- mapply(error_S,mu=rep(model_list_CVR[[i]]$beta, length(lnCVR[[i]]$vi)), se=sqrt(lnCVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_CVR)) {
  lnCVR[[i]]$power.F.S_CVR <- power.F.S_CVR[[i]]
}


#---------------- (3) type M error (overestimate ratio) --------------#
power.F.M_CVR <- NA
for (i in 1:length(lnCVR)) {
  power.F.M_CVR[i] <-mapply(error_M,mu=rep(model_list_CVR[[i]]$beta, length(lnCVR[[i]]$vi)), se=sqrt(lnCVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_CVR)) {
  lnCVR[[i]]$power.F.M_CVR <- power.F.M_CVR[[i]]
}



#---------------- (4) type M error (relative error) --------------#
power.F.M2_CVR <- NA
for (i in 1:length(lnCVR)) {
  power.F.M2_CVR[i] <-mapply(error_M2,mu=rep(model_list_CVR[[i]]$beta, length(lnCVR[[i]]$vi)), se=sqrt(lnCVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_CVR)) {
  lnCVR[[i]]$power.F.M2_CVR <- power.F.M2_CVR[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_CVR <- NA
for (i in 1:length(model_list_CVR)) {
  blups.list_CVR[i] <- ranef(model_list_CVR[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_CVR <- NA # list()
for (i in 1:length(model_list_CVR)) {
  index.list_CVR[i] <- match(as.character(lnCVR[[i]]$Study),rownames(blups.list_CVR[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_CVR <-NA
for (i in 1:length(model_list_CVR)) {
  effect.R_CVR[i] <- mapply(sum, model_list_CVR[[i]]$beta, blups.list_CVR[[i]]$Study[index.list_CVR[[i]],1], blups.list_CVR[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_CVR <- NA
for (i in 1:length(dat_list_variation)) {
  power.R_CVR[i] <- power.individual_Shinichi(mu=effect.R_CVR[[i]], se=sqrt(lnCVR[[i]]$vi)) %>% list()}

# plot(power_CVR[[1]]-power_CVR2[[1]]) - check discrepancy
# allocate each set of power into coCVResponding dataset
for (i in 1:length(power.R_CVR)) {
  lnCVR[[i]]$power.R_CVR <- power.R_CVR[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_CVR <- NA
for (i in 1:12) {
  power.R.S_CVR[i] <- mapply(error_S, mu=effect.R_CVR[[i]], se=sqrt(lnCVR[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into coCVResponding dataset
for (i in 1:length(power.R.S_CVR)) {
  lnCVR[[i]]$power.R.S_CVR <- power.R.S_CVR[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_CVR <- NA
for (i in 1:12) {
  power.R.M_CVR[i] <- mapply(error_M, mu=effect.R_CVR[[i]], se=sqrt(lnCVR[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coCVResponding dataset
for (i in 1:length(power.R.M_CVR)) {
  lnCVR[[i]]$power.R.M_CVR <- power.R.M_CVR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_CVR <- NA
for (i in 1:12) {
  power.R.M2_CVR[i] <- mapply(error_M2, mu=effect.R_CVR[[i]], se=sqrt(lnCVR[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coCVResponding dataset
for (i in 1:length(power.R.M2_CVR)) {
  lnCVR[[i]]$power.R.M2_CVR <- power.R.M2_CVR[[i]]
}




#****************************************************************#
#------------------------------lnVR------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# lnVR
power.F_VR <- NA
for (i in 1:length(lnVR)) {
  power.F_VR[i] <- power.individual_Shinichi(mu=rep(model_list_VR[[i]]$beta, length(lnVR[[i]]$vi)), se=sqrt(lnVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_VR)) {
  lnVR[[i]]$power.F_VR <- power.F_VR[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_VR <- NA
for (i in 1:length(lnVR)) {
  power.F.S_VR[i] <- mapply(error_S,mu=rep(model_list_VR[[i]]$beta, length(lnVR[[i]]$vi)), se=sqrt(lnVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_VR)) {
  lnVR[[i]]$power.F.S_VR <- power.F.S_VR[[i]]
}

#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_VR <- NA
for (i in 1:length(lnVR)) {
  power.F.M_VR[i] <-mapply(error_M,mu=rep(model_list_VR[[i]]$beta, length(lnVR[[i]]$vi)), se=sqrt(lnVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_VR)) {
  lnVR[[i]]$power.F.M_VR <- power.F.M_VR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_VR <- NA
for (i in 1:length(lnVR)) {
  power.F.M2_VR[i] <-mapply(error_M2,mu=rep(model_list_VR[[i]]$beta, length(lnVR[[i]]$vi)), se=sqrt(lnVR[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_VR)) {
  lnVR[[i]]$power.F.M2_VR <- power.F.M2_VR[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_VR <- NA
for (i in 1:length(model_list_VR)) {
  blups.list_VR[i] <- ranef(model_list_VR[[i]]) %>% list()
}

# get study index - match two components random effect
index.list_VR <- NA # list()
for (i in 1:length(model_list_VR)) {
  index.list_VR[i] <- match(as.character(lnVR[[i]]$Study),rownames(blups.list_VR[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_VR <-NA
for (i in 1:length(model_list_VR)) {
  effect.R_VR[i] <- mapply(sum, model_list_VR[[i]]$beta, blups.list_VR[[i]]$Study[index.list_VR[[i]],1], blups.list_VR[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_VR <- NA
for (i in 1:length(dat_list_variation)) {
  power.R_VR[i] <- power.individual_Shinichi(mu=effect.R_VR[[i]], se=sqrt(lnVR[[i]]$vi)) %>% list()}

# plot(power_VR[[1]]-power_VR2[[1]]) - check discrepancy
# allocate each set of power into coVResponding dataset
for (i in 1:length(power.R_VR)) {
  lnVR[[i]]$power.R_VR <- power.R_VR[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_VR <- NA
for (i in 1:12) {
  power.R.S_VR[i] <- mapply(error_S, mu=effect.R_VR[[i]], se=sqrt(lnVR[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into coVResponding dataset
for (i in 1:length(power.R.S_VR)) {
  lnVR[[i]]$power.R.S_VR <- power.R.S_VR[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_VR <- NA
for (i in 1:12) {
  power.R.M_VR[i] <- mapply(error_M, mu=effect.R_VR[[i]], se=sqrt(lnVR[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coVResponding dataset
for (i in 1:length(power.R.M_VR)) {
  lnVR[[i]]$power.R.M_VR <- power.R.M_VR[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_VR <- NA
for (i in 1:12) {
  power.R.M2_VR[i] <- mapply(error_M2, mu=effect.R_VR[[i]], se=sqrt(lnVR[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coVResponding dataset
for (i in 1:length(power.R.M2_VR)) {
  lnVR[[i]]$power.R.M2_VR <- power.R.M2_VR[[i]]
}
```

 
##### 3.2.2 Summary of individual power

```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#****************************************************************#
#-----------------------------lnCVR------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.F_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.F_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.F_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.F_CVR))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.F.S_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F.S_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.F.S_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.F.S_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F.S_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.F.S_CVR))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.F.M_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F.M_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.F.M_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.F.M_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F.M_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.F.M_CVR))[6,])

#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.F.M2_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F.M2_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.F.M2_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.F.M2_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.F.M2_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.F.M2_CVR))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.R_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.R_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.R_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.R_CVR))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.R.S_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R.S_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.R.S_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.R.S_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R.S_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.R.S_CVR))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.R.M_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R.M_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.R.M_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.R.M_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R.M_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.R.M_CVR))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_CVR <- data.frame(MA_case=model_est_CVR$MA_case,
                   Minimum=mapply(summary, sapply(lnCVR, function(x) x$power.R.M2_CVR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R.M2_CVR))[2,],
                   Median=mapply(summary, sapply(lnCVR, function(x) x$power.R.M2_CVR))[3,],
                   Mean=mapply(summary, sapply(lnCVR, function(x) x$power.R.M2_CVR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnCVR, function(x) x$power.R.M2_CVR))[5,], 
                   Maximum=mapply(summary, sapply(lnCVR, function(x) x$power.R.M2_CVR))[6,]) 



#****************************************************************#
#-----------------------------lnVR-------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.F_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.F_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.F_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.F_VR))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.F.S_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F.S_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.F.S_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.F.S_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F.S_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.F.S_VR))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.F.M_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F.M_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.F.M_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.F.M_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F.M_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.F.M_VR))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.F.M2_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F.M2_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.F.M2_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.F.M2_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.F.M2_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.F.M2_VR))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.R_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.R_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.R_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.R_VR))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.R.S_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R.S_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.R.S_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.R.S_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R.S_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.R.S_VR))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.R.M_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R.M_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.R.M_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.R.M_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R.M_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.R.M_VR))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_VR <- data.frame(MA_case=model_est_VR$MA_case,
                   Minimum=mapply(summary, sapply(lnVR, function(x) x$power.R.M2_VR))[1,],      
                   `First quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R.M2_VR))[2,],
                   Median=mapply(summary, sapply(lnVR, function(x) x$power.R.M2_VR))[3,],
                   Mean=mapply(summary, sapply(lnVR, function(x) x$power.R.M2_VR))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnVR, function(x) x$power.R.M2_VR))[5,], 
                   Maximum=mapply(summary, sapply(lnVR, function(x) x$power.R.M2_VR))[6,]) 


# clean NA - ma11 has NA
#for (i in 1:12) { lnVR[[i]] <- lnVR[[i]][!is.na(lnVR[[i]]$power.R_VR),]}
```


##### 3.2.3 SE of individual power

```{r}
#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#****************************************************************#
#-----------------------------lnCVR------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_CVR
se.F_mean <- NA
for (i in 1:length(lnCVR)) {
  se.F_mean[i] <- sd(lnCVR[[i]]$power.F_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.F_CVR[!is.na(lnCVR[[i]]$power.F_CVR)]))
}

power.F_summary_CVR$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_CVR
se.F.S_mean <- NA
for (i in 1:length(lnCVR)) {
  se.F.S_mean[i] <- sd(lnCVR[[i]]$power.F.S_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.F.S_CVR[!is.na(lnCVR[[i]]$power.F.S_CVR)]))
}

power.F.S_summary_CVR$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_CVR
se.F.M_mean <- NA
for (i in 1:length(lnCVR)) {
  se.F.M_mean[i] <- sd(lnCVR[[i]]$power.F.M_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.F.M_CVR[!is.na(lnCVR[[i]]$power.F.M_CVR)]))
}

power.F.M_summary_CVR$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(lnCVR)) {
  se.F.M2_mean[i] <- sd(lnCVR[[i]]$power.F.M2_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.F.M2_CVR[!is.na(lnCVR[[i]]$power.F.M2_CVR)]))
}

power.F.M2_summary_CVR$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_CVR
se.R_mean <- NA
for (i in 1:length(lnCVR)) {
  se.R_mean[i] <- sd(lnCVR[[i]]$power.R_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.R_CVR[!is.na(lnCVR[[i]]$power.R_CVR)]))
}

power.R_summary_CVR$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_CVR
se.R.S_mean <- NA
for (i in 1:length(lnCVR)) {
  se.R.S_mean[i] <- sd(lnCVR[[i]]$power.R.S_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.R.S_CVR[!is.na(lnCVR[[i]]$power.R.S_CVR)]))
}

power.R.S_summary_CVR$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_CVR
se.R.M_mean <- NA
for (i in 1:length(lnCVR)) {
  se.R.M_mean[i] <- sd(lnCVR[[i]]$power.R.M_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.R.M_CVR[!is.na(lnCVR[[i]]$power.R.M_CVR)]))
}

power.R.M_summary_CVR$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(lnCVR)) {
  se.R.M2_mean[i] <- sd(lnCVR[[i]]$power.R.M2_CVR, na.rm=TRUE) / sqrt(length(lnCVR[[i]]$power.R.M2_CVR[!is.na(lnCVR[[i]]$power.R.M2_CVR)]))
}

power.R.M2_summary_CVR$se.R.M2_mean <- se.R.M2_mean





#****************************************************************#
#-----------------------------lnVR-------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_VR
se.F_mean <- NA
for (i in 1:length(lnVR)) {
  se.F_mean[i] <- sd(lnVR[[i]]$power.F_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.F_VR[!is.na(lnVR[[i]]$power.F_VR)]))
}

power.F_summary_VR$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_VR
se.F.S_mean <- NA
for (i in 1:length(lnVR)) {
  se.F.S_mean[i] <- sd(lnVR[[i]]$power.F.S_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.F.S_VR[!is.na(lnVR[[i]]$power.F.S_VR)]))
}

power.F.S_summary_VR$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_VR
se.F.M_mean <- NA
for (i in 1:length(lnVR)) {
  se.F.M_mean[i] <- sd(lnVR[[i]]$power.F.M_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.F.M_VR[!is.na(lnVR[[i]]$power.F.M_VR)]))
}

power.F.M_summary_VR$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(lnVR)) {
  se.F.M2_mean[i] <- sd(lnVR[[i]]$power.F.M2_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.F.M2_VR[!is.na(lnVR[[i]]$power.F.M2_VR)]))
}

power.F.M2_summary_VR$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_VR
se.R_mean <- NA
for (i in 1:length(lnVR)) {
  se.R_mean[i] <- sd(lnVR[[i]]$power.R_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.R_VR[!is.na(lnVR[[i]]$power.R_VR)]))
}

power.R_summary_VR$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_VR
se.R.S_mean <- NA
for (i in 1:length(lnVR)) {
  se.R.S_mean[i] <- sd(lnVR[[i]]$power.R.S_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.R.S_VR[!is.na(lnVR[[i]]$power.R.S_VR)]))
}

power.R.S_summary_VR$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_VR
se.R.M_mean <- NA
for (i in 1:length(lnVR)) {
  se.R.M_mean[i] <- sd(lnVR[[i]]$power.R.M_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.R.M_VR[!is.na(lnVR[[i]]$power.R.M_VR)]))
}

power.R.M_summary_VR$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(lnVR)) {
  se.R.M2_mean[i] <- sd(lnVR[[i]]$power.R.M2_VR, na.rm=TRUE) / sqrt(length(lnVR[[i]]$power.R.M2_VR[!is.na(lnVR[[i]]$power.R.M2_VR)]))
}

power.R.M2_summary_VR$se.R.M2_mean <- se.R.M2_mean
```



#### 3.3 Regression

##### 3.3.1 MA power

```{r}

#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#****************************************************************#
#-----------------------------lnCVR------------------------------#
#****************************************************************#

# add N and k
N_CVR <- NA
for (i in 1:length(lnCVR)) {
  N_CVR[i] <- lnCVR[[i]]$Study %>% unique() %>% length()
}

k_CVR <- NA
for (i in 1:length(lnCVR)) {
  k_CVR[i] <- lnCVR[[i]]$Unit_ID%>% length()
}

model_est_CVR$k <- k_CVR
model_est_CVR$N <- N_CVR

# n
for (i in 1:12) {
  lnCVR[[i]]$n_total <- lnCVR[[i]]$C_N + lnCVR[[i]]$T_N }

n_total_CVR <- NA
for (i in 1:12) {
  n_total_CVR[i] <- lnCVR[[i]]$n_total %>% sum }

model_est_CVR$n <- n_total_CVR

# load meta-analysis level power
#load(here("data","model_est_CVR.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_CVR <- lm(MA.power~1, weights = k, data = model_est_CVR) 
MMA_MA_CVR$coefficients
# log
MMA_MA_CVR2 <- lm(log(MA.power)~1, weights = k, data = model_est_CVR)
# this is median
MMA_MA_CVR2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(MMA_MA_CVR2$coefficients + 0.5*var(log(model_est_CVR$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_CVR2) %>% exp()

# compare residuals
png(filename = "./Figures/residual/power.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA_CVR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_CVR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
dev.off()

#---------------------- (2) type S error -----------------------#
MMA_MA.S_CVR <- lm(MA.power.S~1, weights = k, data = model_est_CVR) 
MMA_MA.S_CVR$coefficients
# log
MMA_MA.S_CVR2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_CVR) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_CVR2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_CVR2$coefficients + 0.5*var(log(model_est_CVR$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_CVR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
png(filename = "./Figures/residual/TypeS.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_MA.S_CVR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_CVR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_CVR <- lm(MA.power.M~1, weights = k, data = model_est_CVR) 
MMA_MA.M_CVR$coefficients
# log
MMA_MA.M_CVR2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_CVR)
# this is median
MMA_MA.M_CVR2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(MMA_MA.M_CVR2$coefficients + 0.5*var(log(model_est_CVR$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_CVR2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_CVR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_CVR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_CVR <- lm(MA.power.M2~1, weights = k, data = model_est_CVR) 
MMA_MA.M2_CVR$coefficients
# log
MMA_MA.M2_CVR2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_CVR)
# this is median
MMA_MA.M2_CVR2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(MMA_MA.M2_CVR2$coefficients + 0.5*var(log(model_est_CVR$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_CVR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_CVR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_CVR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



#****************************************************************#
#-----------------------------lnVR------------------------------#
#****************************************************************#

# add N and k
N_VR <- NA
for (i in 1:length(lnVR)) {
  N_VR[i] <- lnVR[[i]]$Study %>% unique() %>% length()
}

k_VR <- NA
for (i in 1:length(lnVR)) {
  k_VR[i] <- lnVR[[i]]$Unit_ID%>% length()
}

model_est_VR$k <- k_VR
model_est_VR$N <- N_VR


# n
for (i in 1:12) {
  lnVR[[i]]$n_total <- lnVR[[i]]$C_N + lnVR[[i]]$T_N }

n_total_VR <- NA
for (i in 1:12) {
  n_total_VR[i] <- lnVR[[i]]$n_total %>% sum }

model_est_VR$n <- n_total_VR



# load meta-analysis level power
# load(here("data","model_est_VR.RData"))




#--------------------- (1) two tailed power ---------------------#
MMA_MA_VR <- lm(MA.power~1, weights = k, data = model_est_VR) 
MMA_MA_VR$coefficients
# log
MMA_MA_VR2 <- lm(log(MA.power)~1, weights = k, data = model_est_VR)
# this is median
MMA_MA_VR2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(MMA_MA_VR2$coefficients + 0.5*var(log(model_est_VR$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_VR2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_VR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_VR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_VR <- lm(MA.power.S~1, weights = k, data = model_est_VR) 
MMA_MA.S_VR$coefficients
# log
MMA_MA.S_VR2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_VR) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_VR2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_VR2$coefficients + 0.5*var(log(model_est_VR$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_VR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_VR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_VR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_VR <- lm(MA.power.M~1, weights = k, data = model_est_VR) 
MMA_MA.M_VR$coefficients
# log
MMA_MA.M_VR2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_VR)
# this is median
MMA_MA.M_VR2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(MMA_MA.M_VR2$coefficients + 0.5*var(log(model_est_VR$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_VR2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_VR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_VR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_VR <- lm(MA.power.M2~1, weights = k, data = model_est_VR) 
MMA_MA.M2_VR$coefficients
# log
MMA_MA.M2_VR2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_VR)
# this is median
MMA_MA.M2_VR2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(MMA_MA.M2_VR2$coefficients + 0.5*var(log(model_est_VR$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_VR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_VR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_VR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 
```


##### 3.3.2 Individual power

###### 3.3.2.1 lnCVR

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#****************************************************************#
#-----------------------------lnCVR------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique incase some studies have same identities
# lnCVR[[1]]$Study <- paste("m1_1_", lnCVR[[1]]$Study, sep = "")
# lnCVR[[2]]$Study <- paste("m1_2_", lnCVR[[2]]$Study, sep = "")
# lnCVR[[3]]$Study <- paste("m2_1_", lnCVR[[3]]$Study, sep = "")
# lnCVR[[4]]$Study <- paste("m2_2_", lnCVR[[4]]$Study, sep = "")
# lnCVR[[5]]$Study <- paste("m5_1_", lnCVR[[5]]$Study, sep = "")
# lnCVR[[6]]$Study <- paste("m6_1_", lnCVR[[6]]$Study, sep = "")
# lnCVR[[7]]$Study <- paste("m6_2_", lnCVR[[7]]$Study, sep = "")
# lnCVR[[8]]$Study <- paste("m6_3_", lnCVR[[8]]$Study, sep = "")
# lnCVR[[9]]$Study <- paste("m6_4_", lnCVR[[9]]$Study, sep = "")
# lnCVR[[10]]$Study <- paste("m6_5_", lnCVR[[10]]$Study, sep = "")
# lnCVR[[11]]$Study <- paste("m9_1_", lnCVR[[11]]$Study, sep = "")
# lnCVR[[12]]$Study <- paste("m11_1_", lnCVR[[12]]$Study, sep = "")



studyID_CVR <- NA
for (i in 1:length(lnCVR)) {
  studyID_CVR[i] <- lnCVR[[i]]$Study %>% list()
}

MA_case_CVR <-  c(rep('m1_1',length(lnCVR[[1]]$Study)),
                  rep('m1_2',length(lnCVR[[2]]$Study)),
                  rep('m2_1',length(lnCVR[[3]]$Study)),
                  rep('m2_2',length(lnCVR[[4]]$Study)),
                  rep('m5_1',length(lnCVR[[5]]$Study)),
                  rep('m6_1',length(lnCVR[[6]]$Study)),
                  rep('m6_2',length(lnCVR[[7]]$Study)),
                  rep('m6_3',length(lnCVR[[8]]$Study)),
                  rep('m6_4',length(lnCVR[[9]]$Study)),
                  rep('m6_5',length(lnCVR[[10]]$Study)),
                  rep('m9_1',length(lnCVR[[11]]$Study)),
                  rep('m11_1',length(lnCVR[[12]]$Study))
                  )
#MA_case_CVR <- c("1m1_1",  "2m1_2",  "3m2_1",  "4m2_2",  "5m5_1",  "6m6_1",  "7m6_2",  "8m6_3",  "9m6_4",  "10m6_5",  "11m9_1", "12m11_1")



stressor_CVR <-  c(rep('BD_loss',length(lnCVR[[1]]$Study)),
                  rep('BD_loss',length(lnCVR[[2]]$Study)),
                  rep('Fert',length(lnCVR[[3]]$Study)),
                  rep('Fert',length(lnCVR[[4]]$Study)),
                  rep('Fert',length(lnCVR[[5]]$Study)),
                  rep('LUC',length(lnCVR[[6]]$Study)),
                  rep('LUC',length(lnCVR[[7]]$Study)),
                  rep('LUC',length(lnCVR[[8]]$Study)),
                  rep('LUC',length(lnCVR[[9]]$Study)),
                  rep('LUC',length(lnCVR[[10]]$Study)),
                  rep('LUC',length(lnCVR[[11]]$Study)),
                  rep('Inv',length(lnCVR[[12]]$Study))
                  )


#stressor_CVR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_CVR <-  c(rep('E',length(lnCVR[[1]]$Study)),
                  rep('E',length(lnCVR[[2]]$Study)),
                  rep('E',length(lnCVR[[3]]$Study)),
                  rep('E',length(lnCVR[[4]]$Study)),
                  rep('E',length(lnCVR[[5]]$Study)),
                  rep('O',length(lnCVR[[6]]$Study)),
                  rep('O',length(lnCVR[[7]]$Study)),
                  rep('O',length(lnCVR[[8]]$Study)),
                  rep('O',length(lnCVR[[9]]$Study)),
                  rep('O',length(lnCVR[[10]]$Study)),
                  rep('O',length(lnCVR[[11]]$Study)),
                  rep('O',length(lnCVR[[12]]$Study))
                  )

#approach_CVR <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_CVR <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")


studyID_CVR <- unlist(studyID_CVR)
power.F_CVR <- unlist(power.F_CVR)
power.F.S_CVR <- unlist(power.F.S_CVR)
power.F.M_CVR <- unlist(power.F.M_CVR)
power.F.M2_CVR <- unlist(power.F.M2_CVR)
power.R_CVR <- unlist(power.R_CVR)
power.R.S_CVR <- unlist(power.R.S_CVR)
power.R.M_CVR <- unlist(power.R.M_CVR)
power.R.M2_CVR <- unlist(power.R.M2_CVR)


individual_est_CVR <- data.frame("MA_case_CVR" = MA_case_CVR,
                                 "studyID_CVR" = studyID_CVR,
                                "stressor_CVR" = stressor_CVR,
                                "approach_CVR" = approach_CVR,
                                "power.F_CVR" = power.F_CVR,
                                "power.F.S_CVR" = power.F.S_CVR,
                                "power.F.M_CVR" = power.F.M_CVR,
                                "power.F.M2_CVR" = power.F.M2_CVR,
                                "power.R_CVR" = power.R_CVR,
                                "power.R.S_CVR" = power.R.S_CVR,
                                "power.R.M_CVR" = power.R.M_CVR,
                                "power.R.M2_CVR" = power.R.M2_CVR)

#add false positive report probability (FRP)
individual_est_CVR$FRP <- (0.05 * (1 - 0.5)) / (0.05 * (1 - 0.5) + 0.5*individual_est_CVR$power.F_CVR)

MMA_power.F_CVR_FRP <- lmer(log(FRP) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
# this is median 
summary(MMA_power.F_CVR_FRP)$coefficients[1] %>% exp()

# save(individual_est_CVR,file = here("data","individual_est_CVR.RData"))
# save(power.F.M_CVR,file = here("data","power.F.M_CVR.RData"))
# save(power.R.M_CVR,file = here("data","power.R.M_CVR.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_CVR.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_CVR <- lmer(power.F_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
summary(MMA_power.F_CVR)$coefficients[1]
# log
MMA_power.F_CVR2 <- lmer(log(power.F_CVR) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
# this is median 
summary(MMA_power.F_CVR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_CVR2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F_CVR))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_CVR2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_CVR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_CVR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_CVR as fixed effect and stressor as random effect
MMA_power.F_CVR.approach <- lmer(power.F_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.F_CVR.approach)$coefficients
# log
MMA_power.F_CVR.approach2 <- lmer(log(power.F_CVR) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.F_CVR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F_CVR[individual_est_CVR$approach_CVR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.F_CVR[individual_est_CVR$approach_CVR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_CVR.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_CVR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_CVR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_power.F_CVR.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 


# contrasting model
MMA_power.F_CVR.approach4 <- lmer(log(power.F_CVR) ~ 1 + I(approach_CVR) + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# check p value
summary(MMA_power.F_CVR.approach4)

#---------------------- (2) type S error -----------------------#
MMA_power.F.S_CVR <- lmer(power.F.S_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
summary(MMA_power.F.S_CVR)$coefficients[1]
# log
MMA_power.F.S_CVR2 <- lmer(log(power.F.S_CVR + 0.025) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_CVR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_CVR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_CVR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_CVR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_CVR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
png(filename = "./Figures/residual/S_CVR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_CVR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_CVR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.F.S_CVR3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_CVR as fixed effect and stressor as random effect
MMA_power.F.S_CVR.approach <- lmer(power.F.S_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.F.S_CVR.approach)$coefficients
# log
MMA_power.F.S_CVR.approach2 <- lmer(log(power.F.S_CVR + 0.025) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.F.S_CVR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_CVR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_CVR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_CVR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_CVR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_CVR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_CVR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_CVR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_CVR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_CVR.approach2) %>% exp() - 0.025




# lcontrasting model
MMA_power.F.S_CVR.approach4 <- lmer(log(power.F.S_CVR + 0.025) ~ 1 + I(approach_CVR) + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# check p value
summary(MMA_power.F.S_CVR.approach4)


#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_CVR <- lmer(power.F.M_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

summary(MMA_power.F.M_CVR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnCVR are very low. This probably makes some of Type M eCVRor extremely high. 

# but log transformation can work
MMA_power.F.M_CVR2 <- lmer(log(power.F.M_CVR) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

# this is median
summary(MMA_power.F.M_CVR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(summary(MMA_power.F.M_CVR2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F.M_CVR))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_CVR2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_CVR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_CVR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_CVR as fixed effect and stressor as random effect
MMA_power.F.M_CVR.approach <- lmer(power.F.M_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.F.M_CVR.approach)$coefficients
# log
MMA_power.F.M_CVR.approach2 <- lmer(log(power.F.M_CVR) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.F.M_CVR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F.M_CVR[individual_est_CVR$approach_CVR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.F.M_CVR[individual_est_CVR$approach_CVR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_CVR.approach2) %>% exp()


# lcontrasting model
MMA_power.F.M_CVR.approach4 <- lmer(log(power.F.M_CVR) ~ 1 + I(approach_CVR)+ (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# check p value
summary(MMA_power.F.M_CVR.approach4)

#---------------------- (2) type M2 error -----------------------#

MMA_power.F.M2_CVR <- lmer(power.F.M2_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

summary(MMA_power.F.M2_CVR)$coefficients[1] 

# log 
MMA_power.F.M2_CVR2 <- lmer(log(power.F.M2_CVR+0.025) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

# this is median
summary(MMA_power.F.M2_CVR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(summary(MMA_power.F.M2_CVR2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F.M2_CVR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_CVR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_CVR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_CVR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_CVR as fixed effect and stressor as random effect
MMA_power.F.M2_CVR.approach <- lmer(power.F.M2_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.F.M2_CVR.approach)$coefficients
# log
MMA_power.F.M2_CVR.approach2 <- lmer(log(power.F.M2_CVR + 0.025) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.F.M2_CVR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.F.M2_CVR[individual_est_CVR$approach_CVR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.F.M2_CVR[individual_est_CVR$approach_CVR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_CVR.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_CVR <- lmer(power.R_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
summary(MMA_power.R_CVR)$coefficients[1]
# log
MMA_power.R_CVR2 <- lmer(log(power.R_CVR) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
# this is median 
summary(MMA_power.R_CVR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_CVR2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R_CVR))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_CVR2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_CVR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_CVR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_CVR as fixed effect and stressor as random effect
MMA_power.R_CVR.approach <- lmer(power.R_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.R_CVR.approach)$coefficients
# log
MMA_power.R_CVR.approach2 <- lmer(log(power.R_CVR) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.R_CVR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R_CVR[individual_est_CVR$approach_CVR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.R_CVR[individual_est_CVR$approach_CVR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_CVR.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_CVR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_CVR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# contrasting model
MMA_power.R_CVR.approach4 <- lmer(log(power.R_CVR) ~ 1 + I(approach_CVR) + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# check p value
summary(MMA_power.R_CVR.approach4)

 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_CVR <- lmer(power.R.S_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
summary(MMA_power.R.S_CVR)$coefficients[1]

# log
MMA_power.R.S_CVR2 <- lmer(log(power.R.S_CVR + 0.025) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_CVR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_CVR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_CVR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_CVR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_CVR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
png(filename = "./Figures/residual/S_CVR2.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_CVR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_CVR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()



# include approach_CVR as fixed effect and stressor as random effect
MMA_power.R.S_CVR.approach <- lmer(power.R.S_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.R.S_CVR.approach)$coefficients
# log
MMA_power.R.S_CVR.approach2 <- lmer(log(power.R.S_CVR + 0.025) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.R.S_CVR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_CVR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_CVR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_CVR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_CVR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_CVR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_CVR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_CVR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_CVR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_CVR.approach2) %>% exp()



# contrasting model
MMA_power.R.S_CVR.approach4 <- lmer(log(power.R.S_CVR + 0.025) ~ 1 + I(approach_CVR) + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# check p value
summary(MMA_power.R.S_CVR.approach4)

#---------------------- (2) type M error -----------------------#

MMA_power.R.M_CVR <- lmer(power.R.M_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

summary(MMA_power.R.M_CVR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnCVR are very low. This probably makes some of Type M eCVRor extremely high. 

# but log transformation can work
MMA_power.R.M_CVR2 <- lmer(log(power.R.M_CVR) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

# this is median
summary(MMA_power.R.M_CVR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(summary(MMA_power.R.M_CVR2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R.M_CVR))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_CVR2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_CVR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_CVR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_CVR as fixed effect and stressor as random effect
MMA_power.R.M_CVR.approach <- lmer(power.R.M_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.R.M_CVR.approach)$coefficients
# log
MMA_power.R.M_CVR.approach2 <- lmer(log(power.R.M_CVR) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.R.M_CVR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R.M_CVR[individual_est_CVR$approach_CVR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.R.M_CVR[individual_est_CVR$approach_CVR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_CVR.approach2) %>% exp()



# contrasting model
MMA_power.R.M_CVR.approach4 <- lmer(log(power.R.M_CVR) ~ 1 + I(approach_CVR) + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# check p value
summary(MMA_power.R.M_CVR.approach4)

#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_CVR <- lmer(power.R.M2_CVR ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

summary(MMA_power.R.M2_CVR)$coefficients[1] 

# log 
MMA_power.R.M2_CVR2 <- lmer(log(power.R.M2_CVR+0.025) ~ 1 + (1 | studyID_CVR), data = individual_est_CVR)

# this is median
summary(MMA_power.R.M2_CVR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coCVRect but it is fine for now)
(summary(MMA_power.R.M2_CVR2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R.M2_CVR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_CVR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_CVR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_CVR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_CVR as fixed effect and stressor as random effect
MMA_power.R.M2_CVR.approach <- lmer(power.R.M2_CVR ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
summary(MMA_power.R.M2_CVR.approach)$coefficients
# log
MMA_power.R.M2_CVR.approach2 <- lmer(log(power.R.M2_CVR + 0.025) ~ 1 + I(approach_CVR) -1 + (1 | studyID_CVR) + (1 | stressor_CVR), data = individual_est_CVR)
# this is median
summary(MMA_power.R.M2_CVR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_CVR.approach2)$coefficients[1] + 0.5*var(log(individual_est_CVR$power.R.M2_CVR[individual_est_CVR$approach_CVR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_CVR.approach2)$coefficients[2] + 0.5*var(log(individual_est_CVR$power.R.M2_CVR[individual_est_CVR$approach_CVR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_CVR.approach2) %>% exp() - 0.025



# #----------------------------------------------------------------#
# #           (i) intercept (overall mean) as true effect
# #----------------------------------------------------------------#
# 
# # add study ID
# 
# # add N and k
# N_CVR <- NA
# for (i in 1:length(lnCVR)) {
#   N_CVR[i] <- lnCVR[[i]]$Unit_ID %>% length()
# }
# 
# k_CVR <- NA
# for (i in 1:length(lnCVR)) {
#   k_CVR[i] <- lnCVR[[i]]$Study %>% length()
# }
# 
# power.F_summary_CVR$N <- N_CVR
# power.F_summary_CVR$k <- k_CVR
# 
# 
# 
# 
# 
# 
# 
# approach_CVR <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
# 
# treatment_CVR <- c("Pr","Pr", "Pr","Pr", "Pr", "Pr","Pr","Pr","Pr","Pr", "Pr", "Pr")
# 
# stressor_CVR <- c("BD_loss","BD_loss", "Fert", "Fert", "Fert", "LUC","LUC","LUC","LUC","LUC", "LUC", "Inv")
# 
# stressor_CVR %>% as.data.frame() # check the correctness
# 
# 
# moderator_CVR <- cbind(approach_CVR,treatment_CVR,stressor_CVR)
# 
# power.F_summary_CVR <- cbind(power.F_summary_CVR, moderator_CVR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F_summary_CVR$approach_CVR <- factor(power.F_summary_CVR$approach_CVR, levels=c("O", "E"))
# 
# MMA_power.F_CVR.approach <- with(power.F_summary_CVR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_CVR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F_CVR.stressor <- with(power.F_summary_CVR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_CVR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F_CVR <- with(power.F_summary_CVR, rma(yi = Mean, sei = se.F_mean,   method = "REML", test = "t"))
# 
# 
# 
# power.F.S_summary_CVR <- cbind(power.F.S_summary_CVR, moderator_CVR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.S_summary_CVR$approach_CVR <- factor(power.F.S_summary_CVR$approach_CVR, levels=c("O", "E"))
# 
# MMA_power.F.S_CVR.approach <- with(power.F.S_summary_CVR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_CVR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.S_CVR.stressor <- with(power.F.S_summary_CVR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_CVR) -1, method = "REML", test = "t"))
# 
# MMA_power.F.S_CVR <- with(power.F.S_summary_CVR, rma(yi = Mean, sei = se.F.S_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# power.F.M_summary_CVR <- cbind(power.F.M_summary_CVR, moderator_CVR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_CVR$approach_CVR <- factor(power.F.M_summary_CVR$approach_CVR, levels=c("O", "E"))
# 
# MMA_power.F.M_CVR.approach <- with(power.F.M_summary_CVR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_CVR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.M_CVR.stressor <- with(power.F.M_summary_CVR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_CVR) -1, method = "REML", test = "t"))
# 
# MMA_power.F.M_CVR <- with(power.F.M_summary_CVR, rma(yi = Mean, sei = se.F.M_mean,   method = "REML", test = "t"))
# 
# MMA_power.F.M2_CVR <- with(power.F.M2_summary_CVR, rma(yi = Mean, sei = se.F.M2_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# #----------------------------------------------------------------#
# #                 (ii) effect size specific effect as true effect
# #----------------------------------------------------------------#
# MMA_power.R_CVR <- with(power.R_summary_CVR, rma(yi = Mean, sei = se.R_mean,   method = "REML", test = "t"))
# 
# MMA_power.R.S_CVR <- with(power.R.S_summary_CVR, rma(yi = Mean, sei = se.R.S_mean,   method = "REML", test = "t"))
# 
# MMA_power.R.M_CVR <- with(power.R.M_summary_CVR, rma(yi = Mean, sei = se.R.M_mean,   method = "REML", test = "t"))
# 
# MMA_power.R.M2_CVR <- with(power.R.M2_summary_CVR, rma(yi = Mean, sei = se.R.M2_mean,   method = "REML", test = "t"))
```


###### 3.3.2.2 lnVR
```{r}
#****************************************************************#
#-----------------------------lnVR-------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


## make study identity unique incase some studies have same identities
# lnVR[[1]]$Study <- paste("m1_1_", lnVR[[1]]$Study, sep = "")
# lnVR[[2]]$Study <- paste("m1_2_", lnVR[[2]]$Study, sep = "")
# lnVR[[3]]$Study <- paste("m2_1_", lnVR[[3]]$Study, sep = "")
# lnVR[[4]]$Study <- paste("m2_2_", lnVR[[4]]$Study, sep = "")
# lnVR[[5]]$Study <- paste("m5_1_", lnVR[[5]]$Study, sep = "")
# lnVR[[6]]$Study <- paste("m6_1_", lnVR[[6]]$Study, sep = "")
# lnVR[[7]]$Study <- paste("m6_2_", lnVR[[7]]$Study, sep = "")
# lnVR[[8]]$Study <- paste("m6_3_", lnVR[[8]]$Study, sep = "")
# lnVR[[9]]$Study <- paste("m6_4_", lnVR[[9]]$Study, sep = "")
# lnVR[[10]]$Study <- paste("m6_5_", lnVR[[10]]$Study, sep = "")
# lnVR[[11]]$Study <- paste("m9_1_", lnVR[[11]]$Study, sep = "")
# lnVR[[12]]$Study <- paste("m11_1_", lnVR[[12]]$Study, sep = "")

studyID_VR <- NA
for (i in 1:length(lnVR)) {
  studyID_VR[i] <- lnVR[[i]]$Study %>% list()
}

MA_case_VR <-  c(rep('m1_1',length(lnVR[[1]]$Study)),
                  rep('m1_2',length(lnVR[[2]]$Study)),
                  rep('m2_1',length(lnVR[[3]]$Study)),
                  rep('m2_2',length(lnVR[[4]]$Study)),
                  rep('m5_1',length(lnVR[[5]]$Study)),
                  rep('m6_1',length(lnVR[[6]]$Study)),
                  rep('m6_2',length(lnVR[[7]]$Study)),
                  rep('m6_3',length(lnVR[[8]]$Study)),
                  rep('m6_4',length(lnVR[[9]]$Study)),
                  rep('m6_5',length(lnVR[[10]]$Study)),
                  rep('m9_1',length(lnVR[[11]]$Study)),
                  rep('m11_1',length(lnVR[[12]]$Study))
                  )
# MA_case_VR <- c("1m1_1",  "2m1_2",  "3m2_1",  "4m2_2",  "5m5_1",  "6m6_1",  "7m6_2",  "8m6_3",  "9m6_4",  "10m6_5",  "11m9_1", "12m11_1")


stressor_VR <-  c(rep('BD_loss',length(lnVR[[1]]$Study)),
                  rep('BD_loss',length(lnVR[[2]]$Study)),
                  rep('Fert',length(lnVR[[3]]$Study)),
                  rep('Fert',length(lnVR[[4]]$Study)),
                  rep('Fert',length(lnVR[[5]]$Study)),
                  rep('LUC',length(lnVR[[6]]$Study)),
                  rep('LUC',length(lnVR[[7]]$Study)),
                  rep('LUC',length(lnVR[[8]]$Study)),
                  rep('LUC',length(lnVR[[9]]$Study)),
                  rep('LUC',length(lnVR[[10]]$Study)),
                  rep('LUC',length(lnVR[[11]]$Study)),
                  rep('Inv',length(lnVR[[12]]$Study))
                  )


# stressor_VR <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_VR <-  c(rep('E',length(lnVR[[1]]$Study)),
                  rep('E',length(lnVR[[2]]$Study)),
                  rep('E',length(lnVR[[3]]$Study)),
                  rep('E',length(lnVR[[4]]$Study)),
                  rep('E',length(lnVR[[5]]$Study)),
                  rep('O',length(lnVR[[6]]$Study)),
                  rep('O',length(lnVR[[7]]$Study)),
                  rep('O',length(lnVR[[8]]$Study)),
                  rep('O',length(lnVR[[9]]$Study)),
                  rep('O',length(lnVR[[10]]$Study)),
                  rep('O',length(lnVR[[11]]$Study)),
                  rep('O',length(lnVR[[12]]$Study))
                  )

# approach_VR <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_VR <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")


studyID_VR <- unlist(studyID_VR)
power.F_VR <- unlist(power.F_VR)
power.F.S_VR <- unlist(power.F.S_VR)
power.F.M_VR <- unlist(power.F.M_VR)
power.F.M2_VR <- unlist(power.F.M2_VR)
power.R_VR <- unlist(power.R_VR)
power.R.S_VR <- unlist(power.R.S_VR)
power.R.M_VR <- unlist(power.R.M_VR)
power.R.M2_VR <- unlist(power.R.M2_VR)


individual_est_VR <- data.frame("MA_case_VR" = MA_case_VR,
                                "studyID_VR" = studyID_VR,
                                "stressor_VR" = stressor_VR,
                                "approach_VR" = approach_VR,
                                "power.F_VR" = power.F_VR,
                                "power.F.S_VR" = power.F.S_VR,
                                "power.F.M_VR" = power.F.M_VR,
                                "power.F.M2_VR" = power.F.M2_VR,
                                "power.R_VR" = power.R_VR,
                                "power.R.S_VR" = power.R.S_VR,
                                "power.R.M_VR" = power.R.M_VR,
                                "power.R.M2_VR" = power.R.M2_VR)

#add false positive report probability (FRP)
individual_est_VR$FRP <- (0.05 * (1 - 0.5)) / (0.05 * (1 - 0.5) + 0.5*individual_est_VR$power.F_VR)

MMA_power.F_VR_FRP <- lmer(log(FRP) ~ 1 + (1 | studyID_VR), data = individual_est_VR)
# this is median 
summary(MMA_power.F_VR_FRP)$coefficients[1] %>% exp()

# save(individual_est_VR,file = here("data","individual_est_VR.RData"))
# save(power.F.M_VR,file = here("data","power.F.M_VR.RData"))
# save(power.R.M_VR,file = here("data","power.R.M_VR.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_VR.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_VR <- lmer(power.F_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)
summary(MMA_power.F_VR)$coefficients[1]
# log
MMA_power.F_VR2 <- lmer(log(power.F_VR) ~ 1 + (1 | studyID_VR), data = individual_est_VR)
# this is median 
summary(MMA_power.F_VR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_VR2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F_VR))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_VR2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_VR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_VR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_VR as fixed effect and stressor as random effect
MMA_power.F_VR.approach <- lmer(power.F_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.F_VR.approach)$coefficients
# log
MMA_power.F_VR.approach2 <- lmer(log(power.F_VR) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.F_VR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F_VR[individual_est_VR$approach_VR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.F_VR[individual_est_VR$approach_VR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_VR.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_VR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_VR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_power.F_VR.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 



# contrasting model
MMA_power.F_VR.approach4 <- lmer(log(power.F_VR) ~ 1 + I(approach_VR) + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# check p value
summary(MMA_power.F_VR.approach4)

#---------------------- (2) type S error -----------------------#
MMA_power.F.S_VR <- lmer(power.F.S_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)
summary(MMA_power.F.S_VR)$coefficients[1]
# log
MMA_power.F.S_VR2 <- lmer(log(power.F.S_VR + 0.025) ~ 1 + (1 | studyID_VR), data = individual_est_VR)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_VR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_VR2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_VR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_VR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_VR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
png(filename = "./Figures/residual/S_VR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_VR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_VR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()



# include approach_VR as fixed effect and stressor as random effect
MMA_power.F.S_VR.approach <- lmer(power.F.S_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.F.S_VR.approach)$coefficients
# log
MMA_power.F.S_VR.approach2 <- lmer(log(power.F.S_VR + 0.025) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.F.S_VR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_VR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_VR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_VR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_VR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_VR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_VR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_VR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_VR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_VR.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.F.S_VR.approach4 <- lmer(log(power.F.S_VR + 0.025) ~ 1 + I(approach_VR) + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# check p value
summary(MMA_power.F.S_VR.approach4)

#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_VR <- lmer(power.F.M_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)

summary(MMA_power.F.M_VR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnVR are very low. This probably makes some of Type M eVRor extremely high. 

# but log transformation can work
MMA_power.F.M_VR2 <- lmer(log(power.F.M_VR) ~ 1 + (1 | studyID_VR), data = individual_est_VR)

# this is median
summary(MMA_power.F.M_VR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(summary(MMA_power.F.M_VR2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F.M_VR))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_VR2) %>% exp()

# make plot
png(filename = "./Figures/residual/M_CVR.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_VR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_VR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 
dev.off()

# include approach_VR as fixed effect and stressor as random effect
MMA_power.F.M_VR.approach <- lmer(power.F.M_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.F.M_VR.approach)$coefficients
# log
MMA_power.F.M_VR.approach2 <- lmer(log(power.F.M_VR) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.F.M_VR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F.M_VR[individual_est_VR$approach_VR=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.F.M_VR[individual_est_VR$approach_VR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_VR.approach2) %>% exp()


# contrasting model
MMA_power.F.M_VR.approach4 <- lmer(log(power.F.M_VR) ~ 1 + I(approach_VR) + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# check p value
summary(MMA_power.F.M_VR.approach4)

#---------------------- (2) type M2 error -----------------------#

MMA_power.F.M2_VR <- lmer(power.F.M2_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)

summary(MMA_power.F.M2_VR)$coefficients[1] 

# log 
MMA_power.F.M2_VR2 <- lmer(log(power.F.M2_VR+0.025) ~ 1 + (1 | studyID_VR), data = individual_est_VR)

# this is median
summary(MMA_power.F.M2_VR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(summary(MMA_power.F.M2_VR2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F.M2_VR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_VR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_VR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_VR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_VR as fixed effect and stressor as random effect
MMA_power.F.M2_VR.approach <- lmer(power.F.M2_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.F.M2_VR.approach)$coefficients
# log
MMA_power.F.M2_VR.approach2 <- lmer(log(power.F.M2_VR + 0.025) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.F.M2_VR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.F.M2_VR[individual_est_VR$approach_VR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.F.M2_VR[individual_est_VR$approach_VR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_VR.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_VR <- lmer(power.R_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)
summary(MMA_power.R_VR)$coefficients[1]
# log
MMA_power.R_VR2 <- lmer(log(power.R_VR) ~ 1 + (1 | studyID_VR), data = individual_est_VR)
# this is median 
summary(MMA_power.R_VR2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_VR2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R_VR))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_VR2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_VR) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_VR2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_VR as fixed effect and stressor as random effect
MMA_power.R_VR.approach <- lmer(power.R_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.R_VR.approach)$coefficients
# log
MMA_power.R_VR.approach2 <- lmer(log(power.R_VR) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.R_VR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R_VR[individual_est_VR$approach_VR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.R_VR[individual_est_VR$approach_VR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_VR.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_VR.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_VR.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_VR <- lmer(power.R.S_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)
summary(MMA_power.R.S_VR)$coefficients[1]

# log
MMA_power.R.S_VR2 <- lmer(log(power.R.S_VR + 0.025) ~ 1 + (1 | studyID_VR), data = individual_est_VR)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_VR2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_VR2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_VR2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_VR2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_VR2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
png(filename = "./Figures/residual/S_VR2.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_VR) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_VR2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()



# include approach_VR as fixed effect and stressor as random effect
MMA_power.R.S_VR.approach <- lmer(power.R.S_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.R.S_VR.approach)$coefficients
# log
MMA_power.R.S_VR.approach2 <- lmer(log(power.R.S_VR + 0.025) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.R.S_VR.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_VR.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_VR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_VR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_VR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_VR.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_VR.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_VR.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_VR.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_VR.approach2) %>% exp()


#---------------------- (2) type M error -----------------------#

MMA_power.R.M_VR <- lmer(power.R.M_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)

summary(MMA_power.R.M_VR)$coefficients[1] # I checked the raw data and found that some sampling variances of lnVR are very low. This probably makes some of Type M eVRor extremely high. 

# but log transformation can work
MMA_power.R.M_VR2 <- lmer(log(power.R.M_VR) ~ 1 + (1 | studyID_VR), data = individual_est_VR)

# this is median
summary(MMA_power.R.M_VR2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(summary(MMA_power.R.M_VR2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R.M_VR))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_VR2) %>% exp()

# make plot
png(filename = "./Figures/residual/M_VR2.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_VR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_VR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual")
dev.off()


# include approach_VR as fixed effect and stressor as random effect
MMA_power.R.M_VR.approach <- lmer(power.R.M_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.R.M_VR.approach)$coefficients
# log
MMA_power.R.M_VR.approach2 <- lmer(log(power.R.M_VR) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.R.M_VR.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R.M_VR[individual_est_VR$approach_VR=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.R.M_VR[individual_est_VR$approach_VR=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_VR.approach2) %>% exp()



#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_VR <- lmer(power.R.M2_VR ~ 1 + (1 | studyID_VR), data = individual_est_VR)

summary(MMA_power.R.M2_VR)$coefficients[1] 

# log 
MMA_power.R.M2_VR2 <- lmer(log(power.R.M2_VR+0.025) ~ 1 + (1 | studyID_VR), data = individual_est_VR)

# this is median
summary(MMA_power.R.M2_VR2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coVRect but it is fine for now)
(summary(MMA_power.R.M2_VR2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R.M2_VR+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_VR2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_VR) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_VR2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_VR as fixed effect and stressor as random effect
MMA_power.R.M2_VR.approach <- lmer(power.R.M2_VR ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
summary(MMA_power.R.M2_VR.approach)$coefficients
# log
MMA_power.R.M2_VR.approach2 <- lmer(log(power.R.M2_VR + 0.025) ~ 1 + I(approach_VR) -1 + (1 | studyID_VR) + (1 | stressor_VR), data = individual_est_VR)
# this is median
summary(MMA_power.R.M2_VR.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_VR.approach2)$coefficients[1] + 0.5*var(log(individual_est_VR$power.R.M2_VR[individual_est_VR$approach_VR=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_VR.approach2)$coefficients[2] + 0.5*var(log(individual_est_VR$power.R.M2_VR[individual_est_VR$approach_VR=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_VR.approach2) %>% exp() - 0.025

# #----------------------------------------------------------------#
# #           (i) intercept (overall mean) as true effect
# #----------------------------------------------------------------#
# # add study ID
# 
# # add N and k
# N_VR <- NA
# for (i in 1:length(lnVR)) {
#   N_VR[i] <- lnVR[[i]]$Unit_ID %>% length()
# }
# 
# k_VR <- NA
# for (i in 1:length(lnVR)) {
#   k_VR[i] <- lnVR[[i]]$Study %>% length()
# }
# 
# power.F_summary_VR$N <- N_VR
# power.F_summary_VR$k <- k_VR
# 
# 
# 
# approach_VR <- c("E", "E", "E", "E", "E", "O", "O", "O", "O", "O", "O", "O")
# 
# treatment_VR <- c("Pr","Pr", "Pr","Pr", "Pr", "Pr","Pr","Pr","Pr","Pr", "Pr", "Pr")
# 
# stressor_VR <- c("BD_loss","BD_loss", "Fert", "Fert", "Fert", "LUC","LUC","LUC","LUC","LUC", "LUC", "Inv")
# 
# stressor_VR %>% as.data.frame() # check the correctness
# 
# 
# moderator_VR <- cbind(approach_VR,treatment_VR,stressor_VR)
# 
# power.F_summary_VR <- cbind(power.F_summary_VR, moderator_VR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F_summary_VR$approach_VR <- factor(power.F_summary_VR$approach_VR, levels=c("O", "E"))
# 
# MMA_power.F_VR.approach <- with(power.F_summary_VR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_VR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F_VR.stressor <- with(power.F_summary_VR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_VR) -1, method = "REML", test = "t")) 
# 
# MMA_power.F_VR <- with(power.F_summary_VR, rma(yi = Mean, sei = se.F_mean,   method = "REML", test = "t"))
# 
# 
# 
# power.F.S_summary_VR <- cbind(power.F.S_summary_VR, moderator_VR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.S_summary_VR$approach_VR <- factor(power.F.S_summary_VR$approach_VR, levels=c("O", "E"))
# 
# MMA_power.F.S_VR.approach <- with(power.F.S_summary_VR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_VR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.S_VR.stressor <- with(power.F.S_summary_VR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_VR) -1, method = "REML", test = "t"))
# 
# MMA_power.F.S_VR <- with(power.F.S_summary_VR, rma(yi = Mean, sei = se.F.S_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# power.F.M_summary_VR <- cbind(power.F.M_summary_VR, moderator_VR)
# 
# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_VR$approach_VR <- factor(power.F.M_summary_VR$approach_VR, levels=c("O", "E"))
# 
# MMA_power.F.M_VR.approach <- with(power.F.M_summary_VR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_VR) -1, method = "REML", test = "t")) # relevel(approach, ref="O")
# 
# MMA_power.F.M_VR.stressor <- with(power.F.M_summary_VR, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(stressor_VR) -1, method = "REML", test = "t"))
# 
# MMA_power.F.M_VR <- with(power.F.M_summary_VR, rma(yi = Mean, sei = se.F.M_mean,   method = "REML", test = "t"))
# 
# MMA_power.F.M2_VR <- with(power.F.M2_summary_VR, rma(yi = Mean, sei = se.F.M2_mean,   method = "REML", test = "t"))
# 
# 
# 
# 
# 
# #----------------------------------------------------------------#
# #                 (ii) effect size specific effect as true effect
# #----------------------------------------------------------------#
# MMA_power.R_VR <- with(power.R_summary_VR, rma(yi = Mean, sei = se.R_mean,   method = "REML", test = "t"))
# 
# MMA_power.R.S_VR <- with(power.R.S_summary_VR, rma(yi = Mean, sei = se.R.S_mean,   method = "REML", test = "t"))
# 
# MMA_power.R.M_VR <- with(power.R.M_summary_VR, rma(yi = Mean, sei = se.R.M_mean,   method = "REML", test = "t"))
# 
# MMA_power.R.M2_VR <- with(power.R.M2_summary_VR, rma(yi = Mean, sei = se.R.M2_mean,   method = "REML", test = "t"))

```



### 4. SMD and lnRR

#### 4.1 MA power calculation

```{r}
#***************************************************************#
#             power for 12 meta-analytic cases                  #
#***************************************************************#


#save(dat_list_SMD,file = here("data","dat_list_SMD.RData"))
#save(lnrr, file = here("data","lnrr.RData"))
#save(model_est_lnrr, file = here("data","model_est_lnrr.RData"))

# make a list of data
dat_list_SMD <- list(raw_m1_1,
                           raw_m1_2,
                           raw_m2_1,
                           raw_m2_2,
                           raw_m5_1,
                           raw_m6_1,
                           raw_m6_2,
                           raw_m6_3,
                           raw_m6_4,
                           raw_m6_5,
                           raw_m9_1,
                           raw_m11_1)

# calculate the number of total effect sizes - sample size
ES_number <- NA
ES_number <- mapply(unique, sapply(dat_list_SMD, function(x) x$Unit_ID)) 
unlist(ES_number) %>% length() # 2004


# calculate 2 type of effect size statistics (i.e.SMD and lnRR)

SMD <- NA
for (i in 1:length(dat_list_SMD)) {
  SMD[i] <- escalc(measure = "SMD",
                    m1i = T_mean,
                    m2i = C_mean,
                    sd1i = T_sd,
                    sd2i = C_sd,
                    n1i = T_N,
                    n2i = C_N,
                    data = dat_list_SMD[[i]]) %>% list()
}

lnrr <- NA
for (i in 1:length(dat_list_SMD)) {
  lnrr[i] <- escalc(measure = "ROM",
                    m1i = T_mean,
                    m2i = C_mean,
                    sd1i = T_sd,
                    sd2i = C_sd,
                    n1i = T_N,
                    n2i = C_N,
                    data = dat_list_SMD[[i]]) %>% list()
} 


# clean NA
for (i in 1:12) {
  SMD[[i]] <- SMD[[i]][!is.na(SMD[[i]]$yi),]
}

for (i in 1:12) {
  lnrr[[i]] <- lnrr[[i]][!is.na(lnrr[[i]]$yi),]
}


# prepare "ture" effect of variation (i.e. SMD and lnrr) for power analysis - fit multi-level meta-analytic models
model_list_SMD<- NA
for (i in 1:length(dat_list_SMD)) {
 model_list_SMD[i] <- rma.mv(data = SMD[[i]], yi = yi, V = vi, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

model_list_lnrr<- NA
for (i in 1:length(dat_list_SMD)) {
 model_list_lnrr[i] <- rma.mv(data = lnrr[[i]], yi = yi, V = vi, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}


#****************************************************************#
#------------------------------SMD-----------------------------#
#****************************************************************#

# we assume meta-analytic mean as ture effect, so we need to get estimate (mu) and corresponding error (SE)
model_est_SMD <- data.frame(MA_case=c("m1_1",
                                      "m1_2",
                                      "m2_1",
                                      "m2_2",
                                      "m5_1",
                                      "m6_1",
                                      "m6_2",
                                      "m6_3",
                                      "m6_4",
                                      "m6_5",
                                      "m9_1",
                                      "m11_1"),
                  mu_SMD=sapply(model_list_SMD, function(x) x$beta),
                  SE_SMD=sapply(model_list_SMD, function(x) x$se),
                  ll_NHST=sapply(model_list_SMD, function(x) x$ci.lb),
                  ul_NHST=sapply(model_list_SMD, function(x) x$ci.ub),
                  p_value=sapply(model_list_SMD, function(x) x$pval) %>% round(4))



#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_SMD$MA.power <- power.ma_Shinichi(mu=model_est_SMD$mu,SE=model_est_SMD$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_SMD$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_SMD$mu[i],se=model_est_SMD$SE[i],alpha=0.05) %>% unlist()
}

model_est_SMD$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_SMD$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_SMD$mu[i],se=model_est_SMD$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_SMD$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_SMD$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_SMD$mu[i],se=model_est_SMD$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_SMD$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_SMD, file = "./meta-analysis power_SMD.csv", row.names = FALSE)


#****************************************************************#
#-------------------------------lnrr-----------------------------#
#****************************************************************#

# we assume meta-analytic mean as ture effect, so we need to get estimate (mu) and corresponding error (SE)

model_est_lnrr <- data.frame(MA_case=model_est_SMD$MA_case,
                  mu_lnrr=sapply(model_list_lnrr, function(x) x$beta),
                  SE_lnrr=sapply(model_list_lnrr, function(x) x$se),
                  ll_NHST=sapply(model_list_lnrr, function(x) x$ci.lb),
                  ul_NHST=sapply(model_list_lnrr, function(x) x$ci.ub),
                  p_value=sapply(model_list_lnrr, function(x) x$pval))

#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_lnrr$MA.power <- power.ma_Shinichi(mu=model_est_lnrr$mu,SE=model_est_lnrr$SE)

#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_lnrr$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_lnrr$mu[i],se=model_est_lnrr$SE[i],alpha=0.05) %>% unlist()
}

model_est_lnrr$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_lnrr$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_lnrr$mu[i],se=model_est_lnrr$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_lnrr$MA.power.M <- MA.power.M

#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#  
MA.power.M2 <- NA
for (i in 1:length(model_est_lnrr$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_lnrr$mu[i],se=model_est_lnrr$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_lnrr$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_lnrr, file = "./meta-analysis power_lnrr.csv", row.names = FALSE)
```


#### 4.2 Individual power calculation 

##### 4.2.1 Calculation

```{r}
#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference)


#****************************************************************#
#------------------------------SMD-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# SMD
power.F_SMD <- NA
for (i in 1:length(SMD)) {
  power.F_SMD[i] <- power.individual_Shinichi(mu=rep(model_list_SMD[[i]]$beta, length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_SMD)) {
  SMD[[i]]$power.F_SMD <- power.F_SMD[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_SMD <- NA
for (i in 1:length(SMD)) {
  power.F.S_SMD[i] <- mapply(error_S,mu=rep(model_list_SMD[[i]]$beta, length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_SMD)) {
  SMD[[i]]$power.F.S_SMD <- power.F.S_SMD[[i]]
}



#---------------- (3) type M error (relative error) --------------#
power.F.M_SMD <- NA
for (i in 1:length(SMD)) {
  power.F.M_SMD[i] <-mapply(error_M,mu=rep(model_list_SMD[[i]]$beta, length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_SMD)) {
  SMD[[i]]$power.F.M_SMD <- power.F.M_SMD[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_SMD <- NA
for (i in 1:length(SMD)) {
  power.F.M2_SMD[i] <-mapply(error_M2,mu=rep(model_list_SMD[[i]]$beta, length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_SMD)) {
  SMD[[i]]$power.F.M2_SMD <- power.F.M2_SMD[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_SMD <- NA
for (i in 1:length(model_list_SMD)) {
  blups.list_SMD[i] <- ranef(model_list_SMD[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_SMD <- NA # list()
for (i in 1:length(model_list_SMD)) {
  index.list_SMD[i] <- match(as.character(SMD[[i]]$Study),rownames(blups.list_SMD[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_SMD <-NA
for (i in 1:length(model_list_SMD)) {
  effect.R_SMD[i] <- mapply(sum, model_list_SMD[[i]]$beta, blups.list_SMD[[i]]$Study[index.list_SMD[[i]],1], blups.list_SMD[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_SMD <- NA
for (i in 1:length(dat_list_SMD)) {
  power.R_SMD[i] <- power.individual_Shinichi(mu=effect.R_SMD[[i]], se=sqrt(SMD[[i]]$vi)) %>% list()}

# plot(power_SMD[[1]]-power_SMD2[[1]]) - check discrepancy
# allocate each set of power into coSMDesponding dataset
for (i in 1:length(power.R_SMD)) {
  SMD[[i]]$power.R_SMD <- power.R_SMD[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_SMD <- NA
for (i in 1:12) {
  power.R.S_SMD[i] <- mapply(error_S, mu=effect.R_SMD[[i]], se=sqrt(SMD[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into coSMDesponding dataset
for (i in 1:length(power.R.S_SMD)) {
  SMD[[i]]$power.R.S_SMD <- power.R.S_SMD[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_SMD <- NA
for (i in 1:12) {
  power.R.M_SMD[i] <- mapply(error_M, mu=effect.R_SMD[[i]], se=sqrt(SMD[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDesponding dataset
for (i in 1:length(power.R.M_SMD)) {
  SMD[[i]]$power.R.M_SMD <- power.R.M_SMD[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_SMD <- NA
for (i in 1:12) {
  power.R.M2_SMD[i] <- mapply(error_M2, mu=effect.R_SMD[[i]], se=sqrt(SMD[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDesponding dataset
for (i in 1:length(power.R.M2_SMD)) {
  SMD[[i]]$power.R.M2_SMD <- power.R.M2_SMD[[i]]
}





#****************************************************************#
#------------------------------lnrr-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# lnrr
power.F_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F_lnrr[i] <- power.individual_Shinichi(mu=rep(model_list_lnrr[[i]]$beta, length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_lnrr)) {
  lnrr[[i]]$power.F_lnrr <- power.F_lnrr[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F.S_lnrr[i] <- mapply(error_S,mu=rep(model_list_lnrr[[i]]$beta, length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_lnrr)) {
  lnrr[[i]]$power.F.S_lnrr <- power.F.S_lnrr[[i]]
}



#---------------- (3) type M error (relative error) --------------#
power.F.M_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F.M_lnrr[i] <-mapply(error_M,mu=rep(model_list_lnrr[[i]]$beta, length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_lnrr)) {
  lnrr[[i]]$power.F.M_lnrr <- power.F.M_lnrr[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F.M2_lnrr[i] <-mapply(error_M2,mu=rep(model_list_lnrr[[i]]$beta, length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_lnrr)) {
  lnrr[[i]]$power.F.M2_lnrr <- power.F.M2_lnrr[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_lnrr <- NA
for (i in 1:length(model_list_lnrr)) {
  blups.list_lnrr[i] <- ranef(model_list_lnrr[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_lnrr <- NA # list()
for (i in 1:length(model_list_lnrr)) {
  index.list_lnrr[i] <- match(as.character(lnrr[[i]]$Study),rownames(blups.list_lnrr[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_lnrr <-NA
for (i in 1:length(model_list_lnrr)) {
  effect.R_lnrr[i] <- mapply(sum, model_list_lnrr[[i]]$beta, blups.list_lnrr[[i]]$Study[index.list_lnrr[[i]],1], blups.list_lnrr[[i]]$Unit_ID[,1]) %>% list()
}



#--------------------- (1) two tailed power ---------------------#
power.R_lnrr <- NA
for (i in 1:length(dat_list_SMD)) {
  power.R_lnrr[i] <- power.individual_Shinichi(mu=effect.R_lnrr[[i]], se=sqrt(lnrr[[i]]$vi)) %>% list()}

# plot(power_lnrr[[1]]-power_lnrr2[[1]]) - check discrepancy
# allocate each set of power into colnrresponding dataset
for (i in 1:length(power.R_SMD)) {
  lnrr[[i]]$power.R_lnrr <- power.R_lnrr[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_lnrr <- NA
for (i in 1:12) {
  power.R.S_lnrr[i] <- mapply(error_S, mu=effect.R_lnrr[[i]], se=sqrt(lnrr[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into colnrresponding dataset
for (i in 1:length(power.R.S_lnrr)) {
  lnrr[[i]]$power.R.S_lnrr <- power.R.S_lnrr[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_lnrr <- NA
for (i in 1:12) {
  power.R.M_lnrr[i] <- mapply(error_M, mu=effect.R_lnrr[[i]], se=sqrt(lnrr[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into colnrresponding dataset
for (i in 1:length(power.R.M_lnrr)) {
  lnrr[[i]]$power.R.M_lnrr <- power.R.M_lnrr[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_lnrr <- NA
for (i in 1:12) {
  power.R.M2_lnrr[i] <- mapply(error_M2, mu=effect.R_lnrr[[i]], se=sqrt(lnrr[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into colnrresponding dataset
for (i in 1:length(power.R.M2_lnrr)) {
  lnrr[[i]]$power.R.M2_lnrr <- power.R.M2_lnrr[[i]]
}
```


##### 4.2.2 Summary of individual power
```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMD------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.F_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.F_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.F_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.F_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.F_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.F_SMD))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.F.S_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.F.S_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.F.S_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.F.S_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.F.S_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.F.S_SMD))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.F.M_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.F.M_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.F.M_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.F.M_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.F.M_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.F.M_SMD))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.F.M2_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.F.M2_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.F.M2_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.F.M2_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.F.M2_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.F.M2_SMD))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.R_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.R_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.R_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.R_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.R_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.R_SMD))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.R.S_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.R.S_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.R.S_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.R.S_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.R.S_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.R.S_SMD))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.R.M_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.R.M_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.R.M_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.R.M_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.R.M_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.R.M_SMD))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_SMD <- data.frame(MA_case=model_est_SMD$MA_case,
                   Minimum=mapply(summary, sapply(SMD, function(x) x$power.R.M2_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(SMD, function(x) x$power.R.M2_SMD))[2,],
                   Median=mapply(summary, sapply(SMD, function(x) x$power.R.M2_SMD))[3,],
                   Mean=mapply(summary, sapply(SMD, function(x) x$power.R.M2_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMD, function(x) x$power.R.M2_SMD))[5,], 
                   Maximum=mapply(summary, sapply(SMD, function(x) x$power.R.M2_SMD))[6,]) 





#****************************************************************#
#-----------------------------lnrr-------------------------------#
#****************************************************************#

#clean NA - ma1.1 has NA
for (i in 1:12) { lnrr[[i]] <- lnrr[[i]][!is.na(lnrr[[i]]$power.R_lnrr),]} # also power.F_lnrr

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#

power.F_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[6,]) 



# clean NA - ma1.1 has NA
#for (i in 1:12) { lnrr[[i]] <- lnrr[[i]][!is.na(lnrr[[i]]$power.R_lnrr),]}
```


##### 4.2.3 SE of individual power

```{r}
#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMD------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_SMD
se.F_mean <- NA
for (i in 1:length(SMD)) {
  se.F_mean[i] <- sd(SMD[[i]]$power.F_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.F_SMD[!is.na(SMD[[i]]$power.F_SMD)]))
}

power.F_summary_SMD$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_SMD
se.F.S_mean <- NA
for (i in 1:length(SMD)) {
  se.F.S_mean[i] <- sd(SMD[[i]]$power.F.S_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.F.S_SMD[!is.na(SMD[[i]]$power.F.S_SMD)]))
}

power.F.S_summary_SMD$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_SMD
se.F.M_mean <- NA
for (i in 1:length(SMD)) {
  se.F.M_mean[i] <- sd(SMD[[i]]$power.F.M_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.F.M_SMD[!is.na(SMD[[i]]$power.F.M_SMD)]))
}

power.F.M_summary_SMD$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(SMD)) {
  se.F.M2_mean[i] <- sd(SMD[[i]]$power.F.M2_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.F.M2_SMD[!is.na(SMD[[i]]$power.F.M2_SMD)]))
}

power.F.M2_summary_SMD$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_SMD
se.R_mean <- NA
for (i in 1:length(SMD)) {
  se.R_mean[i] <- sd(SMD[[i]]$power.R_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.R_SMD[!is.na(SMD[[i]]$power.R_SMD)]))
}

power.R_summary_SMD$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_SMD
se.R.S_mean <- NA
for (i in 1:length(SMD)) {
  se.R.S_mean[i] <- sd(SMD[[i]]$power.R.S_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.R.S_SMD[!is.na(SMD[[i]]$power.R.S_SMD)]))
}

power.R.S_summary_SMD$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_SMD
se.R.M_mean <- NA
for (i in 1:length(SMD)) {
  se.R.M_mean[i] <- sd(SMD[[i]]$power.R.M_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.R.M_SMD[!is.na(SMD[[i]]$power.R.M_SMD)]))
}

power.R.M_summary_SMD$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(SMD)) {
  se.R.M2_mean[i] <- sd(SMD[[i]]$power.R.M2_SMD, na.rm=TRUE) / sqrt(length(SMD[[i]]$power.R.M2_SMD[!is.na(SMD[[i]]$power.R.M2_SMD)]))
}

power.R.M2_summary_SMD$se.R.M2_mean <- se.R.M2_mean







#****************************************************************#
#-----------------------------lnrr-------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_lnrr
se.F_mean <- NA
for (i in 1:length(lnrr)) {
  se.F_mean[i] <- sd(lnrr[[i]]$power.F_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F_lnrr[!is.na(lnrr[[i]]$power.F_lnrr)]))
}

power.F_summary_lnrr$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_lnrr
se.F.S_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.S_mean[i] <- sd(lnrr[[i]]$power.F.S_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F.S_lnrr[!is.na(lnrr[[i]]$power.F.S_lnrr)]))
}

power.F.S_summary_lnrr$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_lnrr
se.F.M_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.M_mean[i] <- sd(lnrr[[i]]$power.F.M_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F.M_lnrr[!is.na(lnrr[[i]]$power.F.M_lnrr)]))
}

power.F.M_summary_lnrr$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.M2_mean[i] <- sd(lnrr[[i]]$power.F.M2_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F.M2_lnrr[!is.na(lnrr[[i]]$power.F.M2_lnrr)]))
}

power.F.M2_summary_lnrr$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_lnrr
se.R_mean <- NA
for (i in 1:length(lnrr)) {
  se.R_mean[i] <- sd(lnrr[[i]]$power.R_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R_lnrr[!is.na(lnrr[[i]]$power.R_lnrr)]))
}

power.R_summary_lnrr$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_lnrr
se.R.S_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.S_mean[i] <- sd(lnrr[[i]]$power.R.S_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R.S_lnrr[!is.na(lnrr[[i]]$power.R.S_lnrr)]))
}

power.R.S_summary_lnrr$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_lnrr
se.R.M_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.M_mean[i] <- sd(lnrr[[i]]$power.R.M_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R.M_lnrr[!is.na(lnrr[[i]]$power.R.M_lnrr)]))
}

power.R.M_summary_lnrr$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.M2_mean[i] <- sd(lnrr[[i]]$power.R.M2_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R.M2_lnrr[!is.na(lnrr[[i]]$power.R.M2_lnrr)]))
}

power.R.M2_summary_lnrr$se.R.M2_mean <- se.R.M2_mean
```


#### 4.3 Regression

##### 4.3.1 MA power

```{r}

#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#****************************************************************#
#-----------------------------SMD------------------------------#
#****************************************************************#

# add N and k
N_SMD <- NA
for (i in 1:length(SMD)) {
  N_SMD[i] <- SMD[[i]]$Study %>% unique() %>% length()
}

k_SMD <- NA
for (i in 1:length(SMD)) {
  k_SMD[i] <- SMD[[i]]$Unit_ID%>% length()
}

model_est_SMD$k <- k_SMD
model_est_SMD$N <- N_SMD


# n
for (i in 1:12) {
  SMD[[i]]$n_total <- SMD[[i]]$C_N + SMD[[i]]$T_N }

n_total_SMD <- NA
for (i in 1:12) {
  n_total_SMD[i] <- SMD[[i]]$n_total %>% sum }

model_est_SMD$n <- n_total_SMD

# load meta-analysis level power
#load(here("data","model_est_SMD.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_SMD <- lm(MA.power~1, weights = k, data = model_est_SMD) 
MMA_MA_SMD$coefficients
# log
MMA_MA_SMD2 <- lm(log(MA.power)~1, weights = k, data = model_est_SMD)
# this is median
MMA_MA_SMD2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_SMD2$coefficients + 0.5*var(log(model_est_SMD$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_SMD2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_SMD) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_SMD2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_SMD <- lm(MA.power.S~1, weights = k, data = model_est_SMD) 
MMA_MA.S_SMD$coefficients
# log
MMA_MA.S_SMD2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_SMD) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_SMD2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_SMD2$coefficients + 0.5*var(log(model_est_SMD$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_SMD) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_SMD2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_SMD <- lm(MA.power.M~1, weights = k, data = model_est_SMD) 
MMA_MA.M_SMD$coefficients
# log
MMA_MA.M_SMD2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_SMD)
# this is median
MMA_MA.M_SMD2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coSMDect but it is fine for now)
(MMA_MA.M_SMD2$coefficients + 0.5*var(log(model_est_SMD$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_SMD2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_SMD <- lm(MA.power.M2~1, weights = k, data = model_est_SMD) 
MMA_MA.M2_SMD$coefficients
# log
MMA_MA.M2_SMD2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_SMD)
# this is median
MMA_MA.M2_SMD2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coSMDect but it is fine for now)
(MMA_MA.M2_SMD2$coefficients + 0.5*var(log(model_est_SMD$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



#****************************************************************#
#-----------------------------lnrr------------------------------#
#****************************************************************#

# add N and k
N_lnrr <- NA
for (i in 1:length(lnrr)) {
  N_lnrr[i] <- lnrr[[i]]$Study %>% unique() %>% length()
}

k_lnrr <- NA
for (i in 1:length(lnrr)) {
  k_lnrr[i] <- lnrr[[i]]$Unit_ID%>% length()
}

model_est_lnrr$k <- k_lnrr
model_est_lnrr$N <- N_lnrr


for (i in 1:12) {
  lnrr[[i]]$n_total <- lnrr[[i]]$C_N + lnrr[[i]]$T_N }

n_total_lnrr <- NA
for (i in 1:12) {
  n_total_lnrr[i] <- lnrr[[i]]$n_total %>% sum }

model_est_lnrr$n <- n_total_lnrr


# load meta-analysis level power
#load(here("data","model_est_lnrr.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_lnrr <- lm(MA.power~1, weights = k, data = model_est_lnrr) 
MMA_MA_lnrr$coefficients
# log
MMA_MA_lnrr2 <- lm(log(MA.power)~1, weights = k, data = model_est_lnrr)
# this is median
MMA_MA_lnrr2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(MMA_MA_lnrr2$coefficients + 0.5*var(log(model_est_lnrr$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_lnrr2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_lnrr) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_lnrr2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_lnrr <- lm(MA.power.S~1, weights = k, data = model_est_lnrr) 
MMA_MA.S_lnrr$coefficients
# log
MMA_MA.S_lnrr2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_lnrr) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_lnrr2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_lnrr2$coefficients + 0.5*var(log(model_est_lnrr$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_lnrr) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_lnrr2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_lnrr <- lm(MA.power.M~1, weights = k, data = model_est_lnrr) 
MMA_MA.M_lnrr$coefficients
# log
MMA_MA.M_lnrr2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_lnrr)
# this is median
MMA_MA.M_lnrr2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(MMA_MA.M_lnrr2$coefficients + 0.5*var(log(model_est_lnrr$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_lnrr2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_lnrr <- lm(MA.power.M2~1, weights = k, data = model_est_lnrr) 
MMA_MA.M2_lnrr$coefficients
# log
MMA_MA.M2_lnrr2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_lnrr)
# this is median
MMA_MA.M2_lnrr2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(MMA_MA.M2_lnrr2$coefficients + 0.5*var(log(model_est_lnrr$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 
```



##### 4.3.2 Individual power

###### 4.3.2.1 SMD

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#****************************************************************#
#-----------------------------SMD------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


## make study identity unique incase some studies have same identities
# SMD[[1]]$Study <- paste("m1_1_", SMD[[1]]$Study, sep = "")
# SMD[[2]]$Study <- paste("m1_2_", SMD[[2]]$Study, sep = "")
# SMD[[3]]$Study <- paste("m2_1_", SMD[[3]]$Study, sep = "")
# SMD[[4]]$Study <- paste("m2_2_", SMD[[4]]$Study, sep = "")
# SMD[[5]]$Study <- paste("m5_1_", SMD[[5]]$Study, sep = "")
# SMD[[6]]$Study <- paste("m6_1_", SMD[[6]]$Study, sep = "")
# SMD[[7]]$Study <- paste("m6_2_", SMD[[7]]$Study, sep = "")
# SMD[[8]]$Study <- paste("m6_3_", SMD[[8]]$Study, sep = "")
# SMD[[9]]$Study <- paste("m6_4_", SMD[[9]]$Study, sep = "")
# SMD[[10]]$Study <- paste("m6_5_", SMD[[10]]$Study, sep = "")
# SMD[[11]]$Study <- paste("m9_1_", SMD[[11]]$Study, sep = "")
# SMD[[12]]$Study <- paste("m11_1_", SMD[[12]]$Study, sep = "")


# numer of replicates n
n_total_SMD <- NA
for (i in 1:length(SMD)) {
  n_total_SMD[i] <- SMD[[i]]$n_total %>% list()
}
n_total_SMD <- n_total_SMD %>% unlist()
summary(n_total_SMD)

# individual effect size and sampling variance
es_SMD <- NA
for (i in 1:length(SMD)) {
  es_SMD[i] <- SMD[[i]]$yi %>% list()
}

v_SMD <- NA
for (i in 1:length(SMD)) {
  v_SMD[i] <- SMD[[i]]$vi %>% list()
}



studyID_SMD <- NA
for (i in 1:length(SMD)) {
  studyID_SMD[i] <- SMD[[i]]$Study %>% list()
}




MA_case_SMD <-  c(rep('m1_1',length(SMD[[1]]$Study)),
                  rep('m1_2',length(SMD[[2]]$Study)),
                  rep('m2_1',length(SMD[[3]]$Study)),
                  rep('m2_2',length(SMD[[4]]$Study)),
                  rep('m5_1',length(SMD[[5]]$Study)),
                  rep('m6_1',length(SMD[[6]]$Study)),
                  rep('m6_2',length(SMD[[7]]$Study)),
                  rep('m6_3',length(SMD[[8]]$Study)),
                  rep('m6_4',length(SMD[[9]]$Study)),
                  rep('m6_5',length(SMD[[10]]$Study)),
                  rep('m9_1',length(SMD[[11]]$Study)),
                  rep('m11_1',length(SMD[[12]]$Study))
                  )
#MA_case_SMD <- c("1m1_1",  "2m1_2",  "3m2_1",  "4m2_2",  "5m5_1",  "6m6_1",  "7m6_2",  "8m6_3",  "9m6_4",  "10m6_5",  "11m9_1", "12m11_1")


stressor_SMD <-  c(rep('BD_loss',length(SMD[[1]]$Study)),
                  rep('BD_loss',length(SMD[[2]]$Study)),
                  rep('Fert',length(SMD[[3]]$Study)),
                  rep('Fert',length(SMD[[4]]$Study)),
                  rep('Fert',length(SMD[[5]]$Study)),
                  rep('LUC',length(SMD[[6]]$Study)),
                  rep('LUC',length(SMD[[7]]$Study)),
                  rep('LUC',length(SMD[[8]]$Study)),
                  rep('LUC',length(SMD[[9]]$Study)),
                  rep('LUC',length(SMD[[10]]$Study)),
                  rep('LUC',length(SMD[[11]]$Study)),
                  rep('Inv',length(SMD[[12]]$Study))
                  )


#stressor_SMD <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_SMD <-  c(rep('E',length(SMD[[1]]$Study)),
                  rep('E',length(SMD[[2]]$Study)),
                  rep('E',length(SMD[[3]]$Study)),
                  rep('E',length(SMD[[4]]$Study)),
                  rep('E',length(SMD[[5]]$Study)),
                  rep('O',length(SMD[[6]]$Study)),
                  rep('O',length(SMD[[7]]$Study)),
                  rep('O',length(SMD[[8]]$Study)),
                  rep('O',length(SMD[[9]]$Study)),
                  rep('O',length(SMD[[10]]$Study)),
                  rep('O',length(SMD[[11]]$Study)),
                  rep('O',length(SMD[[12]]$Study))
                  )

#approach_SMD <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_SMD <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")

es_SMD <- unlist(es_SMD)
v_SMD <- unlist(v_SMD)

studyID_SMD <- unlist(studyID_SMD)
power.F_SMD <- unlist(power.F_SMD)
power.F.S_SMD <- unlist(power.F.S_SMD)
power.F.M_SMD <- unlist(power.F.M_SMD)
power.F.M2_SMD <- unlist(power.F.M2_SMD)
power.R_SMD <- unlist(power.R_SMD)
power.R.S_SMD <- unlist(power.R.S_SMD)
power.R.M_SMD <- unlist(power.R.M_SMD)
power.R.M2_SMD <- unlist(power.R.M2_SMD)
n_total_SMD <- unlist(n_total_SMD)

individual_est_SMD <- data.frame("es_SMD" = es_SMD,
                                 "v_SMD" = v_SMD,
                                 "MA_case_SMD" = MA_case_SMD,
                                 "studyID_SMD" = studyID_SMD,
                                "stressor_SMD" = stressor_SMD,
                                "approach_SMD" = approach_SMD,
                                "power.F_SMD" = power.F_SMD,
                                "power.F.S_SMD" = power.F.S_SMD,
                                "power.F.M_SMD" = power.F.M_SMD,
                                "power.F.M2_SMD" = power.F.M2_SMD,
                                "power.R_SMD" = power.R_SMD,
                                "power.R.S_SMD" = power.R.S_SMD,
                                "power.R.M_SMD" = power.R.M_SMD,
                                "power.R.M2_SMD" = power.R.M2_SMD)

individual_est_SMD$n_total_SMD <- n_total_SMD
#plot(individual_est_SMD$n_total_SMD, individual_est_SMD$power.F_SMD)

# save(individual_est_SMD,file = here("data","individual_est_SMD.RData"))
# save(power.F.M_SMD,file = here("data","power.F.M_SMD.RData"))
# save(power.R.M_SMD,file = here("data","power.R.M_SMD.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_SMD.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_SMD <- lmer(power.F_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
summary(MMA_power.F_SMD)$coefficients[1]
# log
MMA_power.F_SMD2 <- lmer(log(power.F_SMD) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
# this is median 
summary(MMA_power.F_SMD2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_SMD2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F_SMD))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_SMD2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_SMD) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_SMD2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_SMD as fixed effect and stressor as random effect
MMA_power.F_SMD.approach <- lmer(power.F_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.F_SMD.approach)$coefficients
# log
MMA_power.F_SMD.approach2 <- lmer(log(power.F_SMD) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.F_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F_SMD[individual_est_SMD$approach_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.F_SMD[individual_est_SMD$approach_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_SMD.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_SMD.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_SMD.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 



# contrasting model
MMA_power.F_SMD.approach4 <- lmer(log(power.F_SMD) ~ 1 + I(approach_SMD) + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# check p value
summary(MMA_power.F_SMD.approach4)


#---------------------- (2) type S error -----------------------#
MMA_power.F.S_SMD <- lmer(power.F.S_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
summary(MMA_power.F.S_SMD)$coefficients[1]
# log
MMA_power.F.S_SMD2 <- lmer(log(power.F.S_SMD + 0.025) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
png(filename = "./Figures/residual/S.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_SMD) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_SMD2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()
#residuals(MMA_power.F.S_SMD3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_SMD as fixed effect and stressor as random effect
MMA_power.F.S_SMD.approach <- lmer(power.F.S_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.F.S_SMD.approach)$coefficients
# log
MMA_power.F.S_SMD.approach2 <- lmer(log(power.F.S_SMD + 0.025) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.F.S_SMD.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_SMD.approach2) %>% exp() - 0.025




# contrasting model
MMA_power.F.S_SMD.approach4 <- lmer(log(power.F.S_SMD + 0.025) ~ 1 + I(approach_SMD) + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# check p value
summary(MMA_power.F.S_SMD.approach4)


#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_SMD <- lmer(power.F.M_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

summary(MMA_power.F.M_SMD)$coefficients[1] # I checked the raw data and found that some sampling variances of lnSMD are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.F.M_SMD2 <- lmer(log(power.F.M_SMD) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

# this is median
summary(MMA_power.F.M_SMD2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coSMDect but it is fine for now)
(summary(MMA_power.F.M_SMD2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F.M_SMD))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_SMD2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_SMD as fixed effect and stressor as random effect
MMA_power.F.M_SMD.approach <- lmer(power.F.M_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.F.M_SMD.approach)$coefficients
# log
MMA_power.F.M_SMD.approach2 <- lmer(log(power.F.M_SMD) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.F.M_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F.M_SMD[individual_est_SMD$approach_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.F.M_SMD[individual_est_SMD$approach_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_SMD.approach2) %>% exp()


# contrasting model
MMA_power.F.M_SMD.approach4 <- lmer(log(power.F.M_SMD) ~ 1 + I(approach_SMD) + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# check p value
summary(MMA_power.F.M_SMD.approach4)

#---------------------- (2) type M2 error -----------------------#

MMA_power.F.M2_SMD <- lmer(power.F.M2_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

summary(MMA_power.F.M2_SMD)$coefficients[1] 

# log 
MMA_power.F.M2_SMD2 <- lmer(log(power.F.M2_SMD+0.025) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

# this is median
summary(MMA_power.F.M2_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coSMDect but it is fine for now)
(summary(MMA_power.F.M2_SMD2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F.M2_SMD+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_SMD2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_SMD as fixed effect and stressor as random effect
MMA_power.F.M2_SMD.approach <- lmer(power.F.M2_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.F.M2_SMD.approach)$coefficients
# log
MMA_power.F.M2_SMD.approach2 <- lmer(log(power.F.M2_SMD + 0.025) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.F.M2_SMD.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.F.M2_SMD[individual_est_SMD$approach_SMD=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.F.M2_SMD[individual_est_SMD$approach_SMD=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_SMD.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_SMD <- lmer(power.R_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
summary(MMA_power.R_SMD)$coefficients[1]
# log
MMA_power.R_SMD2 <- lmer(log(power.R_SMD) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
# this is median 
summary(MMA_power.R_SMD2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_SMD2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R_SMD))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_SMD2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_SMD) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_SMD2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_SMD as fixed effect and stressor as random effect
MMA_power.R_SMD.approach <- lmer(power.R_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.R_SMD.approach)$coefficients
# log
MMA_power.R_SMD.approach2 <- lmer(log(power.R_SMD) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.R_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R_SMD[individual_est_SMD$approach_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.R_SMD[individual_est_SMD$approach_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_SMD.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_SMD.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_SMD.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# contrasting model
MMA_power.R_SMD.approach4 <- lmer(log(power.R_SMD) ~ 1 + I(approach_SMD) + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# check p value
summary(MMA_power.R_SMD.approach4)

 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_SMD <- lmer(power.R.S_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
summary(MMA_power.R.S_SMD)$coefficients[1]

# log
MMA_power.R.S_SMD2 <- lmer(log(power.R.S_SMD + 0.025) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
png(filename = "./Figures/residual/S.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_SMD) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_SMD2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()



# include approach_SMD as fixed effect and stressor as random effect
MMA_power.R.S_SMD.approach <- lmer(power.R.S_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.R.S_SMD.approach)$coefficients
# log
MMA_power.R.S_SMD.approach2 <- lmer(log(power.R.S_SMD + 0.025) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.R.S_SMD.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_SMD.approach2) %>% exp()



# contrasting model
MMA_power.R.S_SMD.approach4 <- lmer(log(power.R.S_SMD + 0.025) ~ 1 + I(approach_SMD) + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# check p value
summary(MMA_power.R.S_SMD.approach4)

#---------------------- (2) type M error -----------------------#

MMA_power.R.M_SMD <- lmer(power.R.M_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

summary(MMA_power.R.M_SMD)$coefficients[1] # I checked the raw data and found that some sampling variances of lnSMD are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.R.M_SMD2 <- lmer(log(power.R.M_SMD) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

# this is median
summary(MMA_power.R.M_SMD2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coSMDect but it is fine for now)
(summary(MMA_power.R.M_SMD2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R.M_SMD))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_SMD2) %>% exp()

# make plot
png(filename = "./Figures/residual/M.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 
dev.off()


# include approach_SMD as fixed effect and stressor as random effect
MMA_power.R.M_SMD.approach <- lmer(power.R.M_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.R.M_SMD.approach)$coefficients
# log
MMA_power.R.M_SMD.approach2 <- lmer(log(power.R.M_SMD) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.R.M_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R.M_SMD[individual_est_SMD$approach_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.R.M_SMD[individual_est_SMD$approach_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_SMD.approach2) %>% exp()


# contrating model
MMA_power.R.M_SMD.approach4 <- lmer(log(power.R.M_SMD) ~ 1 + I(approach_SMD) + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# check p value
summary(MMA_power.R.M_SMD.approach4)


#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_SMD <- lmer(power.R.M2_SMD ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

summary(MMA_power.R.M2_SMD)$coefficients[1] 

# log 
MMA_power.R.M2_SMD2 <- lmer(log(power.R.M2_SMD+0.025) ~ 1 + (1 | studyID_SMD), data = individual_est_SMD)

# this is median
summary(MMA_power.R.M2_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coSMDect but it is fine for now)
(summary(MMA_power.R.M2_SMD2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R.M2_SMD+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_SMD2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_SMD as fixed effect and stressor as random effect
MMA_power.R.M2_SMD.approach <- lmer(power.R.M2_SMD ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
summary(MMA_power.R.M2_SMD.approach)$coefficients
# log
MMA_power.R.M2_SMD.approach2 <- lmer(log(power.R.M2_SMD + 0.025) ~ 1 + I(approach_SMD) -1 + (1 | studyID_SMD) + (1 | stressor_SMD), data = individual_est_SMD)
# this is median
summary(MMA_power.R.M2_SMD.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMD$power.R.M2_SMD[individual_est_SMD$approach_SMD=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMD$power.R.M2_SMD[individual_est_SMD$approach_SMD=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_SMD.approach2) %>% exp() - 0.025


# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_SMD$approach_SMD <- factor(power.F.M_summary_SMD$approach_SMD, levels=c("O", "E"))
# 
# MMA_power.F.M_SMD.approach <- with(power.F.M_summary_SMD, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_SMD) -1, method = "REML", test = "t")) # relevel(approach, ref="O")

```


###### 4.3.2.2 lnRR

```{r}
#****************************************************************#
#-----------------------------lnrr-------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


## make study identity unique incase some studies have same identities
# lnrr[[1]]$Study <- paste("m1_1_", lnrr[[1]]$Study, sep = "")
# lnrr[[2]]$Study <- paste("m1_2_", lnrr[[2]]$Study, sep = "")
# lnrr[[3]]$Study <- paste("m2_1_", lnrr[[3]]$Study, sep = "")
# lnrr[[4]]$Study <- paste("m2_2_", lnrr[[4]]$Study, sep = "")
# lnrr[[5]]$Study <- paste("m5_1_", lnrr[[5]]$Study, sep = "")
# lnrr[[6]]$Study <- paste("m6_1_", lnrr[[6]]$Study, sep = "")
# lnrr[[7]]$Study <- paste("m6_2_", lnrr[[7]]$Study, sep = "")
# lnrr[[8]]$Study <- paste("m6_3_", lnrr[[8]]$Study, sep = "")
# lnrr[[9]]$Study <- paste("m6_4_", lnrr[[9]]$Study, sep = "")
# lnrr[[10]]$Study <- paste("m6_5_", lnrr[[10]]$Study, sep = "")
# lnrr[[11]]$Study <- paste("m9_1_", lnrr[[11]]$Study, sep = "")
# lnrr[[12]]$Study <- paste("m11_1_", lnrr[[12]]$Study, sep = "")


studyID_lnrr <- NA
for (i in 1:length(lnrr)) {
  studyID_lnrr[i] <- lnrr[[i]]$Study %>% list()
}

MA_case_lnrr <-  c(rep('m1_1',length(lnrr[[1]]$Study)),
                  rep('m1_2',length(lnrr[[2]]$Study)),
                  rep('m2_1',length(lnrr[[3]]$Study)),
                  rep('m2_2',length(lnrr[[4]]$Study)),
                  rep('m5_1',length(lnrr[[5]]$Study)),
                  rep('m6_1',length(lnrr[[6]]$Study)),
                  rep('m6_2',length(lnrr[[7]]$Study)),
                  rep('m6_3',length(lnrr[[8]]$Study)),
                  rep('m6_4',length(lnrr[[9]]$Study)),
                  rep('m6_5',length(lnrr[[10]]$Study)),
                  rep('m9_1',length(lnrr[[11]]$Study)),
                  rep('m11_1',length(lnrr[[12]]$Study))
                  )
# MA_case_lnrr <- c("1m1_1",  "2m1_2",  "3m2_1",  "4m2_2",  "5m5_1",  "6m6_1",  "7m6_2",  "8m6_3",  "9m6_4",  "10m6_5",  "11m9_1", "12m11_1")


stressor_lnrr <-  c(rep('BD_loss',length(lnrr[[1]]$Study)),
                  rep('BD_loss',length(lnrr[[2]]$Study)),
                  rep('Fert',length(lnrr[[3]]$Study)),
                  rep('Fert',length(lnrr[[4]]$Study)),
                  rep('Fert',length(lnrr[[5]]$Study)),
                  rep('LUC',length(lnrr[[6]]$Study)),
                  rep('LUC',length(lnrr[[7]]$Study)),
                  rep('LUC',length(lnrr[[8]]$Study)),
                  rep('LUC',length(lnrr[[9]]$Study)),
                  rep('LUC',length(lnrr[[10]]$Study)),
                  rep('LUC',length(lnrr[[11]]$Study)),
                  rep('Inv',length(lnrr[[12]]$Study))
                  )


# stressor_lnrr <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_lnrr <-  c(rep('E',length(lnrr[[1]]$Study)),
                  rep('E',length(lnrr[[2]]$Study)),
                  rep('E',length(lnrr[[3]]$Study)),
                  rep('E',length(lnrr[[4]]$Study)),
                  rep('E',length(lnrr[[5]]$Study)),
                  rep('O',length(lnrr[[6]]$Study)),
                  rep('O',length(lnrr[[7]]$Study)),
                  rep('O',length(lnrr[[8]]$Study)),
                  rep('O',length(lnrr[[9]]$Study)),
                  rep('O',length(lnrr[[10]]$Study)),
                  rep('O',length(lnrr[[11]]$Study)),
                  rep('O',length(lnrr[[12]]$Study))
                  )

# approach_lnrr <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_lnrr <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")




studyID_lnrr <- unlist(studyID_lnrr)
power.F_lnrr <- unlist(power.F_lnrr) %>% na.omit() # delete NA, # clean NA - ma1.1 has NA for (i in 1:12) { lnrr[[i]] <- lnrr[[i]][!is.na(lnrr[[i]]$power.R_lnrr),]} # also power.F_lnrr
power.F.S_lnrr <- unlist(power.F.S_lnrr) %>% na.omit()  # delete NA
power.F.M_lnrr <- unlist(power.F.M_lnrr) %>% na.omit() # delete NA
power.F.M2_lnrr <- unlist(power.F.M2_lnrr) %>% na.omit() # delete NA
power.R_lnrr <- unlist(power.R_lnrr) %>% na.omit() # delete NA
power.R.S_lnrr <- unlist(power.R.S_lnrr) %>% na.omit() # delete NA
power.R.M_lnrr <- unlist(power.R.M_lnrr) %>% na.omit() # delete NA
power.R.M2_lnrr <- unlist(power.R.M2_lnrr) %>% na.omit() # delete NA


individual_est_lnrr <- data.frame("MA_case_lnrr" = MA_case_lnrr,
                                  "studyID_lnrr" = studyID_lnrr,
                                "stressor_lnrr" = stressor_lnrr,
                                "approach_lnrr" = approach_lnrr,
                                "power.F_lnrr" = power.F_lnrr,
                                "power.F.S_lnrr" = power.F.S_lnrr,
                                "power.F.M_lnrr" = power.F.M_lnrr,
                                "power.F.M2_lnrr" = power.F.M2_lnrr,
                                "power.R_lnrr" = power.R_lnrr,
                                "power.R.S_lnrr" = power.R.S_lnrr,
                                "power.R.M_lnrr" = power.R.M_lnrr,
                                "power.R.M2_lnrr" = power.R.M2_lnrr)


# save(individual_est_lnrr,file = here("data","individual_est_lnrr.RData"))
# save(power.F.M_lnrr,file = here("data","power.F.M_lnrr.RData"))
# save(power.R.M_lnrr,file = here("data","power.R.M_lnrr.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_lnrr.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_lnrr <- lmer(power.F_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
summary(MMA_power.F_lnrr)$coefficients[1]
# log
MMA_power.F_lnrr2 <- lmer(log(power.F_lnrr) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
# this is median 
summary(MMA_power.F_lnrr2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F_lnrr))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_lnrr2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_lnrr) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_lnrr2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.F_lnrr.approach <- lmer(power.F_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.F_lnrr.approach)$coefficients
# log
MMA_power.F_lnrr.approach2 <- lmer(log(power.F_lnrr) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.F_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F_lnrr[individual_est_lnrr$approach_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.F_lnrr[individual_est_lnrr$approach_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_lnrr.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_lnrr.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_lnrr.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 
#residuals(MMA_power.F_lnrr.approach3) %>% hist(main = paste("logit power (MAOM)"), xlab = "Residual") 


# contrasting model
MMA_power.F_lnrr.approach4 <- lmer(log(power.F_lnrr) ~ 1 + I(approach_lnrr) + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# check p value
summary(MMA_power.F_lnrr.approach4)

#---------------------- (2) type S error -----------------------#
MMA_power.F.S_lnrr <- lmer(power.F.S_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
summary(MMA_power.F.S_lnrr)$coefficients[1]
# log
MMA_power.F.S_lnrr2 <- lmer(log(power.F.S_lnrr + 0.025) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
png(filename = "./Figures/residual/S.png", width = 8, height = 5, units = "in", type = "windows", res = 400)
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_lnrr) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_lnrr2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
dev.off()



# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.F.S_lnrr.approach <- lmer(power.F.S_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.F.S_lnrr.approach)$coefficients
# log
MMA_power.F.S_lnrr.approach2 <- lmer(log(power.F.S_lnrr + 0.025) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.F.S_lnrr.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_lnrr.approach2) %>% exp() - 0.025





# contrasting model
MMA_power.F.S_lnrr.approach4 <- lmer(log(power.F.S_lnrr + 0.025) ~ 1 + I(approach_lnrr) + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.F.S_lnrr.approach4)


#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_lnrr <- lmer(power.F.M_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

summary(MMA_power.F.M_lnrr)$coefficients[1] # I checked the raw data and found that some sampling variances of lnlnrr are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.F.M_lnrr2 <- lmer(log(power.F.M_lnrr) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

# this is median
summary(MMA_power.F.M_lnrr2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(summary(MMA_power.F.M_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F.M_lnrr))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_lnrr2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.F.M_lnrr.approach <- lmer(power.F.M_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.F.M_lnrr.approach)$coefficients
# log
MMA_power.F.M_lnrr.approach2 <- lmer(log(power.F.M_lnrr) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.F.M_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F.M_lnrr[individual_est_lnrr$approach_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.F.M_lnrr[individual_est_lnrr$approach_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_lnrr.approach2) %>% exp()



# log
MMA_power.F.M_lnrr.approach4 <- lmer(log(power.F.M_lnrr) ~ 1 + I(approach_lnrr) + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# check p value
summary(MMA_power.F.M_lnrr.approach4)

#---------------------- (2) type M2 error -----------------------#

MMA_power.F.M2_lnrr <- lmer(power.F.M2_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

summary(MMA_power.F.M2_lnrr)$coefficients[1] 

# log 
MMA_power.F.M2_lnrr2 <- lmer(log(power.F.M2_lnrr+0.025) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

# this is median
summary(MMA_power.F.M2_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(summary(MMA_power.F.M2_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F.M2_lnrr+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_lnrr2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.F.M2_lnrr.approach <- lmer(power.F.M2_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.F.M2_lnrr.approach)$coefficients
# log
MMA_power.F.M2_lnrr.approach2 <- lmer(log(power.F.M2_lnrr + 0.025) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.F.M2_lnrr.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.F.M2_lnrr[individual_est_lnrr$approach_lnrr=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.F.M2_lnrr[individual_est_lnrr$approach_lnrr=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_lnrr.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_lnrr <- lmer(power.R_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
summary(MMA_power.R_lnrr)$coefficients[1]
# log
MMA_power.R_lnrr2 <- lmer(log(power.R_lnrr) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
# this is median 
summary(MMA_power.R_lnrr2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R_lnrr))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_lnrr2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_lnrr) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_lnrr2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.R_lnrr.approach <- lmer(power.R_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.R_lnrr.approach)$coefficients
# log
MMA_power.R_lnrr.approach2 <- lmer(log(power.R_lnrr) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.R_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R_lnrr[individual_est_lnrr$approach_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.R_lnrr[individual_est_lnrr$approach_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_lnrr.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_lnrr.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_lnrr.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_lnrr <- lmer(power.R.S_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
summary(MMA_power.R.S_lnrr)$coefficients[1]

# log
MMA_power.R.S_lnrr2 <- lmer(log(power.R.S_lnrr + 0.025) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_lnrr) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_lnrr2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")



# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.R.S_lnrr.approach <- lmer(power.R.S_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.R.S_lnrr.approach)$coefficients
# log
MMA_power.R.S_lnrr.approach2 <- lmer(log(power.R.S_lnrr + 0.025) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.R.S_lnrr.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_lnrr.approach2) %>% exp()


#---------------------- (2) type M error -----------------------#

MMA_power.R.M_lnrr <- lmer(power.R.M_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

summary(MMA_power.R.M_lnrr)$coefficients[1] # I checked the raw data and found that some sampling variances of lnlnrr are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.R.M_lnrr2 <- lmer(log(power.R.M_lnrr) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

# this is median
summary(MMA_power.R.M_lnrr2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(summary(MMA_power.R.M_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R.M_lnrr))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_lnrr2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.R.M_lnrr.approach <- lmer(power.R.M_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.R.M_lnrr.approach)$coefficients
# log
MMA_power.R.M_lnrr.approach2 <- lmer(log(power.R.M_lnrr) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.R.M_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R.M_lnrr[individual_est_lnrr$approach_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.R.M_lnrr[individual_est_lnrr$approach_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_lnrr.approach2) %>% exp()



#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_lnrr <- lmer(power.R.M2_lnrr ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

summary(MMA_power.R.M2_lnrr)$coefficients[1] 

# log 
MMA_power.R.M2_lnrr2 <- lmer(log(power.R.M2_lnrr+0.025) ~ 1 + (1 | studyID_lnrr), data = individual_est_lnrr)

# this is median
summary(MMA_power.R.M2_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% colnrrect but it is fine for now)
(summary(MMA_power.R.M2_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R.M2_lnrr+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_lnrr2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_lnrr as fixed effect and stressor as random effect
MMA_power.R.M2_lnrr.approach <- lmer(power.R.M2_lnrr ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
summary(MMA_power.R.M2_lnrr.approach)$coefficients
# log
MMA_power.R.M2_lnrr.approach2 <- lmer(log(power.R.M2_lnrr + 0.025) ~ 1 + I(approach_lnrr) -1 + (1 | studyID_lnrr) + (1 | stressor_lnrr), data = individual_est_lnrr)
# this is median
summary(MMA_power.R.M2_lnrr.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_lnrr$power.R.M2_lnrr[individual_est_lnrr$approach_lnrr=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_lnrr$power.R.M2_lnrr[individual_est_lnrr$approach_lnrr=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_lnrr.approach2) %>% exp() - 0.025

# # convert moderator to factor with desired ordering of levels
# power.F_summary_lnrr$approach_lnrr <- factor(power.F_summary_lnrr$approach_lnrr, levels=c("O", "E"))
# 
# MMA_power.F_lnrr.approach <- with(power.F_summary_lnrr, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_lnrr) -1, method = "REML", test = "t")) # relevel(approach, ref="O")

```






### 4. SMDH 

#### 4.1 MA power calculation

```{r}
#***************************************************************#
#             power for 12 meta-analytic cases                  #
#***************************************************************#



# make a list of data
dat_list_SMDH <- list(raw_m1_1,
                           raw_m1_2,
                           raw_m2_1,
                           raw_m2_2,
                           raw_m5_1,
                           raw_m6_1,
                           raw_m6_2,
                           raw_m6_3,
                           raw_m6_4,
                           raw_m6_5,
                           raw_m9_1,
                           raw_m11_1)

# calculate the number of total effect sizes - sample size
ES_number <- NA
ES_number <- mapply(unique, sapply(dat_list_SMDH, function(x) x$Unit_ID)) 
unlist(ES_number) %>% length() # 2004


# calculate 2 type of effect size statistics (i.e.SMDH and lnRR)

SMDH <- NA
for (i in 1:length(dat_list_SMDH)) {
  SMDH[i] <- escalc(measure = "SMDH",
                    m1i = T_mean,
                    m2i = C_mean,
                    sd1i = T_sd,
                    sd2i = C_sd,
                    n1i = T_N,
                    n2i = C_N,
                    data = dat_list_SMDH[[i]]) %>% list()
}



# clean NA
for (i in 1:12) {
  SMDH[[i]] <- SMDH[[i]][!is.na(SMDH[[i]]$yi),]
}



# prepare "ture" effect of variation (i.e. SMDH and lnrr) for power analysis - fit multi-level meta-analytic models
model_list_SMDH<- NA
for (i in 1:length(dat_list_SMDH)) {
 model_list_SMDH[i] <- rma.mv(data = SMDH[[i]], yi = yi, V = vi, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}


#****************************************************************#
#------------------------------SMDH-----------------------------#
#****************************************************************#

# we assume meta-analytic mean as ture effect, so we need to get estimate (mu) and corresponding error (SE)
model_est_SMDH <- data.frame(MA_case=c("m1_1",
                                      "m1_2",
                                      "m2_1",
                                      "m2_2",
                                      "m5_1",
                                      "m6_1",
                                      "m6_2",
                                      "m6_3",
                                      "m6_4",
                                      "m6_5",
                                      "m9_1",
                                      "m11_1"),
                  mu_SMDH=sapply(model_list_SMDH, function(x) x$beta),
                  SE_SMDH=sapply(model_list_SMDH, function(x) x$se),
                  ll_NHST=sapply(model_list_SMDH, function(x) x$ci.lb),
                  ul_NHST=sapply(model_list_SMDH, function(x) x$ci.ub),
                  p_value=sapply(model_list_SMDH, function(x) x$pval) %>% round(4))



#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_SMDH$MA.power <- power.ma_Shinichi(mu=model_est_SMDH$mu,SE=model_est_SMDH$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_SMDH$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_SMDH$mu[i],se=model_est_SMDH$SE[i],alpha=0.05) %>% unlist()
}

model_est_SMDH$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_SMDH$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_SMDH$mu[i],se=model_est_SMDH$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_SMDH$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_SMDH$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_SMDH$mu[i],se=model_est_SMDH$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_SMDH$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_SMDH, file = "./meta-analysis power_SMDH.csv", row.names = FALSE)


```


#### 4.2 Individual power calculation 

##### 4.2.1 Calculation

```{r}
#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference)


#****************************************************************#
#------------------------------SMDH-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# SMDH
power.F_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F_SMDH[i] <- power.individual_Shinichi(mu=rep(model_list_SMDH[[i]]$beta, length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_SMDH)) {
  SMDH[[i]]$power.F_SMDH <- power.F_SMDH[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F.S_SMDH[i] <- mapply(error_S,mu=rep(model_list_SMDH[[i]]$beta, length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_SMDH)) {
  SMDH[[i]]$power.F.S_SMDH <- power.F.S_SMDH[[i]]
}



#---------------- (3) type M error (relative error) --------------#
power.F.M_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F.M_SMDH[i] <-mapply(error_M,mu=rep(model_list_SMDH[[i]]$beta, length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_SMDH)) {
  SMDH[[i]]$power.F.M_SMDH <- power.F.M_SMDH[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F.M2_SMDH[i] <-mapply(error_M2,mu=rep(model_list_SMDH[[i]]$beta, length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_SMDH)) {
  SMDH[[i]]$power.F.M2_SMDH <- power.F.M2_SMDH[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_SMDH <- NA
for (i in 1:length(model_list_SMDH)) {
  blups.list_SMDH[i] <- ranef(model_list_SMDH[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_SMDH <- NA # list()
for (i in 1:length(model_list_SMDH)) {
  index.list_SMDH[i] <- match(as.character(SMDH[[i]]$Study),rownames(blups.list_SMDH[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_SMDH <-NA
for (i in 1:length(model_list_SMDH)) {
  effect.R_SMDH[i] <- mapply(sum, model_list_SMDH[[i]]$beta, blups.list_SMDH[[i]]$Study[index.list_SMDH[[i]],1], blups.list_SMDH[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_SMDH <- NA
for (i in 1:length(dat_list_SMDH)) {
  power.R_SMDH[i] <- power.individual_Shinichi(mu=effect.R_SMDH[[i]], se=sqrt(SMDH[[i]]$vi)) %>% list()}

# plot(power_SMDH[[1]]-power_SMDH2[[1]]) - check discrepancy
# allocate each set of power into coSMDHesponding dataset
for (i in 1:length(power.R_SMDH)) {
  SMDH[[i]]$power.R_SMDH <- power.R_SMDH[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_SMDH <- NA
for (i in 1:12) {
  power.R.S_SMDH[i] <- mapply(error_S, mu=effect.R_SMDH[[i]], se=sqrt(SMDH[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into coSMDHesponding dataset
for (i in 1:length(power.R.S_SMDH)) {
  SMDH[[i]]$power.R.S_SMDH <- power.R.S_SMDH[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_SMDH <- NA
for (i in 1:12) {
  power.R.M_SMDH[i] <- mapply(error_M, mu=effect.R_SMDH[[i]], se=sqrt(SMDH[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDHesponding dataset
for (i in 1:length(power.R.M_SMDH)) {
  SMDH[[i]]$power.R.M_SMDH <- power.R.M_SMDH[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_SMDH <- NA
for (i in 1:12) {
  power.R.M2_SMDH[i] <- mapply(error_M2, mu=effect.R_SMDH[[i]], se=sqrt(SMDH[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDHesponding dataset
for (i in 1:length(power.R.M2_SMDH)) {
  SMDH[[i]]$power.R.M2_SMDH <- power.R.M2_SMDH[[i]]
}

```


##### 4.2.2 Summary of individual power
```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMDH------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.F_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.F_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.F_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.F_SMDH))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.F.S_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F.S_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.F.S_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.F.S_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F.S_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.F.S_SMDH))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.F.M_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F.M_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.F.M_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.F.M_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F.M_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.F.M_SMDH))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.F.M2_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F.M2_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.F.M2_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.F.M2_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.F.M2_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.F.M2_SMDH))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.R_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.R_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.R_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.R_SMDH))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.R.S_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R.S_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.R.S_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.R.S_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R.S_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.R.S_SMDH))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.R.M_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R.M_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.R.M_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.R.M_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R.M_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.R.M_SMDH))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_SMDH <- data.frame(MA_case=model_est_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(SMDH, function(x) x$power.R.M2_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R.M2_SMDH))[2,],
                   Median=mapply(summary, sapply(SMDH, function(x) x$power.R.M2_SMDH))[3,],
                   Mean=mapply(summary, sapply(SMDH, function(x) x$power.R.M2_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(SMDH, function(x) x$power.R.M2_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(SMDH, function(x) x$power.R.M2_SMDH))[6,]) 





#****************************************************************#
#-----------------------------lnrr-------------------------------#
#****************************************************************#

#clean NA - ma1.1 has NA
for (i in 1:12) { lnrr[[i]] <- lnrr[[i]][!is.na(lnrr[[i]]$power.R_lnrr),]} # also power.F_lnrr

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#

power.F_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F_lnrr))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F.S_lnrr))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F.M_lnrr))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.F.M2_lnrr))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R_lnrr))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R.S_lnrr))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R.M_lnrr))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_lnrr <- data.frame(MA_case=model_est_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[2,],
                   Median=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[3,],
                   Mean=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(lnrr, function(x) x$power.R.M2_lnrr))[6,]) 



# clean NA - ma1.1 has NA
#for (i in 1:12) { lnrr[[i]] <- lnrr[[i]][!is.na(lnrr[[i]]$power.R_lnrr),]}
```


##### 4.2.3 SE of individual power

```{r}
#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMDH------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_SMDH
se.F_mean <- NA
for (i in 1:length(SMDH)) {
  se.F_mean[i] <- sd(SMDH[[i]]$power.F_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.F_SMDH[!is.na(SMDH[[i]]$power.F_SMDH)]))
}

power.F_summary_SMDH$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_SMDH
se.F.S_mean <- NA
for (i in 1:length(SMDH)) {
  se.F.S_mean[i] <- sd(SMDH[[i]]$power.F.S_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.F.S_SMDH[!is.na(SMDH[[i]]$power.F.S_SMDH)]))
}

power.F.S_summary_SMDH$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_SMDH
se.F.M_mean <- NA
for (i in 1:length(SMDH)) {
  se.F.M_mean[i] <- sd(SMDH[[i]]$power.F.M_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.F.M_SMDH[!is.na(SMDH[[i]]$power.F.M_SMDH)]))
}

power.F.M_summary_SMDH$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(SMDH)) {
  se.F.M2_mean[i] <- sd(SMDH[[i]]$power.F.M2_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.F.M2_SMDH[!is.na(SMDH[[i]]$power.F.M2_SMDH)]))
}

power.F.M2_summary_SMDH$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_SMDH
se.R_mean <- NA
for (i in 1:length(SMDH)) {
  se.R_mean[i] <- sd(SMDH[[i]]$power.R_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.R_SMDH[!is.na(SMDH[[i]]$power.R_SMDH)]))
}

power.R_summary_SMDH$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_SMDH
se.R.S_mean <- NA
for (i in 1:length(SMDH)) {
  se.R.S_mean[i] <- sd(SMDH[[i]]$power.R.S_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.R.S_SMDH[!is.na(SMDH[[i]]$power.R.S_SMDH)]))
}

power.R.S_summary_SMDH$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_SMDH
se.R.M_mean <- NA
for (i in 1:length(SMDH)) {
  se.R.M_mean[i] <- sd(SMDH[[i]]$power.R.M_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.R.M_SMDH[!is.na(SMDH[[i]]$power.R.M_SMDH)]))
}

power.R.M_summary_SMDH$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(SMDH)) {
  se.R.M2_mean[i] <- sd(SMDH[[i]]$power.R.M2_SMDH, na.rm=TRUE) / sqrt(length(SMDH[[i]]$power.R.M2_SMDH[!is.na(SMDH[[i]]$power.R.M2_SMDH)]))
}

power.R.M2_summary_SMDH$se.R.M2_mean <- se.R.M2_mean







#****************************************************************#
#-----------------------------lnrr-------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_lnrr
se.F_mean <- NA
for (i in 1:length(lnrr)) {
  se.F_mean[i] <- sd(lnrr[[i]]$power.F_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F_lnrr[!is.na(lnrr[[i]]$power.F_lnrr)]))
}

power.F_summary_lnrr$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_lnrr
se.F.S_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.S_mean[i] <- sd(lnrr[[i]]$power.F.S_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F.S_lnrr[!is.na(lnrr[[i]]$power.F.S_lnrr)]))
}

power.F.S_summary_lnrr$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_lnrr
se.F.M_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.M_mean[i] <- sd(lnrr[[i]]$power.F.M_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F.M_lnrr[!is.na(lnrr[[i]]$power.F.M_lnrr)]))
}

power.F.M_summary_lnrr$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.M2_mean[i] <- sd(lnrr[[i]]$power.F.M2_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.F.M2_lnrr[!is.na(lnrr[[i]]$power.F.M2_lnrr)]))
}

power.F.M2_summary_lnrr$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_lnrr
se.R_mean <- NA
for (i in 1:length(lnrr)) {
  se.R_mean[i] <- sd(lnrr[[i]]$power.R_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R_lnrr[!is.na(lnrr[[i]]$power.R_lnrr)]))
}

power.R_summary_lnrr$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_lnrr
se.R.S_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.S_mean[i] <- sd(lnrr[[i]]$power.R.S_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R.S_lnrr[!is.na(lnrr[[i]]$power.R.S_lnrr)]))
}

power.R.S_summary_lnrr$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_lnrr
se.R.M_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.M_mean[i] <- sd(lnrr[[i]]$power.R.M_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R.M_lnrr[!is.na(lnrr[[i]]$power.R.M_lnrr)]))
}

power.R.M_summary_lnrr$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.M2_mean[i] <- sd(lnrr[[i]]$power.R.M2_lnrr, na.rm=TRUE) / sqrt(length(lnrr[[i]]$power.R.M2_lnrr[!is.na(lnrr[[i]]$power.R.M2_lnrr)]))
}

power.R.M2_summary_lnrr$se.R.M2_mean <- se.R.M2_mean
```


#### 4.3 Regression

##### 4.3.1 MA power

```{r}

#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#****************************************************************#
#-----------------------------SMDH------------------------------#
#****************************************************************#

# add N and k
N_SMDH <- NA
for (i in 1:length(SMDH)) {
  N_SMDH[i] <- SMDH[[i]]$Study %>% unique() %>% length()
}

k_SMDH <- NA
for (i in 1:length(SMDH)) {
  k_SMDH[i] <- SMDH[[i]]$Unit_ID%>% length()
}

model_est_SMDH$k <- k_SMDH
model_est_SMDH$N <- N_SMDH



for (i in 1:12) {
  SMDH[[i]]$n_total <- SMDH[[i]]$C_N + SMDH[[i]]$T_N }

n_total_SMDH <- NA
for (i in 1:12) {
  n_total_SMDH[i] <- SMDH[[i]]$n_total %>% sum }

model_est_SMDH$n <- n_total_SMDH

# load meta-analysis level power
#load(here("data","model_est_SMDH.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_SMDH <- lm(MA.power~1, weights = k, data = model_est_SMDH) 
MMA_MA_SMDH$coefficients
# log
MMA_MA_SMDH2 <- lm(log(MA.power)~1, weights = k, data = model_est_SMDH)
# this is median
MMA_MA_SMDH2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_SMDH2$coefficients + 0.5*var(log(model_est_SMDH$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_SMDH2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_SMDH) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_SMDH2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_SMDH <- lm(MA.power.S~1, weights = k, data = model_est_SMDH) 
MMA_MA.S_SMDH$coefficients
# log
MMA_MA.S_SMDH2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_SMDH) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_SMDH2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_SMDH2$coefficients + 0.5*var(log(model_est_SMDH$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_SMDH) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_SMDH2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_SMDH <- lm(MA.power.M~1, weights = k, data = model_est_SMDH) 
MMA_MA.M_SMDH$coefficients
# log
MMA_MA.M_SMDH2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_SMDH)
# this is median
MMA_MA.M_SMDH2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coSMDHect but it is fine for now)
(MMA_MA.M_SMDH2$coefficients + 0.5*var(log(model_est_SMDH$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_SMDH2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_SMDH <- lm(MA.power.M2~1, weights = k, data = model_est_SMDH) 
MMA_MA.M2_SMDH$coefficients
# log
MMA_MA.M2_SMDH2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_SMDH)
# this is median
MMA_MA.M2_SMDH2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coSMDHect but it is fine for now)
(MMA_MA.M2_SMDH2$coefficients + 0.5*var(log(model_est_SMDH$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 

```



##### 4.3.2 Individual power

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#****************************************************************#
#-----------------------------SMDH------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique incase some studies have same identities
# SMDH[[1]]$Study <- paste("m1_1_", SMDH[[1]]$Study, sep = "")
# SMDH[[2]]$Study <- paste("m1_2_", SMDH[[2]]$Study, sep = "")
# SMDH[[3]]$Study <- paste("m2_1_", SMDH[[3]]$Study, sep = "")
# SMDH[[4]]$Study <- paste("m2_2_", SMDH[[4]]$Study, sep = "")
# SMDH[[5]]$Study <- paste("m5_1_", SMDH[[5]]$Study, sep = "")
# SMDH[[6]]$Study <- paste("m6_1_", SMDH[[6]]$Study, sep = "")
# SMDH[[7]]$Study <- paste("m6_2_", SMDH[[7]]$Study, sep = "")
# SMDH[[8]]$Study <- paste("m6_3_", SMDH[[8]]$Study, sep = "")
# SMDH[[9]]$Study <- paste("m6_4_", SMDH[[9]]$Study, sep = "")
# SMDH[[10]]$Study <- paste("m6_5_", SMDH[[10]]$Study, sep = "")
# SMDH[[11]]$Study <- paste("m9_1_", SMDH[[11]]$Study, sep = "")
# SMDH[[12]]$Study <- paste("m11_1_", SMDH[[12]]$Study, sep = "")


studyID_SMDH <- NA
for (i in 1:length(SMDH)) {
  studyID_SMDH[i] <- SMDH[[i]]$Study %>% list()
}


MA_case_SMDH <-  c(rep('m1_1',length(SMDH[[1]]$Study)),
                  rep('m1_2',length(SMDH[[2]]$Study)),
                  rep('m2_1',length(SMDH[[3]]$Study)),
                  rep('m2_2',length(SMDH[[4]]$Study)),
                  rep('m5_1',length(SMDH[[5]]$Study)),
                  rep('m6_1',length(SMDH[[6]]$Study)),
                  rep('m6_2',length(SMDH[[7]]$Study)),
                  rep('m6_3',length(SMDH[[8]]$Study)),
                  rep('m6_4',length(SMDH[[9]]$Study)),
                  rep('m6_5',length(SMDH[[10]]$Study)),
                  rep('m9_1',length(SMDH[[11]]$Study)),
                  rep('m11_1',length(SMDH[[12]]$Study))
                  )
#MA_case_SMDH <- c("1m1_1",  "2m1_2",  "3m2_1",  "4m2_2",  "5m5_1",  "6m6_1",  "7m6_2",  "8m6_3",  "9m6_4",  "10m6_5",  "11m9_1", "12m11_1")


stressor_SMDH <-  c(rep('BD_loss',length(SMDH[[1]]$Study)),
                  rep('BD_loss',length(SMDH[[2]]$Study)),
                  rep('Fert',length(SMDH[[3]]$Study)),
                  rep('Fert',length(SMDH[[4]]$Study)),
                  rep('Fert',length(SMDH[[5]]$Study)),
                  rep('LUC',length(SMDH[[6]]$Study)),
                  rep('LUC',length(SMDH[[7]]$Study)),
                  rep('LUC',length(SMDH[[8]]$Study)),
                  rep('LUC',length(SMDH[[9]]$Study)),
                  rep('LUC',length(SMDH[[10]]$Study)),
                  rep('LUC',length(SMDH[[11]]$Study)),
                  rep('Inv',length(SMDH[[12]]$Study))
                  )


#stressor_SMDH <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_SMDH <-  c(rep('E',length(SMDH[[1]]$Study)),
                  rep('E',length(SMDH[[2]]$Study)),
                  rep('E',length(SMDH[[3]]$Study)),
                  rep('E',length(SMDH[[4]]$Study)),
                  rep('E',length(SMDH[[5]]$Study)),
                  rep('O',length(SMDH[[6]]$Study)),
                  rep('O',length(SMDH[[7]]$Study)),
                  rep('O',length(SMDH[[8]]$Study)),
                  rep('O',length(SMDH[[9]]$Study)),
                  rep('O',length(SMDH[[10]]$Study)),
                  rep('O',length(SMDH[[11]]$Study)),
                  rep('O',length(SMDH[[12]]$Study))
                  )

#approach_SMDH <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_SMDH <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")


studyID_SMDH <- unlist(studyID_SMDH)
power.F_SMDH <- unlist(power.F_SMDH)
power.F.S_SMDH <- unlist(power.F.S_SMDH)
power.F.M_SMDH <- unlist(power.F.M_SMDH)
power.F.M2_SMDH <- unlist(power.F.M2_SMDH)
power.R_SMDH <- unlist(power.R_SMDH)
power.R.S_SMDH <- unlist(power.R.S_SMDH)
power.R.M_SMDH <- unlist(power.R.M_SMDH)
power.R.M2_SMDH <- unlist(power.R.M2_SMDH)


individual_est_SMDH <- data.frame("MA_case_SMDH" = MA_case_SMDH,
                                 "studyID_SMDH" = studyID_SMDH,
                                "stressor_SMDH" = stressor_SMDH,
                                "approach_SMDH" = approach_SMDH,
                                "power.F_SMDH" = power.F_SMDH,
                                "power.F.S_SMDH" = power.F.S_SMDH,
                                "power.F.M_SMDH" = power.F.M_SMDH,
                                "power.F.M2_SMDH" = power.F.M2_SMDH,
                                "power.R_SMDH" = power.R_SMDH,
                                "power.R.S_SMDH" = power.R.S_SMDH,
                                "power.R.M_SMDH" = power.R.M_SMDH,
                                "power.R.M2_SMDH" = power.R.M2_SMDH)

# save(individual_est_SMDH,file = here("data","individual_est_SMDH.RData"))
# save(power.F.M_SMDH,file = here("data","power.F.M_SMDH.RData"))
# save(power.R.M_SMDH,file = here("data","power.R.M_SMDH.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_SMDH.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_SMDH <- lmer(power.F_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
summary(MMA_power.F_SMDH)$coefficients[1]
# log
MMA_power.F_SMDH2 <- lmer(log(power.F_SMDH) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
# this is median 
summary(MMA_power.F_SMDH2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F_SMDH))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_SMDH2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_SMDH) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_SMDH2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.F_SMDH.approach <- lmer(power.F_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.F_SMDH.approach)$coefficients
# log
MMA_power.F_SMDH.approach2 <- lmer(log(power.F_SMDH) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.F_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F_SMDH[individual_est_SMDH$approach_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.F_SMDH[individual_est_SMDH$approach_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_SMDH.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_SMDH.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_SMDH.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


#---------------------- (2) type S error -----------------------#
MMA_power.F.S_SMDH <- lmer(power.F.S_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
summary(MMA_power.F.S_SMDH)$coefficients[1]
# log
MMA_power.F.S_SMDH2 <- lmer(log(power.F.S_SMDH + 0.025) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_SMDH) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_SMDH2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
#residuals(MMA_power.F.S_SMDH3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.F.S_SMDH.approach <- lmer(power.F.S_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.F.S_SMDH.approach)$coefficients
# log
MMA_power.F.S_SMDH.approach2 <- lmer(log(power.F.S_SMDH + 0.025) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.F.S_SMDH.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_SMDH.approach2) %>% exp() - 0.025




# contrasting model
MMA_power.F.S_SMDH.approach4 <- lmer(log(power.F.S_SMDH + 0.025) ~ 1 + I(approach_SMDH) + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# check p value
summary(MMA_power.F.S_SMDH.approach4)


#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_SMDH <- lmer(power.F.M_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

summary(MMA_power.F.M_SMDH)$coefficients[1] # I checked the raw data and found that some sampling variances of lnSMDH are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.F.M_SMDH2 <- lmer(log(power.F.M_SMDH) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

# this is median
summary(MMA_power.F.M_SMDH2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coSMDHect but it is fine for now)
(summary(MMA_power.F.M_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F.M_SMDH))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_SMDH2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.F.M_SMDH.approach <- lmer(power.F.M_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.F.M_SMDH.approach)$coefficients
# log
MMA_power.F.M_SMDH.approach2 <- lmer(log(power.F.M_SMDH) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.F.M_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F.M_SMDH[individual_est_SMDH$approach_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.F.M_SMDH[individual_est_SMDH$approach_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_SMDH.approach2) %>% exp()



# contrasting model
MMA_power.F.M_SMDH.approach4 <- lmer(log(power.F.M_SMDH) ~ 1 + I(approach_SMDH) + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.F.M_SMDH.approach4)


#---------------------- (2) type M2 error -----------------------#

MMA_power.F.M2_SMDH <- lmer(power.F.M2_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

summary(MMA_power.F.M2_SMDH)$coefficients[1] 

# log 
MMA_power.F.M2_SMDH2 <- lmer(log(power.F.M2_SMDH+0.025) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

# this is median
summary(MMA_power.F.M2_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coSMDHect but it is fine for now)
(summary(MMA_power.F.M2_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F.M2_SMDH+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_SMDH2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.F.M2_SMDH.approach <- lmer(power.F.M2_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.F.M2_SMDH.approach)$coefficients
# log
MMA_power.F.M2_SMDH.approach2 <- lmer(log(power.F.M2_SMDH + 0.025) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.F.M2_SMDH.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.F.M2_SMDH[individual_est_SMDH$approach_SMDH=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.F.M2_SMDH[individual_est_SMDH$approach_SMDH=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_SMDH.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_SMDH <- lmer(power.R_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
summary(MMA_power.R_SMDH)$coefficients[1]
# log
MMA_power.R_SMDH2 <- lmer(log(power.R_SMDH) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
# this is median 
summary(MMA_power.R_SMDH2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R_SMDH))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_SMDH2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_SMDH) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_SMDH2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.R_SMDH.approach <- lmer(power.R_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.R_SMDH.approach)$coefficients
# log
MMA_power.R_SMDH.approach2 <- lmer(log(power.R_SMDH) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.R_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R_SMDH[individual_est_SMDH$approach_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.R_SMDH[individual_est_SMDH$approach_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_SMDH.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_SMDH.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_SMDH.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_SMDH <- lmer(power.R.S_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
summary(MMA_power.R.S_SMDH)$coefficients[1]

# log
MMA_power.R.S_SMDH2 <- lmer(log(power.R.S_SMDH + 0.025) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_SMDH) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_SMDH2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")



# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.R.S_SMDH.approach <- lmer(power.R.S_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.R.S_SMDH.approach)$coefficients
# log
MMA_power.R.S_SMDH.approach2 <- lmer(log(power.R.S_SMDH + 0.025) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.R.S_SMDH.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_SMDH.approach2) %>% exp()


#---------------------- (2) type M error -----------------------#

MMA_power.R.M_SMDH <- lmer(power.R.M_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

summary(MMA_power.R.M_SMDH)$coefficients[1] # I checked the raw data and found that some sampling variances of lnSMDH are very low. This probably makes some of Type M error extremely high. 

# but log transformation can work
MMA_power.R.M_SMDH2 <- lmer(log(power.R.M_SMDH) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

# this is median
summary(MMA_power.R.M_SMDH2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coSMDHect but it is fine for now)
(summary(MMA_power.R.M_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R.M_SMDH))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_SMDH2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.R.M_SMDH.approach <- lmer(power.R.M_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.R.M_SMDH.approach)$coefficients
# log
MMA_power.R.M_SMDH.approach2 <- lmer(log(power.R.M_SMDH) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.R.M_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R.M_SMDH[individual_est_SMDH$approach_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.R.M_SMDH[individual_est_SMDH$approach_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_SMDH.approach2) %>% exp()



#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_SMDH <- lmer(power.R.M2_SMDH ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

summary(MMA_power.R.M2_SMDH)$coefficients[1] 

# log 
MMA_power.R.M2_SMDH2 <- lmer(log(power.R.M2_SMDH+0.025) ~ 1 + (1 | studyID_SMDH), data = individual_est_SMDH)

# this is median
summary(MMA_power.R.M2_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coSMDHect but it is fine for now)
(summary(MMA_power.R.M2_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R.M2_SMDH+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_SMDH2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_SMDH as fixed effect and stressor as random effect
MMA_power.R.M2_SMDH.approach <- lmer(power.R.M2_SMDH ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
summary(MMA_power.R.M2_SMDH.approach)$coefficients
# log
MMA_power.R.M2_SMDH.approach2 <- lmer(log(power.R.M2_SMDH + 0.025) ~ 1 + I(approach_SMDH) -1 + (1 | studyID_SMDH) + (1 | stressor_SMDH), data = individual_est_SMDH)
# this is median
summary(MMA_power.R.M2_SMDH.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_SMDH$power.R.M2_SMDH[individual_est_SMDH$approach_SMDH=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_SMDH$power.R.M2_SMDH[individual_est_SMDH$approach_SMDH=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_SMDH.approach2) %>% exp() - 0.025


# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_SMDH$approach_SMDH <- factor(power.F.M_summary_SMDH$approach_SMDH, levels=c("O", "E"))
# 
# MMA_power.F.M_SMDH.approach <- with(power.F.M_summary_SMDH, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_SMDH) -1, method = "REML", test = "t")) # relevel(approach, ref="O")

```





### 5. Adjusted SMD (i.e. SMD PET-PEESE)

#### 5.1 Estimate adjusted-SMD (bias-corrected version)

```{r}

#***************************************************************#
#                       PET-PEESE approach                      #
#***************************************************************#

#----------------------------------------------------------------#
#              first-stage: using PET to model SE                #
#----------------------------------------------------------------#


# creating a varible for the "effective sample size" to account for unbalanced sampling
# function to calculate effective sample size
esz <- function(dat){(4*dat$C_N*dat$T_N) / (dat$C_N + dat$T_N)}

 
esz_SMD <- NA
for (i in 1:length(SMD)) {
  esz_SMD[i] <- esz(SMD[[i]]) %>% list()}
# allocate each set of effective sample size into corresponding dataset
for (i in 1:length(SMD)) {
  SMD[[i]]$esz_SMD <- esz_SMD[[i]]
}
 

# creating inverse of sqrt of effective sample size - "effective sample size" based "sampling variance" 
## function to calculate inverse of sqrt of effective sample size
esz.var <- function(dat){1/dat$C_N + 1/dat$T_N}
esz.var_SMD <- NA
for (i in 1:length(SMD)) {
  esz.var_SMD[i] <- esz.var(SMD[[i]]) %>% list()}

# allocate each set of effective sample size into corresponding dataset
for (i in 1:length(SMD)) {
  SMD[[i]]$esz.var_SMD <- esz.var_SMD[[i]]
}


# fit first stage model - inverse of effective sample size as moderator
model_list_PET_PEESE_SMD.sei <- list() # rep(NA, length(dat_list))
for (i in 1:length(SMD)) {
 model_list_PET_PEESE_SMD.sei[i] <- rma.mv(data = SMD[[i]], yi = yi, V = vi, mods = ~ sqrt(esz.var_SMD),random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

# get intercepts and slopes for first stage
## intercepts
model_est_PET_PEESE_SMD.sei.intercept <- data.frame(MA_case=model_est_SMD$MA_case,
                  mu_SMD=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$beta[1]),
                  SE_SMD=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$pval)[c(seq(1,24,2))]) # odd columns for intercept's p-value


## slopes
model_est_PET_PEESE_SMD.sei.slope <- data.frame(MA_case=model_est_SMD$MA_case,
                  mu_SMD=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$beta[2]),
                  SE_SMD=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_SMD.sei, function(x) x$pval)[c(seq(2,24,2))]) # even columns for slope's p-value



#----------------------------------------------------------------#
#           second-stage: using PEESE to model variance          #
#----------------------------------------------------------------#

# fit second stage model - sampling variance as moderator
model_list_PET_PEESE_SMD.var <- list() 
for (i in 1:12) {
 model_list_PET_PEESE_SMD.var[i] <- rma.mv(data = SMD[[i]], yi = yi, V = vi, mods = ~ esz.var_SMD, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}


# get intercepts and slopes for second stage
## intercepts
model_est_PET_PEESE_SMD.var.intercept <- data.frame(MA_case=model_est_SMD$MA_case,
                  mu_SMD=sapply(model_list_PET_PEESE_SMD.var, function(x) x$beta[1]),
                  SE_SMD=sapply(model_list_PET_PEESE_SMD.var, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMD.var, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMD.var, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_SMD.var, function(x) x$pval)[c(seq(1,24,2))]) # odd columns for intercept's p-value




## slopes
model_est_PET_PEESE_SMD.var.slope <- data.frame(MA_case=model_est_SMD$MA_case,
                  mu_SMD=sapply(model_list_PET_PEESE_SMD.var, function(x) x$beta[2]),
                  SE_SMD=sapply(model_list_PET_PEESE_SMD.var, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMD.var, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMD.var, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_SMD.var, function(x) x$pval)[c(seq(2,24,2))]) # odd columns for slope's p-value




#***************************************************************#
#           find meta-analyses with correct direction           #
#***************************************************************#

# using PET’s intercept ('se' as moderator) when slope is not sig but PEEESE’s intercept (variance or 'se^2' as moderator) if PET’s slope is sig
## label for reorder later
model_est_PET_PEESE_SMD.sei.intercept$id <- c(1:12)
model_est_PET_PEESE_SMD.sei.slope$id <- c(1:12)
model_est_PET_PEESE_SMD.var.intercept$id <- c(1:12)
model_est_PET_PEESE_SMD.var.slope$id <- c(1:12)

## significant slope
model_est_PET_PEESE_SMD.sei.slope.sig <- model_est_PET_PEESE_SMD.sei.slope %>% subset(p_value < 0.05) 
## non-significant slope
model_est_PET_PEESE_SMD.sei.slope.nonsig <- model_est_PET_PEESE_SMD.sei.slope %>% subset(p_value > 0.05)

## get location of PET's sig slope and non-sig slope, respectively
location.sig <- which(model_est_PET_PEESE_SMD.sei.slope$p_value < 0.05)
location.nonsig <- which(model_est_PET_PEESE_SMD.sei.slope$p_value > 0.05)


## get the intercpet from PEESE (when PET’s slope is sig) and PET (when PET’s slope is nonsig)
model_est_PET_PEESE_SMD <- rbind(model_est_PET_PEESE_SMD.sei.intercept[location.nonsig,],model_est_PET_PEESE_SMD.var.intercept[location.sig,]) 

# reorder according to the sequences of meta-analyses
model_est_PET_PEESE_SMD <- model_est_PET_PEESE_SMD[order(model_est_PET_PEESE_SMD$id),] # reorder according to the sequences of meta-analyses


# obtain absolute value
model_est_PET_PEESE_SMD2 <- model_est_PET_PEESE_SMD
model_est_PET_PEESE_SMD2$mu_SMD <- abs(model_est_PET_PEESE_SMD$mu_SMD)

model_est_SMD2 <- model_est_SMD
model_est_SMD2$mu_SMD <- abs(model_est_SMD$mu_SMD)



# using dabestr package to creat a table for paired comparision of meta-analytic overall estimate (MAOM) and bias-corrected estimate (cMAOM)
# estimate <- c(rep('Naive', 15), rep('PET-PEESE', 15))
dummy <- rep("Dummy", 12)
wide.data <- 
  tibble::tibble(
    MAOM = model_est_SMD2$mu_SMD,
    cMAOM = model_est_PET_PEESE_SMD2$mu_SMD,
    Dummy = dummy, ID = 1:12, MA_case = model_est_PET_PEESE_SMD2$MA_case)


my.data   <- 
  wide.data %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired <- 
  my.data %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot.SMD <- two.group.paired %>% 
  cohens_d() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic means (SMM)",
      effsize.ylabel = "Differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot.SMD.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot.SMD
dev.off()


## find correct direction of slope
include.point <- which((wide.data$cMAOM - wide.data$MAOM)<0)
## table only includes correct data
wide.data3 <- wide.data[include.point,]

## make paired comparision plot 
my.data3 <- 
  wide.data3 %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired3 <- 
  my.data3 %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot3_SMD <- two.group.paired3 %>% 
  cohens_d() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic means (SMD)",
      effsize.ylabel = "Differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot3_SMD.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot3_SMD
dev.off()

```



#### 5.2 Compile datasets for adjusted SMD
We only had 3 meta-analyses showing the correct direction slope. For the left 9 meta-analyses, we used original meta-analysis overall mean

```{r}
#***************************************************************#
#                           Model estimates                     #
#***************************************************************#

# get estimates from bias-corrected models (model_est_PET_PEESE_SMD) if in a correct direction of slope. Otherwise it should use estimates from original models (model_est_SMD). 

# view(my.data3) or my.data3$ID can know those from bias-corrected models: 1, 3, 4, 11, 12
# get corresponding estimates
model_est_adjusted_SMD <- data.frame(MA_case=model_est_PET_PEESE_SMD$MA_case,
                    mu_SMD=c(model_est_PET_PEESE_SMD$mu_SMD[1], # match with the my.data3$ID; also see 3, 4, 11
                             model_est_SMD$mu_SMD[2], 
                             model_est_PET_PEESE_SMD$mu_SMD[3], 
                             model_est_PET_PEESE_SMD$mu_SMD[4],
                             model_est_SMD$mu_SMD[5],
                             model_est_SMD$mu_SMD[6],
                             model_est_SMD$mu_SMD[7],
                             model_est_SMD$mu_SMD[8],
                             model_est_SMD$mu_SMD[9],
                             model_est_SMD$mu_SMD[10],
                             model_est_PET_PEESE_SMD$mu_SMD[11],
                             model_est_PET_PEESE_SMD$mu_SMD[12]
                            ),
                    
                    SE_SMD=c(model_est_PET_PEESE_SMD$SE_SMD[1],
                             model_est_SMD$SE_SMD[2], 
                             model_est_PET_PEESE_SMD$SE_SMD[3], 
                             model_est_PET_PEESE_SMD$SE_SMD[4],
                             model_est_SMD$SE_SMD[5],
                             model_est_SMD$SE_SMD[6],
                             model_est_SMD$SE_SMD[7],
                             model_est_SMD$SE_SMD[8],
                             model_est_SMD$SE_SMD[9],
                             model_est_SMD$SE_SMD[10],
                             model_est_PET_PEESE_SMD$SE_SMD[11],
                             model_est_PET_PEESE_SMD$SE_SMD[12]
                            ),
                    
                ll_NHST=c(model_est_PET_PEESE_SMD$ll_NHST[1],
                             model_est_SMD$ll_NHST[2], 
                             model_est_PET_PEESE_SMD$ll_NHST[3], 
                             model_est_PET_PEESE_SMD$ll_NHST[4],
                             model_est_SMD$ll_NHST[5],
                             model_est_SMD$ll_NHST[6],
                             model_est_SMD$ll_NHST[7],
                             model_est_SMD$ll_NHST[8],
                             model_est_SMD$ll_NHST[9],
                             model_est_SMD$ll_NHST[10],
                             model_est_PET_PEESE_SMD$ll_NHST[11],
                             model_est_PET_PEESE_SMD$ll_NHST[12]
                            ),
                
                  ul_NHST=c(model_est_PET_PEESE_SMD$ul_NHST[1],
                             model_est_SMD$ul_NHST[2], 
                             model_est_PET_PEESE_SMD$ul_NHST[3], 
                             model_est_PET_PEESE_SMD$ul_NHST[4],
                             model_est_SMD$ul_NHST[5],
                             model_est_SMD$ul_NHST[6],
                             model_est_SMD$ul_NHST[7],
                             model_est_SMD$ul_NHST[8],
                             model_est_SMD$ul_NHST[9],
                             model_est_SMD$ul_NHST[10],
                             model_est_PET_PEESE_SMD$ul_NHST[11],
                             model_est_PET_PEESE_SMD$ul_NHST[12]
                            ),
                
                  p_value=c(model_est_PET_PEESE_SMD$p_value[1],
                             model_est_SMD$p_value[2], 
                             model_est_PET_PEESE_SMD$p_value[3], 
                             model_est_PET_PEESE_SMD$p_value[4],
                             model_est_SMD$p_value[5],
                             model_est_SMD$p_value[6],
                             model_est_SMD$p_value[7],
                             model_est_SMD$p_value[8],
                             model_est_SMD$p_value[9],
                             model_est_SMD$p_value[10],
                             model_est_PET_PEESE_SMD$p_value[11],
                             model_est_PET_PEESE_SMD$p_value[12]
                            ))  


model_est_adjusted_SMD$SE_SMD <- model_est_SMD$SE_SMD

#***************************************************************#
#                               Models                          #
#***************************************************************#

# using from model_list_PET_PEESE_SMD.sei where slopes show significance (locations from model_est_PET_PEESE_SMD.sei.slope.nonsig) and using models from model_list_PET_PEESE_SMD.var when model_list_PET_PEESE_SMD.sei has sig slopes (viz, locations from model_est_PET_PEESE_SMD.sei.slope.sig)

PET_PEESE_list_SMD <- list(model_list_PET_PEESE_SMD.sei[[1]],
                          model_list_PET_PEESE_SMD.sei[[2]],
                          model_list_PET_PEESE_SMD.sei[[3]],
                          model_list_PET_PEESE_SMD.sei[[4]],
                          model_list_PET_PEESE_SMD.sei[[5]], # locations from model_est_PET_PEESE_SMD.sei.slope.sig
                          model_list_PET_PEESE_SMD.sei[[6]],
                          model_list_PET_PEESE_SMD.sei[[7]],
                          model_list_PET_PEESE_SMD.sei[[8]],
                          model_list_PET_PEESE_SMD.sei[[9]],
                          model_list_PET_PEESE_SMD.sei[[10]],
                          model_list_PET_PEESE_SMD.var[[11]], # locations from model_est_PET_PEESE_SMD.sei.slope.sig
                          model_list_PET_PEESE_SMD.sei[[12]]
                          )

# combine original models
# get models from bias-corrected models (model_est_PET_PEESE_SMD) if in a correct direction of slope. Otherwise it should use original models (model_est_SMD). Using view(my.data3) to get locations of those from bias-corrected models: 1, 3, 4, 11
model_list_adjusted_SMD <- list(PET_PEESE_list_SMD[[1]],
                                model_list_SMD[[2]],
                               PET_PEESE_list_SMD[[3]],
                               PET_PEESE_list_SMD[[4]],
                               model_list_SMD[[5]],
                               model_list_SMD[[6]],
                               model_list_SMD[[7]],
                               model_list_SMD[[8]],
                               model_list_SMD[[9]],
                               model_list_SMD[[10]],
                               PET_PEESE_list_SMD[[11]],
                               PET_PEESE_list_SMD[[12]]
                               )

```



#### 5.3 MA power calculation

```{r}
#***************************************************************#
#             power for 12 meta-analytic cases                  #
#***************************************************************#


# make a list of data
dat_list_adjusted_SMD <- SMD


# prepare "ture" effect of variation (i.e. SMD and SMDH) for power analysis - fit multi-level meta-analytic models


#****************************************************************#
#------------------------------SMD-----------------------------#
#****************************************************************#


#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_adjusted_SMD$MA.power <- power.ma_Shinichi(mu=model_est_adjusted_SMD$mu,SE=model_est_adjusted_SMD$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_adjusted_SMD$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_adjusted_SMD$mu[i],se=model_est_adjusted_SMD$SE[i],alpha=0.05) %>% unlist()
}

model_est_adjusted_SMD$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_adjusted_SMD$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_adjusted_SMD$mu[i],se=model_est_adjusted_SMD$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_adjusted_SMD$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_adjusted_SMD$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_adjusted_SMD$mu[i],se=model_est_adjusted_SMD$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_adjusted_SMD$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_adjusted_SMD, file = "./meta-analysis power_adjusted_SMD.csv", row.names = FALSE)

```


#### 5.4 Individual power calculation

##### 5.4.1 Calculation
```{r}
#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference)


#****************************************************************#
#------------------------------SMD-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# SMD
power.F_adjusted_SMD <- NA
for (i in 1:length(SMD)) {
  power.F_adjusted_SMD[i] <- power.individual_Shinichi(mu=rep(model_est_adjusted_SMD$mu_SMD[i], length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_adjusted_SMD)) {
  dat_list_adjusted_SMD[[i]]$power.F_adjusted_SMD <- power.F_adjusted_SMD[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_adjusted_SMD <- NA
for (i in 1:length(SMD)) {
  power.F.S_adjusted_SMD[i] <- mapply(error_S,mu=rep(model_est_adjusted_SMD$mu_SMD[i], length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_adjusted_SMD)) {
  dat_list_adjusted_SMD[[i]]$power.F.S_adjusted_SMD <- power.F.S_adjusted_SMD[[i]]
}



#---------------- (3) type M error (relative error) --------------#
power.F.M_adjusted_SMD <- NA
for (i in 1:length(SMD)) {
  power.F.M_adjusted_SMD[i] <-mapply(error_M,mu=rep(model_est_adjusted_SMD$mu_SMD[i], length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_adjusted_SMD)) {
  dat_list_adjusted_SMD[[i]]$power.F.M_adjusted_SMD <- power.F.M_adjusted_SMD[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_adjusted_SMD <- NA
for (i in 1:length(SMD)) {
  power.F.M2_adjusted_SMD[i] <-mapply(error_M2,mu=rep(model_est_adjusted_SMD$mu_SMD[i], length(SMD[[i]]$vi)), se=sqrt(SMD[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_adjusted_SMD)) {
  dat_list_adjusted_SMD[[i]]$power.F.M2_adjusted_SMD <- power.F.M2_adjusted_SMD[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_adjusted_SMD <- NA
for (i in 1:length(model_list_adjusted_SMD)) {
  blups.list_adjusted_SMD[i] <- ranef(model_list_adjusted_SMD[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_adjusted_SMD <- NA # list()
for (i in 1:length(model_list_adjusted_SMD)) {
  index.list_adjusted_SMD[i] <- match(as.character(SMD[[i]]$Study),rownames(blups.list_adjusted_SMD[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_adjusted_SMD <-NA
for (i in 1:length(model_list_adjusted_SMD)) {
  effect.R_adjusted_SMD[i] <- mapply(sum, model_est_adjusted_SMD$mu_SMD[i], blups.list_adjusted_SMD[[i]]$Study[index.list_adjusted_SMD[[i]],1], blups.list_adjusted_SMD[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_adjusted_SMD <- NA
for (i in 1:12) {
  power.R_adjusted_SMD[i] <- power.individual_Shinichi(mu=effect.R_adjusted_SMD[[i]], se=sqrt(SMD[[i]]$vi)) %>% list()}

# plot(power_adjusted_SMD[[1]]-power_adjusted_SMD2[[1]]) - check discrepancy
# allocate each set of power into coSMDesponding dataset
for (i in 1:12) {
  dat_list_adjusted_SMD[[i]]$power.R_adjusted_SMD <- power.R_adjusted_SMD[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_adjusted_SMD <- NA
for (i in 1:12) {
  power.R.S_adjusted_SMD[i] <- mapply(error_S, mu=effect.R_adjusted_SMD[[i]], se=sqrt(SMD[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into coSMDesponding dataset
for (i in 1:12) {
  dat_list_adjusted_SMD[[i]]$power.R.S_adjusted_SMD <- power.R.S_adjusted_SMD[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_adjusted_SMD <- NA
for (i in 1:12) {
  power.R.M_adjusted_SMD[i] <- mapply(error_M, mu=effect.R_adjusted_SMD[[i]], se=sqrt(SMD[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDesponding dataset
for (i in 1:length(power.R.M_adjusted_SMD)) {
  dat_list_adjusted_SMD[[i]]$power.R.M_adjusted_SMD <- power.R.M_adjusted_SMD[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_adjusted_SMD <- NA
for (i in 1:12) {
  power.R.M2_adjusted_SMD[i] <- mapply(error_M2, mu=effect.R_adjusted_SMD[[i]], se=sqrt(SMD[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDesponding dataset
for (i in 1:length(power.R.M2_adjusted_SMD)) {
  dat_list_adjusted_SMD[[i]]$power.R.M2_adjusted_SMD <- power.R.M2_adjusted_SMD[[i]]
}
```


##### 5.4.2 Summary of individual power

```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMD------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F_adjusted_SMD))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.S_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.S_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.S_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.S_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.S_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.S_adjusted_SMD))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M_adjusted_SMD))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M2_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M2_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M2_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M2_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M2_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.F.M2_adjusted_SMD))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R_adjusted_SMD))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.S_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.S_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.S_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.S_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.S_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.S_adjusted_SMD))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M_adjusted_SMD))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_adjusted_SMD <- data.frame(MA_case=model_est_adjusted_SMD$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M2_adjusted_SMD))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M2_adjusted_SMD))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M2_adjusted_SMD))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M2_adjusted_SMD))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M2_adjusted_SMD))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMD, function(x) x$power.R.M2_adjusted_SMD))[6,])
```


##### 5.4.3 SE of individual power

```{r}
#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMD------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_adjusted_SMD
se.F_mean <- NA
for (i in 1:length(SMD)) {
  se.F_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.F_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.F_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.F_adjusted_SMD)]))
}

power.F_summary_adjusted_SMD$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_adjusted_SMD
se.F.S_mean <- NA
for (i in 1:length(SMD)) {
  se.F.S_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.F.S_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.F.S_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.F.S_adjusted_SMD)]))
}

power.F.S_summary_adjusted_SMD$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_adjusted_SMD
se.F.M_mean <- NA
for (i in 1:length(SMD)) {
  se.F.M_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.F.M_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.F.M_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.F.M_adjusted_SMD)]))
}

power.F.M_summary_adjusted_SMD$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(SMD)) {
  se.F.M2_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.F.M2_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.F.M2_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.F.M2_adjusted_SMD)]))
}

power.F.M2_summary_adjusted_SMD$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_adjusted_SMD
se.R_mean <- NA
for (i in 1:length(SMD)) {
  se.R_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.R_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.R_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.R_adjusted_SMD)]))
}

power.R_summary_adjusted_SMD$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_adjusted_SMD
se.R.S_mean <- NA
for (i in 1:length(SMD)) {
  se.R.S_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.R.S_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.R.S_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.R.S_adjusted_SMD)]))
}

power.R.S_summary_adjusted_SMD$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_adjusted_SMD
se.R.M_mean <- NA
for (i in 1:length(SMD)) {
  se.R.M_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.R.M_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.R.M_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.R.M_adjusted_SMD)]))
}

power.R.M_summary_adjusted_SMD$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(SMD)) {
  se.R.M2_mean[i] <- sd(dat_list_adjusted_SMD[[i]]$power.R.M2_adjusted_SMD, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMD[[i]]$power.R.M2_adjusted_SMD[!is.na(dat_list_adjusted_SMD[[i]]$power.R.M2_adjusted_SMD)]))
}

power.R.M2_summary_adjusted_SMD$se.R.M2_mean <- se.R.M2_mean
```


#### 5.5 Regression

##### 5.3.1 MA power

```{r}

#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#****************************************************************#
#-----------------------------adjusted_SMD------------------------------#
#****************************************************************#

# add N and k
N_adjusted_SMD <- NA
for (i in 1:length(dat_list_adjusted_SMD)) {
  N_adjusted_SMD[i] <- dat_list_adjusted_SMD[[i]]$Study %>% unique() %>% length()
}

k_adjusted_SMD <- NA
for (i in 1:length(dat_list_adjusted_SMD)) {
  k_adjusted_SMD[i] <- dat_list_adjusted_SMD[[i]]$Unit_ID%>% length()
}

model_est_adjusted_SMD$k <- k_adjusted_SMD


# load meta-analysis level power
#load(here("data","model_est_adjusted_SMD.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_adjusted_SMD <- lm(MA.power~1, weights = k, data = model_est_adjusted_SMD) 
MMA_MA_adjusted_SMD$coefficients
# log
MMA_MA_adjusted_SMD2 <- lm(log(MA.power)~1, weights = k, data = model_est_adjusted_SMD)
# this is median
MMA_MA_adjusted_SMD2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_adjusted_SMD2$coefficients + 0.5*var(log(model_est_adjusted_SMD$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_adjusted_SMD2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_adjusted_SMD) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_adjusted_SMD2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_adjusted_SMD <- lm(MA.power.S~1, weights = k, data = model_est_adjusted_SMD) 
MMA_MA.S_adjusted_SMD$coefficients
# log
MMA_MA.S_adjusted_SMD2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_adjusted_SMD) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_adjusted_SMD2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_adjusted_SMD2$coefficients + 0.5*var(log(model_est_adjusted_SMD$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_adjusted_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_adjusted_SMD) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_adjusted_SMD2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_adjusted_SMD <- lm(MA.power.M~1, weights = k, data = model_est_adjusted_SMD) 
MMA_MA.M_adjusted_SMD$coefficients
# log
MMA_MA.M_adjusted_SMD2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_adjusted_SMD)
# this is median
MMA_MA.M_adjusted_SMD2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coadjusted_SMDect but it is fine for now)
(MMA_MA.M_adjusted_SMD2$coefficients + 0.5*var(log(model_est_adjusted_SMD$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_adjusted_SMD2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_adjusted_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_adjusted_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_adjusted_SMD <- lm(MA.power.M2~1, weights = k, data = model_est_adjusted_SMD) 
MMA_MA.M2_adjusted_SMD$coefficients
# log
MMA_MA.M2_adjusted_SMD2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_adjusted_SMD)
# this is median
MMA_MA.M2_adjusted_SMD2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coadjusted_SMDect but it is fine for now)
(MMA_MA.M2_adjusted_SMD2$coefficients + 0.5*var(log(model_est_adjusted_SMD$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_adjusted_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_adjusted_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_adjusted_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 

```



##### 5.3.2 Individual power

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#****************************************************************#
#-----------------------------adjusted_SMD------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique incase some studies have same identities
# dat_list_adjusted_SMD[[1]]$Study <- paste("m1_1_", dat_list_adjusted_SMD[[1]]$Study, sep = "")
# dat_list_adjusted_SMD[[2]]$Study <- paste("m1_2_", dat_list_adjusted_SMD[[2]]$Study, sep = "")
# dat_list_adjusted_SMD[[3]]$Study <- paste("m2_1_", dat_list_adjusted_SMD[[3]]$Study, sep = "")
# dat_list_adjusted_SMD[[4]]$Study <- paste("m2_2_", dat_list_adjusted_SMD[[4]]$Study, sep = "")
# dat_list_adjusted_SMD[[5]]$Study <- paste("m5_1_", dat_list_adjusted_SMD[[5]]$Study, sep = "")
# dat_list_adjusted_SMD[[6]]$Study <- paste("m6_1_", dat_list_adjusted_SMD[[6]]$Study, sep = "")
# dat_list_adjusted_SMD[[7]]$Study <- paste("m6_2_", dat_list_adjusted_SMD[[7]]$Study, sep = "")
# dat_list_adjusted_SMD[[8]]$Study <- paste("m6_3_", dat_list_adjusted_SMD[[8]]$Study, sep = "")
# dat_list_adjusted_SMD[[9]]$Study <- paste("m6_4_", dat_list_adjusted_SMD[[9]]$Study, sep = "")
# dat_list_adjusted_SMD[[10]]$Study <- paste("m6_5_", dat_list_adjusted_SMD[[10]]$Study, sep = "")
# dat_list_adjusted_SMD[[11]]$Study <- paste("m9_1_", dat_list_adjusted_SMD[[11]]$Study, sep = "")
# dat_list_adjusted_SMD[[12]]$Study <- paste("m11_1_", dat_list_adjusted_SMD[[12]]$Study, sep = "")



studyID_adjusted_SMD <- NA
for (i in 1:length(dat_list_adjusted_SMD)) {
  studyID_adjusted_SMD[i] <- dat_list_adjusted_SMD[[i]]$Study %>% list()
}

stressor_adjusted_SMD <-  c(rep('BD_loss',length(dat_list_adjusted_SMD[[1]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted_SMD[[2]]$Study)),
                  rep('Fert',length(dat_list_adjusted_SMD[[3]]$Study)),
                  rep('Fert',length(dat_list_adjusted_SMD[[4]]$Study)),
                  rep('Fert',length(dat_list_adjusted_SMD[[5]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMD[[6]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMD[[7]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMD[[8]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMD[[9]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMD[[10]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMD[[11]]$Study)),
                  rep('Inv',length(dat_list_adjusted_SMD[[12]]$Study))
                  )


# stressor_adjusted_SMD <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_adjusted_SMD <-  c(rep('E',length(dat_list_adjusted_SMD[[1]]$Study)),
                  rep('E',length(dat_list_adjusted_SMD[[2]]$Study)),
                  rep('E',length(dat_list_adjusted_SMD[[3]]$Study)),
                  rep('E',length(dat_list_adjusted_SMD[[4]]$Study)),
                  rep('E',length(dat_list_adjusted_SMD[[5]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[6]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[7]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[8]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[9]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[10]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[11]]$Study)),
                  rep('O',length(dat_list_adjusted_SMD[[12]]$Study))
                  )

# approach_adjusted_SMD <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_adjusted_SMD <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")


studyID_adjusted_SMD <- unlist(studyID_adjusted_SMD)
power.F_adjusted_SMD <- unlist(power.F_adjusted_SMD)
power.F.S_adjusted_SMD <- unlist(power.F.S_adjusted_SMD)
power.F.M_adjusted_SMD <- unlist(power.F.M_adjusted_SMD)
power.F.M2_adjusted_SMD <- unlist(power.F.M2_adjusted_SMD)
power.R_adjusted_SMD <- unlist(power.R_adjusted_SMD)
power.R.S_adjusted_SMD <- unlist(power.R.S_adjusted_SMD)
power.R.M_adjusted_SMD <- unlist(power.R.M_adjusted_SMD)
power.R.M2_adjusted_SMD <- unlist(power.R.M2_adjusted_SMD)


individual_est_adjusted_SMD <- data.frame("studyID_adjusted_SMD" = studyID_adjusted_SMD,
                                "stressor_adjusted_SMD" = stressor_adjusted_SMD,
                                "approach_adjusted_SMD" = approach_adjusted_SMD,
                                "power.F_adjusted_SMD" = power.F_adjusted_SMD,
                                "power.F.S_adjusted_SMD" = power.F.S_adjusted_SMD,
                                "power.F.M_adjusted_SMD" = power.F.M_adjusted_SMD,
                                "power.F.M2_adjusted_SMD" = power.F.M2_adjusted_SMD,
                                "power.R_adjusted_SMD" = power.R_adjusted_SMD,
                                "power.R.S_adjusted_SMD" = power.R.S_adjusted_SMD,
                                "power.R.M_adjusted_SMD" = power.R.M_adjusted_SMD,
                                "power.R.M2_adjusted_SMD" = power.R.M2_adjusted_SMD)
 
# save(individual_est_adjusted_SMD,file = here("data","individual_est_adjusted_SMD.RData"))
# save(power.F.M_adjusted_SMD,file = here("data","power.F.M_adjusted_SMD.RData"))
# save(power.R.M_adjusted_SMD,file = here("data","power.R.M_adjusted_SMD.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_adjusted_SMD.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_adjusted_SMD <- lmer(power.F_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.F_adjusted_SMD)$coefficients[1]
# log
MMA_power.F_adjusted_SMD2 <- lmer(log(power.F_adjusted_SMD) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median 
summary(MMA_power.F_adjusted_SMD2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F_adjusted_SMD))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_adjusted_SMD2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_SMD) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_SMD2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.F_adjusted_SMD.approach <- lmer(power.F_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.F_adjusted_SMD.approach)$coefficients
# log
MMA_power.F_adjusted_SMD.approach2 <- lmer(log(power.F_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.F_adjusted_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.F_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_adjusted_SMD.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_SMD.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_SMD.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# log
MMA_power.F_adjusted_SMD.approach4 <- lmer(log(power.F_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.F_adjusted_SMD.approach4)



#---------------------- (2) type S error -----------------------#
MMA_power.F.S_adjusted_SMD <- lmer(power.F.S_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.F.S_adjusted_SMD)$coefficients[1]
# log
MMA_power.F.S_adjusted_SMD2 <- lmer(log(power.F.S_adjusted_SMD + 0.025) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_adjusted_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_adjusted_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_adjusted_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_adjusted_SMD) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_adjusted_SMD2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
#residuals(MMA_power.F.S_adjusted_SMD3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.F.S_adjusted_SMD.approach <- lmer(power.F.S_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.F.S_adjusted_SMD.approach)$coefficients
# log
MMA_power.F.S_adjusted_SMD.approach2 <- lmer(log(power.F.S_adjusted_SMD + 0.025) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_adjusted_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_adjusted_SMD.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.F.S_adjusted_SMD.approach4 <- lmer(log(power.F.S_adjusted_SMD + 0.025) ~ 1 + I(approach_adjusted_SMD) + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# check p value
summary(MMA_power.F.S_adjusted_SMD.approach4)


#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_adjusted_SMD <- lmer(power.F.M_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

summary(MMA_power.F.M_adjusted_SMD)$coefficients[1] # I checked the raw data and found that some sampling variances of lnadjusted_SMD are very low. This probably makes some of Type M eadjusted_SMDor extremely high. 

# but log transformation can work
MMA_power.F.M_adjusted_SMD2 <- lmer(log(power.F.M_adjusted_SMD) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

# this is median
summary(MMA_power.F.M_adjusted_SMD2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coadjusted_SMDect but it is fine for now)
(summary(MMA_power.F.M_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F.M_adjusted_SMD))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_adjusted_SMD2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_adjusted_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_adjusted_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.F.M_adjusted_SMD.approach <- lmer(power.F.M_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.F.M_adjusted_SMD.approach)$coefficients
# log
MMA_power.F.M_adjusted_SMD.approach2 <- lmer(log(power.F.M_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.F.M_adjusted_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F.M_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.F.M_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_adjusted_SMD.approach2) %>% exp()


# contrasting model
MMA_power.F.M_adjusted_SMD.approach4 <- lmer(log(power.F.M_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# check p value
summary(MMA_power.F.M_adjusted_SMD.approach4)

#---------------------- (2) type M2 eadjusted_SMDor -----------------------#

MMA_power.F.M2_adjusted_SMD <- lmer(power.F.M2_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

summary(MMA_power.F.M2_adjusted_SMD)$coefficients[1] 

# log 
MMA_power.F.M2_adjusted_SMD2 <- lmer(log(power.F.M2_adjusted_SMD+0.025) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

# this is median
summary(MMA_power.F.M2_adjusted_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coadjusted_SMDect but it is fine for now)
(summary(MMA_power.F.M2_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F.M2_adjusted_SMD+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_adjusted_SMD2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_adjusted_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_adjusted_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.F.M2_adjusted_SMD.approach <- lmer(power.F.M2_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.F.M2_adjusted_SMD.approach)$coefficients
# log
MMA_power.F.M2_adjusted_SMD.approach2 <- lmer(log(power.F.M2_adjusted_SMD + 0.025) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.F.M2_adjusted_SMD.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.F.M2_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.F.M2_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_adjusted_SMD.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_adjusted_SMD <- lmer(power.R_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.R_adjusted_SMD)$coefficients[1]
# log
MMA_power.R_adjusted_SMD2 <- lmer(log(power.R_adjusted_SMD) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median 
summary(MMA_power.R_adjusted_SMD2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R_adjusted_SMD))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_adjusted_SMD2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_SMD) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_SMD2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.R_adjusted_SMD.approach <- lmer(power.R_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.R_adjusted_SMD.approach)$coefficients
# log
MMA_power.R_adjusted_SMD.approach2 <- lmer(log(power.R_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.R_adjusted_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.R_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_adjusted_SMD.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_SMD.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_SMD.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

 

# contrasting model
MMA_power.R_adjusted_SMD.approach4 <- lmer(log(power.R_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# check p value
summary(MMA_power.R_adjusted_SMD.approach4)


#---------------------- (2) type S error -----------------------#
MMA_power.R.S_adjusted_SMD <- lmer(power.R.S_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.R.S_adjusted_SMD)$coefficients[1]

# log
MMA_power.R.S_adjusted_SMD2 <- lmer(log(power.R.S_adjusted_SMD + 0.025) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_adjusted_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_adjusted_SMD2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMD2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_SMD2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_adjusted_SMD2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_adjusted_SMD) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_adjusted_SMD2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")



# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.R.S_adjusted_SMD.approach <- lmer(power.R.S_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.R.S_adjusted_SMD.approach)$coefficients
# log
MMA_power.R.S_adjusted_SMD.approach2 <- lmer(log(power.R.S_adjusted_SMD + 0.025) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_adjusted_SMD.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_SMD.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_SMD.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_adjusted_SMD.approach2) %>% exp()



# contrasting model
MMA_power.R.S_adjusted_SMD.approach4 <- lmer(log(power.R.S_adjusted_SMD + 0.025) ~ 1 + I(approach_adjusted_SMD) + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# check p value
summary(MMA_power.R.S_adjusted_SMD.approach4)


#---------------------- (2) type M error -----------------------#

MMA_power.R.M_adjusted_SMD <- lmer(power.R.M_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

summary(MMA_power.R.M_adjusted_SMD)$coefficients[1] # I checked the raw data and found that some sampling variances of lnadjusted_SMD are very low. This probably makes some of Type M eadjusted_SMDor extremely high. 

# but log transformation can work
MMA_power.R.M_adjusted_SMD2 <- lmer(log(power.R.M_adjusted_SMD) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

# this is median
summary(MMA_power.R.M_adjusted_SMD2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coadjusted_SMDect but it is fine for now)
(summary(MMA_power.R.M_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R.M_adjusted_SMD))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_adjusted_SMD2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_adjusted_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_adjusted_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.R.M_adjusted_SMD.approach <- lmer(power.R.M_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.R.M_adjusted_SMD.approach)$coefficients
# log
MMA_power.R.M_adjusted_SMD.approach2 <- lmer(log(power.R.M_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.R.M_adjusted_SMD.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R.M_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.R.M_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_adjusted_SMD.approach2) %>% exp()



# contrasting model
MMA_power.R.M_adjusted_SMD.approach4 <- lmer(log(power.R.M_adjusted_SMD) ~ 1 + I(approach_adjusted_SMD) + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# check p value
summary(MMA_power.R.M_adjusted_SMD.approach4)


#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_adjusted_SMD <- lmer(power.R.M2_adjusted_SMD ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

summary(MMA_power.R.M2_adjusted_SMD)$coefficients[1] 

# log 
MMA_power.R.M2_adjusted_SMD2 <- lmer(log(power.R.M2_adjusted_SMD+0.025) ~ 1 + (1 | studyID_adjusted_SMD), data = individual_est_adjusted_SMD)

# this is median
summary(MMA_power.R.M2_adjusted_SMD2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coadjusted_SMDect but it is fine for now)
(summary(MMA_power.R.M2_adjusted_SMD2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R.M2_adjusted_SMD+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_adjusted_SMD2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_adjusted_SMD) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_adjusted_SMD2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_SMD as fixed effect and stressor as random effect
MMA_power.R.M2_adjusted_SMD.approach <- lmer(power.R.M2_adjusted_SMD ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
summary(MMA_power.R.M2_adjusted_SMD.approach)$coefficients
# log
MMA_power.R.M2_adjusted_SMD.approach2 <- lmer(log(power.R.M2_adjusted_SMD + 0.025) ~ 1 + I(approach_adjusted_SMD) -1 + (1 | studyID_adjusted_SMD) + (1 | stressor_adjusted_SMD), data = individual_est_adjusted_SMD)
# this is median
summary(MMA_power.R.M2_adjusted_SMD.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_adjusted_SMD.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMD$power.R.M2_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_adjusted_SMD.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMD$power.R.M2_adjusted_SMD[individual_est_adjusted_SMD$approach_adjusted_SMD=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_adjusted_SMD.approach2) %>% exp() - 0.025


# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_adjusted_SMD$approach_adjusted_SMD <- factor(power.F.M_summary_adjusted_SMD$approach_adjusted_SMD, levels=c("O", "E"))
# 
# MMA_power.F.M_adjusted_SMD.approach <- with(power.F.M_summary_adjusted_SMD, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_adjusted_SMD) -1, method = "REML", test = "t")) # relevel(approach, ref="O")

```



### 6. Adjusted lnRR (i.e. lnrr PET-PEESE)

#### 6.1 Estimate adjusted-lnRR (bias-corrected version)

```{r}

#***************************************************************#
#                       PET-PEESE approach                      #
#***************************************************************#

#----------------------------------------------------------------#
#              first-stage: using PET to model SE                #
#----------------------------------------------------------------#


# creating a varible for the "effective sample size" to account for unbalanced sampling
# function to calculate effective sample size
esz <- function(dat){(4*dat$C_N*dat$T_N) / (dat$C_N + dat$T_N)}

 
esz_lnrr <- NA
for (i in 1:length(lnrr)) {
  esz_lnrr[i] <- esz(lnrr[[i]]) %>% list()}
# allocate each set of effective sample size into corresponding dataset
for (i in 1:length(lnrr)) {
  lnrr[[i]]$esz_lnrr <- esz_lnrr[[i]]
}
 

# creating inverse of sqrt of effective sample size - "effective sample size" based "sampling variance" 
## function to calculate inverse of sqrt of effective sample size
esz.var <- function(dat){1/dat$C_N + 1/dat$T_N}
esz.var_lnrr <- NA
for (i in 1:length(lnrr)) {
  esz.var_lnrr[i] <- esz.var(lnrr[[i]]) %>% list()}

# allocate each set of effective sample size into corresponding dataset
for (i in 1:length(lnrr)) {
  lnrr[[i]]$esz.var_lnrr <- esz.var_lnrr[[i]]
}


# fit first stage model - inverse of effective sample size as moderator
model_list_PET_PEESE_lnrr.sei <- list() # rep(NA, length(dat_list))
for (i in 1:length(lnrr)) {
 model_list_PET_PEESE_lnrr.sei[i] <- rma.mv(data = lnrr[[i]], yi = yi, V = vi, mods = ~ sqrt(esz.var_lnrr),random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

# get intercepts and slopes for first stage
## intercepts
model_est_PET_PEESE_lnrr.sei.intercept <- data.frame(MA_case=model_est_lnrr$MA_case,
                  mu_lnrr=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$beta[1]),
                  SE_lnrr=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$pval)[c(seq(1,24,2))]) # odd columns for intercept's p-value


## slopes
model_est_PET_PEESE_lnrr.sei.slope <- data.frame(MA_case=model_est_lnrr$MA_case,
                  mu_lnrr=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$beta[2]),
                  SE_lnrr=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_lnrr.sei, function(x) x$pval)[c(seq(2,24,2))]) # even columns for slope's p-value



#----------------------------------------------------------------#
#           second-stage: using PEESE to model variance          #
#----------------------------------------------------------------#

# fit second stage model - sampling variance as moderator
model_list_PET_PEESE_lnrr.var <- list() 
for (i in 1:12) {
 model_list_PET_PEESE_lnrr.var[i] <- rma.mv(data = lnrr[[i]], yi = yi, V = vi, mods = ~ esz.var_lnrr, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}


# get intercepts and slopes for second stage
## intercepts
model_est_PET_PEESE_lnrr.var.intercept <- data.frame(MA_case=model_est_lnrr$MA_case,
                  mu_lnrr=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$beta[1]),
                  SE_lnrr=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$pval)[c(seq(1,24,2))]) # odd columns for intercept's p-value




## slopes
model_est_PET_PEESE_lnrr.var.slope <- data.frame(MA_case=model_est_lnrr$MA_case,
                  mu_lnrr=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$beta[2]),
                  SE_lnrr=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_lnrr.var, function(x) x$pval)[c(seq(2,24,2))]) # odd columns for slope's p-value




#***************************************************************#
#           find meta-analyses with correct direction           #
#***************************************************************#

# using PET’s intercept ('se' as moderator) when slope is not sig but PEEESE’s intercept (variance or 'se^2' as moderator) if PET’s slope is sig
## label for reorder later
model_est_PET_PEESE_lnrr.sei.intercept$id <- c(1:12)
model_est_PET_PEESE_lnrr.sei.slope$id <- c(1:12)
model_est_PET_PEESE_lnrr.var.intercept$id <- c(1:12)
model_est_PET_PEESE_lnrr.var.slope$id <- c(1:12)

## significant slope
model_est_PET_PEESE_lnrr.sei.slope.sig <- model_est_PET_PEESE_lnrr.sei.slope %>% subset(p_value < 0.05) 
## non-significant slope
model_est_PET_PEESE_lnrr.sei.slope.nonsig <- model_est_PET_PEESE_lnrr.sei.slope %>% subset(p_value > 0.05)

## get location of PET's sig slope and non-sig slope, respectively
location.sig <- which(model_est_PET_PEESE_lnrr.sei.slope$p_value < 0.05)
location.nonsig <- which(model_est_PET_PEESE_lnrr.sei.slope$p_value > 0.05)


## get the intercpet from PEESE (when PET’s slope is sig) and PET (when PET’s slope is nonsig)
model_est_PET_PEESE_lnrr <- rbind(model_est_PET_PEESE_lnrr.sei.intercept[location.nonsig,],model_est_PET_PEESE_lnrr.var.intercept[location.sig,]) 

# reorder according to the sequences of meta-analyses
model_est_PET_PEESE_lnrr <- model_est_PET_PEESE_lnrr[order(model_est_PET_PEESE_lnrr$id),] # reorder according to the sequences of meta-analyses


# obtain absolute value
model_est_PET_PEESE_lnrr2 <- model_est_PET_PEESE_lnrr
model_est_PET_PEESE_lnrr2$mu_lnrr <- abs(model_est_PET_PEESE_lnrr$mu_lnrr)

model_est_lnrr2 <- model_est_lnrr
model_est_lnrr2$mu_lnrr <- abs(model_est_lnrr$mu_lnrr)



# using dabestr package to creat a table for paired comparision of meta-analytic overall estimate (MAOM) and bias-corrected estimate (cMAOM)
# estimate <- c(rep('Naive', 15), rep('PET-PEESE', 15))
dummy <- rep("Dummy", 12)
wide.data <- 
  tibble::tibble(
    MAOM = model_est_lnrr2$mu_lnrr,
    cMAOM = model_est_PET_PEESE_lnrr2$mu_lnrr,
    Dummy = dummy, ID = 1:12, MA_case = model_est_PET_PEESE_lnrr2$MA_case)


my.data   <- 
  wide.data %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired <- 
  my.data %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot.lnrr <- two.group.paired %>% 
  mean_diff() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic estimate (lnrr)",
      effsize.ylabel = "Mean differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot.lnrr.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot.lnrr
dev.off()


## find correct direction of slope
include.point <- which((wide.data$cMAOM - wide.data$MAOM)<0)
## table only includes correct data
wide.data3 <- wide.data[include.point,]

## make paired comparision plot 
my.data3 <- 
  wide.data3 %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired3 <- 
  my.data3 %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot3_lnrr <- two.group.paired3 %>% 
  mean_diff() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic estimate (lnrr)",
      effsize.ylabel = "Mean differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot3_lnrr.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot3_lnrr
dev.off()

```



#### 6.2 Compile datasets for adjusted lnrr
We only had 3 meta-analyses showing the correct direction slope. For the left 9 meta-analyses, we used original meta-analysis overall mean

```{r}
#***************************************************************#
#                           Model estimates                     #
#***************************************************************#

# get estimates from bias-corrected models (model_est_PET_PEESE_lnrr) if in a correct direction of slope. Otherwise it should use estimates from original models (model_est_lnrr). 

# view(my.data3) or my.data3$ID can know those from bias-corrected models: 2, 3, 4, 8, 9, 11
# get corresponding estimates
model_est_adjusted_lnrr <- data.frame(MA_case=model_est_PET_PEESE_lnrr$MA_case,
                    mu_lnrr=c(model_est_lnrr$mu_lnrr[1],
                             model_est_PET_PEESE_lnrr$mu_lnrr[2], # match with the my.data3$ID; also see 3, 4, 8, 9, 11
                             model_est_PET_PEESE_lnrr$mu_lnrr[3], 
                             model_est_PET_PEESE_lnrr$mu_lnrr[4],
                             model_est_lnrr$mu_lnrr[5],
                             model_est_lnrr$mu_lnrr[6],
                             model_est_lnrr$mu_lnrr[7],
                             model_est_PET_PEESE_lnrr$mu_lnrr[8],
                             model_est_PET_PEESE_lnrr$mu_lnrr[9],
                             model_est_lnrr$mu_lnrr[10],
                             model_est_PET_PEESE_lnrr$mu_lnrr[11],
                             model_est_lnrr$mu_lnrr[12]
                            ),
                    
                    SE_lnrr=c(model_est_lnrr$SE_lnrr[1],
                             model_est_PET_PEESE_lnrr$SE_lnrr[2], 
                             model_est_PET_PEESE_lnrr$SE_lnrr[3], 
                             model_est_PET_PEESE_lnrr$SE_lnrr[4],
                             model_est_lnrr$SE_lnrr[5],
                             model_est_lnrr$SE_lnrr[6],
                             model_est_lnrr$SE_lnrr[7],
                             model_est_PET_PEESE_lnrr$SE_lnrr[8],
                             model_est_PET_PEESE_lnrr$SE_lnrr[9],
                             model_est_lnrr$SE_lnrr[10],
                             model_est_PET_PEESE_lnrr$SE_lnrr[11],
                             model_est_lnrr$SE_lnrr[12]
                            ),
                    
                ll_NHST=c(model_est_lnrr$ll_NHST[1],
                             model_est_PET_PEESE_lnrr$ll_NHST[2], 
                             model_est_PET_PEESE_lnrr$ll_NHST[3], 
                             model_est_PET_PEESE_lnrr$ll_NHST[4],
                             model_est_lnrr$ll_NHST[5],
                             model_est_lnrr$ll_NHST[6],
                             model_est_lnrr$ll_NHST[7],
                             model_est_PET_PEESE_lnrr$ll_NHST[8],
                             model_est_PET_PEESE_lnrr$ll_NHST[9],
                             model_est_lnrr$ll_NHST[10],
                             model_est_PET_PEESE_lnrr$ll_NHST[11],
                             model_est_lnrr$ll_NHST[12]
                            ),
                
                  ul_NHST=c(model_est_lnrr$ul_NHST[1],
                             model_est_PET_PEESE_lnrr$ul_NHST[2], 
                             model_est_PET_PEESE_lnrr$ul_NHST[3], 
                             model_est_PET_PEESE_lnrr$ul_NHST[4],
                             model_est_lnrr$ul_NHST[5],
                             model_est_lnrr$ul_NHST[6],
                             model_est_lnrr$ul_NHST[7],
                             model_est_PET_PEESE_lnrr$ul_NHST[8],
                             model_est_PET_PEESE_lnrr$ul_NHST[9],
                             model_est_lnrr$ul_NHST[10],
                             model_est_PET_PEESE_lnrr$ul_NHST[11],
                             model_est_lnrr$ul_NHST[12]
                            ),
                
                  p_value=c(model_est_lnrr$p_value[1],
                             model_est_PET_PEESE_lnrr$p_value[2], 
                             model_est_PET_PEESE_lnrr$p_value[3], 
                             model_est_PET_PEESE_lnrr$p_value[4],
                             model_est_lnrr$p_value[5],
                             model_est_lnrr$p_value[6],
                             model_est_lnrr$p_value[7],
                             model_est_PET_PEESE_lnrr$p_value[8],
                             model_est_PET_PEESE_lnrr$p_value[9],
                             model_est_lnrr$p_value[10],
                             model_est_PET_PEESE_lnrr$p_value[11],
                             model_est_lnrr$p_value[12]
                            ))  
# note that Egger regression’s SE for the intercept is a lot bigger than original one; becuase this is a conditional estimate - SE for the intercept for V = 0 or 1/Neffect = 0; So conditional SE will be usually higher than unconditioned; esepcially there is no actually data when V = 0!; so this really is an estimate

# replace all SE by original SE (unconditional SE); becuase SE from PET-PEEESE is a conditional estimate: SE for the intercept for V = 0 or 1/Neffect = 0
model_est_adjusted_lnrr$SE_lnrr <- model_est_lnrr$SE_lnrr


#***************************************************************#
#                               Models                          #
#***************************************************************#

# using from model_list_PET_PEESE_lnrr.sei where slopes show significance (locations from model_est_PET_PEESE_lnrr.sei.slope.nonsig) and using models from model_list_PET_PEESE_lnrr.var when model_list_PET_PEESE_lnrr.sei has sig slopes (viz, locations from model_est_PET_PEESE_lnrr.sei.slope.sig)

PET_PEESE_list_lnrr <- list(model_list_PET_PEESE_lnrr.sei[[1]],
                          model_list_PET_PEESE_lnrr.sei[[2]],
                          model_list_PET_PEESE_lnrr.sei[[3]],
                          model_list_PET_PEESE_lnrr.sei[[4]],
                          model_list_PET_PEESE_lnrr.sei[[5]],
                          model_list_PET_PEESE_lnrr.sei[[6]],
                          model_list_PET_PEESE_lnrr.var[[7]], # locations from model_est_PET_PEESE_lnrr.sei.slope.sig
                          model_list_PET_PEESE_lnrr.sei[[8]],
                          model_list_PET_PEESE_lnrr.sei[[9]],
                          model_list_PET_PEESE_lnrr.sei[[10]],
                          model_list_PET_PEESE_lnrr.var[[11]], # locations from model_est_PET_PEESE_lnrr.sei.slope.sig
                          model_list_PET_PEESE_lnrr.sei[[12]]
                          )

# combine original models
# get models from bias-corrected models (model_est_PET_PEESE_lnrr) if in a correct direction of slope. Otherwise it should use original models (model_est_lnrr). Using view(my.data3) to get locations of those from bias-corrected models: 2, 3,4, 8, 9, 11
model_list_adjusted_lnrr <- list(model_list_lnrr[[1]],
                                PET_PEESE_list_lnrr[[2]],
                                PET_PEESE_list_lnrr[[3]],
                                PET_PEESE_list_lnrr[[4]],
                                model_list_lnrr[[5]],
                                model_list_lnrr[[6]],
                                model_list_lnrr[[7]],
                                PET_PEESE_list_lnrr[[8]],
                                PET_PEESE_list_lnrr[[9]],
                                model_list_lnrr[[10]],
                                PET_PEESE_list_lnrr[[11]],
                                model_list_lnrr[[12]]
                               )

```




#### 6.3 MA power calculation

```{r}
#***************************************************************#
#             power for 12 meta-analytic cases                  #
#***************************************************************#


# make a list of data
dat_list_adjusted_lnrr <- lnrr


# prepare "ture" effect of variation (i.e. lnrr and lnrrH) for power analysis - fit multi-level meta-analytic models


#****************************************************************#
#------------------------------lnrr-----------------------------#
#****************************************************************#


#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_adjusted_lnrr$MA.power <- power.ma_Shinichi(mu=model_est_adjusted_lnrr$mu,SE=model_est_adjusted_lnrr$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_adjusted_lnrr$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_adjusted_lnrr$mu[i],se=model_est_adjusted_lnrr$SE[i],alpha=0.05) %>% unlist()
}

model_est_adjusted_lnrr$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_adjusted_lnrr$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_adjusted_lnrr$mu[i],se=model_est_adjusted_lnrr$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_adjusted_lnrr$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_adjusted_lnrr$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_adjusted_lnrr$mu[i],se=model_est_adjusted_lnrr$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_adjusted_lnrr$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_adjusted_lnrr, file = "./meta-analysis power_adjusted_lnrr.csv", row.names = FALSE)

```


#### 6.4 Individual power calculation

##### 6.4.1 Calculation
```{r}
#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference)


#****************************************************************#
#------------------------------lnrr-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# lnrr
power.F_adjusted_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F_adjusted_lnrr[i] <- power.individual_Shinichi(mu=rep(model_est_adjusted_lnrr$mu_lnrr[i], length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_adjusted_lnrr)) {
  dat_list_adjusted_lnrr[[i]]$power.F_adjusted_lnrr <- power.F_adjusted_lnrr[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_adjusted_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F.S_adjusted_lnrr[i] <- mapply(error_S,mu=rep(model_est_adjusted_lnrr$mu_lnrr[i], length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_adjusted_lnrr)) {
  dat_list_adjusted_lnrr[[i]]$power.F.S_adjusted_lnrr <- power.F.S_adjusted_lnrr[[i]]
}



#---------------- (3) type M error (relative error) --------------#
power.F.M_adjusted_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F.M_adjusted_lnrr[i] <-mapply(error_M,mu=rep(model_est_adjusted_lnrr$mu_lnrr[i], length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_adjusted_lnrr)) {
  dat_list_adjusted_lnrr[[i]]$power.F.M_adjusted_lnrr <- power.F.M_adjusted_lnrr[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_adjusted_lnrr <- NA
for (i in 1:length(lnrr)) {
  power.F.M2_adjusted_lnrr[i] <-mapply(error_M2,mu=rep(model_est_adjusted_lnrr$mu_lnrr[i], length(lnrr[[i]]$vi)), se=sqrt(lnrr[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_adjusted_lnrr)) {
  dat_list_adjusted_lnrr[[i]]$power.F.M2_adjusted_lnrr <- power.F.M2_adjusted_lnrr[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_adjusted_lnrr <- NA
for (i in 1:length(model_list_adjusted_lnrr)) {
  blups.list_adjusted_lnrr[i] <- ranef(model_list_adjusted_lnrr[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_adjusted_lnrr <- NA # list()
for (i in 1:length(model_list_adjusted_lnrr)) {
  index.list_adjusted_lnrr[i] <- match(as.character(lnrr[[i]]$Study),rownames(blups.list_adjusted_lnrr[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_adjusted_lnrr <-NA
for (i in 1:length(model_list_adjusted_lnrr)) {
  effect.R_adjusted_lnrr[i] <- mapply(sum, model_est_adjusted_lnrr$mu_lnrr[i], blups.list_adjusted_lnrr[[i]]$Study[index.list_adjusted_lnrr[[i]],1], blups.list_adjusted_lnrr[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_adjusted_lnrr <- NA
for (i in 1:12) {
  power.R_adjusted_lnrr[i] <- power.individual_Shinichi(mu=effect.R_adjusted_lnrr[[i]], se=sqrt(lnrr[[i]]$vi)) %>% list()}

# plot(power_adjusted_lnrr[[1]]-power_adjusted_lnrr2[[1]]) - check discrepancy
# allocate each set of power into colnrresponding dataset
for (i in 1:12) {
  dat_list_adjusted_lnrr[[i]]$power.R_adjusted_lnrr <- power.R_adjusted_lnrr[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_adjusted_lnrr <- NA
for (i in 1:12) {
  power.R.S_adjusted_lnrr[i] <- mapply(error_S, mu=effect.R_adjusted_lnrr[[i]], se=sqrt(lnrr[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into colnrresponding dataset
for (i in 1:12) {
  dat_list_adjusted_lnrr[[i]]$power.R.S_adjusted_lnrr <- power.R.S_adjusted_lnrr[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_adjusted_lnrr <- NA
for (i in 1:12) {
  power.R.M_adjusted_lnrr[i] <- mapply(error_M, mu=effect.R_adjusted_lnrr[[i]], se=sqrt(lnrr[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into colnrresponding dataset
for (i in 1:length(power.R.M_adjusted_lnrr)) {
  dat_list_adjusted_lnrr[[i]]$power.R.M_adjusted_lnrr <- power.R.M_adjusted_lnrr[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_adjusted_lnrr <- NA
for (i in 1:12) {
  power.R.M2_adjusted_lnrr[i] <- mapply(error_M2, mu=effect.R_adjusted_lnrr[[i]], se=sqrt(lnrr[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into colnrresponding dataset
for (i in 1:length(power.R.M2_adjusted_lnrr)) {
  dat_list_adjusted_lnrr[[i]]$power.R.M2_adjusted_lnrr <- power.R.M2_adjusted_lnrr[[i]]
}
```


##### 6.4.2 Summary of individual power

```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#****************************************************************#
#-----------------------------lnrr------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F_adjusted_lnrr))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.S_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.S_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.S_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.S_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.S_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.S_adjusted_lnrr))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M_adjusted_lnrr))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M2_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M2_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M2_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M2_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M2_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.F.M2_adjusted_lnrr))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R_adjusted_lnrr))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.S_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.S_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.S_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.S_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.S_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.S_adjusted_lnrr))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M_adjusted_lnrr))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_adjusted_lnrr <- data.frame(MA_case=model_est_adjusted_lnrr$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M2_adjusted_lnrr))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M2_adjusted_lnrr))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M2_adjusted_lnrr))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M2_adjusted_lnrr))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M2_adjusted_lnrr))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_lnrr, function(x) x$power.R.M2_adjusted_lnrr))[6,])
```


##### 6.4.3 SE of individual power

```{r}
#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#****************************************************************#
#-----------------------------lnrr------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_adjusted_lnrr
se.F_mean <- NA
for (i in 1:length(lnrr)) {
  se.F_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.F_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.F_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.F_adjusted_lnrr)]))
}

power.F_summary_adjusted_lnrr$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_adjusted_lnrr
se.F.S_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.S_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.F.S_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.F.S_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.F.S_adjusted_lnrr)]))
}

power.F.S_summary_adjusted_lnrr$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_adjusted_lnrr
se.F.M_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.M_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.F.M_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.F.M_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.F.M_adjusted_lnrr)]))
}

power.F.M_summary_adjusted_lnrr$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(lnrr)) {
  se.F.M2_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.F.M2_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.F.M2_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.F.M2_adjusted_lnrr)]))
}

power.F.M2_summary_adjusted_lnrr$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_adjusted_lnrr
se.R_mean <- NA
for (i in 1:length(lnrr)) {
  se.R_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.R_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.R_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.R_adjusted_lnrr)]))
}

power.R_summary_adjusted_lnrr$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_adjusted_lnrr
se.R.S_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.S_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.R.S_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.R.S_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.R.S_adjusted_lnrr)]))
}

power.R.S_summary_adjusted_lnrr$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_adjusted_lnrr
se.R.M_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.M_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.R.M_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.R.M_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.R.M_adjusted_lnrr)]))
}

power.R.M_summary_adjusted_lnrr$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(lnrr)) {
  se.R.M2_mean[i] <- sd(dat_list_adjusted_lnrr[[i]]$power.R.M2_adjusted_lnrr, na.rm=TRUE) / sqrt(length(dat_list_adjusted_lnrr[[i]]$power.R.M2_adjusted_lnrr[!is.na(dat_list_adjusted_lnrr[[i]]$power.R.M2_adjusted_lnrr)]))
}

power.R.M2_summary_adjusted_lnrr$se.R.M2_mean <- se.R.M2_mean
```


#### 6.5 Regression

##### 6.3.1 MA power

```{r}

#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#****************************************************************#
#-----------------------------adjusted_lnrr------------------------------#
#****************************************************************#

# add N and k
N_adjusted_lnrr <- NA
for (i in 1:length(dat_list_adjusted_lnrr)) {
  N_adjusted_lnrr[i] <- dat_list_adjusted_lnrr[[i]]$Study %>% unique() %>% length()
}

k_adjusted_lnrr <- NA
for (i in 1:length(dat_list_adjusted_lnrr)) {
  k_adjusted_lnrr[i] <- dat_list_adjusted_lnrr[[i]]$Unit_ID%>% length()
}

model_est_adjusted_lnrr$k <- k_adjusted_lnrr
model_est_adjusted_lnrr$N <- N_adjusted_lnrr

# load meta-analysis level power
# load(here("data","model_est_adjusted_lnrr.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_adjusted_lnrr <- lm(MA.power~1, weights = k, data = model_est_adjusted_lnrr) 
MMA_MA_adjusted_lnrr$coefficients
# log
MMA_MA_adjusted_lnrr2 <- lm(log(MA.power)~1, weights = k, data = model_est_adjusted_lnrr)
# this is median
MMA_MA_adjusted_lnrr2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_adjusted_lnrr$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_adjusted_lnrr2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_adjusted_lnrr) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_adjusted_lnrr2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_adjusted_lnrr <- lm(MA.power.S~1, weights = k, data = model_est_adjusted_lnrr) 
MMA_MA.S_adjusted_lnrr$coefficients
# log
MMA_MA.S_adjusted_lnrr2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_adjusted_lnrr) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_adjusted_lnrr2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_adjusted_lnrr$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_adjusted_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_adjusted_lnrr) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_adjusted_lnrr2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_adjusted_lnrr <- lm(MA.power.M~1, weights = k, data = model_est_adjusted_lnrr) 
MMA_MA.M_adjusted_lnrr$coefficients
# log
MMA_MA.M_adjusted_lnrr2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_adjusted_lnrr)
# this is median
MMA_MA.M_adjusted_lnrr2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coadjusted_lnrrect but it is fine for now)
(MMA_MA.M_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_adjusted_lnrr$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_adjusted_lnrr2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_adjusted_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_adjusted_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_adjusted_lnrr <- lm(MA.power.M2~1, weights = k, data = model_est_adjusted_lnrr) 
MMA_MA.M2_adjusted_lnrr$coefficients
# log
MMA_MA.M2_adjusted_lnrr2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_adjusted_lnrr)
# this is median
MMA_MA.M2_adjusted_lnrr2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coadjusted_lnrrect but it is fine for now)
(MMA_MA.M2_adjusted_lnrr2$coefficients + 0.5*var(log(model_est_adjusted_lnrr$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_adjusted_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_adjusted_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_adjusted_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 

```



##### 6.3.2 Individual power

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#****************************************************************#
#-----------------------------adjusted_lnrr------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique incase some studies have same identities
# dat_list_adjusted_lnrr[[1]]$Study <- paste("m1_1_", dat_list_adjusted_lnrr[[1]]$Study, sep = "")
# dat_list_adjusted_lnrr[[2]]$Study <- paste("m1_2_", dat_list_adjusted_lnrr[[2]]$Study, sep = "")
# dat_list_adjusted_lnrr[[3]]$Study <- paste("m2_1_", dat_list_adjusted_lnrr[[3]]$Study, sep = "")
# dat_list_adjusted_lnrr[[4]]$Study <- paste("m2_2_", dat_list_adjusted_lnrr[[4]]$Study, sep = "")
# dat_list_adjusted_lnrr[[5]]$Study <- paste("m5_1_", dat_list_adjusted_lnrr[[5]]$Study, sep = "")
# dat_list_adjusted_lnrr[[6]]$Study <- paste("m6_1_", dat_list_adjusted_lnrr[[6]]$Study, sep = "")
# dat_list_adjusted_lnrr[[7]]$Study <- paste("m6_2_", dat_list_adjusted_lnrr[[7]]$Study, sep = "")
# dat_list_adjusted_lnrr[[8]]$Study <- paste("m6_3_", dat_list_adjusted_lnrr[[8]]$Study, sep = "")
# dat_list_adjusted_lnrr[[9]]$Study <- paste("m6_4_", dat_list_adjusted_lnrr[[9]]$Study, sep = "")
# dat_list_adjusted_lnrr[[10]]$Study <- paste("m6_5_", dat_list_adjusted_lnrr[[10]]$Study, sep = "")
# dat_list_adjusted_lnrr[[11]]$Study <- paste("m9_1_", dat_list_adjusted_lnrr[[11]]$Study, sep = "")
# dat_list_adjusted_lnrr[[12]]$Study <- paste("m11_1_", dat_list_adjusted_lnrr[[12]]$Study, sep = "")


studyID_adjusted_lnrr <- NA
for (i in 1:length(dat_list_adjusted_lnrr)) {
  studyID_adjusted_lnrr[i] <- dat_list_adjusted_lnrr[[i]]$Study %>% list()
}

MA_case_adjusted_lnrr <-  c(rep('m1_1',length(dat_list_adjusted_lnrr[[1]]$Study)),
                  rep('m1_2',length(dat_list_adjusted_lnrr[[2]]$Study)),
                  rep('m2_1',length(dat_list_adjusted_lnrr[[3]]$Study)),
                  rep('m2_2',length(dat_list_adjusted_lnrr[[4]]$Study)),
                  rep('m5_1',length(dat_list_adjusted_lnrr[[5]]$Study)),
                  rep('m6_1',length(dat_list_adjusted_lnrr[[6]]$Study)),
                  rep('m6_2',length(dat_list_adjusted_lnrr[[7]]$Study)),
                  rep('m6_3',length(dat_list_adjusted_lnrr[[8]]$Study)),
                  rep('m6_4',length(dat_list_adjusted_lnrr[[9]]$Study)),
                  rep('m6_5',length(dat_list_adjusted_lnrr[[10]]$Study)),
                  rep('m9_1',length(dat_list_adjusted_lnrr[[11]]$Study)),
                  rep('m11_1',length(dat_list_adjusted_lnrr[[12]]$Study))
                  )
#MA_case_adjusted_lnrr <- c("1m1_1",  "2m1_2",  "3m2_1",  "4m2_2",  "5m5_1",  "6m6_1",  "7m6_2",  "8m6_3",  "9m6_4",  "10m6_5",  "11m9_1", "12m11_1")


stressor_adjusted_lnrr <-  c(rep('BD_loss',length(dat_list_adjusted_lnrr[[1]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted_lnrr[[2]]$Study)),
                  rep('Fert',length(dat_list_adjusted_lnrr[[3]]$Study)),
                  rep('Fert',length(dat_list_adjusted_lnrr[[4]]$Study)),
                  rep('Fert',length(dat_list_adjusted_lnrr[[5]]$Study)),
                  rep('LUC',length(dat_list_adjusted_lnrr[[6]]$Study)),
                  rep('LUC',length(dat_list_adjusted_lnrr[[7]]$Study)),
                  rep('LUC',length(dat_list_adjusted_lnrr[[8]]$Study)),
                  rep('LUC',length(dat_list_adjusted_lnrr[[9]]$Study)),
                  rep('LUC',length(dat_list_adjusted_lnrr[[10]]$Study)),
                  rep('LUC',length(dat_list_adjusted_lnrr[[11]]$Study)),
                  rep('Inv',length(dat_list_adjusted_lnrr[[12]]$Study))
                  )


#stressor_adjusted_lnrr <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_adjusted_lnrr <-  c(rep('E',length(dat_list_adjusted_lnrr[[1]]$Study)),
                  rep('E',length(dat_list_adjusted_lnrr[[2]]$Study)),
                  rep('E',length(dat_list_adjusted_lnrr[[3]]$Study)),
                  rep('E',length(dat_list_adjusted_lnrr[[4]]$Study)),
                  rep('E',length(dat_list_adjusted_lnrr[[5]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[6]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[7]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[8]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[9]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[10]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[11]]$Study)),
                  rep('O',length(dat_list_adjusted_lnrr[[12]]$Study))
                  )

#approach_adjusted_lnrr <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_adjusted_lnrr <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")


studyID_adjusted_lnrr <- unlist(studyID_adjusted_lnrr)
power.F_adjusted_lnrr <- unlist(power.F_adjusted_lnrr)
power.F.S_adjusted_lnrr <- unlist(power.F.S_adjusted_lnrr)
power.F.M_adjusted_lnrr <- unlist(power.F.M_adjusted_lnrr)
power.F.M2_adjusted_lnrr <- unlist(power.F.M2_adjusted_lnrr)
power.R_adjusted_lnrr <- unlist(power.R_adjusted_lnrr)
power.R.S_adjusted_lnrr <- unlist(power.R.S_adjusted_lnrr)
power.R.M_adjusted_lnrr <- unlist(power.R.M_adjusted_lnrr)
power.R.M2_adjusted_lnrr <- unlist(power.R.M2_adjusted_lnrr)


individual_est_adjusted_lnrr <- data.frame("MA_case_adjusted_lnrr" = MA_case_adjusted_lnrr,
                                           "studyID_adjusted_lnrr" = studyID_adjusted_lnrr,
                                "stressor_adjusted_lnrr" = stressor_adjusted_lnrr,
                                "approach_adjusted_lnrr" = approach_adjusted_lnrr,
                                "power.F_adjusted_lnrr" = power.F_adjusted_lnrr,
                                "power.F.S_adjusted_lnrr" = power.F.S_adjusted_lnrr,
                                "power.F.M_adjusted_lnrr" = power.F.M_adjusted_lnrr,
                                "power.F.M2_adjusted_lnrr" = power.F.M2_adjusted_lnrr,
                                "power.R_adjusted_lnrr" = power.R_adjusted_lnrr,
                                "power.R.S_adjusted_lnrr" = power.R.S_adjusted_lnrr,
                                "power.R.M_adjusted_lnrr" = power.R.M_adjusted_lnrr,
                                "power.R.M2_adjusted_lnrr" = power.R.M2_adjusted_lnrr)

# save(individual_est_adjusted_lnrr,file = here("data","individual_est_adjusted_lnrr.RData"))
# save(power.F.M_adjusted_lnrr,file = here("data","power.F.M_adjusted_lnrr.RData"))
# save(power.R.M_adjusted_lnrr,file = here("data","power.R.M_adjusted_lnrr.RData"))


# load individual level power
# load(here("data","individual_est_adjusted_lnrr.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_adjusted_lnrr <- lmer(power.F_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.F_adjusted_lnrr)$coefficients[1]
# log
MMA_power.F_adjusted_lnrr2 <- lmer(log(power.F_adjusted_lnrr) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median 
summary(MMA_power.F_adjusted_lnrr2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F_adjusted_lnrr))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_adjusted_lnrr2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_lnrr) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_lnrr2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.F_adjusted_lnrr.approach <- lmer(power.F_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.F_adjusted_lnrr.approach)$coefficients
# log
MMA_power.F_adjusted_lnrr.approach2 <- lmer(log(power.F_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.F_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_adjusted_lnrr.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_lnrr.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_lnrr.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 



# contrasting model
MMA_power.F_adjusted_lnrr.approach4 <- lmer(log(power.F_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# check p value
summary(MMA_power.F_adjusted_lnrr.approach4)


#---------------------- (2) type S error -----------------------#
MMA_power.F.S_adjusted_lnrr <- lmer(power.F.S_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.F.S_adjusted_lnrr)$coefficients[1]
# log
MMA_power.F.S_adjusted_lnrr2 <- lmer(log(power.F.S_adjusted_lnrr + 0.025) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_adjusted_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_adjusted_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_adjusted_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_adjusted_lnrr) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_adjusted_lnrr2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
#residuals(MMA_power.F.S_adjusted_lnrr3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.F.S_adjusted_lnrr.approach <- lmer(power.F.S_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.F.S_adjusted_lnrr.approach)$coefficients
# log
MMA_power.F.S_adjusted_lnrr.approach2 <- lmer(log(power.F.S_adjusted_lnrr + 0.025) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_adjusted_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_adjusted_lnrr.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.F.S_adjusted_lnrr.approach4 <- lmer(log(power.F.S_adjusted_lnrr + 0.025) ~ 1 + I(approach_adjusted_lnrr) + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# check p value
summary(MMA_power.F.S_adjusted_lnrr.approach4)

#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_adjusted_lnrr <- lmer(power.F.M_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

summary(MMA_power.F.M_adjusted_lnrr)$coefficients[1] # I checked the raw data and found that some sampling variances of lnadjusted_lnrr are very low. This probably makes some of Type M eadjusted_lnrror extremely high. 

# but log transformation can work
MMA_power.F.M_adjusted_lnrr2 <- lmer(log(power.F.M_adjusted_lnrr) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

# this is median
summary(MMA_power.F.M_adjusted_lnrr2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coadjusted_lnrrect but it is fine for now)
(summary(MMA_power.F.M_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F.M_adjusted_lnrr))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_adjusted_lnrr2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_adjusted_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_adjusted_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.F.M_adjusted_lnrr.approach <- lmer(power.F.M_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.F.M_adjusted_lnrr.approach)$coefficients
# log
MMA_power.F.M_adjusted_lnrr.approach2 <- lmer(log(power.F.M_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.F.M_adjusted_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F.M_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.F.M_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_adjusted_lnrr.approach2) %>% exp()



# contrasting model
MMA_power.F.M_adjusted_lnrr.approach4 <- lmer(log(power.F.M_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# check p value
summary(MMA_power.F.M_adjusted_lnrr.approach4)


#---------------------- (2) type M2 eadjusted_lnrror -----------------------#

MMA_power.F.M2_adjusted_lnrr <- lmer(power.F.M2_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

summary(MMA_power.F.M2_adjusted_lnrr)$coefficients[1] 

# log 
MMA_power.F.M2_adjusted_lnrr2 <- lmer(log(power.F.M2_adjusted_lnrr+0.025) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

# this is median
summary(MMA_power.F.M2_adjusted_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coadjusted_lnrrect but it is fine for now)
(summary(MMA_power.F.M2_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F.M2_adjusted_lnrr+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_adjusted_lnrr2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_adjusted_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_adjusted_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.F.M2_adjusted_lnrr.approach <- lmer(power.F.M2_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.F.M2_adjusted_lnrr.approach)$coefficients
# log
MMA_power.F.M2_adjusted_lnrr.approach2 <- lmer(log(power.F.M2_adjusted_lnrr + 0.025) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.F.M2_adjusted_lnrr.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.F.M2_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.F.M2_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_adjusted_lnrr.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_adjusted_lnrr <- lmer(power.R_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.R_adjusted_lnrr)$coefficients[1]
# log
MMA_power.R_adjusted_lnrr2 <- lmer(log(power.R_adjusted_lnrr) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median 
summary(MMA_power.R_adjusted_lnrr2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R_adjusted_lnrr))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_adjusted_lnrr2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_lnrr) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_lnrr2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.R_adjusted_lnrr.approach <- lmer(power.R_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.R_adjusted_lnrr.approach)$coefficients
# log
MMA_power.R_adjusted_lnrr.approach2 <- lmer(log(power.R_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.R_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_adjusted_lnrr.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_lnrr.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_lnrr.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

 

# contrasting model
MMA_power.R_adjusted_lnrr.approach4 <- lmer(log(power.R_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# check p value
summary(MMA_power.R_adjusted_lnrr.approach4)


#---------------------- (2) type S error -----------------------#
MMA_power.R.S_adjusted_lnrr <- lmer(power.R.S_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.R.S_adjusted_lnrr)$coefficients[1]

# log
MMA_power.R.S_adjusted_lnrr2 <- lmer(log(power.R.S_adjusted_lnrr + 0.025) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_adjusted_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_adjusted_lnrr2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_lnrr2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_lnrr2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_adjusted_lnrr2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_adjusted_lnrr) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_adjusted_lnrr2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")



# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.R.S_adjusted_lnrr.approach <- lmer(power.R.S_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.R.S_adjusted_lnrr.approach)$coefficients
# log
MMA_power.R.S_adjusted_lnrr.approach2 <- lmer(log(power.R.S_adjusted_lnrr + 0.025) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_adjusted_lnrr.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_lnrr.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_lnrr.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_adjusted_lnrr.approach2) %>% exp()


# contrasting model
MMA_power.R.S_adjusted_lnrr.approach4 <- lmer(log(power.R.S_adjusted_lnrr + 0.025) ~ 1 + I(approach_adjusted_lnrr) + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# check p value
summary(MMA_power.R.S_adjusted_lnrr.approach4)



#---------------------- (2) type M error -----------------------#

MMA_power.R.M_adjusted_lnrr <- lmer(power.R.M_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

summary(MMA_power.R.M_adjusted_lnrr)$coefficients[1] # I checked the raw data and found that some sampling variances of lnadjusted_lnrr are very low. This probably makes some of Type M eadjusted_lnrror extremely high. 

# but log transformation can work
MMA_power.R.M_adjusted_lnrr2 <- lmer(log(power.R.M_adjusted_lnrr) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

# this is median
summary(MMA_power.R.M_adjusted_lnrr2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coadjusted_lnrrect but it is fine for now)
(summary(MMA_power.R.M_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R.M_adjusted_lnrr))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_adjusted_lnrr2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_adjusted_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_adjusted_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.R.M_adjusted_lnrr.approach <- lmer(power.R.M_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.R.M_adjusted_lnrr.approach)$coefficients
# log
MMA_power.R.M_adjusted_lnrr.approach2 <- lmer(log(power.R.M_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.R.M_adjusted_lnrr.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R.M_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.R.M_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_adjusted_lnrr.approach2) %>% exp()



# contrasting model
MMA_power.R.M_adjusted_lnrr.approach4 <- lmer(log(power.R.M_adjusted_lnrr) ~ 1 + I(approach_adjusted_lnrr) + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# check p value
summary(MMA_power.R.M_adjusted_lnrr.approach4)

#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_adjusted_lnrr <- lmer(power.R.M2_adjusted_lnrr ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

summary(MMA_power.R.M2_adjusted_lnrr)$coefficients[1] 

# log 
MMA_power.R.M2_adjusted_lnrr2 <- lmer(log(power.R.M2_adjusted_lnrr+0.025) ~ 1 + (1 | studyID_adjusted_lnrr), data = individual_est_adjusted_lnrr)

# this is median
summary(MMA_power.R.M2_adjusted_lnrr2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coadjusted_lnrrect but it is fine for now)
(summary(MMA_power.R.M2_adjusted_lnrr2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R.M2_adjusted_lnrr+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_adjusted_lnrr2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_adjusted_lnrr) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_adjusted_lnrr2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_lnrr as fixed effect and stressor as random effect
MMA_power.R.M2_adjusted_lnrr.approach <- lmer(power.R.M2_adjusted_lnrr ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
summary(MMA_power.R.M2_adjusted_lnrr.approach)$coefficients
# log
MMA_power.R.M2_adjusted_lnrr.approach2 <- lmer(log(power.R.M2_adjusted_lnrr + 0.025) ~ 1 + I(approach_adjusted_lnrr) -1 + (1 | studyID_adjusted_lnrr) + (1 | stressor_adjusted_lnrr), data = individual_est_adjusted_lnrr)
# this is median
summary(MMA_power.R.M2_adjusted_lnrr.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_adjusted_lnrr.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_lnrr$power.R.M2_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_adjusted_lnrr.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_lnrr$power.R.M2_adjusted_lnrr[individual_est_adjusted_lnrr$approach_adjusted_lnrr=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_adjusted_lnrr.approach2) %>% exp() - 0.025


# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_adjusted_lnrr$approach_adjusted_lnrr <- factor(power.F.M_summary_adjusted_lnrr$approach_adjusted_lnrr, levels=c("O", "E"))
# 
# MMA_power.F.M_adjusted_lnrr.approach <- with(power.F.M_summary_adjusted_lnrr, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_adjusted_lnrr) -1, method = "REML", test = "t")) # relevel(approach, ref="O")

```




### 7. Adjusted SMDH (i.e. SMDH PET-PEESE)

#### 7.1 Estimate adjusted-SMDH (bias-corrected version)

```{r}

#***************************************************************#
#                       PET-PEESE approach                      #
#***************************************************************#

#----------------------------------------------------------------#
#              first-stage: using PET to model SE                #
#----------------------------------------------------------------#


# creating a varible for the "effective sample size" to account for unbalanced sampling
# function to calculate effective sample size
esz <- function(dat){(4*dat$C_N*dat$T_N) / (dat$C_N + dat$T_N)}

 
esz_SMDH <- NA
for (i in 1:length(SMDH)) {
  esz_SMDH[i] <- esz(SMDH[[i]]) %>% list()}
# allocate each set of effective sample size into corresponding dataset
for (i in 1:length(SMDH)) {
  SMDH[[i]]$esz_SMDH <- esz_SMDH[[i]]
}
 

# creating inverse of sqrt of effective sample size - "effective sample size" based "sampling variance" 
## function to calculate inverse of sqrt of effective sample size
esz.var <- function(dat){1/dat$C_N + 1/dat$T_N}
esz.var_SMDH <- NA
for (i in 1:length(SMDH)) {
  esz.var_SMDH[i] <- esz.var(SMDH[[i]]) %>% list()}

# allocate each set of effective sample size into corresponding dataset
for (i in 1:length(SMDH)) {
  SMDH[[i]]$esz.var_SMDH <- esz.var_SMDH[[i]]
}


# fit first stage model - inverse of effective sample size as moderator
model_list_PET_PEESE_SMDH.sei <- list() # rep(NA, length(dat_list))
for (i in 1:length(SMDH)) {
 model_list_PET_PEESE_SMDH.sei[i] <- rma.mv(data = SMDH[[i]], yi = yi, V = vi, mods = ~ sqrt(esz.var_SMDH),random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}

# get intercepts and slopes for first stage
## intercepts
model_est_PET_PEESE_SMDH.sei.intercept <- data.frame(MA_case=model_est_SMDH$MA_case,
                  mu_SMDH=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$beta[1]),
                  SE_SMDH=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$pval)[c(seq(1,24,2))]) # odd columns for intercept's p-value


## slopes
model_est_PET_PEESE_SMDH.sei.slope <- data.frame(MA_case=model_est_SMDH$MA_case,
                  mu_SMDH=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$beta[2]),
                  SE_SMDH=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_SMDH.sei, function(x) x$pval)[c(seq(2,24,2))]) # even columns for slope's p-value



#----------------------------------------------------------------#
#           second-stage: using PEESE to model variance          #
#----------------------------------------------------------------#

# fit second stage model - sampling variance as moderator
model_list_PET_PEESE_SMDH.var <- list() 
for (i in 1:12) {
 model_list_PET_PEESE_SMDH.var[i] <- rma.mv(data = SMDH[[i]], yi = yi, V = vi, mods = ~ esz.var_SMDH, random = list(~1|Study, ~1|Unit_ID), method = "REML", test = "t") %>% list()
}


# get intercepts and slopes for second stage
## intercepts
model_est_PET_PEESE_SMDH.var.intercept <- data.frame(MA_case=model_est_SMDH$MA_case,
                  mu_SMDH=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$beta[1]),
                  SE_SMDH=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$se[1]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$ci.lb[1]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$ci.ub[1]),
                  p_value=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$pval)[c(seq(1,24,2))]) # odd columns for intercept's p-value




## slopes
model_est_PET_PEESE_SMDH.var.slope <- data.frame(MA_case=model_est_SMDH$MA_case,
                  mu_SMDH=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$beta[2]),
                  SE_SMDH=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$se[2]),
                  ll_NHST=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$ci.lb[2]),
                  ul_NHST=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$ci.ub[2]),
                  p_value=sapply(model_list_PET_PEESE_SMDH.var, function(x) x$pval)[c(seq(2,24,2))]) # odd columns for slope's p-value




#***************************************************************#
#           find meta-analyses with correct direction           #
#***************************************************************#

# using PET’s intercept ('se' as moderator) when slope is not sig but PEEESE’s intercept (variance or 'se^2' as moderator) if PET’s slope is sig
## label for reorder later
model_est_PET_PEESE_SMDH.sei.intercept$id <- c(1:12)
model_est_PET_PEESE_SMDH.sei.slope$id <- c(1:12)
model_est_PET_PEESE_SMDH.var.intercept$id <- c(1:12)
model_est_PET_PEESE_SMDH.var.slope$id <- c(1:12)

## significant slope
model_est_PET_PEESE_SMDH.sei.slope.sig <- model_est_PET_PEESE_SMDH.sei.slope %>% subset(p_value < 0.05) 
## non-significant slope
model_est_PET_PEESE_SMDH.sei.slope.nonsig <- model_est_PET_PEESE_SMDH.sei.slope %>% subset(p_value > 0.05)

## get location of PET's sig slope and non-sig slope, respectively
location.sig <- which(model_est_PET_PEESE_SMDH.sei.slope$p_value < 0.05)
location.nonsig <- which(model_est_PET_PEESE_SMDH.sei.slope$p_value > 0.05)


## get the intercpet from PEESE (when PET’s slope is sig) and PET (when PET’s slope is nonsig)
model_est_PET_PEESE_SMDH <- rbind(model_est_PET_PEESE_SMDH.sei.intercept[location.nonsig,],model_est_PET_PEESE_SMDH.var.intercept[location.sig,]) 

# reorder according to the sequences of meta-analyses
model_est_PET_PEESE_SMDH <- model_est_PET_PEESE_SMDH[order(model_est_PET_PEESE_SMDH$id),] # reorder according to the sequences of meta-analyses


# obtain absolute value
model_est_PET_PEESE_SMDH2 <- model_est_PET_PEESE_SMDH
model_est_PET_PEESE_SMDH2$mu_SMDH <- abs(model_est_PET_PEESE_SMDH$mu_SMDH)

model_est_SMDH2 <- model_est_SMDH
model_est_SMDH2$mu_SMDH <- abs(model_est_SMDH$mu_SMDH)



# using dabestr package to creat a table for paired comparision of meta-analytic overall estimate (MAOM) and bias-corrected estimate (cMAOM)
# estimate <- c(rep('Naive', 15), rep('PET-PEESE', 15))
dummy <- rep("Dummy", 12)
wide.data <- 
  tibble::tibble(
    MAOM = model_est_SMDH2$mu_SMDH,
    cMAOM = model_est_PET_PEESE_SMDH2$mu_SMDH,
    Dummy = dummy, ID = 1:12, MA_case = model_est_PET_PEESE_SMDH2$MA_case)


my.data   <- 
  wide.data %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired <- 
  my.data %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot.SMDH <- two.group.paired %>% 
  mean_diff() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic estimate (SMDH)",
      effsize.ylabel = "Mean differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot.SMDH.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot.SMDH
dev.off()


## find correct direction of slope
include.point <- which((wide.data$cMAOM - wide.data$MAOM)<0)
## table only includes correct data
wide.data3 <- wide.data[include.point,]

## make paired comparision plot 
my.data3 <- 
  wide.data3 %>%
  tidyr::gather(key = Group, value = Measurement, -ID, -Dummy, -MA_case)


two.group.paired3 <- 
  my.data3 %>%
  dabest(Group, Measurement, 
         idx = c("MAOM", "cMAOM"), 
         paired = TRUE, id.col = ID)

paired.plot3_SMDH <- two.group.paired3 %>% 
  cohens_d() %>% 
  plot(#rawplot.ylim = c(-2, 1),
       #effsize.ylim = c(-2, 1),
       #rawplot.markersize = 1,
       #rawplot.groupwidth = 0.4,
      rawplot.ylabel = "Meta-analytic means (SMDH)",
      effsize.ylabel = "Differences (bootstrap resampling)",
      axes.title.fontsize = 14, # default is 14
      palette = c("Dark2")
      )


png(filename = "./Figures/paired.plot3_SMDH.png", width = 5, height = 4, units = "in", type = "windows", res = 400)
paired.plot3_SMDH
dev.off()

```



#### 7.2 Compile datasets for adjusted SMDH
We only had 3 meta-analyses showing the correct direction slope. For the left 9 meta-analyses, we used original meta-analysis overall mean

```{r}
#***************************************************************#
#                           Model estimates                     #
#***************************************************************#

# get estimates from bias-corrected models (model_est_PET_PEESE_SMDH) if in a correct direction of slope. Otherwise it should use estimates from original models (model_est_SMDH). 

# view(my.data3) or my.data3$ID can know those from bias-corrected models: 1, 3, 4, 11, 12
# get corresponding estimates
model_est_adjusted_SMDH <- data.frame(MA_case=model_est_PET_PEESE_SMDH$MA_case,
                    mu_SMDH=c(model_est_PET_PEESE_SMDH$mu_SMDH[1], # match with the my.data3$ID; also see 3, 4, 11, 12
                             model_est_SMDH$mu_SMDH[2], 
                             model_est_PET_PEESE_SMDH$mu_SMDH[3], 
                             model_est_PET_PEESE_SMDH$mu_SMDH[4],
                             model_est_SMDH$mu_SMDH[5],
                             model_est_SMDH$mu_SMDH[6],
                             model_est_SMDH$mu_SMDH[7],
                             model_est_SMDH$mu_SMDH[8],
                             model_est_SMDH$mu_SMDH[9],
                             model_est_SMDH$mu_SMDH[10],
                             model_est_PET_PEESE_SMDH$mu_SMDH[11],
                             model_est_PET_PEESE_SMDH$mu_SMDH[12]
                            ),
                    
                    SE_SMDH=c(model_est_PET_PEESE_SMDH$SE_SMDH[1],
                             model_est_SMDH$SE_SMDH[2], 
                             model_est_PET_PEESE_SMDH$SE_SMDH[3], 
                             model_est_PET_PEESE_SMDH$SE_SMDH[4],
                             model_est_SMDH$SE_SMDH[5],
                             model_est_SMDH$SE_SMDH[6],
                             model_est_SMDH$SE_SMDH[7],
                             model_est_SMDH$SE_SMDH[8],
                             model_est_SMDH$SE_SMDH[9],
                             model_est_SMDH$SE_SMDH[10],
                             model_est_PET_PEESE_SMDH$SE_SMDH[11],
                             model_est_PET_PEESE_SMDH$SE_SMDH[12]
                            ),
                    
                ll_NHST=c(model_est_PET_PEESE_SMDH$ll_NHST[1],
                             model_est_SMDH$ll_NHST[2], 
                             model_est_PET_PEESE_SMDH$ll_NHST[3], 
                             model_est_PET_PEESE_SMDH$ll_NHST[4],
                             model_est_SMDH$ll_NHST[5],
                             model_est_SMDH$ll_NHST[6],
                             model_est_SMDH$ll_NHST[7],
                             model_est_SMDH$ll_NHST[8],
                             model_est_SMDH$ll_NHST[9],
                             model_est_SMDH$ll_NHST[10],
                             model_est_PET_PEESE_SMDH$ll_NHST[11],
                             model_est_PET_PEESE_SMDH$ll_NHST[12]
                            ),
                
                  ul_NHST=c(model_est_PET_PEESE_SMDH$ul_NHST[1],
                             model_est_SMDH$ul_NHST[2], 
                             model_est_PET_PEESE_SMDH$ul_NHST[3], 
                             model_est_PET_PEESE_SMDH$ul_NHST[4],
                             model_est_SMDH$ul_NHST[5],
                             model_est_SMDH$ul_NHST[6],
                             model_est_SMDH$ul_NHST[7],
                             model_est_SMDH$ul_NHST[8],
                             model_est_SMDH$ul_NHST[9],
                             model_est_SMDH$ul_NHST[10],
                             model_est_PET_PEESE_SMDH$ul_NHST[11],
                             model_est_PET_PEESE_SMDH$ul_NHST[12]
                            ),
                
                  p_value=c(model_est_PET_PEESE_SMDH$p_value[1],
                             model_est_SMDH$p_value[2], 
                             model_est_PET_PEESE_SMDH$p_value[3], 
                             model_est_PET_PEESE_SMDH$p_value[4],
                             model_est_SMDH$p_value[5],
                             model_est_SMDH$p_value[6],
                             model_est_SMDH$p_value[7],
                             model_est_SMDH$p_value[8],
                             model_est_SMDH$p_value[9],
                             model_est_SMDH$p_value[10],
                             model_est_PET_PEESE_SMDH$p_value[11],
                             model_est_PET_PEESE_SMDH$p_value[12]
                            ))  

model_est_adjusted_SMDH$SE_SMDH <-model_est_SMDH$SE_SMDH


#***************************************************************#
#                               Models                          #
#***************************************************************#

# using from model_list_PET_PEESE_SMDH.sei where slopes show significance (locations from model_est_PET_PEESE_SMDH.sei.slope.nonsig) and using models from model_list_PET_PEESE_SMDH.var when model_list_PET_PEESE_SMDH.sei has sig slopes (viz, locations from model_est_PET_PEESE_SMDH.sei.slope.sig)

PET_PEESE_list_SMDH <- list(model_list_PET_PEESE_SMDH.sei[[1]],
                          model_list_PET_PEESE_SMDH.var[[2]], # locations from model_est_PET_PEESE_SMDH.sei.slope.sig
                          model_list_PET_PEESE_SMDH.sei[[3]],
                          model_list_PET_PEESE_SMDH.sei[[4]],
                          model_list_PET_PEESE_SMDH.var[[5]], # locations from model_est_PET_PEESE_SMDH.sei.slope.sig
                          model_list_PET_PEESE_SMDH.sei[[6]],
                          model_list_PET_PEESE_SMDH.sei[[7]],
                          model_list_PET_PEESE_SMDH.sei[[8]],
                          model_list_PET_PEESE_SMDH.sei[[9]],
                          model_list_PET_PEESE_SMDH.sei[[10]],
                          model_list_PET_PEESE_SMDH.var[[11]], # locations from model_est_PET_PEESE_SMDH.sei.slope.sig
                          model_list_PET_PEESE_SMDH.sei[[12]]
                          )

# combine original models
# get models from bias-corrected models (model_est_PET_PEESE_SMDH) if in a correct direction of slope. Otherwise it should use original models (model_est_SMDH). Using view(my.data3) to get locations of those from bias-corrected models: 1, 3, 4, 11, 12
model_list_adjusted_SMDH <- list(PET_PEESE_list_SMDH[[1]],
                                model_list_SMDH[[2]],
                               PET_PEESE_list_SMDH[[3]],
                               PET_PEESE_list_SMDH[[4]],
                               model_list_SMDH[[5]],
                               model_list_SMDH[[6]],
                               model_list_SMDH[[7]],
                               model_list_SMDH[[8]],
                               model_list_SMDH[[9]],
                               model_list_SMDH[[10]],
                               PET_PEESE_list_SMDH[[11]],
                               PET_PEESE_list_SMDH[[12]]
                               )

```




#### 7.3 MA power calculation

```{r}
#***************************************************************#
#             power for 12 meta-analytic cases                  #
#***************************************************************#


# make a list of data
dat_list_adjusted_SMDH <- SMDH


# prepare "ture" effect of variation (i.e. SMDH and SMDHH) for power analysis - fit multi-level meta-analytic models


#****************************************************************#
#------------------------------SMDH-----------------------------#
#****************************************************************#


#-----------------------------------------------------------#
#          (1) two-tailed power for meta-analyses
#-----------------------------------------------------------#
model_est_adjusted_SMDH$MA.power <- power.ma_Shinichi(mu=model_est_adjusted_SMDH$mu,SE=model_est_adjusted_SMDH$SE)


#-----------------------------------------------------------#
#            (2) type S error for meta-analyses
#-----------------------------------------------------------#
MA.power.S <- NA
for (i in 1:length(model_est_adjusted_SMDH$MA_case)) {
  MA.power.S[i] <- error_S(mu=model_est_adjusted_SMDH$mu[i],se=model_est_adjusted_SMDH$SE[i],alpha=0.05) %>% unlist()
}

model_est_adjusted_SMDH$MA.power.S <- MA.power.S


#-----------------------------------------------------------#
#   (3) type M error (overestimate ratio) for meta-analyses
#-----------------------------------------------------------#
MA.power.M <- NA
for (i in 1:length(model_est_adjusted_SMDH$MA_case)) {
  MA.power.M[i] <- error_M(mu=model_est_adjusted_SMDH$mu[i],se=model_est_adjusted_SMDH$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_adjusted_SMDH$MA.power.M <- MA.power.M


#-----------------------------------------------------------#
#   (4) type M error (relative error) for meta-analyses
#-----------------------------------------------------------#
MA.power.M2 <- NA
for (i in 1:length(model_est_adjusted_SMDH$MA_case)) {
  MA.power.M2[i] <- error_M2(mu=model_est_adjusted_SMDH$mu[i],se=model_est_adjusted_SMDH$SE[i],alpha=0.05,N=10000) %>% unlist()
}

model_est_adjusted_SMDH$MA.power.M2 <- MA.power.M2


# Save
write.csv(model_est_adjusted_SMDH, file = "./meta-analysis power_adjusted_SMDH.csv", row.names = FALSE)

```


#### 7.4 Individual power calculation

##### 7.4.1 Calculation
```{r}
#***************************************************************#
#        power for empirical studies within meta-analysis       #
#***************************************************************#

# We have three approaches for calculating empirical studies within meta-analysis: (i) using meta-analytic estimate (i.e. intercept or fixed effect) as true effect; (ii) using effect size specific effect as true effect (i.e. fixed plus random effect), which accomodate between-study heterogeneity; (iii) postulated (i.e. hypothetical) effect as true effect - 5%, 10%, 20%, 40% difference)


#****************************************************************#
#------------------------------SMDH-----------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#

# SMDH
power.F_adjusted_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F_adjusted_SMDH[i] <- power.individual_Shinichi(mu=rep(model_est_adjusted_SMDH$mu_SMDH[i], length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F_adjusted_SMDH)) {
  dat_list_adjusted_SMDH[[i]]$power.F_adjusted_SMDH <- power.F_adjusted_SMDH[[i]]
}


#---------------------- (2) type S error -----------------------#
power.F.S_adjusted_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F.S_adjusted_SMDH[i] <- mapply(error_S,mu=rep(model_est_adjusted_SMDH$mu_SMDH[i], length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.S_adjusted_SMDH)) {
  dat_list_adjusted_SMDH[[i]]$power.F.S_adjusted_SMDH <- power.F.S_adjusted_SMDH[[i]]
}



#---------------- (3) type M error (relative error) --------------#
power.F.M_adjusted_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F.M_adjusted_SMDH[i] <-mapply(error_M,mu=rep(model_est_adjusted_SMDH$mu_SMDH[i], length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M_adjusted_SMDH)) {
  dat_list_adjusted_SMDH[[i]]$power.F.M_adjusted_SMDH <- power.F.M_adjusted_SMDH[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.F.M2_adjusted_SMDH <- NA
for (i in 1:length(SMDH)) {
  power.F.M2_adjusted_SMDH[i] <-mapply(error_M2,mu=rep(model_est_adjusted_SMDH$mu_SMDH[i], length(SMDH[[i]]$vi)), se=sqrt(SMDH[[i]]$vi)) %>% list()}

# allocate each set of power into corresponding dataset
for (i in 1:length(power.F.M2_adjusted_SMDH)) {
  dat_list_adjusted_SMDH[[i]]$power.F.M2_adjusted_SMDH <- power.F.M2_adjusted_SMDH[[i]]
}


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

# use effects without random effects as true effect sizes for each individual study, to calculate power for each individual study
# This is what Helmut suggest to do, to account for random effects of each study

# get best linear unbiased estimate (only random effect) - this contains two components random effect respectively, i.e. list(~1|Study, ~1|Unit_ID)
blups.list_adjusted_SMDH <- NA
for (i in 1:length(model_list_adjusted_SMDH)) {
  blups.list_adjusted_SMDH[i] <- ranef(model_list_adjusted_SMDH[[i]]) %>% list()
}

# get study index - match two components of random effect
index.list_adjusted_SMDH <- NA # list()
for (i in 1:length(model_list_adjusted_SMDH)) {
  index.list_adjusted_SMDH[i] <- match(as.character(SMDH[[i]]$Study),rownames(blups.list_adjusted_SMDH[[i]]$Study)) %>% list()
}

# effects geting rid of random effects
effect.R_adjusted_SMDH <-NA
for (i in 1:length(model_list_adjusted_SMDH)) {
  effect.R_adjusted_SMDH[i] <- mapply(sum, model_est_adjusted_SMDH$mu_SMDH[i], blups.list_adjusted_SMDH[[i]]$Study[index.list_adjusted_SMDH[[i]],1], blups.list_adjusted_SMDH[[i]]$Unit_ID[,1]) %>% list()
}


#--------------------- (1) two tailed power ---------------------#
power.R_adjusted_SMDH <- NA
for (i in 1:12) {
  power.R_adjusted_SMDH[i] <- power.individual_Shinichi(mu=effect.R_adjusted_SMDH[[i]], se=sqrt(SMDH[[i]]$vi)) %>% list()}

# plot(power_adjusted_SMDH[[1]]-power_adjusted_SMDH2[[1]]) - check discrepancy
# allocate each set of power into coSMDHesponding dataset
for (i in 1:12) {
  dat_list_adjusted_SMDH[[i]]$power.R_adjusted_SMDH <- power.R_adjusted_SMDH[[i]]
} 

# Note that meta-analytic model only has one predicted/fitted value - fixed effect. While Meta-regression's fitted values are dependent on the level of moderator (i.e. independent variable)

#---------------------- (2) type S error -----------------------#
power.R.S_adjusted_SMDH <- NA
for (i in 1:12) {
  power.R.S_adjusted_SMDH[i] <- mapply(error_S, mu=effect.R_adjusted_SMDH[[i]], se=sqrt(SMDH[[i]]$vi), alpha=0.05) %>% list()
}

# allocate each set of power into coSMDHesponding dataset
for (i in 1:12) {
  dat_list_adjusted_SMDH[[i]]$power.R.S_adjusted_SMDH <- power.R.S_adjusted_SMDH[[i]]
}


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_adjusted_SMDH <- NA
for (i in 1:12) {
  power.R.M_adjusted_SMDH[i] <- mapply(error_M, mu=effect.R_adjusted_SMDH[[i]], se=sqrt(SMDH[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDHesponding dataset
for (i in 1:length(power.R.M_adjusted_SMDH)) {
  dat_list_adjusted_SMDH[[i]]$power.R.M_adjusted_SMDH <- power.R.M_adjusted_SMDH[[i]]
}


#---------------- (4) type M error (relative error) --------------#
power.R.M2_adjusted_SMDH <- NA
for (i in 1:12) {
  power.R.M2_adjusted_SMDH[i] <- mapply(error_M2, mu=effect.R_adjusted_SMDH[[i]], se=sqrt(SMDH[[i]]$vi), alpha=0.05, N=10000) %>% list()
}  

# allocate each set of power into coSMDHesponding dataset
for (i in 1:length(power.R.M2_adjusted_SMDH)) {
  dat_list_adjusted_SMDH[[i]]$power.R.M2_adjusted_SMDH <- power.R.M2_adjusted_SMDH[[i]]
}
```


##### 7.4.2 Summary of individual power

```{r}
#*********************************************************************#
#----------- summary of empirical power for each approach ------------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMDH------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.F_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F_adjusted_SMDH))[6,]) 


#---------------------- (2) type S error -----------------------#
power.F.S_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.S_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.S_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.S_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.S_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.S_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.S_adjusted_SMDH))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.F.M_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M_adjusted_SMDH))[6,])


#---------------- (4) type M error (relative error) --------------#
power.F.M2_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M2_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M2_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M2_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M2_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M2_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.F.M2_adjusted_SMDH))[6,])



#----------------------------------------------------------------#
#     (ii) effect size specific effect as true effect  
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
power.R_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R_adjusted_SMDH))[6,]) 


#---------------------- (2) type S error -----------------------#
power.R.S_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.S_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.S_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.S_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.S_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.S_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.S_adjusted_SMDH))[6,]) 


#-------------- (3) type M error (overestimate ratio) -------------#
power.R.M_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M_adjusted_SMDH))[6,]) 



#---------------- (4) type M error (relative error) --------------#
power.R.M2_summary_adjusted_SMDH <- data.frame(MA_case=model_est_adjusted_SMDH$MA_case,
                   Minimum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M2_adjusted_SMDH))[1,],      
                   `First quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M2_adjusted_SMDH))[2,],
                   Median=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M2_adjusted_SMDH))[3,],
                   Mean=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M2_adjusted_SMDH))[4,], 
                   `Third quarter`=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M2_adjusted_SMDH))[5,], 
                   Maximum=mapply(summary, sapply(dat_list_adjusted_SMDH, function(x) x$power.R.M2_adjusted_SMDH))[6,])
```


##### 7.4.3 SE of individual power

```{r}
#*********************************************************************#
#--------- calculate standard error for each type of power -----------#
#*********************************************************************#

#****************************************************************#
#-----------------------------SMDH------------------------------#
#****************************************************************#

#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.F_adjusted_SMDH
se.F_mean <- NA
for (i in 1:length(SMDH)) {
  se.F_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.F_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.F_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.F_adjusted_SMDH)]))
}

power.F_summary_adjusted_SMDH$se.F_mean <- se.F_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.F.S_adjusted_SMDH
se.F.S_mean <- NA
for (i in 1:length(SMDH)) {
  se.F.S_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.F.S_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.F.S_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.F.S_adjusted_SMDH)]))
}

power.F.S_summary_adjusted_SMDH$se.F.S_mean <- se.F.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.F.M_adjusted_SMDH
se.F.M_mean <- NA
for (i in 1:length(SMDH)) {
  se.F.M_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.F.M_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.F.M_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.F.M_adjusted_SMDH)]))
}

power.F.M_summary_adjusted_SMDH$se.F.M_mean <- se.F.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.F.M2_RR
se.F.M2_mean <- NA
for (i in 1:length(SMDH)) {
  se.F.M2_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.F.M2_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.F.M2_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.F.M2_adjusted_SMDH)]))
}

power.F.M2_summary_adjusted_SMDH$se.F.M2_mean <- se.F.M2_mean


#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
# standard error of variable power.R_adjusted_SMDH
se.R_mean <- NA
for (i in 1:length(SMDH)) {
  se.R_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.R_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.R_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.R_adjusted_SMDH)]))
}

power.R_summary_adjusted_SMDH$se.R_mean <- se.R_mean


#---------------------- (2) type S error -----------------------#
# standard error of variable power.R.S_adjusted_SMDH
se.R.S_mean <- NA
for (i in 1:length(SMDH)) {
  se.R.S_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.R.S_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.R.S_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.R.S_adjusted_SMDH)]))
}

power.R.S_summary_adjusted_SMDH$se.R.S_mean <- se.R.S_mean



#-------------- (3) type M error (overestimate ratio) -------------#
# standard error of variable power.R.M_adjusted_SMDH
se.R.M_mean <- NA
for (i in 1:length(SMDH)) {
  se.R.M_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.R.M_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.R.M_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.R.M_adjusted_SMDH)]))
}

power.R.M_summary_adjusted_SMDH$se.R.M_mean <- se.R.M_mean


#---------------- (4) type M error (relative error) --------------#
# standard error of variable power.R.M2_RR
se.R.M2_mean <- NA
for (i in 1:length(SMDH)) {
  se.R.M2_mean[i] <- sd(dat_list_adjusted_SMDH[[i]]$power.R.M2_adjusted_SMDH, na.rm=TRUE) / sqrt(length(dat_list_adjusted_SMDH[[i]]$power.R.M2_adjusted_SMDH[!is.na(dat_list_adjusted_SMDH[[i]]$power.R.M2_adjusted_SMDH)]))
}

power.R.M2_summary_adjusted_SMDH$se.R.M2_mean <- se.R.M2_mean
```


#### 7.5 Regression

##### 7.3.1 MA power

```{r}

#***************************************************************#
#      estiamte overall power for meta-analysis level power     #
#***************************************************************#

#****************************************************************#
#-----------------------------adjusted_SMDH------------------------------#
#****************************************************************#

# add N and k
N_adjusted_SMDH <- NA
for (i in 1:length(dat_list_adjusted_SMDH)) {
  N_adjusted_SMDH[i] <- dat_list_adjusted_SMDH[[i]]$Study %>% unique() %>% length()
}

k_adjusted_SMDH <- NA
for (i in 1:length(dat_list_adjusted_SMDH)) {
  k_adjusted_SMDH[i] <- dat_list_adjusted_SMDH[[i]]$Unit_ID%>% length()
}

model_est_adjusted_SMDH$k <- k_adjusted_SMDH


# load meta-analysis level power
#load(here("data","model_est_adjusted_SMDH.RData"))


#--------------------- (1) two tailed power ---------------------#
MMA_MA_adjusted_SMDH <- lm(MA.power~1, weights = k, data = model_est_adjusted_SMDH) 
MMA_MA_adjusted_SMDH$coefficients
# log
MMA_MA_adjusted_SMDH2 <- lm(log(MA.power)~1, weights = k, data = model_est_adjusted_SMDH)
# this is median
MMA_MA_adjusted_SMDH2$coefficients  %>% exp() 
# this is mean
# we mean want to use this (not 100% correct but it is fine for now)
(MMA_MA_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_adjusted_SMDH$MA.power))) %>% exp() 
#confidence interval of median
confint(MMA_MA_adjusted_SMDH2) %>% exp()

# compare residuals
par(mfrow = c(1, 2))
residuals(MMA_MA_adjusted_SMDH) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_MA_adjusted_SMDH2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

#---------------------- (2) type S error -----------------------#
MMA_MA.S_adjusted_SMDH <- lm(MA.power.S~1, weights = k, data = model_est_adjusted_SMDH) 
MMA_MA.S_adjusted_SMDH$coefficients
# log
MMA_MA.S_adjusted_SMDH2 <- lm(log(MA.power.S+0.025) ~ 1, weights = k, data = model_est_adjusted_SMDH) # +0.025(25%) to avoide ln(0) = infinity 
# this is median
MMA_MA.S_adjusted_SMDH2$coefficients %>% exp() - 0.025
# this is mean
(MMA_MA.S_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_adjusted_SMDH$MA.power.S + 0.025))) %>% exp() - 0.025
#confidence interval of median
confint(MMA_MA.S_adjusted_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.S_adjusted_SMDH) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_MA.S_adjusted_SMDH2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual") 

#-------------- (3) type M error (overestimate ratio) -------------#

MMA_MA.M_adjusted_SMDH <- lm(MA.power.M~1, weights = k, data = model_est_adjusted_SMDH) 
MMA_MA.M_adjusted_SMDH$coefficients
# log
MMA_MA.M_adjusted_SMDH2 <- lm(log(MA.power.M)~1, weights = k, data = model_est_adjusted_SMDH)
# this is median
MMA_MA.M_adjusted_SMDH2$coefficients %>% exp() 
# this is mean
# we mean want to use this (not 100% coadjusted_SMDHect but it is fine for now)
(MMA_MA.M_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_adjusted_SMDH$MA.power.M))) %>% exp() 

#confidence interval of median
confint(MMA_MA.M_adjusted_SMDH2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M_adjusted_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M_adjusted_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


#-------------- (3) type M2 error (overestimate ratio) -------------#

MMA_MA.M2_adjusted_SMDH <- lm(MA.power.M2~1, weights = k, data = model_est_adjusted_SMDH) 
MMA_MA.M2_adjusted_SMDH$coefficients
# log
MMA_MA.M2_adjusted_SMDH2 <- lm(log(MA.power.M2+0.025)~1, weights = k, data = model_est_adjusted_SMDH)
# this is median
MMA_MA.M2_adjusted_SMDH2$coefficients %>% exp() -0.025
# this is mean
# we mean want to use this (not 100% coadjusted_SMDHect but it is fine for now)
(MMA_MA.M2_adjusted_SMDH2$coefficients + 0.5*var(log(model_est_adjusted_SMDH$MA.power.M2+0.025))) %>% exp() -0.025

#confidence interval of median
confint(MMA_MA.M2_adjusted_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_MA.M2_adjusted_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_MA.M2_adjusted_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 

```



##### 7.3.2 Individual power

```{r}
#*********************************************************************#
#-------------------- meta-meta-analysis on power --------------------#
#*********************************************************************#


#****************************************************************#
#-----------------------------adjusted_SMDH------------------------------#
#****************************************************************#


#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#

## make study identity unique incase some studies have same identities
# dat_list_adjusted_SMDH[[1]]$Study <- paste("m1_1_", dat_list_adjusted_SMDH[[1]]$Study, sep = "")
# dat_list_adjusted_SMDH[[2]]$Study <- paste("m1_2_", dat_list_adjusted_SMDH[[2]]$Study, sep = "")
# dat_list_adjusted_SMDH[[3]]$Study <- paste("m2_1_", dat_list_adjusted_SMDH[[3]]$Study, sep = "")
# dat_list_adjusted_SMDH[[4]]$Study <- paste("m2_2_", dat_list_adjusted_SMDH[[4]]$Study, sep = "")
# dat_list_adjusted_SMDH[[5]]$Study <- paste("m5_1_", dat_list_adjusted_SMDH[[5]]$Study, sep = "")
# dat_list_adjusted_SMDH[[6]]$Study <- paste("m6_1_", dat_list_adjusted_SMDH[[6]]$Study, sep = "")
# dat_list_adjusted_SMDH[[7]]$Study <- paste("m6_2_", dat_list_adjusted_SMDH[[7]]$Study, sep = "")
# dat_list_adjusted_SMDH[[8]]$Study <- paste("m6_3_", dat_list_adjusted_SMDH[[8]]$Study, sep = "")
# dat_list_adjusted_SMDH[[9]]$Study <- paste("m6_4_", dat_list_adjusted_SMDH[[9]]$Study, sep = "")
# dat_list_adjusted_SMDH[[10]]$Study <- paste("m6_5_", dat_list_adjusted_SMDH[[10]]$Study, sep = "")
# dat_list_adjusted_SMDH[[11]]$Study <- paste("m9_1_", dat_list_adjusted_SMDH[[11]]$Study, sep = "")
# dat_list_adjusted_SMDH[[12]]$Study <- paste("m11_1_", dat_list_adjusted_SMDH[[12]]$Study, sep = "")



studyID_adjusted_SMDH <- NA
for (i in 1:length(dat_list_adjusted_SMDH)) {
  studyID_adjusted_SMDH[i] <- dat_list_adjusted_SMDH[[i]]$Study %>% list()
}

stressor_adjusted_SMDH <-  c(rep('BD_loss',length(dat_list_adjusted_SMDH[[1]]$Study)),
                  rep('BD_loss',length(dat_list_adjusted_SMDH[[2]]$Study)),
                  rep('Fert',length(dat_list_adjusted_SMDH[[3]]$Study)),
                  rep('Fert',length(dat_list_adjusted_SMDH[[4]]$Study)),
                  rep('Fert',length(dat_list_adjusted_SMDH[[5]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMDH[[6]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMDH[[7]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMDH[[8]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMDH[[9]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMDH[[10]]$Study)),
                  rep('LUC',length(dat_list_adjusted_SMDH[[11]]$Study)),
                  rep('Inv',length(dat_list_adjusted_SMDH[[12]]$Study))
                  )


# stressor_adjusted_SMDH <- c("1BD_loss","2BD_loss", "3Fert", "4Fert", "5Fert", "6LUC","7LUC","8LUC","9LUC","10LUC", "11LUC", "12Inv")


approach_adjusted_SMDH <-  c(rep('E',length(dat_list_adjusted_SMDH[[1]]$Study)),
                  rep('E',length(dat_list_adjusted_SMDH[[2]]$Study)),
                  rep('E',length(dat_list_adjusted_SMDH[[3]]$Study)),
                  rep('E',length(dat_list_adjusted_SMDH[[4]]$Study)),
                  rep('E',length(dat_list_adjusted_SMDH[[5]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[6]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[7]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[8]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[9]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[10]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[11]]$Study)),
                  rep('O',length(dat_list_adjusted_SMDH[[12]]$Study))
                  )

# approach_adjusted_SMDH <- c("1E", "2E", "3E", "4E", "5E", "6O", "7O", "8O", "9O", "10O", "11O", "12O")

# treatment_adjusted_SMDH <- c("1Pr","2Pr", "3Pr","4Pr", "5Pr", "6Pr","7Pr","8Pr","9Pr","10Pr", "11Pr", "12Pr")


studyID_adjusted_SMDH <- unlist(studyID_adjusted_SMDH)
power.F_adjusted_SMDH <- unlist(power.F_adjusted_SMDH)
power.F.S_adjusted_SMDH <- unlist(power.F.S_adjusted_SMDH)
power.F.M_adjusted_SMDH <- unlist(power.F.M_adjusted_SMDH)
power.F.M2_adjusted_SMDH <- unlist(power.F.M2_adjusted_SMDH)
power.R_adjusted_SMDH <- unlist(power.R_adjusted_SMDH)
power.R.S_adjusted_SMDH <- unlist(power.R.S_adjusted_SMDH)
power.R.M_adjusted_SMDH <- unlist(power.R.M_adjusted_SMDH)
power.R.M2_adjusted_SMDH <- unlist(power.R.M2_adjusted_SMDH)


individual_est_adjusted_SMDH <- data.frame("studyID_adjusted_SMDH" = studyID_adjusted_SMDH,
                                "stressor_adjusted_SMDH" = stressor_adjusted_SMDH,
                                "approach_adjusted_SMDH" = approach_adjusted_SMDH,
                                "power.F_adjusted_SMDH" = power.F_adjusted_SMDH,
                                "power.F.S_adjusted_SMDH" = power.F.S_adjusted_SMDH,
                                "power.F.M_adjusted_SMDH" = power.F.M_adjusted_SMDH,
                                "power.F.M2_adjusted_SMDH" = power.F.M2_adjusted_SMDH,
                                "power.R_adjusted_SMDH" = power.R_adjusted_SMDH,
                                "power.R.S_adjusted_SMDH" = power.R.S_adjusted_SMDH,
                                "power.R.M_adjusted_SMDH" = power.R.M_adjusted_SMDH,
                                "power.R.M2_adjusted_SMDH" = power.R.M2_adjusted_SMDH)
 
# save(individual_est_adjusted_SMDH,file = here("data","individual_est_adjusted_SMDH.RData"))
# save(power.F.M_adjusted_SMDH,file = here("data","power.F.M_adjusted_SMDH.RData"))
# save(power.R.M_adjusted_SMDH,file = here("data","power.R.M_adjusted_SMDH.RData"))
# 
# 
# # load individual level power
# load(here("data","individual_est_adjusted_SMDH.RData"))
#***************************************************************#
#        estiamte overall power for individual level power      #
#***************************************************************#
#----------------------------------------------------------------#
#           (i) intercept (overall mean) as true effect
#----------------------------------------------------------------#


#--------------------- (1) two tailed power ---------------------#
MMA_power.F_adjusted_SMDH <- lmer(power.F_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.F_adjusted_SMDH)$coefficients[1]
# log
MMA_power.F_adjusted_SMDH2 <- lmer(log(power.F_adjusted_SMDH) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median 
summary(MMA_power.F_adjusted_SMDH2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.F_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F_adjusted_SMDH))) %>% exp()
# confidence intercal of median
confint(MMA_power.F_adjusted_SMDH2) %>% exp()


# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_SMDH) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_SMDH2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.F_adjusted_SMDH.approach <- lmer(power.F_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.F_adjusted_SMDH.approach)$coefficients
# log
MMA_power.F_adjusted_SMDH.approach2 <- lmer(log(power.F_adjusted_SMDH) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.F_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.F_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F_adjusted_SMDH.approach2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F_adjusted_SMDH.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.F_adjusted_SMDH.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 



# contrasting model
MMA_power.F_adjusted_SMDH.approach4 <- lmer(log(power.F_adjusted_SMDH) ~ 1 + I(approach_adjusted_SMDH) + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# check p value
summary(MMA_power.F_adjusted_SMDH.approach4)



#---------------------- (2) type S error -----------------------#
MMA_power.F.S_adjusted_SMDH <- lmer(power.F.S_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.F.S_adjusted_SMDH)$coefficients[1]
# log
MMA_power.F.S_adjusted_SMDH2 <- lmer(log(power.F.S_adjusted_SMDH + 0.025) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median - and - 0.025 is important
summary(MMA_power.F.S_adjusted_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.F.S_adjusted_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.F.S_adjusted_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.F.S_adjusted_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.S_adjusted_SMDH) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.S_adjusted_SMDH2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")
#residuals(MMA_power.F.S_adjusted_SMDH3) %>% hist(main = paste("logit Type S (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.F.S_adjusted_SMDH.approach <- lmer(power.F.S_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.F.S_adjusted_SMDH.approach)$coefficients
# log
MMA_power.F.S_adjusted_SMDH.approach2 <- lmer(log(power.F.S_adjusted_SMDH + 0.025) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.F.S_adjusted_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.F.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.F.S_adjusted_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.S_adjusted_SMDH.approach2) %>% exp() - 0.025



# contrasting model
MMA_power.F.S_adjusted_SMDH.approach4 <- lmer(log(power.F.S_adjusted_SMDH + 0.025) ~ 1 + I(approach_adjusted_SMDH) + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# check p value
summary(MMA_power.F.S_adjusted_SMDH.approach4)

#---------------------- (2) type M error -----------------------#
 
MMA_power.F.M_adjusted_SMDH <- lmer(power.F.M_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

summary(MMA_power.F.M_adjusted_SMDH)$coefficients[1] # I checked the raw data and found that some sampling variances of lnadjusted_SMDH are very low. This probably makes some of Type M eadjusted_SMDH extremely high. 

# but log transformation can work
MMA_power.F.M_adjusted_SMDH2 <- lmer(log(power.F.M_adjusted_SMDH) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

# this is median
summary(MMA_power.F.M_adjusted_SMDH2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coadjusted_SMDHect but it is fine for now)
(summary(MMA_power.F.M_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F.M_adjusted_SMDH))) %>% exp() 
# confidence interval of median
confint(MMA_power.F.M_adjusted_SMDH2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M_adjusted_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M_adjusted_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.F.M_adjusted_SMDH.approach <- lmer(power.F.M_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.F.M_adjusted_SMDH.approach)$coefficients
# log
MMA_power.F.M_adjusted_SMDH.approach2 <- lmer(log(power.F.M_adjusted_SMDH) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.F.M_adjusted_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.F.M_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F.M_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.F.M_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.F.M_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.F.M_adjusted_SMDH.approach2) %>% exp()



# contrasting model
MMA_power.F.M_adjusted_SMDH.approach4 <- lmer(log(power.F.M_adjusted_SMDH) ~ 1 + I(approach_adjusted_SMDH) + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# check p value
summary(MMA_power.F.M_adjusted_SMDH.approach4)


#---------------------- (2) type M2 eadjusted_SMDH -----------------------#

MMA_power.F.M2_adjusted_SMDH <- lmer(power.F.M2_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

summary(MMA_power.F.M2_adjusted_SMDH)$coefficients[1] 

# log 
MMA_power.F.M2_adjusted_SMDH2 <- lmer(log(power.F.M2_adjusted_SMDH+0.025) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

# this is median
summary(MMA_power.F.M2_adjusted_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coadjusted_SMDHect but it is fine for now)
(summary(MMA_power.F.M2_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F.M2_adjusted_SMDH+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.F.M2_adjusted_SMDH2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.F.M2_adjusted_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.F.M2_adjusted_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.F.M2_adjusted_SMDH.approach <- lmer(power.F.M2_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.F.M2_adjusted_SMDH.approach)$coefficients
# log
MMA_power.F.M2_adjusted_SMDH.approach2 <- lmer(log(power.F.M2_adjusted_SMDH + 0.025) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.F.M2_adjusted_SMDH.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.F.M2_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.F.M2_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.F.M2_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.F.M2_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.F.M2_adjusted_SMDH.approach2) %>% exp() - 0.025
 



#----------------------------------------------------------------#
#                 (ii) effect size specific effect as true effect
#----------------------------------------------------------------#

#--------------------- (1) two tailed power ---------------------#
MMA_power.R_adjusted_SMDH <- lmer(power.R_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.R_adjusted_SMDH)$coefficients[1]
# log
MMA_power.R_adjusted_SMDH2 <- lmer(log(power.R_adjusted_SMDH) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median 
summary(MMA_power.R_adjusted_SMDH2)$coefficients[1] %>% exp()
# this is mean
(summary(MMA_power.R_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R_adjusted_SMDH))) %>% exp()
# confidence intercal of median
confint(MMA_power.R_adjusted_SMDH2) %>% exp()

# compare residual
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_SMDH) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_SMDH2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.R_adjusted_SMDH.approach <- lmer(power.R_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.R_adjusted_SMDH.approach)$coefficients
# log
MMA_power.R_adjusted_SMDH.approach2 <- lmer(log(power.R_adjusted_SMDH) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.R_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.R_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R_adjusted_SMDH.approach2) %>% exp()


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R_adjusted_SMDH.approach) %>% hist(main = paste("orignal power (MAOM)"), xlab = "Residual")
residuals(MMA_power.R_adjusted_SMDH.approach2) %>% hist(main = paste("log power (MAOM)"), xlab = "Residual") 

 
#---------------------- (2) type S error -----------------------#
MMA_power.R.S_adjusted_SMDH <- lmer(power.R.S_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.R.S_adjusted_SMDH)$coefficients[1]

# log
MMA_power.R.S_adjusted_SMDH2 <- lmer(log(power.R.S_adjusted_SMDH + 0.025) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median - and - 0.025 is important
summary(MMA_power.R.S_adjusted_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
(summary(MMA_power.R.S_adjusted_SMDH2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMDH2)$varcor[[1]][[1]] + # sigma^2 for study level
                     summary(MMA_power.R.S_adjusted_SMDH2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

#confidence interval of median
confint(MMA_power.R.S_adjusted_SMDH2) %>% exp() - 0.025 # if the lower boundary was negative (probably caused by the negative variance), we used 0 to replace it


# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.S_adjusted_SMDH) %>% hist(main = paste("orignal Type S (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.S_adjusted_SMDH2) %>% hist(main = paste("log Type S (MAOM)"), xlab = "Residual")



# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.R.S_adjusted_SMDH.approach <- lmer(power.R.S_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.R.S_adjusted_SMDH.approach)$coefficients
# log
MMA_power.R.S_adjusted_SMDH.approach2 <- lmer(log(power.R.S_adjusted_SMDH + 0.025) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients %>% exp() -0.025
# this is mean
## experimental study
(summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients[1] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

## observational study
(summary(MMA_power.R.S_adjusted_SMDH.approach2)$coefficients[2] + 
                0.5*(summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[1]][[1]] + # sigma^2 for study level
                    summary(MMA_power.R.S_adjusted_SMDH.approach2)$varcor[[2]][[1]] + # sigma^2 for approach level
                     summary(MMA_power.R.S_adjusted_SMDH.approach2)$sigma^2) # residual level - we cannot do like what we did above as we added 0.025
        ) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.S_adjusted_SMDH.approach2) %>% exp() - 0.025


#---------------------- (2) type M error -----------------------#

MMA_power.R.M_adjusted_SMDH <- lmer(power.R.M_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

summary(MMA_power.R.M_adjusted_SMDH)$coefficients[1] # I checked the raw data and found that some sampling variances of lnadjusted_SMDH are very low. This probably makes some of Type M eadjusted_SMDH extremely high. 

# but log transformation can work
MMA_power.R.M_adjusted_SMDH2 <- lmer(log(power.R.M_adjusted_SMDH) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

# this is median
summary(MMA_power.R.M_adjusted_SMDH2)$coefficients[1] %>% exp()
# this is mean
# we mean want to use this (not 100% coadjusted_SMDHect but it is fine for now)
(summary(MMA_power.R.M_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R.M_adjusted_SMDH))) %>% exp() 
# confidence interval of median
confint(MMA_power.R.M_adjusted_SMDH2) %>% exp()

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M_adjusted_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M_adjusted_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 


# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.R.M_adjusted_SMDH.approach <- lmer(power.R.M_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.R.M_adjusted_SMDH.approach)$coefficients
# log
MMA_power.R.M_adjusted_SMDH.approach2 <- lmer(log(power.R.M_adjusted_SMDH) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.R.M_adjusted_SMDH.approach2)$coefficients %>% exp()
# this is mean
## experimental study
(summary(MMA_power.R.M_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R.M_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='E']))) %>% exp()

## observational study
(summary(MMA_power.R.M_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.R.M_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='O']))) %>% exp()

# confidence interval of median
confint(MMA_power.R.M_adjusted_SMDH.approach2) %>% exp()



#---------------------- (2) type M2 error -----------------------#

MMA_power.R.M2_adjusted_SMDH <- lmer(power.R.M2_adjusted_SMDH ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

summary(MMA_power.R.M2_adjusted_SMDH)$coefficients[1] 

# log 
MMA_power.R.M2_adjusted_SMDH2 <- lmer(log(power.R.M2_adjusted_SMDH+0.025) ~ 1 + (1 | studyID_adjusted_SMDH), data = individual_est_adjusted_SMDH)

# this is median
summary(MMA_power.R.M2_adjusted_SMDH2)$coefficients[1] %>% exp() - 0.025
# this is mean
# we mean want to use this (not 100% coadjusted_SMDHect but it is fine for now)
(summary(MMA_power.R.M2_adjusted_SMDH2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R.M2_adjusted_SMDH+0.025))) %>% exp() - 0.025
# confidence interval of median
confint(MMA_power.R.M2_adjusted_SMDH2) %>% exp() - 0.025

# make plot
par(mfrow = c(1, 2))
residuals(MMA_power.R.M2_adjusted_SMDH) %>% hist(main = paste("orignal Type M (MAOM)"), xlab = "Residual")
residuals(MMA_power.R.M2_adjusted_SMDH2) %>% hist(main = paste("log Type M (MAOM)"), xlab = "Residual") 



# include approach_adjusted_SMDH as fixed effect and stressor as random effect
MMA_power.R.M2_adjusted_SMDH.approach <- lmer(power.R.M2_adjusted_SMDH ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
summary(MMA_power.R.M2_adjusted_SMDH.approach)$coefficients
# log
MMA_power.R.M2_adjusted_SMDH.approach2 <- lmer(log(power.R.M2_adjusted_SMDH + 0.025) ~ 1 + I(approach_adjusted_SMDH) -1 + (1 | studyID_adjusted_SMDH) + (1 | stressor_adjusted_SMDH), data = individual_est_adjusted_SMDH)
# this is median
summary(MMA_power.R.M2_adjusted_SMDH.approach2)$coefficients %>% exp() - 0.025
# this is mean
## experimental study
(summary(MMA_power.R.M2_adjusted_SMDH.approach2)$coefficients[1] + 0.5*var(log(individual_est_adjusted_SMDH$power.R.M2_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='E'] + 0.025))) %>% exp() -0.025

## observational study
(summary(MMA_power.R.M2_adjusted_SMDH.approach2)$coefficients[2] + 0.5*var(log(individual_est_adjusted_SMDH$power.R.M2_adjusted_SMDH[individual_est_adjusted_SMDH$approach_adjusted_SMDH=='O'] + 0.025))) %>% exp() - 0.025

# confidence interval of median
confint(MMA_power.R.M2_adjusted_SMDH.approach2) %>% exp() - 0.025


# # convert moderator to factor with desired ordering of levels
# power.F.M_summary_adjusted_SMDH$approach_adjusted_SMDH <- factor(power.F.M_summary_adjusted_SMDH$approach_adjusted_SMDH, levels=c("O", "E"))
# 
# MMA_power.F.M_adjusted_SMDH.approach <- with(power.F.M_summary_adjusted_SMDH, rma(yi = Mean, sei = se.F_mean,  mods = ~ I(approach_adjusted_SMDH) -1, method = "REML", test = "t")) # relevel(approach, ref="O")

```





### inverse of SD
```{r}
mean <- 0.3
stand_error <- 0.03
sim <- rnorm(100000000, 0.3, 0.03)
mean(sim)
mean(1/sim)
sd(1/sim)
var(1/sim) # 0.12
# approximation does not work so well
# var = var*(deriv(1/mean))^2
0.03^2*(-1/(0.3)^2)^2 # 0.11111
```




### stressor categories
```{r}

stressor_RR <- c("1","2","3","4","5","6Fert 3","7Fert 4","8LUC 1","9LUC 2","10LUC 3","11LUC 4","12LUC 5","13Fert 5","14Fert 6","15Precip","16LUC 6 ","17Warm 2","18Inv 1","19Fire1 ","20Fire 2","21Fire 3","22Warm 3","23Warm 4","24Warm 5 ","25BD_loss 3","26BD_loss 4","27BD_loss 5","28Acid","29Inv 2","30Inv 3")


stressor_RR <- c("1BD_loss 1","2BD_loss 2","3Fert 1","4Fert 2","5Warm 1","6Fert 3","7Fert 4","8LUC 1","9LUC 2","10LUC 3","11LUC 4","12LUC 5","13Fert 5","14Fert 6","15Precip","16LUC 6 ","17Warm 2","18Inv 1","19Fire1 ","20Fire 2","21Fire 3","22Warm 3","23Warm 4","24Warm 5 ","25BD_loss 3","26BD_loss 4","27BD_loss 5","28Acid","29Inv 2","30Inv 3")

```


### Funnel plots - SE
```{r}
model_list_RR[[1]]$yi %>% range()
100*i2_ml(model_list_RR[[1]])%>% round(3)
png(filename = "./Figures/funnel/funnel.SE_BD_loss1.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma1.1 <- funnel(model_list_RR[[1]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("BD loss 1: ", "I"[total]^2, '=88.7%', ',',  "I"[study]^2, '=8.4%', ',', "I"[residual]^2, '=80.3%',  sep='')),
       digits = c(0,0))
#funnel.SE_ma1.1 <- recordPlot()
dev.off()


model_list_RR[[2]]$yi %>% range()
100*i2_ml(model_list_RR[[2]]) %>% round(3)

png(filename = "./Figures/funnel/funnel.SE_BD_loss2.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma1.2 <- funnel(model_list_RR[[2]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("BD_loss 2: ", "I"[total]^2, '=48.4%', ',',  "I"[study]^2, '=33.5%', ',', "I"[residual]^2, '=14.9%',  sep='')),
       digits = c(0,0))
dev.off()


model_list_RR[[3]]$yi %>% range()
100*i2_ml(model_list_RR[[3]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fert1.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma2.1 <- funnel(model_list_RR[[3]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fert 1: ", "I"[total]^2, '=99.7%', ',',  "I"[study]^2, '=60.7%', ',', "I"[residual]^2, '=39.0%',  sep='')),
       digits = c(0,0))
dev.off()


model_list_RR[[4]]$yi %>% range()
100*i2_ml(model_list_RR[[4]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fert2.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma2.2 <- funnel(model_list_RR[[4]], 
       yaxis = "seinv", 
       xlim = c(-5, 5),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fert 2: ", "I"[total]^2, '=99.6%', ',',  "I"[study]^2, '=58.6%', ',', "I"[residual]^2, '=41.0%',  sep='')),
       digits = c(0,0))
dev.off()

# all_FST <- (ggdraw(funnel.SE_ma1.1) + ggdraw(funnel.SE_ma1.2)) /(ggdraw(funnel.SE_ma2.1) + ggdraw(funnel.SE_ma2.2)) + plot_annotation(tag_levels = 'a')
model_list_RR[[5]]$yi %>% range()
100*i2_ml(model_list_RR[[5]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Warm1.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma3.1 <- funnel(model_list_RR[[5]], 
       yaxis = "seinv", 
       xlim = c(-10, 10),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Warm 1: ", "I"[total]^2, '=87.2%', ',',  "I"[study]^2, '=27.1%', ',', "I"[residual]^2, '=60.1%',  sep='')),
       digits = c(0,0))
dev.off()


model_list_RR[[6]]$yi %>% range()
100*i2_ml(model_list_RR[[6]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fert3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma4.1 <- funnel(model_list_RR[[6]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fert 3: ", "I"[total]^2, '=89.4%', ',',  "I"[study]^2, '=36.0%', ',', "I"[residual]^2, '=53.4%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[7]]$yi %>% range()
100*i2_ml(model_list_RR[[7]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fert4.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma5.1 <- funnel(model_list_RR[[7]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fert 4: ", "I"[total]^2, '=99.0%', ',',  "I"[study]^2, '=64.5%', ',', "I"[residual]^2, '=34.5%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[8]]$yi %>% range()
100*i2_ml(model_list_RR[[8]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_LUC1.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma6.1 <- funnel(model_list_RR[[8]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("LUC 1: ", "I"[total]^2, '=99.7%', ',',  "I"[study]^2, '=53.9%', ',', "I"[residual]^2, '=45.9%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[9]]$yi %>% range()
100*i2_ml(model_list_RR[[9]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_LUC2.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma6.2 <- funnel(model_list_RR[[9]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("LUC 2: ", "I"[total]^2, '=98.07%', ',',  "I"[study]^2, '=83.7%', ',', "I"[residual]^2, '=14.3%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[10]]$yi %>% range()
100*i2_ml(model_list_RR[[10]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_LUC3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma6.3 <- funnel(model_list_RR[[10]], 
       yaxis = "seinv", 
       xlim = c(-5, 5),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("LUC 3: ", "I"[total]^2, '=95.8%', ',',  "I"[study]^2, '=3.3%', ',', "I"[residual]^2, '=92.5%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[11]]$yi %>% range()
100*i2_ml(model_list_RR[[11]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_LUC4.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma6.4 <- funnel(model_list_RR[[11]], 
       yaxis = "seinv", 
       xlim = c(-6, 6),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("LUC 4: ", "I"[total]^2, '=98.6%', ',',  "I"[study]^2, '=22.3%', ',', "I"[residual]^2, '=76.3%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[12]]$yi %>% range()
100*i2_ml(model_list_RR[[12]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_LUC5.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma6.5 <- funnel(model_list_RR[[12]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("LUC 5: ", "I"[total]^2, '=91.1%', ',',  "I"[study]^2, '=18.0%', ',', "I"[residual]^2, '=73.1%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[13]]$yi %>% range()
100*i2_ml(model_list_RR[[13]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fert5.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma7.1 <- funnel(model_list_RR[[13]], 
       yaxis = "seinv", 
       xlim = c(-1, 1),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fert 5: ", "I"[total]^2, '=86.8%', ',',  "I"[study]^2, '=65.6%', ',', "I"[residual]^2, '=21.1%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[14]]$yi %>% range()
100*i2_ml(model_list_RR[[14]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fert6.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma7.2 <- funnel(model_list_RR[[14]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fert 6: ", "I"[total]^2, '=54.9%', ',',  "I"[study]^2, '=30.6%', ',', "I"[residual]^2, '=24.2%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[15]]$yi %>% range()
100*i2_ml(model_list_RR[[15]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Precip.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma8.1 <- funnel(model_list_RR[[15]], 
       yaxis = "seinv", 
       xlim = c(-1, 1),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Precip: ", "I"[total]^2, '=97.2%', ',',  "I"[study]^2, '=78.6%', ',', "I"[residual]^2, '=18.6%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[16]]$yi %>% range()
100*i2_ml(model_list_RR[[16]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_LUC6.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma9.1 <- funnel(model_list_RR[[16]], 
       yaxis = "seinv", 
       xlim = c(-5, 5),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("LUC 6: ", "I"[total]^2, '=99.0%', ',',  "I"[study]^2, '=38.1%', ',', "I"[residual]^2, '=61.0%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[17]]$yi %>% range()
100*i2_ml(model_list_RR[[17]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Warm2.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma10.1 <- funnel(model_list_RR[[17]], 
       yaxis = "seinv", 
       xlim = c(-3, 3),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Warm 2: ", "I"[total]^2, '=39.6%', ',',  "I"[study]^2, '=39.6%', ',', "I"[residual]^2, '=0%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[18]]$yi %>% range()
100*i2_ml(model_list_RR[[18]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Inv1.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma11.1 <- funnel(model_list_RR[[18]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Inv 1: ", "I"[total]^2, '=100.0%', ',',  "I"[study]^2, '=8.3%', ',', "I"[residual]^2, '=91.7%',  sep='')),
       digits = c(0,0))
dev.off()





model_list_RR[[19]]$yi %>% range()
100*i2_ml(model_list_RR[[19]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fire1.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma12.1 <- funnel(model_list_RR[[19]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fire 1: ", "I"[total]^2, '=98.3%', ',',  "I"[study]^2, '=90.0%', ',', "I"[residual]^2, '=8.4%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[20]]$yi %>% range()
100*i2_ml(model_list_RR[[20]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fire2.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma13.1 <- funnel(model_list_RR[[20]], 
       yaxis = "seinv", 
       xlim = c(-1, 1),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fire 2: ", "I"[total]^2, '=0%', ',',  "I"[study]^2, '=0%', ',', "I"[residual]^2, '=0%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[21]]$yi %>% range()
100*i2_ml(model_list_RR[[21]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Fire3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma13.2 <- funnel(model_list_RR[[21]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Fire 3: ", "I"[total]^2, '=0%', ',',  "I"[study]^2, '=0%', ',', "I"[residual]^2, '=0%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[22]]$yi %>% range()
100*i2_ml(model_list_RR[[22]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Warm3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma14.1 <- funnel(model_list_RR[[22]], 
       yaxis = "seinv", 
       xlim = c(-1, 1),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Warm 3: ", "I"[total]^2, '=81%', ',',  "I"[study]^2, '=81%', ',', "I"[residual]^2, '=0%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[23]]$yi %>% range()
100*i2_ml(model_list_RR[[23]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Warm4.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma14.2 <- funnel(model_list_RR[[23]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Warm 4: ", "I"[total]^2, '=89.7%', ',',  "I"[study]^2, '=44.1%', ',', "I"[residual]^2, '=45.6%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[24]]$yi %>% range()
100*i2_ml(model_list_RR[[24]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Warm5.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma14.3 <- funnel(model_list_RR[[24]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Warm 5: ", "I"[total]^2, '=91.7%', ',',  "I"[study]^2, '=70.0%', ',', "I"[residual]^2, '=21.7%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[25]]$yi %>% range()
100*i2_ml(model_list_RR[[25]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_BD_loss3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma15.1 <- funnel(model_list_RR[[25]], 
       yaxis = "seinv", 
       xlim = c(-8, 8),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("BD_loss 3: ", "I"[total]^2, '=92.3%', ',',  "I"[study]^2, '=77.6%', ',', "I"[residual]^2, '=14.7%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[26]]$yi %>% range()
100*i2_ml(model_list_RR[[26]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_BD_loss4.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma16.1 <- funnel(model_list_RR[[26]], 
       yaxis = "seinv", 
       xlim = c(-7, 7),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("BD_loss 4: ", "I"[total]^2, '=99.7%', ',',  "I"[study]^2, '=18.9%', ',', "I"[residual]^2, '=80.8%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[27]]$yi %>% range()
100*i2_ml(model_list_RR[[27]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_BD_loss5.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma16.2 <- funnel(model_list_RR[[27]], 
       yaxis = "seinv", 
       xlim = c(-6, 6),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("BD_loss 5: ", "I"[total]^2, '=98.2%', ',',  "I"[study]^2, '=32.9%', ',', "I"[residual]^2, '=65.3%',  sep='')),
       digits = c(0,0))
dev.off()




model_list_RR[[28]]$yi %>% range()
100*i2_ml(model_list_RR[[28]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Acid.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma20.1 <- funnel(model_list_RR[[28]], 
       yaxis = "seinv", 
       xlim = c(-2, 2),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Acid: ", "I"[total]^2, '=99.2%', ',',  "I"[study]^2, '=71.4%', ',', "I"[residual]^2, '=27.8%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[29]]$yi %>% range()
100*I2_ml(model_list_RR[[29]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Inv2.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma23.1 <- funnel(model_list_RR[[29]], 
       yaxis = "seinv", 
       xlim = c(-5, 5),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Inv 2: ", "I"[total]^2, '=95.2%', ',',  "I"[study]^2, '=55.7%', ',', "I"[residual]^2, '=39.5%',  sep='')),
       digits = c(0,0))
dev.off()



model_list_RR[[30]]$yi %>% range()
100*i2_ml(model_list_RR[[30]]) %>% round(3)
png(filename = "./Figures/funnel/funnel.SE_Inv3.png", width = 5, height = 5, units = "in", type = "windows", res = 400)
funnel.SE_ma24.1 <- funnel(model_list_RR[[30]], 
       yaxis = "seinv", 
       xlim = c(-4, 4),
       level = c(90, 95, 99), 
       shade = c("white", "#CC79A7", '#56B4E9'), 
       refline = 0,  pch = 21, legend = F,
       ylab = "Precison (1/SE)", xlab = "Effect size (lnRR)", 
       main = expression(paste("Inv 3: ", "I"[total]^2, '=98.5%', ',',  "I"[study]^2, '=56.1%', ',', "I"[residual]^2, '=42.4%',  sep='')),
       digits = c(0,0))
dev.off()



#all_FST <- ggarrange(funnel.SE_ma1.1, funnel.SE_ma1.2, funnel.SE_ma2.1, funnel.SE_ma2.2, nrow = 2, ncol = 2)

#all_FST2 <- funnel.SE_ma1.1 + funnel.SE_ma1.2 + plot_layout(ncol = 2, nrow = 1)

#png(filename = "./Figures/all_FST.png", width = 10, height = 10, units = "in", type = "windows", res = 400)
#all_FST 
#dev.off()


#png(filename = "./Figures/all_FST2.png", width = 10, height = 10, units = "in", type = "windows", res = 400)
#all_FST2 
#dev.off()




  
```






```{r}

funnel(dat_list[[1]]$yi, dat_list[[1]]$vi, ni = dat_list[[1]]$Unit_ID, yaxis="ni",
       xlim = c(-3, 3),
       refline=model_list_RR[[1]]$beta, xlab = "Effect size (lnRR)")



funnel(model_list_RR[[1]], 
       yaxis = "sei", 
       xlim = c(-3, 3),
       level = c(95, 99), 
       shade = c("white", "gray55"), 
       refline = 0, legend = F, 
       ylab = "Stanard error (SE)", xlab = "Effect size (lnRR)")
legend(x = 1, y = 0, legend = c("0.01 < p < 0.05"), pch = c(15), col = c("gray55"), bty = "n")






```











### Section 3 - original version 
three weighting schemes (i.e. WAAP, PET-PEESE, http://environmentalcomputing.net/meta-analysis/) to evaluate publication bias


```{r}
#***************************************************************#
#                          WAAP approach                        #
#***************************************************************#
# In our case, my understanding is we should call WAAP as random-effects-WAAP, because we do not want to use fixed effects model
# Selecting adequately powered studies
## We only use studies with power >80% or SE < 2.8
WAAP_dat_m1_1_RR <- dat_m1_1 %>% subset(power_RR > 0.8)
WAAP_dat_m1_1_CVR <- dat_m1_1 %>% subset(power_CVR > 0.8) # none data
WAAP_dat_m1_1_VR <- dat_m1_1 %>% subset(power_VR > 0.8) # none data
# Evaluating publication using adequately powered studies
WAAP_m1_1_RR <- with(WAAP_dat_m1_1_RR, rma(yi = RR,
                                         sei = VRR,
                                         #mods = ~sqrt(VRR),
                                         random = list(~1|Study, ~1|Unit_ID),
                                         method = "REML",
                                         test = "t"))

WAAP_m1_1_RR2 <- with(WAAP_dat_m1_1_RR, rma(yi = RR,
                                         sei = VRR,
                                         mods = ~sqrt(VRR),
                                         random = list(~1|Study, ~1|Unit_ID),
                                         method = "REML",
                                         test = "t"))
#***************************************************************#
#                       PET-PEESE approach                      #
#***************************************************************#
basically if the slope is not sig, use PET but if sig, move on to PEESE

PET’s intercept when slope is not sig but PEEESE’s intercept if PET’s slope is sig


# Get precision, i.e. 1/SE
dat_m1_1$SE <- sqrt(dat_m1_1$vi) # note it is SE rather than variance (V), so we should use sqrt(V)
# # PET model - specifing 1/se^2 as weights
# PET.m1_1 <- lm(RR~SE, weights = (1/SE)**2,data=dat_m1_1) # This form (OLS) reverse the intercept and slope coefficient from WLS version. Therefore, intercept from WLS version is the slope from OLS version. So we should not remove intercept (i.e. -1)
# summary(PET.m1_1) # intercept rather than slope is our expected estimate
# 
# # Or we can use two-step approach for PET
# dat_m1_1$t <- dat_m1_1$RR/sqrt(dat_m1_1$VRR)
# dat_m1_1$precision <- 1/sqrt(dat_m1_1$VRR)
# # We got same results with the above
# PET.m1_1_2 <- lm(t~precision, data=dat_m1_1)
# 
# 
# 
# # PET-PEESE model - quadratic model rather than linear model
# PET_PEESE.m1_1 <- lm(RR~VRR, weights =(1/SE)**2,data=dat_m1_1)
# summary(PET_PEESE.m1_1) 
# Or we can use meta-regression with variances (i.e. SE^2) as moderator
PET_PEESE.m1_0 <- rma(data = dat_m1_1, yi = yi, sei = vi, 
                          #mods = ~SE, # using variance rather than SE
                          random = list(~1|Study, ~1|Unit_ID),
                          method = "REML")
summary(PET_PEESE.m1_0)
PET_PEESE.m1_1 <- rma(data = dat_m1_1, yi = yi, sei = vi, 
                          mods = ~SE, # using variance rather than SE
                          random = list(~1|Study, ~1|Unit_ID),
                          method = "REML")
summary(PET_PEESE.m1_1)
PET_PEESE.m1_2 <- rma(data = dat_m1_1, yi = yi, sei = vi, 
                          mods = ~ vi, # using variance rather than SE
                          random = list(~1|Study, ~1|Unit_ID),
                          method = "REML")
summary(PET_PEESE.m1_2)
# Note: I am not sure which approachs you want me to use to evaluate publication bias in this website: http://environmentalcomputing.net/meta-analysis/
#   
# Whatever, I used a regular model to evaluate publication, i.e. Egger regression test
# #***************************************************************#
#                      Egger regression test                    #
#***************************************************************#
# Egger_m1_1_RR <- with(dat_m1_1, rma(yi = RR,
#                                          sei = VRR,
#                                          mods = ~sqrt(VRR),
#                                          random = list(~1|Study, ~1|Unit_ID),
#                                          method = "REML",
#                                          test = "t"))
# 
# summary(Egger_m1_1_RR) # Note that here we should look at slope, rather than intercept, which is a distinction from PET model
# alternative model 
alternative_model <- with(dat_m1_1, rma(yi = yi,
                                         W = 1/vi,
                                         sei = vi,
                                         random = list(~1|Study, ~1|Unit_ID),
                                         method = "REML"))
summary(alternative_model) 




# or we can do like this
alternative_model2 <- with(dat_m1_1, rma(yi = yi,
                                         W = 1/sqrt(vi),
                                         sei = vi,
                                         mods = vi,
                                         random = list(~1|Study, ~1|Unit_ID),
                                         method = "REML"))




# my way
alternative_model3 <- with(dat_m1_1, rma(yi = yi,
                                         W = 1/sqrt(vi),
                                         sei = vi,
                                         mods = sqrt(vi),
                                         random = list(~1|Study, ~1|Unit_ID),
                                         method = "REML"))

```










